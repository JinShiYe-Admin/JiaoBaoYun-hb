<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/utils/common.css" rel="stylesheet" />
		<style type="text/css">
			.mui-table-view-cell:after,
			before {
				background-color: #dddddd;
			}
			
			.mui-table-view:before {
				background-color: #dddddd;
			}
			
			.mui-table-view:after {
				background-color: #dddddd;
			}
		</style>

	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">设置</h1>
		</header>
		<div class="mui-content">
			<ul class="mui-table-view">
				<!--<li class="mui-table-view-cell">
					<a class="mui-navigate-right" id="yinsi"  style="font-size: 15px;">
						隐私
					</a>
				</li>-->
				<li class="mui-table-view-cell" id="0">
					<a id="change-phoneNum" class="mui-navigate-right" style="font-size: 15px;">
						<p class="mui-pull-right" id='change_phoneNum' style="font-size: 13px;margin-right: 30px;"></p>
						<div class="mui-media-body" style="font-size: 15px;">
							绑定手机
						</div>
					</a>
				</li>
				<li class="mui-table-view-cell">
					<a id="change-passwords" class="mui-navigate-right" style="font-size: 15px;">
						修改密码
					</a>
				</li>
				<li class="mui-table-view-cell">
					<a class="mui-navigate-right" id="quit" style="font-size: 15px;">
						退出登录
					</a>
				</li>
			</ul>
		</div>
		<script src="../../js/mui.min.js"></script>
		<!--共用事件-->
		<script src="../../js/utils/events.js" type="text/javascript" charset="utf-8"></script>
		<!--本地存储-->
		<script src="../../js/libs/myStorage/myStorage.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/storageKeyName.js" type="text/javascript" charset="utf-8"></script>
		<!--共用协议-->
		<script src="../../js/publicProtocol.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/qiuzhi/delContent_pop.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/qiuzhi/delContent_pop.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			mui.init({
				swipeBack: true //启用右滑关闭功能
			});
			//存储个人信息
			var tempInfo;

			var wxChannel = null; // 微信支付
			var aliChannel = null; // 支付宝支付
			var channel = null;

			mui.plusReady(function() {
				tempInfo = window.myStorage.getItem(window.storageKeyName.PERSONALINFO);
				console.log('tempInfo.uid:' + tempInfo.uid);
				document.getElementById('change_phoneNum').innerText = tempInfo.uid;
				// 获取支付通道
				plus.payment.getChannels(function(channels) {
					console.log('channels=' + JSON.stringify(channels));
					alert("通道=" + JSON.stringify(channels));
					for(var i in channels) {
						var temp = channels[i];
						if(temp.id == 'alipay') {
							aliChannel = temp;
						} else if(temp.id == 'wxpay') {
							wxChannel = temp;
						}
					}
				}, function(e) {
					alert("获取支付通道失败：" + e.message);
				});
				//点击绑定手机cell，弹出
				mui('.mui-table-view').on('tap', '.mui-table-view-cell', function() {

					var index = this.id.replace('li', '');
					console.log('index:' + index);
					if(index == '0') {
						console.log("ali");
						pay('alipay');
						//											mui.confirm(tempInfo.uid, '您已绑定手机号', ['取消', '更换'], function(e) {
						//												var index = e.index;
						//												switch(index) {
						//													case 0: //取消
						//														break;
						//													case 1: //返回
						//														//flag为2，表示是更改绑定手机
						//														events.openNewWindowWithData('../register/register_phoneNumber.html', '2');
						//					
						//														break;
						//												}
						//											}, 'div');
					}
				});
				//				window.addEventListener("swiperight", function(e) {
				//					console.log('侧滑。。。');
				//                      //默认滑动角度在-45度到45度之间，都会触发右滑菜单，为避免误操作，可自定义限制滑动角度；
				//                      if (Math.abs(e.detail.angle) < 30) {
				//                          self.close();
				//                      }
				//                  });
				//隐私
				//				events.addTap('yinsi', function() {
				//					mui.toast('此功能暂未开放');
				//				});
				var ALIPAYSERVER = 'https://jsypay.jiaobaowang.net/jsypay/alipay/sys/aliappserver.ashx';
				//		var WXPAYSERVER='http://demo.dcloud.net.cn/helloh5/payment/wxpay.php?total=1';
				var WXPAYSERVER = 'https://jsypay.jiaobaowang.net/example/AppServer.aspx?body="教宝云-会员"&attach="附件数据"&total_fee=201';
				//2. 发起支付请求
				function pay(id) {
					// 从服务器请求支付订单
					var PAYSERVER = '';
					if(id == 'alipay') {
						PAYSERVER = ALIPAYSERVER;
						channel = aliChannel;
					} else if(id == 'wxpay') {
						PAYSERVER = WXPAYSERVER;
						channel = wxChannel;
					} else {
						plus.nativeUI.alert("不支持此支付通道！", null, "捐赠");
						return;
					}
					var xhr = new XMLHttpRequest();
					xhr.onreadystatechange = function() {
						console.log('xhr=' + JSON.stringify(xhr));
						switch(xhr.readyState) {
							case 4:
								if(xhr.status == 200) {
									alert("PAYSERVER=" + PAYSERVER+','+JSON.stringify(channel));
									alert("获取订单信=" + JSON.stringify(xhr));
									plus.payment.request(channel, xhr.responseText, function(result) {
										plus.nativeUI.alert("支付成功！", function() {
											back();
										});
									}, function(error) {
										console.log('error' + JSON.stringify(error));
										plus.nativeUI.alert("支付失败：" + error.code);
									});
								} else {
									alert("获取订单信息失败！");
								}
								break;
							default:
								break;
						}
					}
					xhr.open('GET', PAYSERVER);
					xhr.send();
				}
				//修改密码
				events.addTap('change-passwords', function() {
					loadURL();
					//					events.openNewWindowWithData('../register/modify_password.html', '1');
				});

				function loadURL() {
					// 初始化图片选择控制器
					//					UIImagePickerController * controller = [
					//						[UIImagePickerController alloc] init
					//					];
					var tempC1 = plus.ios.importClass('UIImagePickerController');
					var tempC = new tempC1();
					/*设置媒体来源，即调用出来的UIImagePickerController所显示出来的界面，有一下三种来源
					 typedef NS_ENUM(NSInteger, UIImagePickerControllerSourceType) {
					     UIImagePickerControllerSourceTypePhotoLibrary,
					     UIImagePickerControllerSourceTypeCamera,
					  UIImagePickerControllerSourceTypeSavedPhotosAlbum
					 };分别表示：图片列表，摄像头，相机相册*/
					//					[controller setSourceType: UIImagePickerControllerSourceTypeCamera];
//					plus.ios.invoke(tempC, 'setSourceType', 'UIImagePickerControllerSourceTypeCamera');
					tempC.setSourceType('UIImagePickerControllerSourceTypeCamera');
					// 设置所支持的媒体功能，即只能拍照，或则只能录像，或者两者都可以
					//					NSString * requiredMediaType = (NSString * ) kUTTypeImage;
					//					NSString * requiredMediaType1 = (NSString * ) kUTTypeMovie;
					var tempType = 'kUTTypeMovie';
					//					NSArray * arrMediaTypes = [NSArray arrayWithObjects: requiredMediaType, requiredMediaType1, nil];
					var arrMediaTypes = plus.ios.importClass('NSArray');
					arrMediaTypes.arrayWithObjects(tempType);
					//					[controller setMediaTypes: arrMediaTypes];
//					plus.ios.invoke(tempC, 'setMediaTypes', arrMediaTypes);
					tempC.setMediaTypes(arrMediaTypes);
					// 设置录制视频的质量
					//					[controller setVideoQuality: UIImagePickerControllerQualityTypeHigh];
//					plus.ios.invoke(tempC, 'setVideoQuality', 'UIImagePickerControllerQualityTypeHigh');
//					tempC.setVideoQuality('UIImagePickerControllerQualityTypeHigh');
					//设置最长摄像时间
					//					[controller setVideoMaximumDuration: 10. f];
//					plus.ios.invoke(tempC, 'setVideoMaximumDuration', 10);
//					tempC.setVideoMaximumDuration(10);
					// 设置是否可以管理已经存在的图片或者视频
					//					[controller setAllowsEditing: YES];
					// 设置代理
					//					[controller setDelegate: self];
					//					[self presentViewController: controller animated: YES completion: nil];
//					var wv = plus.ios.currentWebview();
//					var main = plus.android.runtimeMainActivity();
//					var main = plus.ios.runtimeMainActivity();
//					main.presentViewControlleranimatedcompletion(tempC, true, null);
//					UINavigationController * viewController = (UINavigationController*)view.reactViewController;
//					[viewController.navigationController pushViewController:[AiMeiViewController new] animated:YES];
				}
				//退出
				events.addTap('quit', function() {
					console.log('2222');
					var btnArray = [{
						title: "确定"
					}];
					plus.nativeUI.actionSheet({
						title: "确定退出？",
						cancel: "取消",
						buttons: btnArray
					}, function(e) {
						var index = e.index;
						switch(index) {
							case 0: //取消
								break;
							case 1: //退出登录
								//判断是否设置了密码
								console.log('tempinfo:' + JSON.toString(tempInfo));
								if(Number(tempInfo.ispw) == 1) { //有密码
									//发送注销协议
									//25.用户注销
									//需要参数
									var comData = {

									};
									// 等待的对话框
									var wd = events.showWaiting();
									postDataPro_PostLoginOut(comData, wd, function(data) {
										wd.close();
										console.log('注销success:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
										if(data.RspCode == 0) {
											window.myStorage.setItem(window.storageKeyName.PERSONALINFO, null);
											events.defaultLogin(function(data) {
												if(data.value) {
													//退出登录
													events.logOff();
													events.infoChanged();
													mui.fire(plus.webview.getWebviewById("index.html"), 'quit');
													mui.back();
												}
											});
										} else {
											mui.toast(data.RspTxt);
										}
									});

								} else { //无密码
									events.openNewWindowWithData('../register/modify_password.html', '2');
								}
								break;
						}
					});
				});
			});
		</script>
	</body>

</html>