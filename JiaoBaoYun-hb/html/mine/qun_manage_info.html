<!--
	作者：444811716@qq.com
	时间：2016-12-06
	描述：创建群
-->
<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<link rel="stylesheet" href="../../css/iconfont/iconfont.css" />
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/utils/camera.js"></script>
		<script type="text/javascript" src="../../js/publicProtocol.js"></script>
		<script type="text/javascript" src="../../js/utils/CloudFileUtil.js"></script>
		<script type="text/javascript" src="../../js/utils/events.js"></script>
		<script type="text/javascript" src="../../js/cloud/AndroidFileSystem.js"></script>
		<script type="text/javascript" src="../../js/utils/UploadHeadImage.js"></script>
		<style>
			body,
			.mui-content {
				background: white;
			}
			/*#qunimage {
				height: 100px;
			}*/

			.qun-image {
				height: 100px;
				width: 100px;
				/*text-align: center;*/
				margin-top: 20px;
			}

			.mui-input-row label {
				text-align: center;
				width: 25%;
				padding: 11px 0px;
				font-size: 15px;
			}

			.mui-input-group {
				margin-top: 20px;
			}

			.mui-input-group:before,
			.mui-input-group:after {
				height: 0px;
			}

			.mui-input-row label~input,
			.mui-input-row label~select,
			.mui-input-row label~textarea {
				width: 75%;
				font-size: 15px;
			}

			.mui-input-group .mui-input-row:after {
				width: 100%;
				left: 0;
				background: #e4e4e4;
			}

			.mui-btn-block {
				/*border-radius: 50px;*/
				margin-top: 50px;
				width: 80%;
				margin-left: 10%;
				height: 40px;
				padding: 0;
				border: 1px solid #1db8f1;
				background-color: #1db8f1
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<p class="mui-title common-color-white">填写群信息</p>
		</header>
		<div class="mui-content">
			<div id="qunimage" style="text-align: center;margin-left: auto;margin-right: auto;">
				<div id="choose" class="qun-image" style="text-align: center;margin-left: auto;margin-right: auto;border: 1px solid #F2F2F2;border-radius: 50%;">
					<a class="mui-icon iconfont icon-xiangji" style="color: #BBBBBB;font-size: 30px;margin-top: 20px;">
						<p style="font-size: 10px;margin-top: 10px;">
							请上传群图标!
						</p>
					</a>
				</div>
			</div>
			<form class="mui-input-group">
				<div class="mui-input-row">
					<label>群名称：</label>
					<input id="qunname" type="text" placeholder="请为你们的群起一个给力的名字吧！" oninput="if(value.length>20)value=value.slice(0,20)">
				</div>
				<div class="mui-input-row">
					<label>群说明：</label>
					<input id="qunintroduce" type="text" placeholder="请简单介绍一下本群！" oninput="if(value.length>30)value=value.slice(0,30)">
				</div>
				<div class="mui-input-row">
					<label>群备注：</label>
					<input id="qunremark" type="text" oninput="if(value.length>30)value=value.slice(0,30)">
				</div>
			</form>
			<button id="commit" type="button" class="mui-btn mui-btn-blue mui-btn-block">提交</button>
		</div>
		<script type="text/javascript">
			mui.init();
			mui.plusReady(function() {
				var qunImgPath = '';
				document.getElementById('choose').addEventListener('tap', function() {
					//console.log('选择群图标');
					var btnArray = [{
						title: "拍照"
					}, {
						title: "相册"
					}];
					plus.nativeUI.actionSheet({
						title: "选择上传群图标的方式",
						cancel: "取消",
						buttons: btnArray
					}, function(e) {
						var index = e.index;
						switch(index) {
							case 0: //取消
								break;
							case 1: //拍照
								fromCamera();
								break;
							case 2: //相册
								fromPic();
								break;
						}
					});
				});

				document.getElementById("commit").addEventListener('tap', function() {
					var qunName = document.getElementById("qunname"); //群名称
					var qunIntroduce = document.getElementById("qunintroduce"); //群说明
					var qunRemark = document.getElementById("qunremark"); //群备注
					if(qunName.value.replace(/(^\s*)|(\s*$)/g, "") == "") {
						mui.toast('群名称不能为空');
					} else {
						document.getElementById("commit").disabled = true;
						document.activeElement.blur();
						createQun(qunName.value, qunIntroduce.value);
					}
				});

				/**
				 * 上传群图标区域
				 */
				function addQunImg() {
					var div = document.getElementById("qunimage");
					div.innerHTML = '<div id="choose" style="margin-left: ' + marginLeft + ';" class="qun-image">\
									<a class="mui-icon iconfont icon-xiangji" style="color: #BBBBBB;font-size: 30px;margin-top: 20px;">\
										<p style="font-size: 10px;margin-top: 10px;">\
											请上传群图标!\
										</p>\
									</a>\
								</div>';
					//var table = document.body.querySelector('.mui-content');
					//table.insertBefore(div, table.firstChild);
				}

				/**
				 * 从相册选择图片
				 */
				function fromPic() {
					plus.gallery.pick(function(file) {
						console.log('从相册选取图片成功,图片的路径为：' + file);
						var div = document.getElementById("choose");
						div.innerHTML = '<img src="' + file + '"style="margin-top:0px;border: 1px solid #F2F2F2;border-radius: 50%;height: 100px;width: 100px;"/>';
						qunImgPath = file;
					}, function(error) {
						//从相册选取图片失败的回调
						var code = error.code; // 错误编码
						var message = error.message; // 错误描述信息
						if(mui.os.ios) {
							if(code != -2) {
								mui.toast('从相册选取图片失败！' + '错误编码：' + code + '描述信息：' + message);
								console.log('从相册选取图片失败！' + JSON.stringify(error));
							} else {
								console.log('未选取图片');
							}
						} else if(mui.os.android) {
							if(code != 12) {
								mui.toast('从相册选取图片失败！' + '错误编码：' + code + '描述信息：' + message);
								console.log('从相册选取图片失败！' + JSON.stringify(error));
							} else {
								console.log('未选取图片:' + JSON.stringify(error));
							}
						}
					});
				}

				/**
				 * 通过相机拍照
				 */
				function fromCamera() {
					camera.getPic(camera.getCamera(), function(path) {
						plus.io.resolveLocalFileSystemURL(path, function(succesCB) {
							var div = document.getElementById("choose");
							div.innerHTML = '<img src="' + succesCB.toLocalURL() + '" style="margin-top:0px;border: 1px solid #F2F2F2;border-radius: 50%;height: 100px;width: 100px;"/>';
							qunImgPath = succesCB.toLocalURL();
						}, function(errorCB) {
							//请求失败的的回调
							mui.toast('请求文件系统失败:' + JSON.stringify(errorCB));
							console.log("请求文件系统失败: " + JSON.stringify(errorCB));
						});
					}, function(error) {
						var code = error.code; // error.code（Number类型）获取错误编码
						var message = error.message; // error.message（String类型）获取错误描述信息。
						if(mui.os.ios) {
							if(code !== 2) {
								mui.toast('拍照失败！' + '错误编码：' + code + ' 描述信息：' + message, '拍照失败');
								console.log('拍照失败！' + JSON.stringify(error));
							} else {
								console.log('未拍取图片');
							}
						} else if(mui.os.android) {
							if(code !== 11) {
								mui.toast('拍照失败！' + '错误编码：' + code + ' 描述信息：' + message, '拍照失败');
								console.log('拍照失败！' + JSON.stringify(error));
							} else {
								console.log('未拍取图片:' + JSON.stringify(error));
							}
						}
					});
				}

				/**
				 * 创建一个群
				 * @param {Object} gname 名称
				 * @param {Object} gnote 说明
				 * @param {Object} gimg
				 */
				function createQun(gname, gnote) {
					//7.用户创建群
					//需要参数
					var comData = {
						gname: gname, //群名
						gnote: gnote, //群说明
						gimg: '', //群头像
					};
					var gid = ''; //群id
					// 等待的对话框
					var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
					postDataPro_PostCrGrp(comData, wd, function(data) {
						console.log('7.90909090success:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
						if(data.RspCode == 0) {
							gid = data.RspData;
							if(qunImgPath == '') {
								changInfo({
									gid: gid, //群id
									gname: gname, //群名
									gnote: gnote, //群说明
									gimg: '', //群头像
								});
								mui.toast('创建群成功');
								mui.back();
							} else {
								plus.nativeUI.showWaiting('正在加载中');
								uploadQunHeadImge(data.RspData, qunImgPath, function(successCB) {
									changInfo({
										gid: gid, //群id
										gname: gname, //群名
										gnote: gnote, //群说明
										gimg: successCB, //群头像
									});
									plus.nativeUI.closeWaiting();
									mui.toast('创建群成功');
									mui.back();
								}, function(errorCB) {
									changInfo({
										gid: gid, //群id
										gname: gname, //群名
										gnote: gnote, //群说明
										gimg: '', //群头像
									});
									plus.nativeUI.closeWaiting();
									mui.toast('创建群成功但是上传群头像失败：' + JSON.stringify(errorCB));
									mui.back();
								});
							}
						} else {
							mui.toast(data.RspTxt);
							console.log('创建群失败：' + data.RspTxt);
						}
						wd.close();
					});
				}

				/**
				 * 创建群后修改界面
				 */
				function changInfo(data) {
					events.fireToPageWithData('qun_manage_sub.html', 'createQun', data);
					events.fireToPageNone('/html/mine/qun_data.html', 'refreshView');
					events.fireToPageNone('../cloud/cloud_home.html', 'infoChanged');
				}

				/**
				 * 上传图片到七牛
				 * @param {Object} qunId 群id
				 * @param {Object} qunImge 群头像
				 * @param {Object} success 成功回调
				 * @param {Object} error 失败回调
				 */
				function uploadQunHeadImge(qunId, qunImge, successCallBack, errorCallBack) {
					var fileName = 'qunheadimge' + qunId + '.png';
					plus.zip.compressImage({
							src: qunImge, //压缩转换原始图片的路径
							dst: '_documents/' + fileName, //压缩转换目标图片的路径
							overwrite: true, //覆盖生成新文件,仅在dst制定的路径文件存在时有效
							format: '.png'
						},
						function(event) {
							//图片压缩成功
							var target = event.target; // 压缩转换后的图片url路径，以"file://"开头
							var size = event.size; // 压缩转换后图片的大小，单位为字节（Byte）
							var width = event.width; // 压缩转换后图片的实际宽度，单位为px
							var height = event.height; // 压缩转换后图片的实际高度，单位为px
							console.log('压缩图片成功---target:' + target + '|size:' + AndroidFileSystem.readSize(size) + '|width:' + width + '|height:' + height);
							//openImage(target); //打开新页面查看图片
							//获取七牛上传token的url
							var getUploadTokenUrl = window.storageKeyName.QNGETUPTOKENHEADIMGE;
							CloudFileUtil.getQNUpToken(getUploadTokenUrl, fileName, function(data) {
								var QNUptoken = data.uptoken;
								console.log('七牛上传token:' + QNUptoken);
								//关闭等待窗口
								//plus.nativeUI.closeWaiting();
								CloudFileUtil.upload(target, QNUptoken, fileName, function(upload, status) {
									//上传任务完成的监听
									console.log('上传任务完成');
									console.log('上传任务完成:' + status);
									console.log('上传任务完成:' + JSON.stringify(upload));
									plus.nativeUI.closeWaiting();
									if(status == 200) { //上传任务成功
										//存放头像的七牛域名
										var domain = window.storageKeyName.QNHEADIMGEDOMAIN;
										var myDate = new Date();
										var gimgPath = domain + fileName + '?' + myDate.getTime();
										//8.用户修改群各项信息
										//需要参数
										var comData2 = {
											rid: qunId, //要修改的群id
											vtp: 'gimg', //更改项，指更改用户信息的相应项,对应后面的vvl值,gimg(头像),gname(群名),gnote(群说明)
											vvl: gimgPath, //要修改成的值

										};
										//返回值model：model_groupList
										// 等待的对话框
										var wd2 = plus.nativeUI.showWaiting(storageKeyName.WAITING);
										postDataPro_PostReGinfo(comData2, wd2, function(data) {
											wd2.close();
											console.log('8_PostReGinfo:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
											if(data.RspCode == 0) {
												successCallBack(gimgPath);
											} else {
												errorCallBack();
												mui.toast(data.RspTxt);
											}
										});
									} else { //上传失败
										errorCallBack(data.responseText);
									}
								}, function(upload, status) {
									//上传任务状态监听
									//上传任务的标识
									var id = upload.__UUID__;
									//已完成上传数据的大小
									var uploadedSize = AndroidFileSystem.readSize(upload.uploadedSize);
									//上传数据的总大小
									var totalSize = AndroidFileSystem.readSize(upload.totalSize);
									//上传任务的状态
									var uploadState = upload.state;
									switch(uploadState) {
										case 0: //上传任务开始调度
											console.log('上传任务开始调度:|id:' + id + '|uploadState:' + uploadState);
											break;
										case 1: //上传任务开始请求
											console.log('上传任务开始请求:|id:' + id + '|uploadState:' + uploadState);
											break;
										case 2: //上传任务请求已经建立
											console.log('上传任务请求已经建立:|id:' + id + '|uploadState:' + uploadState);
											break;
										case 3: //上传任务提交数据
											//console.log('上传任务状态监听:|id:' + id + '|uploadedSize:' + uploadedSize + '|totalSize:' + totalSize + '|uploadState:' + uploadState);
											//var num = parseInt(upload.uploadedSize / upload.totalSize * 100) + '%';
											//console.log(num);
											//size.setTitle('正在上传 ' + num);
											break;
										case 4: //上传任务已完成
											//console.log('上传任务已完成:|id:' + id + '|uploadState:' + uploadState);
											break;
										case 5: //上传任务已暂停
											console.log('上传任务已暂停:|id:' + id + '|uploadState:' + uploadState);
											break;
										default:
											console.log('上传任务状态监听:其他状态:' + uploadState);
											break;
									}
								}, function(task) {
									//上传任务创建成功的回调
									task.start();
								});
							}, function(xhr, type, errorThrown) {
								plus.nativeUI.closeWaiting();
								mui.toast('获取七牛上传token失败：' + type);
								console.log('获取七牛上传token失败：' + type);
							});
						},
						function(error) {
							//图片压缩失败
							var code = error.code; // 错误编码
							var message = error.message; // 错误描述信息
							mui.toast('图片压缩失败！' + '错误编码：' + code + '描述信息：' + message);
							console.log('图片压缩失败！' + JSON.stringify(error));
							//关闭等待窗口
							plus.nativeUI.closeWaiting();
						}
					);
				}
			});
		</script>
	</body>

</html>