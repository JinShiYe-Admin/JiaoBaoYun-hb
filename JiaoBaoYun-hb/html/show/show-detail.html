<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/utils/common.css" rel="stylesheet" />
		<link href="../../css/iconfont/iconfont.css" rel="stylesheet" />
		<link href="../../css/show/show-detail.css" rel="stylesheet" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">详情</h1>
		</header>
		<div id="show-detail" v-if="showDetail.TabId" class="mui-content">
			<div>
				<h4 class="detail-head single-line">{{showDetail.MsgTitle}}</h4>
				<div class="publisher-container">
					<img class="publisher-img" v-bind:src="showDetail.PublisherImg" v-on:tap="openPersonSpace(showDetail.PublisherId)"/>
					<div class="publisher-info">
						<div class="publisher-name single-line">{{showDetail.PublisherName}}</div>
						<div class="publisher-date">
							{{getSimpleDate(showDetail.PublishDate)}}
						</div>
					</div>
					<button class="attention-btn btn-unfocus" v-bind:class="{'btn-focused':showDetail.IsFocused}" v-on:tap="toggleFocus">{{showDetail.IsFocused?'已关注':'关注'}}</button>
				</div>
				<div class="show-content">{{showDetail.MsgContent}}</div>
				<div v-for="img of getImgs(showDetail)">
					
				</div>
				<!--<detail-img v-on:imgs="getImgs(showDetail)">

				</detail-img>-->
				<div class="mui-pull-right extra-container">
					<span class="iconfont icon-support" v-bind:class="{isLiked:showDetail.IsLike,isUnlike:!showDetail.IsLike}" v-on:tap="toggleLike"></span>
					<span class="iconfont icon-liaotian1" v-on:click="openComment"></span>
				</div>
				<div v-if="showDetail.LikeUsers&&showDetail.LikeUsers.length>0" style="width: 100%;">
					<hr style="width: 100%;" />
					<p v-on:tap="openLikers">
						<span class="liker-name" v-for="(liker,likerIndex) of showDetail.LikeUsers" v-if="likerIndex<20" v-on:tap.stop="openPersonSpace(liker.userId)">{{liker.userName}}
							<span v-if="likerIndex<showDetail.LikeUsers.length-1&&likerIndex<19">,</span>
						</span>
						<span v-if="showDetail.LikeUsers.length>20">等人觉得很赞</span
					</p>
				</div>
			</div>
			<div class="comments-container" v-if="showDetail.Comments.length>0">
				<div class="comments-banner">
					<div class=" banner-left"></div>
					<div class="comments-no">评论({{showDetail.TotalCnt}})</div>
				</div>
				<div class="comments-li mui-table-view-cell" v-for="(comment,index0) of showDetail.Comments" v-on:tap="openComment" v-on:longtap="showSheet(comment,index0)">
					<div class="comment-person"><img class="comment-img" v-bind:src="comment.UserImg" v-on:tap.stop="openPersonSpace(comment.UserId)" />
						<div class="comment-name">{{comment.UserName}}</div>
					</div>
					<p class="comment-content">{{comment.CommentContent}}</p>
					<div class="comment-bottom">
						<p class="comment-repliesNo">回复 
							{{comment.Replys.length}}
						</p>
						<p class="comment-date">{{getSimpleDate(comment.CommentDate)}}</p>
					</div>
					<div class="replies-container" v-if="comment.Replys.length>0">
						<div class="reply-li" v-for="(reply,index1) of comment.Replys" v-on:longtap="showSheet(comment,index0,index1)">
							<p class="reply-content"><span class="reply-name">{{reply.UserName}}</span>
						<template v-if="reply.ReplyName">
							@<span class="reply-name">{{reply.ReplyName}}</span>
						</template>
						:{{reply.CommentContent}}</p>
				</div>
			</div>
		</div>
		</div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/utils/events.js"></script>
		<script src="../../js/utils/vue.js"></script>
		<script src="../../js/publicProtocol.js"></script>
		<script src="../../js/show/show-comment.js"></script>
		<script type="text/javascript">
			var pageIndex = 1;
			var tableId = 0;
			mui.init({
				gestureConfig: {
					longtap: true
				},
				beforeback: function() {
					//					commentList.resetData();
					return true;
				}
			})
			mui.plusReady(function() {
				events.preload('../quan/classSpace-persons.html',50);
				mui.fire(plus.webview.currentWebview().opener(), 'detailReady', true);
				window.addEventListener('showDetail', function(e) {
					console.log("获取的数据:" + JSON.stringify(e.detail.data));
					var showInfo = e.detail.data;
					tableId = showInfo.TabId;
					requestShowDetail();
				})
			})
			/**
			 * 获取展现详情
			 */
			function requestShowDetail() {
				var wd = events.showWaiting();
				postDataPro_getUserSpaceByUser({
					userId: events.getUtid(), //用户ID
					userSpaceId: tableId, //用户动态ID
					pageIndex: pageIndex, //评论当前页数
					pageSize: 10 //评论每页记录数
				}, wd, function(data) {
					wd.close();
					console.log("获取的展现详情:" + JSON.stringify(data));
					if(data.RspCode == 0) {
						getUserInfos(data.RspData.Data, rechargeData);
					} else {
						mui.toast(data.RspTxt);
					}
				})
			}

			function rechargeData(showDetail, personInfoes) {
				for(var i in personInfoes) {
					if(showDetail.PublisherId == personInfoes[i].utid) {
						showDetail.PublisherName = getName(personInfoes[i]);
						showDetail.PublisherImg = updateHeadImg(personInfoes[i].uimg, 2);
					}
					if(showDetail.LikeUsers.length > 0) {
						var likers = showDetail.LikeUsers;
						for(var n in likers) {
							if(likers[n].userId == personInfoes[i].utid) {
								likers[n].userName = getName(personInfoes[i]);
							}
						}
					}
					if(showDetail.Comments.length > 0) {
						var comments = showDetail.Comments;
						for(var j in comments) {
							if(comments[j].UserId) {
								if(comments[j].UserId == personInfoes[i].utid) {
									comments[j].UserName = getName(personInfoes[i]);
									comments[j].UserImg = updateHeadImg(personInfoes[i].uimg, 2)
								}
							}
							if(comments[j].ReplyId) {
								if(comments[j].ReplyId == personInfoes[i].utid) {
									comments[j].ReplyName = getName(personInfoes[i]);
									comments[j].ReplyImg = updateHeadImg(personInfoes[i].uimg, 2)
								}
							}
							if(comments[j].Replys.length > 0) {
								var replies = comments[j].Replys;
								for(var m in replies) {
									if(replies[m].UserId) {
										if(replies[m].UserId == personInfoes[i].utid) {
											replies[m].UserName = getName(personInfoes[i]);
										}
									}
									if(replies[m].ReplyId) {
										if(replies[m].ReplyId == personInfoes[i].utid) {
											replies[m].ReplyName = getName(personInfoes[i]);
										}
									}
								}
							}
						}
					}
				}
				console.log("获取人员信息后的展现详情：" + JSON.stringify(showDetail));
				commentList.showDetail = showDetail;
			}

			function getName(info) {
				return info.bunick ? info.bunick : info.unick;
			}

			function getIds(data) {
				console.log("要处理的数据：" + JSON.stringify(data))
				var ids = [];
				ids.push(data.PublisherId);
				if(data.LikeUsers.length > 0) {
					for(var n in data.LikeUsers) {
						ids.push(data.LikeUsers[n].userId);
					}
				}
				if(data.Comments.length > 0) {
					var comments = data.Comments;
					for(var i in comments) {
						if(comments[i].UserId) {
							ids.push(comments[i].UserId);
						}
						if(comments[i].ReplyId) {
							ids.push(comments[i].ReplyId);
						}
						if(comments[i].Replys.length > 0) {
							var replies = comments[i].Replys;
							for(var j in replies) {
								if(replies[j].UserId) {
									ids.push(replies[j].UserId);
								}
								if(replies[j].ReplyId) {
									ids.push(replies[j].ReplyId);
								}
							}
						}
					}
				}
				ids = events.arraySingleItem(ids);
				console.log("获取的id数据：" + ids);
				return ids;
			}
			/**
			 * 21
			 * 获取用户信息
			 */
			function getUserInfos(showDetail, callback) {
				var ids = getIds(showDetail);
				var wd = events.showWaiting();
				postDataPro_PostUinf({
					vvl: ids.toString(),
					vtp: 'g'
				}, wd, function(data) {
					wd.close();
					console.log("获取的数据：" + JSON.stringify(data));
					if(data.RspCode == 0) {
						getRemark(showDetail, ids, data.RspData, callback);
					}
					//					getRemark(showDetail, ids, [], callback);
				})
			}
			/**
			 * 35
			 * * 通过ids获取对用户的备注
			 * @param {Object} ids
			 */
			function getRemark(showDetail, ids, dataInfos, callback) {
				var wd = events.showWaiting();
				postDataPro_PostUmk({
					vvl: ids.toString()
				}, wd, function(data) {
					wd.close();
					console.log("获取的用户备注：" + JSON.stringify(data));
					if(data.RspCode == 0) {
						if(data.RspData.length > 0) {
							var remarkInfos = data.RspData;
							for(var i in dataInfos) {
								for(var j in remarkInfos) {
									if(dataInfos[i].utid == remarkInfos[j].butid) {
										jQuery.extend(dataInfos[i], remarkInfos[j]);
									}
								}

							}
						}
					}
					callback(showDetail, dataInfos);
				})
			}
		</script>
	</body>

</html>