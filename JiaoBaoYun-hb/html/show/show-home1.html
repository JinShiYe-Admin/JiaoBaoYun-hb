<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/utils/fresh.css" />
		<link rel="stylesheet" type="text/css" href="../../css/utils/common.css" />
		<link rel="stylesheet" href="../../css/show/show-list.css" />
		<style>
			.mui-slider-indicator {
				margin-left: -10px;
				bottom: -3px;
			}
			
			.mui-slider-indicator .mui-indicator {
				margin: 1px 2px;
			}
			
			.mui-segmented-control.mui-scroll-wrapper {
				height: 0;
			}
			
			.mui-segmented-control.mui-scroll-wrapper .mui-scroll {
				height: 0;
			}
			
			.mui-fullscreen .mui-segmented-control~.mui-slider-group {
				top: 0;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<h1 class="mui-title">关注</h1>
			<div id="header-indicator" class="mui-slider-indicator">
				<div class="mui-indicator mui-active"></div>
				<div class="mui-indicator"></div>
			</div>
			<a id="publish-show" class="mui-pull-right">发布</a>
		</header>
		<div class="mui-content">
			<div id="slider" class="mui-slider mui-fullscreen">
				<div id="sliderSegmentedControl" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted" style="background-color: transparent;">
					<div class="mui-scroll" style="background-color: transparent;">
						<a class="mui-control-item mui-active" href="#show-all" style="background-color: transparent;">

						</a>
					</div>
				</div>
				<div class="mui-slider-group">
					<div id="show-all" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<div class="show-list">
									<!--<div class="cityNews-container mui-card">
										<div class="mui-table-view">
											<li class="mui-table-view-cell news-container"><img class="news-img" src="http://qn-kfpb.jiaobaowang.net/jxq/PersonalSpace/thumb/1496731091586.png">
												<div class="news-words">
													<p class="news-title single-line">mmm</p>
													<div class="anthor-date">
														<p class="news-anthor single-line">遥不可及</p>
														<p class="news-date">06-06 14:38</p>
													</div>
												</div>
											</li>
											<li class="mui-table-view-cell news-container"><img class="news-img" src="http://qn-kfpb.jiaobaowang.net/jxq/PersonalSpace/thumb/1496731036698.jpg">
												<div class="news-words">
													<p class="news-title single-line">ppppp</p>
													<div class="anthor-date">
														<p class="news-anthor single-line">遥不可及</p>
														<p class="news-date">06-06 14:37</p>
													</div>
												</div>
											</li>
											<li class="mui-table-view-cell news-container"><img class="news-img" src="../../image/show/show-default-small.png">
												<div class="news-words">
													<p class="news-title single-line">kkkkk</p>
													<div class="anthor-date">
														<p class="news-anthor single-line">遥不可及</p>
														<p class="news-date">06-06 14:36</p>
													</div>
												</div>
											</li>
											<li class="mui-table-view-cell news-container"><img class="news-img" src="../../image/show/show-default-small.png">
												<div class="news-words">
													<p class="news-title single-line">工呼吸一下</p>
													<div class="anthor-date">
														<p class="news-anthor single-line">森哈哈哈哈哈哈啦啦啦啦啦就好了考虑</p>
														<p class="news-date">06-06 10:03</p>
													</div>
												</div>
											</li>
											<li class="mui-table-view-cell news-container"><img class="news-img" src="../../image/show/show-default-small.png">
												<div class="news-words">
													<p class="news-title single-line">123456789123456789123456789000</p>
													<div class="anthor-date">
														<p class="news-anthor single-line">遥不可及</p>
														<p class="news-date">06-03 11:03</p>
													</div>
												</div>
											</li>
											<li class="mui-table-view-cell news-container"><img class="news-img" src="../../image/show/show-default-small.png">
												<div class="news-words">
													<p class="news-title single-line">aav</p>
													<div class="anthor-date">
														<p class="news-anthor single-line">遥不可及</p>
														<p class="news-date">06-02 16:31</p>
													</div>
												</div>
											</li>
										</div>
									</div>-->

								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/utils/events.js"></script>
		<script src="../../js/mui.pullToRefresh.js"></script>
		<script src="../../js/mui.pullToRefresh.material.js"></script>
		<script src="../../js/publicProtocol.js"></script>
		<script src="../../js/libs/jquery.lazyload.min.js"></script>
		<script src="../../js/show/show_listnew.js"></script>
		<script>
			mui.init();
			document.getElementById("show-all").showCity = {
				pageFlag: 1, //全部
				acode: 1,
				aname: '全部',
				aflag: 1, //0为根据省市编码获取数据，1为获取关注的人的列表
				pageIndex: 1,
				totalPage: 0
			}
			//阻尼系数
			var deceleration = mui.os.ios ? 0.003 : 0.0009;
			mui.plusReady(function() {
				initFresh(document.getElementById("show-all"));
				show_listnew.getShowList(document.getElementById("show-all").showCity, document.getElementById("show-all").querySelector(".show-list"), show_listnew.setShowList)
				getFocusedPerson(toggleAttendedPart);
				show_listnew.setListListener();
				addSlider();
				window.addEventListener("focus", function() {
					console.log("关注传过来的值！")
					getFocusedPerson(toggleAttendedPart);
				});
				window.addEventListener("infoChanged", function() {
					console.log("********展现监听infoChanged")
					if(document.getElementById("show-attended")) {
						document.getElementById("show-attended").querySelector(".show-list").innerHTML = "";
					}
					document.getElementById("show-all").querySelector(".show-list").innerHTML = "";
					mui(document.getElementById("show-all").querySelector(".mui-scroll-wrapper")).scroll().scrollTo(0,0);
					document.getElementById("show-all").showCity.pageIndex = 1;
					show_listnew.getShowList(document.getElementById("show-all").showCity, document.getElementById("show-all").querySelector(".show-list"), show_listnew.setShowList)
					getFocusedPerson(toggleAttendedPart);
				})
			});

			function addSlider() {
				document.getElementById('slider').addEventListener('slide', function(e) {
					console.log("slider状态：" + JSON.stringify(e.detail))
					if(e.detail.slideNumber == 0) {
						if(document.getElementById("show-attended")) {
							setTitle(11);
						} else {
							setTitle(0);
						}
					} else if(e.detail.slideNumber == 1) {
						if(document.getElementById("show-attended")) {
							setTitle(10);
						} else {
							setTitle(0);
						}

					}
				});
			}
			/**
			 * 
			 * @param {Object} type 0 只有全部 10 显示全部 11 显示关注
			 */
			function setTitle(type) {
				var title = document.querySelector(".mui-title");
				var indicator = document.querySelector("#header-indicator");
				switch(type) {
					case 0: //全部
						title.innerText = "全部";
						indicator.style.display = "none";
						break;
					case 10: //全部
						title.innerText = "全部";
						indicator.style.display = "block";
						indicator.firstElementChild.className = "mui-indicator";
						indicator.lastElementChild.className = "mui-indicator mui-active";
						break;
					case 11: //关注
						title.innerText = "关注";
						indicator.style.display = "block";
						indicator.firstElementChild.className = "mui-indicator mui-active";
						indicator.lastElementChild.className = "mui-indicator";
						break;
					default:
						break;
				}
			}
			/**
			 * 
			 * @param {Object} freshConatiner
			 */
			function initFresh(freshConatiner) {
				mui('.mui-scroll-wrapper').scroll({
					bounce: false,
					indicators: true, //是否显示滚动条
					deceleration: deceleration
				});
				mui(freshConatiner.querySelector(".mui-slider-group .mui-scroll")).pullToRefresh({
					down: {
						callback: function() {
							var self = this;
							var ul = self.element.querySelector('.show-list');
							ul.innerHTML = "";
							freshConatiner.showCity.pageIndex = 1;
							console.log("获取的fresh:" + JSON.stringify(freshConatiner.info))
							show_listnew.getShowList(freshConatiner.showCity, ul, show_listnew.setShowList);
							setTimeout(function() {
								self.endPullDownToRefresh();
							}, 1500);
						}
					},
					up: {
						callback: function() {
							var self = this;
							if(freshConatiner.showCity.pageIndex <= freshConatiner.showCity.totalPage) {
								var ul = self.element.querySelector('.show-list');
								show_listnew.getShowList(freshConatiner.showCity, ul, show_listnew.setShowList);
								setTimeout(function() {
									self.endPullUpToRefresh();
								}, 1500);
							} else {
								self.endPullUpToRefresh();
								mui(".mui-pull-loading")[0].innerHTML = "没有更多了";
							}
						}
					}
				});
			}
			/**
			 * 
			 * @param {Object} callback
			 */
			function getAttendedClasses(callback) {
				if(events.getUtid()) {
					// 等待的对话框
					var wd = events.showWaiting();
					postDataMCPro_getAllFocusCourses({
						userId: events.getUtid(), //用户ID,登录用户
						pageIndex: 1, //当前页数
						pageSize: 1 //每页记录数,传入0，获取总记录数
					}, wd, function(data) {
						wd.close();
						if(data.RspCode == 0 && data.RspData.TotalCnt) {
							callback(true);
						} else {
							callback(false);
						}
					})
				} else {
					if(myStorage.getItem(storageKeyName.SHOWFOCUSEPERSEN) && myStorage.getItem(storageKeyName.SHOWFOCUSEPERSEN).length > 0) {
						callback(true);
					} else {
						callback(false);
					}
				}

			}

			function getFocusedPerson(callback) {
				if(!events.getUtid()) {
					var showFocusedPersen = myStorage.getItem(storageKeyName.SHOWFOCUSEPERSEN);
					if(showFocusedPersen && showFocusedPersen.length > 0) {
						callback(true);
					} else {
						callback(false);
					}
					return;
				}
				var wd = events.showWaiting();
				postDataPro_getFocusByUser({
					userId: events.getUtid()
				}, wd, function(data) {
					wd.close();
					console.log("获取关注的人列表" + JSON.stringify(data));
					if(data.RspCode == 0 && data.RspData.Users.length > 0) {
						callback(true);
					} else {
						callback(false);
					}
				})
			}
			//74.(用户空间）获取多用户空间所有用户动态列表
			function getUsersSpaces(paraModel, callback) {
				//个人信息
				var personal = window.myStorage.getItem(window.storageKeyName.PERSONALINFO);
				//所需参数
				var comData = {
					userId: personal.utid, //用户ID,登录用户
					publisherIds: arrayToStr(paraModel), //发布者ID,例如[1,2,3]
					pageIndex: showCity.pageIndex, //当前页数
					pageSize: 6 //每页记录数
				};
				// 等待的对话框
				var wd1 = events.showWaiting();
				postDataPro_getUserSpacesForAreaByIds(comData, wd1, function(data) {
					wd1.close();
					console.log("展现获取的关注人的动态" + JOSN.stringify(data));
					if(data.RspCode == 0 && data.RspData.Data.length > 0) {
						callback(true);
					} else {
						callback(false);
					}
				});
			}
			/**
			 * 
			 * @param {Object} type 0 删除关注 1 加载关注
			 */
			function toggleAttendedPart(type) {
				console.log("加载关注部分：" + type);
				var sliderGroup = document.querySelector(".mui-slider-group");
				if(type) {
					if(!document.getElementById("show-attended")) {
						sliderGroup.insertBefore(createAttendedFragment(), document.querySelector("#show-all"));
						document.getElementById("show-attended").showCity = {
							pageFlag: 0, //关注
							acode: 1,
							aname: '关注',
							aflag: 1, //0为根据省市编码获取数据，1为获取关注的人的列表
							pageIndex: 1,
							totalPage: 0
						}
						show_listnew.getShowList(document.getElementById("show-attended").showCity, document.getElementById("show-attended").querySelector(".show-list"), show_listnew.setShowList)
						initFresh(document.getElementById("show-attended"));

						setTitle(11);
					}
				} else {
					if(document.getElementById("show-attended")) {

						sliderGroup.removeChild(document.getElementById("show-attended"));
					}
					var slider = mui('#slider').slider();
					slider.gotoItem(0);
					setTitle(0);
				}
			}

			function createAttendedFragment() {
				var div = document.createElement("div");
				div.id = "show-attended";
				div.className = "mui-slider-item mui-control-content"
				div.innerHTML = '<div id="scroll1" class="mui-scroll-wrapper">\
							<div class="mui-scroll">\
								<div class="show-list">\
								</div>\
							</div>\
						</div>';
				return div;
			}
		</script>
	</body>

</html>