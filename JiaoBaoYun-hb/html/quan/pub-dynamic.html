<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/utils/common.css" rel="stylesheet" />
		<link href="../../css/quan/custom-textarea.css" rel="stylesheet" />
		<link href="../../css/iconfont/iconfont.css" rel="stylesheet" />

	</head>

	<body style="background-color: white;">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left " ></a>
			<h1 id="title" class="mui-title"></h1>
			<a id="publish" class="mui-pull-right">发布</a>
		</header>
		<div class="mui-content" >
			<div class="input-content">
				<textarea id="input-content" placeholder="这一刻的想法"></textarea>
				<div id="take_pic" class="take_pic">
					<a class="mui-icon iconfont icon-xiangji1"></a>
				</div>
				<div id="take_camero" class="take_camero">
					<a class="mui-icon iconfont icon-shipin"></a>
				</div>
				<div id="get_gallery" class="get_gallery">
					<a class="mui-icon iconfont icon-tuku"></a>
				</div>
			</div>
			
				<div>
					<p style="margin-left: 10px;font-size: 15px;height: 30px;padding-top: 5px;">发布到:</p>
				</div>
				<div style="margin-left: 10px;">
				<div class="mui-checkbox mui-left mui-disabled" style="width:100; height:30px; float:left; display:inline;margin-left: -20px;">
					<label style="font-size: 15px;">空间</label>
					<input name="checkbox" value="0" type="checkbox" disabled="disabled" style="margin-top: -7px;" checked>
				</div>
				<div class="mui-checkbox mui-left" style="width:100; height:30px; float:left; display:inline; ">
					<label style="font-size: 15px;">展现</label>
					<input id="chenckBox" name="checkbox" value="1" type="checkbox" style="margin-top: -7px;">
				</div>
			</div>

		</div>

	</body>
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/utils/events.js"></script>
	<script src="../../js/utils/camera.js"></script>
	<script src="../../js/utils/files.js"></script>
	<script src="../../js/utils/ASFiles.js"></script>
	<script src="../../js/publicProtocol.js"></script>
	<script src="../../js/utils/CloudFileUtil.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/utils/compress.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/utils/cryption.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/qiniu/qiniu.js" type="text/javascript" charset="utf-8"></script>
	
	<script>
	</script>
	<script type="text/javascript">
		mui.init()
	</script>
	<script>
		var utids = [];
		mui.plusReady(function() {
				var userInfo = window.myStorage.getItem(window.storageKeyName.PERSONALINFO); //用户id

				getGroupList();
				//			var groupInfo;
				//			//界面监听传值
				//			window.addEventListener('postGroupInfo', function(e) {
				//
				//				groupInfo = e.detail.data;
				//				console.log('发布动态页面获取的值：' + JSON.stringify(groupInfo));
				//			});
				var title = document.getElementById('title');
				title.innerText = userInfo.unick;

//				events.addTap('take_pic', function() {
//					mui.toast('此功能暂未开放');
////					camera.getPic(camera.getCamera(), function(path) {
//
////					});
//				});
				events.addTap('take_camero', function() {
					mui.toast('此功能暂未开放');
//					camera.getVideo(camera.getCamera(), function(path) {

//					});
				});
				events.addTap('get_gallery', function() {
					mui.toast('此功能暂未开放');
//					gallery.getMultiplePic(function(paths) {

//					});
				});

				//发布按钮
				events.addTap('publish', function() {
					console.log(333333333)
					var tempInfo = window.myStorage.getItem(window.storageKeyName.PERSONALINFO);
					console.log(tempInfo.uarea.acode)

					var textView = document.getElementById('input-content');
					var tempText = Trim(textView.value);
					console.log('textView.value===' + tempText)
					if(!tempText || tempText == '') {
						mui.toast('请输入内容');
						return;
					} else if(tempText.length > 2000) {
						mui.toast('不能超过2000字');
						return;
					} else {
						tempText = replaceAllBL(tempText)
					}
					var pubScopes;
					var chenckBox = document.getElementById('chenckBox')
					if(!chenckBox.checked) {
						pubScopes = '[1]';
					} else {
						pubScopes = '[1,2]';
					}
					var pubArea;
					if(tempInfo.uarea.acode==undefined){
						pubArea='';
					}else{
						pubArea = tempInfo.uarea.acode
					}
					console.log(tempInfo.uarea.acode);
					var postData = {
						userId: userInfo.utid,
						msgContent: tempText,
						noteType: '2',
						encType: '3',
						encAddr: '',
						encImg: '',
						encIntro: '',
						pubScopes: pubScopes,
						pubArea: pubArea
					}
					for(var z = 0; z < utids.length; z++) {
						console.log(tempInfo.utid);
						console.log(utids[z]);
						if(utids[z] == tempInfo.utid) {
							utids.splice(z, 1);
							break;
						}
					}
					postData.userIds = arrayToStr(utids);
					console.log(JSON.stringify(postData))
					var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
					postDataPro_addUserSpace(postData, wd, function(data) {
						wd.close();
						mui.toast('发布成功！');
						console.log('推送个人空间成功' + JSON.stringify(data));
						textView.value = '';
						events.fireToPageNone('zonep_sub.html', 'refreshZonep');
						mui.back();

					})
				})
			})
			//去除前后空格
		function Trim(str) {
			return str.replace(/(^\s*)|(\s*$)/g, "");
		}
		//获取所有的群
		function getGroupList() {
			var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid; //用户id
			//	//需要参数
			var comData = {
				vtp: 'ag', //要获取的项:cg(创建的群),ug(参与群),mg(协管的群),ag(所有的群)
				vvl: personalUTID, //查询的各项，对应人的utid，可以是查询的任何人
			};
			// 等待的对话框
			var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
			//	获取用户群
			postDataPro_PostGList(comData, wd, function(data) {
				wd.close();
				console.log('获取用户群_PostGList:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
				if(data.RspCode == 0) {
					datasource = data.RspData; //底部列表数据
					var gids = [];
					for(var i = 0; i < datasource.length; i++) {
						gids.push(datasource[i].gid);
					}
					gids = arrayDupRemoval(gids);
					gids = arrayToStr(gids);
					getAllClassMember(gids)
				} else if(data.RspCode == 9) { //没有群
					console.log('显示空白页')

				} else {
					mui.toast(data.RspTxt);
				}
			});

		}

		function getAllClassMember(gids) {
			var gidStr = gids.replace('[', '');
			gidStr = gidStr.replace(']', '');

			//需要参数
			var comData = {
				top: '-1', //选择条数
				vvl: gidStr, //群ID，查询的值
				vvl1: '-1', //群员类型，0家长,1管理员,2老师,3学生,-1取全部

			};
			var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
			// 通过群ID获取群的正常用户
			postDataPro_PostGusers(comData, wd, function(data) {
				wd.close();
				console.log('通过群ID获取群的正常用户_PostGusers:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
				if(data.RspCode == 0) {
					var userList = data.RspData;
					for(var i = 0; i < data.RspData.length; i++) {
						utids.push(data.RspData[i].utid);
					}
					utids = arrayDupRemoval(utids);
				} else {
					mui.toast(data.RspTxt);
				}
			});

		}
		
		/**
	 * 通过系统相机获取图片
	 * 并显示在界面上
	 */
	events.addTap('take_pic', function() {
		camera.getPic(camera.getCamera(), function(picPath) {
			plus.nativeUI.showWaiting(storageKeyName.WAITING);
			var MainSpace = storageKeyName.QNPUBSPACE;
			var saveSpace;
			var thumbSpace;
			saveSpace = storageKeyName.PERSONALSPACE;
			thumbSpace = storageKeyName.PERSONALSPACETHUMB;
			var QNFileName = events.getFileNameByPath(picPath);
			var thumbBase64=Qiniu.URLSafeBase64Encode(MainSpace + ":" + thumbSpace + QNFileName);
			var ops = "imageView2/2/w/200/h/200/format/png|saveas/" +thumbBase64;
			var param = {
				Bucket: MainSpace,
				Key: saveSpace + QNFileName,
				Pops: ops,
				NotifyUrl: ''
			}
			console.log("参数数据：" + JSON.stringify(param))
			var key = 'jxq789!@';
			var data = {
				AppID: "6",
				Param: encryptByDES(key, JSON.stringify(param))
			}
			console.log("加密后的信息：" + encryptByDES(key, JSON.stringify(param)));
			var img;
			CloudFileUtil.getQNUpTokenWithManage(storageKeyName.QNGETUPLOADTOKEN, data, function(datas) {
				console.log("获取的数据：" + JSON.stringify(datas));
				if(datas.Status == 1) {
					var tokenInfo = datas.Data;
					//压缩照片
					compress.compressPIC(picPath, function(event) {
						CloudFileUtil.uploadFile(tokenInfo.Key, event.target, tokenInfo.Token, function(uploadData, status) {
							console.log(JSON.stringify(uploadData));
							img={
								url:tokenInfo.Domain+tokenInfo.Key,
								thumb:tokenInfo.OtherKey[thumbBase64],
								type:1
							}
							plus.nativeUI.closeWaiting();
							setPic(img);
						});
					})

				}
			}, function(xhr, type, errorThrown) {
				console.log("错误类型：" + type + errorThrown);
				plus.nativeUI.closeWaiting();
			});
		})
	});
	</script>

</html>