<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/utils/common.css" rel="stylesheet" />
		<link href="../../css/quan/custom-textarea.css" rel="stylesheet" />
		<link href="../../css/iconfont/iconfont.css" rel="stylesheet" />
		<link href="../../css/homework/publish-answer.css" rel="stylesheet" />
		<style type="text/css">
			.mui-checkbox input[type=checkbox]:checked:before,
			.mui-radio input[type=radio]:checked:before {
				color: #1db8f1
			}
		</style>
	</head>

	<body style="background-color: white;">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left "></a>
			<h1 id="title" class="mui-title"></h1>
			<a id="publish" class="mui-icon mui-pull-right mui-plus-visible" style="padding-left: 30px;padding-top: 15px;font-size: 16px;">发布</a>
		</header>
		<div class=" mui-content">
			<div class="input-content">
				<textarea id="input-content" placeholder="这一刻的想法" style="border-bottom-color: #e4e4e4;"></textarea>
				<div id="take_pic" class="take_pic">
					<a class="mui-icon iconfont icon-xiangji1"></a>
				</div>
				
				<div id="get_gallery" class="get_gallery">
					<a class="mui-icon iconfont icon-tuku"></a>
				</div>
				<div id="get_record" class="get_record">
					<a class="mui-icon iconfont icon-yuyin3"></a>
				</div>
				<div id="take_camero" class="take_camero">
					<a class="mui-icon iconfont icon-shipin"></a>
				</div>
			</div>

			<div>
				<p style="margin-left: 10px;font-size: 15px;height: 30px;padding-top: 5px; background-color: #f2f3f5;">发布到:</p>
			</div>
			<div style="margin-left: 10px;">
				<div id="zoneiv" class="mui-checkbox mui-left mui-disabled" style="width:100; height:30px; float:left; display:inline;margin-left: -20px;">
					<label style="font-size: 15px;">空间</label>
					<input id="zone" name="checkbox" value="0" type="checkbox" disabled="disabled" style="margin-top: -7px;" checked>
				</div>
				<div id="showDiv" class="mui-checkbox mui-left" style="width:100; height:30px; float:left; display:inline; ">
					<label style="font-size: 15px;">展现</label>
					<input id="show" name="checkbox" value="1" type="checkbox" style="margin-top: -7px;" checked>
				</div>
			</div>
			<div id="pictures" style="float: left;background-color: transparent;width: 320px;"></div>
		</div>

	</body>
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/utils/events.js"></script>
	<script src="../../js/utils/camera.js"></script>
	<script src="../../js/utils/files.js"></script>
	<script src="../../js/utils/ASFiles.js"></script>
	<script src="../../js/publicProtocol.js"></script>
	<script src="../../js/utils/CloudFileUtil.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/utils/compress.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/utils/cryption.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/qiniu/qiniu.js" type="text/javascript" charset="utf-8"></script>

	<script>
	</script>
	<script type="text/javascript">
		mui.init()
	</script>
	<script>
		var utids = [];
		var pageFlag;;
		mui.plusReady(function() {
	
			pageFlag = plus.webview.currentWebview().data
			var userInfo = window.myStorage.getItem(window.storageKeyName.PERSONALINFO); //用户id

			getGroupList();
			//			var groupInfo;
			//			//界面监听传值
			//			window.addEventListener('postGroupInfo', function(e) {
			//
			//				groupInfo = e.detail.data;
			//				console.log('发布动态页面获取的值：' + JSON.stringify(groupInfo));
			//			});
			var title = document.getElementById('title');
			title.innerText = userInfo.unick;
			if(pageFlag == 'jxq') {
				console.log('jxq')
				//				document.getElementById("show").checked = false;
			} else {
				console.log('zx')
				//				document.getElementById("show").checked = true;
			}

			//				events.addTap('take_pic', function() {
			//					mui.toast('此功能暂未开放');
			////					camera.getPic(camera.getCamera(), function(path) {
			//
			////					});
			//				});
			CloudFileUtil.setDelPicListener();
						//录音按钮
			events.addTap('get_record', function() {
				mui.toast('功能暂未开放！');
			});

			events.addTap('take_camero', function() {
				mui.toast('此功能暂未开放');
				//					camera.getVideo(camera.getCamera(), function(path) {1

				//					});
			});
			events.addTap('get_gallery', function() {
				if(CloudFileUtil.files.length < 9) {
					var picCount = 0; //上传图片计数
					gallery.getMultiplePic(9 - CloudFileUtil.files.length, function(paths) { //回调函数
						plus.nativeUI.showWaiting(storageKeyName.UPLOADING); //等待框
						console.log("保存的路径：" + JSON.stringify(paths));
						var saveSpace = storageKeyName.PERSONALSPACE; //保存路径
						compress.compressPics(paths, function(compressedPaths) {
							console.log('获取的图片路径：' + JSON.stringify(compressedPaths));
							var data = CloudFileUtil.getMultipleUploadDataOptions(compressedPaths, 6, 200, 0, saveSpace); //获取获取token的各参数
							CloudFileUtil.getQNUpTokenWithManage(storageKeyName.QNGETUPLOADTOKEN, data.options, function(datas) {
									console.log("传回来的值：" + JSON.stringify(datas)) //回调数据
									if(datas.Status == 1) { //成功
										var tokenInfos = datas.Data; //参数信息
										//上传图片
										CloudFileUtil.uploadFiles(compressedPaths, tokenInfos, function(uploadData, status) {
											console.log(JSON.stringify(uploadData));
											var img = {
												url: tokenInfos[0].Domain + JSON.parse(uploadData.responseText).key,
												thumb: (tokenInfos[0].Domain + JSON.parse(uploadData.responseText).key).replace(saveSpace, saveSpace + "thumb/"),
												type: 1
											}
											picCount++;
											CloudFileUtil.setPic(img); //放置图片
											if(picCount == compressedPaths.length) { //所有图片已上传
												plus.nativeUI.closeWaiting(); //关闭等待框
											}
										});

									}
								},
								//错误的回调
								function(xhr, type, errorThrown) {
									console.log("错误类型：" + type + errorThrown);
									plus.nativeUI.closeWaiting();
								});
						});

					});
				} else {
					mui.toast('上传图片附件不得多于9张！');
				}

			});

			//发布按钮
			events.addTap('publish', function() {

				var tempInfo = window.myStorage.getItem(window.storageKeyName.PERSONALINFO);
				console.log(tempInfo.uarea.acode)

				var textView = document.getElementById('input-content');
				var tempText = Trim(textView.value);
				console.log('textView.value===' + tempText)
				if(!tempText || tempText == '') {
					mui.toast('请输入内容');
					return;
				} else if(tempText.length > 2000) {
					mui.toast('不能超过2000字');
					return;
				} else {
					tempText = replaceAllBL(tempText)
				}
				var pubScopes;
				var chenckBox1 = document.getElementById('zone')
				var chenckBox2 = document.getElementById('show')
				if(chenckBox1.checked && chenckBox2.checked) {
					pubScopes = '[1,2]';
				} else if(!chenckBox1.checked && chenckBox2.checked) {
					pubScopes = '[2]';
				} else {
					pubScopes = '[1]';
				}
				//				if(!chenckBox.checked) {
				//					pubScopes = '[1]';
				//				} else {
				//					pubScopes = '[1,2]';
				//				}
				var pubArea;
				var TAs = getTypeAddress();
				if(tempInfo.uarea.acode == undefined) {
					pubArea = '';
				} else {
					pubArea = tempInfo.uarea.acode
				}

				var postData = {
					userId: userInfo.utid,
					msgContent: tempText,
					noteType: '2',
					encType: TAs.encType,
					encAddr: TAs.encAddr,
					encImg: TAs.encImg,
					encIntro: '',
					pubScopes: pubScopes,
					pubArea: pubArea
				}
				for(var z = 0; z < utids.length; z++) {
					console.log(tempInfo.utid);
					console.log(utids[z]);
					if(utids[z] == tempInfo.utid) {
						utids.splice(z, 1);
						break;
					}
				}
				postData.userIds = arrayToStr(utids);
				console.log(JSON.stringify(postData))
				var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
				postDataPro_addUserSpace(postData, wd, function(data) {
					wd.close();
					mui.toast('发布成功！');
					console.log('推送个人空间成功' + JSON.stringify(data));
					textView.value = '';
					if(pageFlag == 'jxq') {
						events.fireToPageNone('zonep_sub.html', 'refreshZonep');
					} else {
						events.fireToPageNone('../show/show_home_1.html', 'infoChanged');
					}

					mui.back();

				})
			})
		})
		//去除前后空格
		function Trim(str) {
			return str.replace(/(^\s*)|(\s*$)/g, "");
		}
		//获取所有的群
		function getGroupList() {
			var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid; //用户id
			//	//需要参数
			var comData = {
				vtp: 'ag', //要获取的项:cg(创建的群),ug(参与群),mg(协管的群),ag(所有的群)
				vvl: personalUTID, //查询的各项，对应人的utid，可以是查询的任何人
			};
			// 等待的对话框
			var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
			//	获取用户群
			postDataPro_PostGList(comData, wd, function(data) {
				wd.close();
				console.log('获取用户群_PostGList:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
				if(data.RspCode == 0) {
					datasource = data.RspData; //底部列表数据
					var gids = [];
					for(var i = 0; i < datasource.length; i++) {
						gids.push(datasource[i].gid);
					}
					gids = arrayDupRemoval(gids);
					gids = arrayToStr(gids);
					getAllClassMember(gids)
				} else if(data.RspCode == 9) { //没有群
					console.log('显示空白页')

				} else {
					mui.toast(data.RspTxt);
				}
			});

		}

		function getAllClassMember(gids) {
			var gidStr = gids.replace('[', '');
			gidStr = gidStr.replace(']', '');

			//需要参数
			var comData = {
				top: '-1', //选择条数
				vvl: gidStr, //群ID，查询的值
				vvl1: '-1', //群员类型，0家长,1管理员,2老师,3学生,-1取全部

			};
			var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
			// 通过群ID获取群的正常用户
			postDataPro_PostGusers(comData, wd, function(data) {
				wd.close();
				console.log('通过群ID获取群的正常用户_PostGusers:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
				if(data.RspCode == 0) {
					var userList = data.RspData;
					for(var i = 0; i < data.RspData.length; i++) {
						utids.push(data.RspData[i].utid);
					}
					utids = arrayDupRemoval(utids);
				} else {
					mui.toast(data.RspTxt);
				}
			});

		}

		/**
		 * 通过系统相机获取图片
		 * 并显示在界面上
		 */
		events.addTap('take_pic', function() {
			if(CloudFileUtil.files.length < 9) {
				camera.getPic(camera.getCamera(), function(picPath) {
					plus.nativeUI.showWaiting(storageKeyName.WAITING);
					var saveSpace = storageKeyName.PERSONALSPACE; //保存空间
					var data = CloudFileUtil.getSingleUploadDataOptions(picPath, 6, 200, 0, saveSpace);
					CloudFileUtil.getQNUpTokenWithManage(storageKeyName.QNGETUPLOADTOKEN, data.options, function(datas) {
						console.log("获取的数据：" + JSON.stringify(datas));
						if(datas.Status == 1) {
							var tokenInfo = datas.Data;
							//压缩照片
							compress.compressPIC(picPath, function(event) {
								//上传文件
								CloudFileUtil.uploadFile(tokenInfo, event.target, function(uploadData, status) {
									console.log(JSON.stringify(uploadData));
									var img = { //图片信息
										url: tokenInfo.Domain + tokenInfo.Key,
										thumb: tokenInfo.OtherKey[data.thumbKey],
										type: 1
									}
									//关闭等待框
									plus.nativeUI.closeWaiting();
									//放置图片
									CloudFileUtil.setPic(img);
								});
							})

						}
					}, function(xhr, type, errorThrown) {
						console.log("错误类型：" + type + errorThrown);
						plus.nativeUI.closeWaiting(); //关闭等待框
					});
				})
			} else {
				mui.toast('上传图片附件不得多于9张！');
			}
		});
		var imgs = [];

		//删除图标的点击事件
		//		mui('#pictures').on('tap', '.icon-guanbi', function() {
		//			imgs.splice(imgs.indexOf(this.parentElement.img), 1);
		//			//删除图片111
		//			pictures.removeChild(this.parentElement);
		//		})
		/**
		 * 获取接口数据文件及缩略图
		 * encType: '',//附件类型,1图片2音视频3仅文字
		 * encAddr: '',//附件地址
		 * encImg: '',//附件缩略图地址
		 */
		var getTypeAddress = function() {
			var TAs = {};
			var encType;
			var encAddrs = [];
			var encImgs = [];
			var theFile;
			if(CloudFileUtil.files.length > 0) { //如果存在附件
				for(var i in CloudFileUtil.files) {
					theFile = CloudFileUtil.files[i];
					if(i == 0) {
						TAs.encType = theFile.type;
					}
					encAddrs.push(theFile.url);
					encImgs.push(theFile.thumb);
				}
				console.log(JSON.stringify(encAddrs));
				console.log(JSON.stringify(encImgs));
				TAs.encAddr = encAddrs.join('|');
				TAs.encImg = encImgs.join('|');
			} else { //不存在附件
				TAs.encType = 0;
				TAs.encAddr = '';
				TAs.encImg = '';
			}
			return TAs;
		}
	</script>

</html>