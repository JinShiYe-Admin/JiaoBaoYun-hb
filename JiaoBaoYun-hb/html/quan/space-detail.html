<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>空间</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<link rel="stylesheet" type="text/css" href="../../css/icons-extra.css" />
		<link rel="stylesheet" href="../../css/iconfont/iconfont.css" />
		<link rel="stylesheet" href="../../css/show/show.css" />
		<link href="../../css/utils/preview.css" rel="stylesheet" />
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/utils/events.js"></script>
		<script type="text/javascript" src="../../js/publicProtocol.js"></script>
		<script type="text/javascript" src="../../js/utils/native.js"></script>
		<script type="text/javascript" src="../../js/mui.lazyload.js"></script>
		<script type="text/javascript" src="../../js/mui.lazyload.img.js"></script>
		<script src="../../js/mui.zoom.js"></script>
		<script src="../../js/mui.previewimage.js"></script>
		<script type="text/javascript" src="../../js/quan/dynamiclistitem.js"></script>

	</head>
	<header class="mui-bar mui-bar-nav">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		<h1 id="spaceDetail" class="mui-title">空间详情</h1>
	</header>

	<body>
		<!--下拉刷新容器-->
		<div class="mui-content mui-scroll-wrapper">
			<div class="mui-scroll">
				<!--数据列表-->
				<ul class="mui-table-view">

				</ul>
			</div>

		</div>

	</body>

	<script>
		var sliderId = 'top_';
		idFlag = '';
		var datasource = {}; //此界面的数据
		var preModel = {}; //上个界面传过来的数据
		zonepArray = [];
		var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid; //用户id
		var personalunick = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).unick; //用户昵称
		var publisherId;
		mui.init({

		});
		mui('.mui-scroll-wrapper').scroll();
		var SCREEN_WIDTH;
		mui.plusReady(function() {
			SCREEN_WIDTH = plus.screen.resolutionWidth;
			preModel = plus.webview.currentWebview().data

			publisherId = preModel.publisherId
			console.log('上个界面传过来的值' + JSON.stringify(preModel));
			mui.previewImage();

			var comData = {
				userId: personalUTID, //用户ID
				userSpaceId: preModel.TabId, //发布用户ID
				pageIndex: '1', //当前页数
				pageSize: '1000' //每页记录数
			};
			requestData(comData);
			window.addEventListener('refreshZonep', function(data) {
				requestData(comData)
			})
			dynamiclistitem.addSomeEvent();

		});
		//请求数据
		function requestData(comData) {

			// 等待的对话框
			var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);

			//82.（用户空间）获取用户针对某条空间详情
			postDataPro_getUserSpaceByUser(comData, wd, function(data) {
				wd.close();
				console.log('获取用户针对某条空间详情_getUserSpaceByUser:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
				if(data.RspCode == 0) {
					var tempRspData = data.RspData.Data;
					var tempArray = [];
					//当前循环的model
					var tempModel0 = tempRspData;
					//将当前model中id塞到数组
					tempArray.push(tempModel0.PublisherId);
					//合并数组,点赞的人
					//					tempArray = tempArray.concat(tempModel0.LikeUsers);
					for(var i in tempModel0.LikeUsers) {
						tempArray = tempArray.concat(tempModel0.LikeUsers[i].userId);
						//								tempModel0.LikeUsers = arrayDupRemoval(tempModel0.LikeUsers);
					}
					//					tempModel0.LikeUsers = arrayDupRemoval(tempModel0.LikeUsers);
					//循环当前model中的回复数组
					for(var item1 in tempModel0.Comments) {
						//回复中的model
						var tempModel1 = tempModel0.Comments[item1];
						//将回复中的id塞到数组
						tempArray.push(tempModel1.UserId);
						tempArray.push(tempModel1.ReplyId);
						//
						for(var item2 in tempModel1.Replys) {
							//回复中的model
							var tempModel2 = tempModel1.Replys[item2];
							//将回复中的id塞到数组
							tempArray.push(tempModel2.UserId);
							tempArray.push(tempModel2.ReplyId);
						}
					}

					//给数组去重
					tempArray = arrayDupRemoval(tempArray);
					//发送获取用户资料申请
					var tempData = {
						vvl: tempArray.join(), //用户id，查询的值,p传个人ID,g传ID串
						vtp: 'g' //查询类型,p(个人)g(id串)
					}

					//21.通过用户ID获取用户资料
					postDataPro_PostUinf(tempData, wd, function(data1) {
						wd.close();
						console.log('获取个人资料success:RspCode:' + data1.RspCode + ',RspData:' + JSON.stringify(data1.RspData) + ',RspTxt:' + data1.RspTxt);
						if(data1.RspCode == 0) {
							//循环当前的个人信息返回值数组
							for(var i in data1.RspData) {
								//当前model
								var tempModel = data1.RspData[i];
								//循环留言数组
								//当前循环的model
								var tempModel0 = tempRspData;
								//遍历点赞的人
								for(var item2 in tempModel0.LikeUsers) {
									//										console.log('item2;;;;;==' + tempModel.utid + ',' + tempModel0.LikeUsers[item2]);
									if(tempModel.utid == tempModel0.LikeUsers[item2].userId) {
										//												tempModel0.LikeUsers.splice(item2, 1, tempModel);
										tempModel0.LikeUsers[item2] = $.extend(tempModel0.LikeUsers[item2], tempModel);
									}
								}
								//对比id是否一致
								if(tempModel0.PublisherId == tempModel.utid) {
									//合并
									tempModel0 = $.extend(tempModel0, tempModel);
								}
								//循环当前model中的回复数组
								for(var item1 in tempModel0.Comments) {
									//回复中的model
									var tempModel1 = tempModel0.Comments[item1];
									//对比id是否一致
									if(tempModel.utid == tempModel1.UserId) {
										//添加参数
										tempModel1.UserIdName = tempModel.unick;
									}
									if(tempModel.utid == tempModel1.ReplyId) {
										//添加参数
										tempModel1.ReplyIdName = tempModel.unick;
									}
									//
									for(var item2 in tempModel1.Replys) {
										//回复中的model
										var tempModel2 = tempModel1.Replys[item2];
										//对比id是否一致
										if(tempModel.utid == tempModel2.UserId) {
											//添加参数
											tempModel2.UserIdName = tempModel.unick;
										}
										if(tempModel.utid == tempModel2.ReplyId) {
											//添加参数
											tempModel2.ReplyIdName = tempModel.unick;
										}
									}
								}

							}
							console.log('循环遍历后的值：' + JSON.stringify(tempRspData));
							datasource = tempRspData
							zonepArray.push(datasource);
							setSpaceDetail(datasource);

						} else {
							mui.toast(data.RspTxt);
						}
					});

				}
			})
		}

		function setSpaceDetail(data) {

			var table = document.body.querySelector('.mui-table-view');
			table.innerHTML = '';
			if(preModel.focusFlag == 0) {
				idFlag = '';
				data.focusFlag = 0;
				data.pageFlag = 0
				data.cityCode = '';
				data.idFlag = '';
				sliderId = 'top_'

			} else {
				idFlag = 'zx';
				data.pageFlag = 1
				data.cityCode = 0;
				data.idFlag = 'zx';
				sliderId = 'top_0'
			}
			data.IsFocused = 1;
			data.id = 0;
			data.id_name = data.cityCode + data.idFlag + data.id;
			var tempModel = dynamiclistitem.addData(data);
			dynamiclistitem.addItem(table, tempModel);

		}

		//设置个人空间动态为已读
		function setUserSpaceReadByUser(upString) {

			if(personalUTID == publisherId) {
				var comData = {
					userId: personalUTID, //用户ID
					spaceTypes: '[4,5,6]'
				}
				var wd;
				postDataPro_setCommentMsgReadByUser(comData, wd, function(data) {
					console.log('与我相关设置成已读success:RspCode:' + JSON.stringify(data));
				})
			}

			var NoReadCnt = plus.webview.currentWebview().data.NoReadCnt //未读条数
			//			if(NoReadCnt != 0) { //如果未读条数不为0，则设置空间状态为已读
			var comData = {
				userId: personalUTID, //用户ID
				publisherIds: upString
			};

			var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
			postDataPro_setUserSpaceReadByUser(comData, wd, function(data) {
				wd.close();
				console.log('设置空间状态为已读_setUserSpaceReadByUser' + JSON.stringify(data));
				if(data.RspCode == 0) {
					//获得主页面的webview
					var main = plus.webview.getWebviewById('../quan/tab-zone.html');
					//触发tab-zone页面的setRead事件
					mui.fire(main, 'setRead', {
						flag: 3
					});

				}

			})
		}

		/**
		 * 下拉刷新具体业务实现
		 */
		function pulldownRefresh() {
			setTimeout(function() {
				var comData = {
					userId: preModel.PublisherId, //用户ID
					userSpaceId: preModel.TabId, //发布用户ID
					pageIndex: '1', //当前页数
					pageSize: '100' //每页记录数
				};
				//请求数据
				requestData(comData);
				mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //refresh completed
			}, 1500);
		}

		/**
		 * 上拉加载具体业务实现
		 */
		function pullupRefresh() {}
	</script>

</html>