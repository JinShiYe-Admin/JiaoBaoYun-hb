<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/utils/common.css" rel="stylesheet" />
		<link href="../../css/iconfont/iconfont.css" rel="stylesheet" />
		<link href="../../css/qiuzhi/qiuzhi-inviteAnswer.css" rel="stylesheet" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">留言板</h1>
		</header>
		<div id="refreshContainer" class="mui-content mui-fullscreen" style="z-index:0">
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<ul id="list-container" class="mui-table-view">

					</ul>
				</div>
			</div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/mui.pullToRefresh.js"></script>
		<script src="../../js/mui.pullToRefresh.material.js"></script>
		<script src="../../js/utils/events.js"></script>
		<script src="../../js/publicProtocol.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/storageKeyName.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			var userID; //传值过来的个人ID
			var pageIndex = 1; //请求数据页面
			var totalPageCount; //总页码
			var flagRef = 0; //是刷新0，还是加载更多1
			var leaveArray = []; //留言总数组
			var personalUTID;//账号id
			mui.init();

			mui.plusReady(function() {
				personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid; //当前登录账号utid
				//赋值
				userID = plus.webview.currentWebview().data;
				console.log('传值过来的个人信息：' + userID);
				//清除节点
				document.getElementById('list-container').innerHTML = "";
				//24.获取某个用户的回答列表
				getUserSpaceMsgsById(userID);

				//上拉下拉注册
				mui(".mui-scroll-wrapper .mui-scroll").pullToRefresh({
					down: {
						callback: function() {
							//清除节点
//							document.getElementById('list-container').innerHTML = "";
							var self = this;
							flagRef = 1;
							if(pageIndex <= totalPageCount) {
								//24.获取某个用户的回答列表
								getUserSpaceMsgsById(userID);
							} else {
								mui.toast('没有更多了');
							}
							self.endPullDownToRefresh();
						}
					},
//					up: {
//						callback: function() {
//							var self = this;
//							console.log("上拉加载更多");
//							flagRef = 1;
//							if(pageIndex <= totalPageCount) {
//								//24.获取某个用户的回答列表
//								getUserSpaceMsgsById(userID);
//							} else {
//								mui.toast('没有更多了');
//							}
//							self.endPullUpToRefresh();
//						}
//					}
				});

			});

			//49.（用户空间）获取用户空间所有留言
			function getUserSpaceMsgsById(userId) {
				var comData = {
					userId: userId, //留言板拥有者id
					pageIndex: pageIndex, //当前页数
					pageSize: '10' //每页记录数
				};
				// 等待的对话框
				var wd = events.showWaiting();
				//49.（用户空间）获取用户空间所有留言，model_userSpaceInfo
				postDataPro_getUserSpaceMsgsById(comData, wd, function(data) {
					wd.close();
					console.log('49、空间所有留言:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt + data.RspData.TotalCnt);
					if(data.RspCode == 0) {
						//总页数
						totalPageCount = data.RspData.TotalPage;
						pageIndex++;
						if(personalUTID == userID) {
							var comData = {
								userId: personalUTID, //用户ID
								spaceTypes: '[7,8]'
							}
							postDataPro_setCommentMsgReadByUser(comData, wd, function(data) {
								console.log('59与我相关设置成已读:' + JSON.stringify(data));
							})
						}
						var tempRspData = data.RspData.Data;
						//获取当前回调留言的个人信息，主要是头像、昵称
						var tempArray = [];
						//先遍历回调数组，获取
						for(var item in tempRspData) {
							//当前循环的model
							var tempModel0 = tempRspData[item];
							//将当前model中id塞到数组
							tempArray.push(tempModel0.UserId);
						}
						//给数组去重
						tempArray = arrayDupRemoval(tempArray);
						//发送获取用户资料申请
						var tempData = {
							vvl: tempArray.join(), //用户id，查询的值,p传个人ID,g传ID串
							vtp: 'g' //查询类型,p(个人)g(id串)
						}
						console.log('tempData:' + JSON.stringify(tempData));
						//21.通过用户ID获取用户资料
						postDataPro_PostUinf(tempData, wd, function(data1) {
							wd.close();
							console.log('21、获取个人资料:' + data1.RspCode + ',RspData:' + JSON.stringify(data1.RspData) + ',RspTxt:' + data1.RspTxt);
							if(data1.RspCode == 0) {
								//循环当前的个人信息返回值数组
								for(var i in data1.RspData) {
									//当前model
									var tempModel = data1.RspData[i];
									//更新头像
									tempModel.uimg = updateHeadImg(tempModel.uimg, 2);
									//循环留言数组
									for(var item in tempRspData) {
										//当前循环的model
										var tempModel0 = tempRspData[item];
										//对比id是否一致
										if(tempModel0.UserId == tempModel.utid) {
											//合并
											tempModel0 = $.extend(tempModel0, tempModel);
										}
									}
								}
							}
							console.log('循环遍历后的值：' + JSON.stringify(tempRspData));
							if(flagRef == 0) { //刷新
								leaveArray = tempRspData;
							} else { //加载更多
								//合并数组
//								Array.prototype.push.apply(tempRspData, leaveArray);
								leaveArray = tempRspData.concat(leaveArray);
							}
							console.log('合并后的值为：' + JSON.stringify(leaveArray));
							setAnswerRecord(tempRspData);
						});

					} else {
						mui.toast(data.RspTxt);
					}
				});
			};

			/**
			 * 放置邀请回答记录数据
			 * @param {Object} list 回答记录数据
			 */
			var setAnswerRecord = function(list) {
				var listContainer = document.getElementById('list-container');
				for(var i in list) {
					createList(listContainer, list[i])
				}
			}
			/**
			 * 拼接回答记录
			 * @param {Object} listContainer
			 * @param {Object} record
			 */
			var createList = function(listContainer, record) {
				var li = document.createElement('li');
				li.className = 'mui-table-view-cell';
				//拼接显示
				li.innerHTML = "<div><p><span>" + record.MsgContent + "</span></p></div>";
				listContainer.appendChild(li);
			}
		</script>
	</body>

</html>