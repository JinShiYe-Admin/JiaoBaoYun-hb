<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>与我相关</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/utils/events.js"></script>
		<script type="text/javascript" src="../../js/publicProtocol.js"></script>

		<style>
			.mui-table-view {
				background: transparent;
				/*背景色透明*/
			}
			
			.mui-table-view-cell {
				background: white;
				/*cell 背景设为白色*/
				padding: 0;
				/*内边距为0*/
				margin-bottom: 10px;
			}
			
			.mui-table-view:before,
			.mui-table-view:after,
			.mui-table-view-cell:after {
				height: 0px;
				/*去掉横线*/
			}
			
			.dynamic-personal-image {
				/*个人头像圆形*/
				border-radius: 50%;
				width: 50px;
				height: 50px;
			}
			
			.dynamic-padding-left-10px {
				padding-left: 10px;
			}
			
			.dynamic-praise-name,
			.dynamic-comment-name {
				/*点赞者和评论者的名字*/
				color: #1277C7;
			}
		</style>
	</head>

	<body>
		<!--下拉刷新容器-->
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
			<div class="mui-scroll">
				<div style="height: 120px;;background-image:url(../../image/quan/leave-bg.png) ;"><br/><br/>
					<h4 id="leaveTitle" style="text-align: center;">主人寄语:雁过留声，人过留名！！</h1>
					
				</div>
				<div id="leaveNum" style="background-color: gainsboro;height: 30px;padding: 5px;font-size: 15px;">
				</div>
				<!--数据列表-->
				<ul id="leaveList" class="mui-table-view">

			</ul>
		</div>
		</div>
	</body>
	<script>
		mui.init({
			pullRefresh: {
				container: '#pullrefresh',
				down: {
					callback: pulldownRefresh
				},
				up: {
					contentrefresh: '正在加载...',
					callback: pullupRefresh
				}
			}
		});
		var userId;
		mui.plusReady(function() {
			userId = plus.webview.currentWebview().data;
				var comData = {
					userId: userId, //用户ID
					pageIndex: (tempPage).toString(), //当前页数
					pageSize: '10' //每页记录数
				};
				//请求数据
				requestData(comData);
				
			})
			/**
			 * 下拉刷新具体业务实现
			 */
		function pulldownRefresh() {
			setTimeout(function() {
				//刷新时将页码归1
				totalCnt = 0;
				flag = 1;
				var comData = {
					userId: userId, //用户ID
					pageIndex: (1).toString(), //当前页数
					pageSize: '10' //每页记录数
				};
				//请求数据
				requestData(comData);
				mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //refresh completed
			}, 1500);

		}
		var count = 0;
		/**
		 * 上拉加载具体业务实现
		 */
		function pullupRefresh() {
			setTimeout(function() {
				flag = 2;
				mui('#pullrefresh').pullRefresh().endPullupToRefresh((++count > 2)); //参数为true代表没有更多数据了。
				if(tempPage * 10 > totalCnt || tempPage * 10 == totalCnt) {
					mui.toast('没有更多了...');
				} else {
					tempPage++;
					var comData = {
						userId: userId, //用户ID
						pageIndex: (tempPage).toString(), //当前页数
						pageSize: '10' //每页记录数
					};
					//请求数据
					requestData(comData);
				}
			}, 1500);

		}
		
		
		//页码，请求第几页数据
		var tempPage = 1;
		//当前留言的总条数
		var totalCnt = 0;
		//判断是加载更多2，还是刷新1
		var flag = 1;
		//页码请求到要显示的数据，array[model_userSpaceInfo]
		var leaveArray = [];
		//请求数据
		function requestData(comData) {
			// 等待的对话框
			var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
			//49.（用户空间）获取用户空间所有留言，model_userSpaceInfo
			postDataPro_getUserSpaceMsgsById(comData, wd, function(data) {
				wd.close();
				console.log('postDataPro_getUserSpaceMsgsById:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt+data.RspData.TotalCnt);
				if(data.RspCode == 0) {
					var tempRspData = data.RspData.Data;
					//获取当前回调留言的个人信息，主要是头像、昵称
					var tempArray = [];
					//先遍历回调数组，获取
					for (var item in tempRspData) {
						//当前循环的model
						var tempModel0 = tempRspData[item];
						//将当前model中id塞到数组
						tempArray.push(tempModel0.UserId);
						//循环当前model中的回复数组
						for (var item1 in tempModel0.Replys) {
							//回复中的model
							var tempModel1 = tempModel0.Replys[item1];
							//将回复中的id塞到数组
							tempArray.push(tempModel1.UserId);
						}
					}
					//给数组去重
					tempArray = arrayDupRemoval(tempArray);
					//发送获取用户资料申请
					var tempData = {
						vvl:tempArray.join(),//用户id，查询的值,p传个人ID,g传ID串
						vtp:'g'//查询类型,p(个人)g(id串)
					}
					console.log('tempData:'+JSON.stringify(tempData));
					//21.通过用户ID获取用户资料
					postDataPro_PostUinf(tempData, wd, function(data1) {
						wd.close();
						console.log('获取个人资料success:RspCode:' + data1.RspCode + ',RspData:' + JSON.stringify(data1.RspData) + ',RspTxt:' + data1.RspTxt);
						if(data1.RspCode == 0) {

							//循环当前的个人信息返回值数组
							for (var i in data1.RspData) {
								//当前model
								var tempModel = data1.RspData[i];
								//判断img是否为null，或者空
								if (tempModel.uimg==''||tempModel.uimg==null) {//赋值
									tempModel.uimg = '../image/utils/default_personalimage.png';
								}else{//修改值
									var myDate = new Date();
									tempModel.uimg = tempModel.uimg + '?' + myDate.getTime();
								}
								//循环留言数组
								for (var item in tempRspData) {
									//当前循环的model
									var tempModel0 = tempRspData[item];
									//对比id是否一致
									if (tempModel0.utid == tempModel.UserId) {
										//合并
										tempModel0 = $.extend(tempModel0, tempModel);
									}
									//循环当前model中的回复数组
									for (var item1 in tempModel0.Replys) {
										//回复中的model
										var tempModel1 = tempModel0.Replys[item1];
										//对比id是否一致
										if (tempModel.utid == tempModel1.UserId) {
											//合并
											tempModel1 = $.extend(tempModel1, tempModel);
										}
									}
								}
							}
						}
						console.log('循环遍历后的值：'+JSON.stringify(tempRspData));
						//判断是加载更多2，还是刷新1
					if(flag == 1) {
						tempPage = 1;
						leaveArray = tempRspData;
					} else {
						//合并数组
						leaveArray = leaveArray.concat(tempRspData);
					}
					//留言总条数
					totalCnt = data.RspData.TotalCnt;
					var leaveNum = document.getElementById("leaveNum");
					leaveNum.innerHTML = '留言('+data.RspData.TotalCnt+')';
					refreshUI();
					});
					
				} else {
					mui.toast(data.RspTxt);
				}
			});
		}
//				"TabId": 6,
//              "MsgContent": "我也谢谢",
//              "ReplyId": 3,
//              "UserId": 1,
//              "UpperId": 4,
//              "MsgDate": "2016-11-22 13:58:33",
//              "utid": 1,
//              "uid": "15264122518",
//              "uname": "testC42C9FF8-4B18-44B5-9265-C9CEA1037070",
//              "unick": "遥不可及",
//              "usex": null,
//              "utxt": null,
//              "uimg": null
		function refreshUI() {

			var ul = document.getElementById('leaveList');
			ul.innerHTML = '';
			for(var i = 0; i < leaveArray.length; i++) {
				var li = document.createElement('li');
				li.className = 'mui-table-view-cell';
				var commentArr = leaveArray[i].Replys;
				var commentHTML = '';
				for(var j=0;j<commentArr.length;j++){
					commentHTML =commentHTML + '<div style="padding:0px 10px 10px 10px"><span id="reply" class=" dynamic-comment-name">'+commentArr[j].unick +':</span><font class="common-font-family-Regular">' + commentArr[j].MsgContent +
					'</font></div>';
				}
				if(!leaveArray[i].uimg){
					li.innerHTML = '<div style="padding:12px"><div class="mui-media-body mui-pull-left"><img class=" dynamic-personal-image" src="../../image/dynamic/u101.png"></div><div class="mui-media-body dynamic-padding-left-10px"><span id="reply'
					+i+'"class=" mui-pull-right dynamic-comment-name leaveReply">回复' +
					'</span><h4>' + leaveArray[i].unick + '</h4><p>' + leaveArray[i].MsgDate + '</p></div></div><div style="padding:0px 10px 10px 10px"><font>'+leaveArray[i].MsgContent+'</font></div>'+commentHTML; 
				}else{
					li.innerHTML = '<div style="padding:12px"><div class="mui-media-body mui-pull-left"><img class=" dynamic-personal-image" src="../../image/dynamic/u101.png"></div><div class="mui-media-body dynamic-padding-left-10px"><span id="reply'
					+i+'"class=" mui-pull-right dynamic-comment-name leaveReply">回复' +
					'</span><h4>' + leaveArray[i].unick + '</h4><p>' + leaveArray[i].MsgDate + '</p></div></div><div style="padding:0px 10px 10px 10px"><font>'+leaveArray[i].MsgContent+'</font></div>'+commentHTML; 					
				}

					ul.insertBefore(li,ul.lastChild);
			}
					mui('.mui-table-view').on('tap', '.leaveReply', function() {
						var cellIndex = this.id.replace('reply','');
						console.log(cellIndex)
//						var userserId = leaveArray[cellIndex].UserId;//留言用户ID
//						var upperId = leaveArray[cellIndex].UpperId;//上级留言ID
//						var replyUserId = leaveArray[cellIndex].ReplyId;//回复ID
//						var userOwnerId = publisherId;//用户ID
//						var msgContent = '今天天气真好';//回复内容
						var data = {
							userId:leaveArray[cellIndex].UserId,
							upperId:leaveArray[cellIndex].UpperId,
							replyUserId:leaveArray[cellIndex].ReplyId,
							userOwnerId:userId,
							msgContent:'今天天气真好'
						}
						events.openNewWindowWithData('leave-reply.html',data);
						});
		}
			</script>

</html>