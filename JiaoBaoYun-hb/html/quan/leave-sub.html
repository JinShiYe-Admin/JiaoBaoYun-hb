<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>与我相关</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/utils/events.js"></script>
		<script type="text/javascript" src="../../js/publicProtocol.js"></script>

		<style>
			.mui-table-view {
				background: transparent;
				/*背景色透明*/
			}
			
			.mui-table-view-cell {
				background: white;
				/*cell 背景设为白色*/
				padding: 0;
				/*内边距为0*/
				margin-bottom: 10px;
			}
			
			.mui-table-view:before,
			.mui-table-view:after,
			.mui-table-view-cell:after {
				height: 0px;
				/*去掉横线*/
			}
			
			.dynamic-personal-image {
				/*个人头像圆形*/
				border-radius: 50%;
				width: 50px;
				height: 50px;
			}
			
			.dynamic-padding-left-10px {
				padding-left: 10px;
			}
			
			.dynamic-praise-name,
			.dynamic-comment-name {
				/*点赞者和评论者的名字*/
				color: #1277C7;
			}
		</style>
	</head>

	<body>
		<!--下拉刷新容器-->
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
			<div class="mui-scroll">
				<div style="height: 120px;;background-image:url(../../image/quan/leave-bg.png) ;"><br/><br/>
					<h4 id="leaveTitle" style="text-align: center;">主人寄语:雁过留声，人过留名！！</h1>
					
				</div>
				<div id="leaveNum" style="background-color: gainsboro;height: 30px;padding: 5px;font-size: 15px;">
				</div>
				<!--数据列表-->
				<ul id="leaveList" class="mui-table-view">

			</ul>
		</div>
		</div>
	</body>
	<script>
		mui.init({
			pullRefresh: {
				container: '#pullrefresh',
				down: {
					callback: pulldownRefresh
				},
				up: {
					contentrefresh: '正在加载...',
					callback: pullupRefresh
				}
			}
		});
		mui.plusReady(function() {
				var comData = {
					userId: '1', //用户空间ID
					pageIndex: (tempPage).toString(), //当前页数
					pageSize: '10' //每页记录数
				};
				//请求数据
				requestData(comData);
			})
			/**
			 * 下拉刷新具体业务实现
			 */
		function pulldownRefresh() {
			setTimeout(function() {
				//刷新时将页码归1
				totalCnt = 0;
				flag = 1;
				var comData = {
					userId: '1', //用户空间ID
					pageIndex: (1).toString(), //当前页数
					pageSize: '10' //每页记录数
				};
				//请求数据
				requestData(comData);
				mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //refresh completed
			}, 1500);

		}
var count = 0;
		/**
		 * 上拉加载具体业务实现
		 */
		function pullupRefresh() {
			setTimeout(function() {
				flag = 2;
				mui('#pullrefresh').pullRefresh().endPullupToRefresh((++count > 2)); //参数为true代表没有更多数据了。
				if(tempPage * 10 > totalCnt || tempPage * 10 == totalCnt) {
					mui.toast('没有更多了...');
				} else {
					tempPage++;
					var comData = {
						userId: '1', //用户空间ID
						pageIndex: (tempPage).toString(), //当前页数
						pageSize: '10' //每页记录数
					};
					//请求数据
					requestData(comData);
				}
			}, 1500);

		}

		//页码，请求第几页数据
		var tempPage = 1;
		//当前留言的总条数
		var totalCnt = 0;
		//判断是加载更多2，还是刷新1
		var flag = 1;
		//页码请求到要显示的数据，array[model_userSpaceInfo]
		var leaveArray = [];
		//请求数据
		function requestData(comData) {
			// 等待的对话框
			var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
			//49.（用户空间）获取用户空间所有留言，model_userSpaceInfo
			postDataPro_getUserSpaceMsgsById(comData, wd, function(data) {
				wd.close();
				console.log('90909090success:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
				if(data.RspCode == 0) {
					//判断是加载更多2，还是刷新1
					if(flag == 1) {
						tempPage = 1;
						leaveArray = data.RspData.Data;
					} else {
						//合并数组
						leaveArray = leaveArray.concat(data.RspData.Data);
					}
					//留言总条数
					totalCnt = data.RspData.TotalCnt;
					var leaveNum = document.getElementById("leaveNum");
					console.log('leaveNum.innerHTML=='+leaveNum.innerHTML )
					leaveNum.innerHTML = '留言('+data.RspData.TotalCnt+')';
					refreshUI();
				} else {
					mui.toast(data.RspTxt);
				}
			});
		}

		function refreshUI() {

			var ul = document.getElementById('leaveList');
			ul.innerHTML = '';
			for(var i = 0; i < leaveArray.length; i++) {
				var li = document.createElement('li');
				li.className = 'mui-table-view-cell';
				li.innerHTML = '<div style="padding:12px"><div class="mui-media-body mui-pull-left"><img class=" dynamic-personal-image" src="../../image/dynamic/u101.png"></div><div class="mui-media-body dynamic-padding-left-10px"><span id="reply" class=" mui-pull-right dynamic-comment-name">' + '回复' +
					'</span><h4>' + leaveArray[i].UserId + '</h4><p>' + leaveArray[i].MsgDate + '</p></div></div><div style="padding: 5px 10px 10px 10px;">' + leaveArray[i].MsgContent + '</div><div style="padding:0px 10px 10px 10px"><font class="common-font-family-Regular">' + leaveArray[i].MsgDate +
					'</font></div>';
					ul.insertBefore(li,ul.lastChild);
			}
						mui('.mui-table-view').on('tap', '.dynamic-comment-name', function() {

				console.log(123)
			});
		}
	</script>

</html>