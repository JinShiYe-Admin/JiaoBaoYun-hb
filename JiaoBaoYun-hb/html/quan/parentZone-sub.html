<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/mui.css" />
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<!--本页面样式表-->
		<link rel="stylesheet" href="../../css/home/zone.css" />
		<link href="../../css/iconfont/iconfont.css" rel="stylesheet" />
		<script type="text/javascript" src="../../js/mui.min.js"></script>

		<!--公用事件js文件-->
		<script type="text/javascript" src="../../js/utils/events.js"></script>
		<script type="text/javascript" src="../../js/publicProtocol.js"></script>

		<script>
			var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid; //用户id
		</script>
		<style type="text/css">
			.dynamic-personal-image {
				/*个人头像圆形*/
				border-radius: 50%;
				width: 50px;
				height: 50px;
			}
		</style>
	</head>

	<body>
		<!--下拉刷新容器-->
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
			<div class="mui-scroll">
				<!--数据列表-->
				<ul class="mui-table-view">

				</ul>
			</div>

		</div>
	</body>
	<script type="text/javascript">
		mui.init({
			pullRefresh: {
				container: '#pullrefresh',
				down: {
					callback: pulldownRefresh
				},
			}
		});
		mui('.mui-scroll-wrapper').scroll();
		var gid;
		var className;
		var datasource;
		mui.plusReady(function() {
				gid = plus.webview.currentWebview().data.classId
				className = plus.webview.currentWebview().data.className
				getBottomList();
			})
			// 通过群ID获取群的正常用户
		function getBottomList() {
			//需要参数
			var comData = {
				top: '-1', //选择条数
				vvl: gid, //群ID，查询的值
				vvl1: '-1', //群员类型，0家长,1管理员,2老师,3学生,-1取全部

			};
			var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
			// 通过群ID获取群的正常用户
			postDataPro_PostGusers(comData, wd, function(data) {
				wd.close();
				console.log('通过群ID获取群的正常用户_PostGusers:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
				if(data.RspCode == 0) {
					datasource = data.RspData;
					//			群用户去重
					var tempUtidArr = [];
					var tempUserArr = [];
					var groupUserList = datasource;

					for(var i = 0; i < groupUserList.length; i++) {

						if(groupUserList[i].mstype == 0) { //0家长,1管理员,2老师,3学生
							groupUserList[i].mstypeName = '[家长]';
						} else if(groupUserList[i].mstype == 1) {
							groupUserList[i].mstypeName = '[管理员]';
						} else if(groupUserList[i].mstype == 2) {
							groupUserList[i].mstypeName = '[老师]';
						} else {
							groupUserList[i].mstypeName = '[学生]';
						}

						var Arrindex = tempUtidArr.indexOf(groupUserList[i].utid);
						if(Arrindex > -1) {
							tempUserArr[Arrindex].ugname = tempUserArr[Arrindex].ugname + groupUserList[i].mstypeName;
						} else {
							groupUserList[i].ugname = groupUserList[i].ugname + groupUserList[i].mstypeName;
							tempUtidArr.push(groupUserList[i].utid);
							tempUserArr.push(groupUserList[i]);

						}
					}
					datasource = tempUserArr;
					var userIds = [];
					for(var i = 0; i < datasource.length; i++) {
						//群用户id数组
						tempModel = datasource[i];
						//判断img是否为null，或者空
						tempModel.uimg = updateHeadImg(tempModel.uimg, 2);
						userIds.push(tempModel.utid)
						userIds.join(',');

					}
					userIds = arrayDupRemoval(userIds)
					upString = arrayToStr(userIds)
					getUserSpaces(upString); //获取多用户空间列表

				} else {
					mui.toast(data.RspTxt);
				}
			});
		}

		//36.（用户空间）获取多用户空间列表
		function getUserSpaces(upString) {
			//所需参数
			var comData = {
				userId: personalUTID, //用户ID
				publisherIds: upString //发布者ID，例如[1,2,3]
			};
			var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);

			//返回model：model_homeSchoolList，model_userNoteInfo
			//36.（用户空间）获取多用户空间列表
			postDataPro_getUserSpacesByUser(comData, wd, function(data) {
				wd.close();
						console.log('获取多用户空间列表_getUserSpacesByUser:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
				if(data.RspCode == 0) {
					var tempArr = [];

					for(var i = 0; i < data.RspData.Data.length; i++) {
						var tempModel = data.RspData.Data[i];
						for(var j = 0; j < datasource.length; j++) {
							if(tempModel.PublisherId == datasource[j].utid) {
								mui.extend(tempModel, datasource[j]);
								tempArr.push(tempModel);
							}
						}
					}
					datasource = tempArr;
					//所需参数
					var upstrings = upString.replace('[', '');
					upstrings = upstrings.replace(']', '');
					var postData = {
						vvl: upstrings //被备注用户ID,utid或utid串
					};
					postDataPro_PostUmk(postData, wd, function(data) {
						wd.close();
						console.log('获取多用户备注_PostUmk:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
						if(data.RspCode == 0) {
							for(var j = 0; j < datasource.length; j++) {
								for(var k = 0; k < data.RspData.length; k++) {
									if(datasource[j].utid == data.RspData[k].butid) {
										var before = datasource[j].ugname.split('[')[0]
										datasource[j].ugname = datasource[j].ugname.replace(before, data.RspData[k].bunick);
									}
								}

							}
							refreshUI();
						} else {
							console.log('底部列表全部数据' + JSON.stringify(datasource));
							refreshUI();
						}
					})

					console.log(JSON.stringify(datasource))
				}

			})
		}

		function refreshUI() {
			var ul = document.getElementsByClassName('mui-table-view')[0];
			ul.innerHTML = '';
			for(var i = 0; i < datasource.length; i++) {
				var li = document.createElement("li");
				li.className = 'mui-table-view-cell mui-media';
				li.id = 'cell' + i;
				var noReadHTML = '';
				if(datasource[i].NoReadCnt != 0) {
					noReadHTML = '<span style="float: left;" ><span  class="mui-badge mui-badge-danger custom-badge2">' + datasource[i].NoReadCnt + '</span></span>';
				} else {
					noReadHTML = '';
				}
				if(!datasource[i].PublishDate) {
					var today = new Date();
					var month = today.getMonth() + 1
					var currentDate = today.getFullYear() + "-" + month + "-" + today.getDate()
					datasource[i].PublishDate = '';
				}
				if(!datasource[i].MsgContent){
					datasource[i].MsgContent = '暂无动态'
				}
				var name = datasource[i].ugname;
				var dateArr = datasource[i].PublishDate.split(' ');
				datasource[i].PublishDate = dateArr[0];
				li.innerHTML = '	<img class="mui-media-object mui-pull-left dynamic-personal-image " src="' + datasource[i].uimg + '" />' +
					noReadHTML + '<p class="time">' + datasource[i].PublishDate + '</p><div class="mui-media-body" style="padding-left: 5px;";>' +
					name + '<p class="mui-ellipsis">' + datasource[i].MsgContent + '</p>';
				ul.appendChild(li);
			}

		}
		//	跳转到家长圈空间界面
		mui('.mui-table-view').on('tap', '.mui-table-view-cell', function() {
			var index = this.id.replace('cell', '');
			var publisherId = datasource[index].utid //空间用户id
			console.log('publisherId==' + publisherId);
			mui.openWindow({
				url: 'zone_main.html',
				id: 'zone_main.html',
				styles: {
					top: '0px', //设置距离顶部的距离
					bottom: '0px'
				},
				extras: {
					data: publisherId,
				}

			});
			var span = this.getElementsByTagName('span')[0];
			if(span) {
				span.parentElement.removeChild(span);
			}
		});
		/**
		 * 下拉刷新具体业务实现
		 */
		function pulldownRefresh() {
			setTimeout(function() {
				datasource = [];
				//请求数据
				getBottomList();
				mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //refresh completed
			}, 1500);
		}
	</script>

</html>