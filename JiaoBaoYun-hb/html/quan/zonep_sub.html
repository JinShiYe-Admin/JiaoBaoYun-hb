<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>空间</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/quan/dynamiclistitem.js"></script>
		<script type="text/javascript" src="../../js/utils/events.js"></script>
		<script type="text/javascript" src="../../js/publicProtocol.js"></script>
		<style>
			.mui-table-view {
				background: transparent;
				/*背景色透明*/
			}
			
			.mui-table-view-cell {
				background: white;
				/*cell 背景设为白色*/
				padding: 0;
				/*内边距为0*/
				margin-bottom: 10px;
			}
			
			.mui-table-view:before,
			.mui-table-view:after,
			.mui-table-view-cell:after {
				height: 0px;
				/*去掉横线*/
			}
			
			.mui-row-padding-8px {
				padding: 8px;
				/*内边距为8px*/
				padding: 12px;
			}
			
			.dynamic-personal-image {
				/*个人头像圆形*/
				border-radius: 50%;
				width: 50px;
				height: 50px;
			}
			
			.dynamic-image-div {
				/*内容中图片之间的内边距*/
				padding: 1px;
			}
			
			.dynamic-image {
				/*内容的图片占全部空间*/
				width: 100%;
				height: 100%;
			}
			
			.dynamic-icon,
			.dynamic-icon-praise,
			.dynamic-icon-comment,
			.dynamic-icon-forward {
				/*点赞，评论，分享的图标*/
				height: 20px;
				width: 20px;
				margin-left: 20px;
			}
			
			.dynamic-icon-Level {
				/*等级图标*/
				height: 20px;
				margin-left: 10px;
			}
			
			.dynamic-icon-praise-small {
				/*点赞列表的小图标*/
				height: 15px;
				width: 15px;
				margin-right: 5px;
				margin-bottom: 0px;
			}
			
			.dynamic-margin-top-10px {
				margin-top: 10px;
			}
			
			.dynamic-padding-left-10px {
				padding-left: 10px;
			}
			
			.dynamic-line {
				/*点赞列表上面的横线*/
				height: 1px;
				width: 100%;
				background: #CCCCCC;
			}
			
			.dynamic-contenttext {
				/*动态内容*/
				font-family: '微软雅黑 Regular', '微软雅黑';
				/*字体样式*/
			}
			
			.dynamic-praise-name,
			.dynamic-comment-name {
				/*点赞者和评论者的名字*/
				color: #1277C7;
			}
			
			.dynamic-comment-btn {
				/*底部的评论按钮*/
				width: 100%;
				margin-top: 10px;
			}
			
			.dynamic-image-more {
				/*更多图片*/
				position: absolute;
				width: 99%;
				height: 99%;
				font-size: 40px;
				color: white;
				text-align: center;
				background-color: rgba(0, 0, 0, 0.3);
			}
			
			.mui-popover {
				position: fixed;
				height: 45px;
				width: 60px;
			}
		</style>
	</head>

	<body>

		<!--下拉刷新容器-->
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
			<div class="mui-scroll">
				<!--数据列表-->
				<ul class="mui-table-view">
					<!--<li id="0" class="mui-table-view-cell">
						<div class="mui-row mui-row-padding-8px">
							<div class="mui-col-sm-12 mui-col-xs-12">
								<div class="mui-media-body mui-pull-left"><img class=" dynamic-personal-image" src="../../image/dynamic/u101.png"></div>
								<div class="mui-media-body dynamic-padding-left-10px"><span class="mui-icon mui-icon-arrowdown mui-pull-right"></span>
									<h4>大熊猫<img src="../../image/dynamic/icon_Level39.png" class=" dynamic-icon-Level"></h4>
									<p>2016-10-12 10:55</p>
								</div>
							</div>
							<div class="mui-col-sm-12 mui-col-xs-12">
								<div class="mui-media-body dynamic-contenttext">
									<font>一二三四二二三四三二三四四二三四</font>
								</div>
							</div>
						</div>
						<div class="mui-row ">
							<div class="mui-col-sm-4 mui-col-xs-4 dynamic-image-div" style="height: 125px;"><img class="dynamic-image" src="../../image/dynamic/u101.png"></div>
							<div class="mui-col-sm-4 mui-col-xs-4 dynamic-image-div" style="height: 125px;"><img class="dynamic-image" src="../../image/dynamic/u101.png"></div>
							<div class="mui-col-sm-4 mui-col-xs-4 dynamic-image-div" style="height: 125px;"><img class="dynamic-image" src="../../image/dynamic/u101.png"></div>
							<div class="mui-col-sm-4 mui-col-xs-4 dynamic-image-div" style="height: 125px;"><img class="dynamic-image" src="../../image/dynamic/u101.png"></div>
							<div class="mui-col-sm-4 mui-col-xs-4 dynamic-image-div" style="height: 125px;"><img class="dynamic-image" src="../../image/dynamic/u101.png"></div>
							<div class="mui-col-sm-4 mui-col-xs-4 dynamic-image-div" style="height: 125px;"><img class="dynamic-image" src="../../image/dynamic/u101.png"></div>
							<div class="mui-col-sm-4 mui-col-xs-4 dynamic-image-div" style="height: 125px;"><img class="dynamic-image" src="../../image/dynamic/u101.png"></div>
							<div class="mui-col-sm-4 mui-col-xs-4 dynamic-image-div" style="height: 125px;"><img class="dynamic-image" src="../../image/dynamic/u101.png"></div>
							<div class="mui-col-sm-4 mui-col-xs-4 dynamic-image-div" style="height: 125px;">
								<div class="dynamic-image-more">
									<font style="line-height: 125px;">+1</font>
								</div><img class="dynamic-image" src="../../image/dynamic/u101.png"></div>
						</div>
						<div class="mui-row mui-row-padding-8px">
							<div class="mui-col-sm-12 mui-col-xs-12">
								<div class="mui-media-body">
									<p><span class="mui-icon mui-icon-image"></span>上传了10张图片到相册《手机相册》</p>
								</div>
							</div>
							<div class="mui-col-sm-12 mui-col-xs-12 dynamic-margin-top-10px">
								<div class="mui-media-body mui-pull-right"><img src="../../image/dynamic/icon_praise.png" class="dynamic-icon-praise"><img src="../../image/dynamic/icon_comment.png" class="dynamic-icon-comment"><img src="../../image/dynamic/icon_forward.png" class="dynamic-icon-forward"></div>
								<div class="mui-media-body">
									<p>浏览30次</p>
								</div>
							</div>
							<div class="mui-col-sm-12 mui-col-xs-12 ">
								<div class="mui-media-body dynamic-line"></div>
							</div>
							<div class="mui-col-sm-12 mui-col-xs-12 dynamic-margin-top-10px">
								<div class="mui-media-body"><img src="../../image/dynamic/icon_praise_small.png" class="dynamic-icon-praise-small mui-pull-left">
									<font class="common-font-family-Regular dynamic-praise-name">一</font>
									<font class="common-font-family-Regular dynamic-praise-name">、一二</font>
									<font class="common-font-family-Regular dynamic-praise-name">、一二三</font>
									<font class="common-font-family-Regular dynamic-praise-name">、一二三四</font>
									<font class="common-font-family-Regular dynamic-praise-name">、一二三四五</font>
									<font class="common-font-family-Regular dynamic-praise-name">、一二三四五六</font>
									<font class="common-font-family-Regular dynamic-praise-name">、一二三四五六七</font>
								</div>
							</div>
							<div class="mui-col-sm-12 mui-col-xs-12">
								<div class="mui-media-body">
									<font class="common-font-family-Regular dynamic-comment-name">陪你上演地老天荒</font>
									<font class="common-font-family-Regular">：嘚瑟呵呵</font>
								</div>
								<div class="mui-media-body">
									<font class="common-font-family-Regular dynamic-comment-name">孟祥菊</font>
									<font class="common-font-family-Regular">回复</font>
									<font class="common-font-family-Regular dynamic-comment-name">陪你上演地老天荒</font>
									<font class="common-font-family-Regular">一二三四五六七八九十</font>
								</div>
							</div>
							<div class="mui-col-sm-12 mui-col-xs-12"><button type="button" class="mui-btn dynamic-comment-btn"><p class="mui-pull-left">评论</p></button></div>
						</div>
					</li>-->

				</ul>
			</div>

		</div>
		<!--下拉菜单-->
		<div id="popover" class="mui-popover">
			<ul class=" mui-table-view">
				<li class="mui-table-view-cell" style="text-align: center;">
					删除
				</li>
				<li class="mui-table-view-cell" style="text-align: center;">
					屏蔽
				</li>
				<li class="mui-table-view-cell" style="text-align: center;">
					收藏
			</ul>
		</div>

	</body>

	<script>
		var publisherId;
		var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid; //用户id

		mui.init({
			pullRefresh: {
				container: '#pullrefresh',
				down: {
					callback: pulldownRefresh
				},
				up: {
					contentrefresh: '正在加载...',
					callback: pullupRefresh
				}
			}
		});

		function refreshUI() {

		}
		/**
		 * 下拉刷新具体业务实现
		 */
		function pulldownRefresh() {
			setTimeout(function() {
				flag = 2; //下拉刷新
				totalCnt = 0; //总页数
				tempPage = 1; //刷新时将页码归1
				var comData = {
					userId: personalUTID, //用户ID
					publisherId: publisherId, //发布用户ID
					noteType: '2', //信息类型,1云笔记,2个人空间动态
					pageIndex: (tempPage).toString(), //当前页数
					pageSize: '10' //每页记录数
				};
				//请求数据
				requestData(comData);
				mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //refresh completed
				//				var table = document.body.querySelector('.mui-table-view');
				//				table.innerHTML = '';
				//				var data = addData();
				//				dynamiclistitem.addItem(table, data, id);

			}, 1500);
		}

		/**
		 * 上拉加载具体业务实现
		 */
		function pullupRefresh() {
			setTimeout(function() {
				flag = 1; //上拉加载更多
				if(tempPage * 10 > totalCnt || tempPage * 10 == totalCnt) {
					mui.toast('没有更多了...');
				} else {
					tempPage++;
					var comData = {
						userId: personalUTID, //用户ID
						publisherId: publisherId, //发布用户ID
						noteType: '2', //信息类型,1云笔记,2个人空间动态
						pageIndex: (tempPage).toString(), //当前页数
						pageSize: '10' //每页记录数
					};
					//请求数据
					requestData(comData);

				}
				mui('#pullrefresh').pullRefresh().endPullupToRefresh(true); //参数为true代表没有更多数据了。

				//							var table = document.body.querySelector('.mui-table-view');
				//							var data = addData();
				//							dynamiclistitem.addItem(table, data, id);
			}, 1500);

		}
		var tempPage = 1; //页码，请求第几页数据
		var totalCnt = 0; //当前留言的总条数
		var flag = 2; //判断是加载更多1，还是刷新2
		var zonepArray = []; //页码请求到要显示的数据，array[model_userNoteInfo]

		//请求数据
		function requestData(comData) {
			// 等待的对话框
			var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
			//28.（用户空间）获取用户针对某用户的空间列表
			postDataPro_getUserSpacesByUserForPublisher(comData, wd, function(data) {
				wd.close();
				console.log('postDataPro_getUserSpacesByUserForPublisher:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
				if(data.RspCode == 0) {
					totalCnt = data.RspData.TotalCnt;
					var tempRspData = data.RspData.Data;
					//获取当前回调留言的个人信息，主要是头像、昵称
					var tempArray = [];
					//先遍历回调数组，获取
					for(var item in tempRspData) {
						//当前循环的model
						var tempModel0 = tempRspData[item];
						//将当前model中id塞到数组
						tempArray.push(tempModel0.PublisherId);
						//循环当前model中的回复数组
						for(var item1 in tempModel0.Replys) {
							//回复中的model
							var tempModel1 = tempModel0.Replys[item];
							//将回复中的id塞到数组
							tempArray.push(tempModel1.UserId);
							tempArray.push(tempModel1.ReplyId);
						}
					}
					//给数组去重
					tempArray = arrayDupRemoval(tempArray);
					//发送获取用户资料申请
					var tempData = {
						vvl: tempArray.join(), //用户id，查询的值,p传个人ID,g传ID串
						vtp: 'g' //查询类型,p(个人)g(id串)
					}
					console.log('tempData:' + JSON.stringify(tempData));

					//21.通过用户ID获取用户资料
					postDataPro_PostUinf(tempData, wd, function(data1) {
						wd.close();
						console.log('获取个人资料success:RspCode:' + data1.RspCode + ',RspData:' + JSON.stringify(data1.RspData) + ',RspTxt:' + data1.RspTxt);
						if(data1.RspCode == 0) {
							//循环当前的个人信息返回值数组
							for(var i in data1.RspData) {
								//当前model
								var tempModel = data1.RspData[i];
								//判断img是否为null，或者空
								if (tempModel.uimg==''||tempModel.uimg==null) {//赋值
									tempModel.uimg = '../image/utils/default_personalimage.png';
								}else{//修改值
									var myDate = new Date();
									tempModel.uimg = tempModel.uimg + '?' + myDate.getTime();
								}
								//循环留言数组
								for(var item in tempRspData) {
									//当前循环的model
									var tempModel0 = tempRspData[item];
									//对比id是否一致
									if(tempModel0.utid == tempModel.UserId) {
										//合并
										tempModel0 = $.extend(tempModel0, tempModel);
									}
									//循环当前model中的回复数组
									for(var item1 in tempModel0.Comments) {
										//回复中的model
										var tempModel1 = tempModel0.Comments[item1];
										//对比id是否一致
										if(tempModel.utid == tempModel1.UserId) {
											//添加参数
											tempModel1.ReplyIdName = tempModel.unick;
										}
										if(tempModel.utid == tempModel1.ReplyId) {
											//添加参数
											tempModel1.ReplyIdName = tempModel.unick;
										}
									}
								}
							}
						}
						console.log('循环遍历后的值：' + JSON.stringify(tempRspData));

						var table = document.body.querySelector('.mui-table-view');
						//判断是加载更多1，还是刷新2
						if(flag == 1) {
							//合并数组
							zonepArray = zonepArray.concat(tempRspData);
							//留言总条数,写到了协议开始
//							totalCnt = data.RspData.TotalCnt;
							for(var i = zonepArray.length; i < zonepArray.length; i++) {
								id = i;
								var data = addData(i);
								dynamiclistitem.addItem(table, data, id);
							}

						} else {
							tempPage = 1;
							zonepArray = tempRspData;
							//留言总条数
							
							table.innerHTML = '';
							for(var i = 0; i < zonepArray.length; i++) {
								id = i;
								var data = addData(i);
								dynamiclistitem.addItem(table, data, id);
							}

						}
					});
				} else {
					mui.toast(data.RspTxt);
				}
			});
		}

		var id = 0;
		mui.plusReady(function() {
			publisherId = plus.webview.currentWebview().data; //发布者id
			tempPage = 1; //页码，请求第几页数据
			totalCnt = 0; //当前留言的总条数
			flag = 2; //判断是加载更多1，还是刷新2
			var comData = {
				userId: personalUTID, //用户ID
				publisherId: publisherId, //发布用户ID
				noteType: '2', //信息类型,1云笔记,2个人空间动态
				pageIndex: (tempPage).toString(), //当前页数
				pageSize: '10' //每页记录数
			};
			console.log(JSON.stringify(comData));
			requestData(comData);

			var click = []; //记录被点击的li的id和被点击元素

			mui('.mui-table-view').on('tap', '.mui-table-view-cell', function() {
				var toast = '';
				mui.each(click, function(index, element) {
					toast = toast + element;
				});
				var id = this.getAttribute('id');
				click.push(id);
				mui.toast('li-id:' + click[click.length - 1] + '-' + toast);
				click = [];
			});

			mui('.mui-table-view').on('tap', '.dynamic-personal-image', function() {
				click.push('头像');
			});
			mui('.mui-table-view').on('tap', 'h4', function() {
				click.push('姓名');
			});
			mui('.mui-table-view').on('tap', '.mui-icon-arrowdown', function() {

				click.push('向下按钮');
			});
			mui('.mui-table-view').on('tap', '.dynamic-contenttext', function() {
				click.push('动态文字');
			});
			mui('.mui-table-view').on('tap', '.dynamic-image', function() {
				click.push('图片' + this.getAttribute('src'));
			});
			mui('.mui-table-view').on('tap', '.dynamic-image-more', function() {
				click.push('更多图片');
			});
			mui('.mui-table-view').on('tap', '.dynamic-icon-praise', function() {
				click.push('点赞');
			});
			mui('.mui-table-view').on('tap', '.dynamic-icon-comment', function() {
				click.push('评论');
			});
			mui('.mui-table-view').on('tap', '.dynamic-icon-forward', function() {
				click.push('分享');
			});
			mui('.mui-table-view').on('tap', '.dynamic-praise-name', function() {
				click.push('点赞者：' + this.innerText);
			});
			mui('.mui-table-view').on('tap', '.dynamic-comment-name', function() {
				click.push('评论者：' + this.innerText);
			});
			mui('.mui-table-view').on('tap', '.dynamic-comment-btn', function() {
				click.push('评论按钮');
			});
		});

		//加载数据
		function addData(index) {
			//[[InfoList],[ImageList],[InteractionList]]动态的信息
			var Data = [];
			var InfoList = []; //头部和内容
			var ImageList = []; //内容的图片
			var InteractionList = []; //底部内容

			//个人信息和内容
			//[personalImage,personalName,time,contentText]个人头像，姓名，发布时间，动态内容的文字
			var personalImage = '../../image/dynamic/u101.png';
			var personalName = '大熊猫';
			var time = zonepArray[index].PublishDate;
			var contentText = zonepArray[index].MsgContent;
			InfoList.push(personalImage);
			InfoList.push(personalName);
			InfoList.push(time);
			InfoList.push(contentText);

			//内容的图片
			//[[ImageUrlList],ImageNum],动态内容的图片路径数组,图片总数量
			var ImageUrlList = [];
			//					if(id == 0) {
			//						ImageUrlList = ['../../image/dynamic/u101.png', '../../image/dynamic/u101.png', '../../image/dynamic/u101.png',
			//							'../../image/dynamic/u101.png', '../../image/dynamic/u101.png', '../../image/dynamic/u101.png',
			//							'../../image/dynamic/u101.png', '../../image/dynamic/u101.png', '../../image/dynamic/u101.png', '../../image/dynamic/u101.png'
			//						];
			//					} 
			var ImageNum = ImageUrlList.length;
			ImageList.push(ImageUrlList);
			ImageList.push(ImageNum);

			//底部
			//[introduce，viewCount，[praiseList],[commentList]]信息说明，浏览次数，点赞列表数组，评论列表数组
			var introduce = '上传了' + ImageNum + '张图片到相册《手机相册》';
			var viewCount = zonepArray[index].ReadCnt;
			var praiseList = zonepArray[index].LikeUsers;

			//[commentList]:评论列表
			//1.评论[commenter,content]，评论者，评论内容
			//2.回复[replyer，commenter，replyContent]回复者，评论者，回复的内容
			var commentList = [];
			var commenter1 = ['陪你上演地老天荒', '嘚瑟呵呵'];
			var replyer1 = ['孟祥菊', '陪你上演地老天荒', '一二三四五六七八九十'];
			commentList.push(commenter1);
			commentList.push(replyer1);

			InteractionList.push(introduce);
			InteractionList.push(viewCount);
			InteractionList.push(praiseList);
			InteractionList.push(commentList);

			Data = [InfoList, ImageList, InteractionList]
			return Data;
		}
	</script>

</html>