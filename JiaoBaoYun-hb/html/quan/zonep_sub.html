<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>空间</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<link rel="stylesheet" type="text/css" href="../../css/icons-extra.css" />
		<link rel="stylesheet" href="../../css/iconfont/iconfont.css" />
		<link href="../../css/utils/preview.css" rel="stylesheet" />
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/utils/events.js"></script>
		<script type="text/javascript" src="../../js/publicProtocol.js"></script>
		<script type="text/javascript" src="../../js/utils/native.js"></script>
		<script type="text/javascript" src="../../js/mui.lazyload.js"></script>
		<script type="text/javascript" src="../../js/mui.lazyload.img.js"></script>
		<script src="../../js/mui.zoom.js"></script>
		<script src="../../js/mui.previewimage.js"></script>
		<script type="text/javascript" src="../../js/quan/dynamiclistitem.js"></script>

		<style>
			.showAll {
				display: none;
				color: #D7D7D7;
				margin-top: 10px;
			}
			
			.ellipsis-show {
				/*内容*/
				display: -webkit-box;
				overflow: hidden;
				white-space: normal !important;
				text-overflow: ellipsis;
				word-wrap: break-word;
				-webkit-line-clamp: inherit;
				-webkit-box-orient: vertical;
			}
			
			.mui-table-view-cell:active {
				background-color: #FFFFFF;
			}
			
			.mui-table-view {
				background: #EFEFF4;
				/*背景色透明*/
			}
			
			.mui-table-view-cell {
				background: white;
				/*cell 背景设为白色*/
				padding: 0;
				/*内边距为0*/
				margin-bottom: 10px;
			}
			
			.mui-table-view:before,
			.mui-table-view:after,
			.mui-table-view-cell:after {
				height: 0px;
				/*去掉横线*/
			}
			
			.mui-table-view-cell {
				background-color: #fff;
				margin-top: 1rem;
			}
			
			.mui-row-padding-8px {
				padding: 8px;
				/*内边距为8px*/
				padding: 12px;
			}
			
			.dynamic-personal-image {
				/*个人头像圆形*/
				border-radius: 50%;
				width: 50px;
				height: 50px;
			}
			
			.dynamic-image-div {
				/*内容中图片之间的内边距*/
				padding: 1px;
			}
			
			.dynamic-image {
				/*内容的图片占全部空间*/
				width: 100%;
				height: 100%;
			}
			
			.dynamic-icon,
			.dynamic-icon-praise,
			.dynamic-icon-comment,
			.dynamic-icon-forward {
				/*点赞，评论，分享的图标*/
				height: 30px;
				width: 30px;
				margin-left: 25px;
			}
			
			.dynamic-icon-Level {
				/*等级图标*/
				height: 20px;
				margin-left: 10px;
			}
			
			.dynamic-icon-praise-small {
				/*点赞列表的小图标*/
				height: 15px;
				width: 15px;
				margin-right: 5px;
				margin-bottom: 0px;
			}
			
			.dynamic-margin-top-10px {
				margin-top: 10px;
			}
			
			.dynamic-padding-left-10px {
				padding-left: 10px;
			}
			
			.dynamic-line {
				/*点赞列表上面的横线*/
				height: 1px;
				width: 100%;
				background: #e4e4e4;
			}
			
			.dynamic-contenttext {
				/*动态内容*/
				font-family: '微软雅黑 Regular', '微软雅黑';
				/*字体样式*/
			}
			
			.dynamic-praise-name,
			.dynamic-comment-name {
				/*点赞者和评论者的名字*/
				color: #1A9BFF;
			}
			
			.replyComment {
				padding-top: 5px;
			}
			
			.dynamic-comment-btn {
				/*底部的评论按钮*/
				width: 100%;
				margin-top: 10px;
				border-width: 1px;
				border-color: #e4e4e4;
			}
			
			.dynamic-image-more {
				/*更多图片*/
				position: absolute;
				width: 99%;
				height: 99%;
				font-size: 40px;
				color: white;
				text-align: center;
				background-color: rgba(0, 0, 0, 0.3);
			}
		</style>
	</head>

	<body>
		<footer id="footer" class="mui-bar mui-bar-tab" style="display: none;">
			<div class="footer-center">
				<textarea onblur="inputOnblur(this)" id='msg-content' type="text" class='input-text'></textarea>
			</div>
			<button id='btn-reply' class="mui-btn mui-btn-green btn-commit" style="background-color: #1db8F1;border-color:#1db8F1 ;">评论</button>
		</footer>
		<!--下拉刷新容器-->
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
			<div class="mui-scroll">
				<!--数据列表-->
				<ul class="mui-table-view">

				</ul>
			</div>

		</div>

		<!--<div id="comment-popover" class="mui-popover" style="width: 100%;top: 150px;height: 200px;">
			<ul class="mui-table-view">
				<img id="closepop" src="../../image/cloud/record_addclassclose.png" style="height: 30px;float: right;margin: 10px;" />
				<input onblur="inputOnblur(this)" id="inputComment" type="text" class="mui-input-clear" placeholder="请输入评论内容" style="width:80% ;margin-left: 10%;text-align: center;border-radius: 50px;">
				<button id="addComment" type="button" class="mui-btn mui-btn-blue mui-btn-block" style="border-radius: 50px;height: 40px;width: 80%;left: 10%;padding: 0;">评论</button>
		</div>-->

	</body>

	<script>
		var pageFlag = 0;
		var idFlag = '';
		var publisherId; //发布者id
		var tempIndex; //节点对象id
		var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid; //用户id
		var personalunick = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).unick; //用户昵称
		var gid;
		var SCREEN_WIDTH;
		mui.init({
			pullRefresh: {
				container: '#pullrefresh',
				down: {
					callback: pulldownRefresh
				},
				up: {
					contentrefresh: '正在加载...',
					callback: pullupRefresh
				}
			}
		});

		var tempPage = 1; //页码，请求第几页数据
		var totalCnt = 0; //当前留言的总条数
		var flag = 2; //判断是加载更多1，还是刷新2
		var zonepArray = []; //页码请求到要显示的数据，array[model_userNoteInfo]
		var isPersonal; //判断是个人空间还是多用户空间

		//请求数据
		function requestData(comData) {
			if(gid) {
				isPersonal = 1;
				getBottomList();

			} else {
				isPersonal = 0;
				// 等待的对话框
				var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);

				//28.（用户空间）获取用户针对某用户的空间列表
				postDataPro_getUserSpacesByUserForPublisher(comData, wd, function(data) {
					wd.close();
					console.log('获取个人空间列表_getUserSpacesByUserForPublisher:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
					if(data.RspCode == 0) {
						if(data.RspData.Data.length == 0) {
							mui.toast('暂无动态')
							return;
						}
						setUserSpaceReadByUser('[' + publisherId + ']');
						totalCnt = data.RspData.TotalCnt;
						var tempRspData = data.RspData.Data;
						//获取当前回调留言的个人信息，主要是头像、昵称
						var tempArray = [];
						//先遍历回调数组，获取
						for(var item in tempRspData) {
							//当前循环的model
							var tempModel0 = tempRspData[item];
							//将当前model中id塞到数组
							tempArray.push(tempModel0.PublisherId);
							//合并数组,点赞的人
							for(var i in tempModel0.LikeUsers) {
								tempArray = tempArray.concat(tempModel0.LikeUsers[i].userId);
								//								tempModel0.LikeUsers = arrayDupRemoval(tempModel0.LikeUsers);
							}

							//循环当前model中的回复数组
							for(var item1 in tempModel0.Comments) {
								//回复中的model
								var tempModel1 = tempModel0.Comments[item1];
								//将回复中的id塞到数组
								tempArray.push(tempModel1.UserId);
								tempArray.push(tempModel1.ReplyId);
								//
								for(var item2 in tempModel1.Replys) {
									//回复中的model
									var tempModel2 = tempModel1.Replys[item2];
									//将回复中的id塞到数组
									tempArray.push(tempModel2.UserId);
									tempArray.push(tempModel2.ReplyId);
								}
							}
						}
						//给数组去重
						tempArray = arrayDupRemoval(tempArray);
						//发送获取用户资料申请
						var tempData = {
							vvl: tempArray.join(), //用户id，查询的值,p传个人ID,g传ID串
							vtp: 'g' //查询类型,p(个人)g(id串)
						}

						//21.通过用户ID获取用户资料
						postDataPro_PostUinf(tempData, wd, function(data1) {
							wd.close();
							console.log('获取个人资料success:RspCode:' + data1.RspCode + ',RspData:' + JSON.stringify(data1.RspData) + ',RspTxt:' + data1.RspTxt);
							if(data1.RspCode == 0) {
								//循环当前的个人信息返回值数组
								for(var i in data1.RspData) {
									//当前model
									var tempModel = data1.RspData[i];
									//更新头像
									tempModel.uimg = updateHeadImg(tempModel.uimg, 2);
									//循环留言数组
									for(var item in tempRspData) {
										//当前循环的model
										var tempModel0 = tempRspData[item];
										//遍历点赞的人
										for(var item2 in tempModel0.LikeUsers) {
											//										console.log('item2;;;;;==' + tempModel.utid + ',' + tempModel0.LikeUsers[item2]);
											if(tempModel.utid == tempModel0.LikeUsers[item2].userId) {
												//												tempModel0.LikeUsers.splice(item2, 1, tempModel);
												tempModel0.LikeUsers[item2] = $.extend(tempModel0.LikeUsers[item2], tempModel);
											}
										}
										//对比id是否一致
										if(tempModel0.PublisherId == tempModel.utid) {
											//合并
											tempModel0 = $.extend(tempModel0, tempModel);
										}
										//循环当前model中的回复数组
										for(var item1 in tempModel0.Comments) {
											//回复中的model
											var tempModel1 = tempModel0.Comments[item1];
											//对比id是否一致
											if(tempModel.utid == tempModel1.UserId) {
												//添加参数
												tempModel1.UserIdName = tempModel.unick;
											}
											if(tempModel.utid == tempModel1.ReplyId) {
												//添加参数
												tempModel1.ReplyIdName = tempModel.unick;
											}
											//
											for(var item2 in tempModel1.Replys) {
												//回复中的model
												var tempModel2 = tempModel1.Replys[item2];
												//对比id是否一致
												if(tempModel.utid == tempModel2.UserId) {
													//添加参数
													tempModel2.UserIdName = tempModel.unick;
												}
												if(tempModel.utid == tempModel2.ReplyId) {
													//添加参数
													tempModel2.ReplyIdName = tempModel.unick;
												}
											}
										}
									}
								}
							}
							console.log('循环遍历后的值：' + JSON.stringify(tempRspData));

							var table = document.body.querySelector('.mui-table-view');
							//判断是加载更多1，还是刷新2
							if(flag == 1) {
								var tempLength = zonepArray.length;
								//合并数组
								zonepArray = zonepArray.concat(tempRspData);
								mui('#pullrefresh').pullRefresh().endPullupToRefresh(); //参数为true代表没有更多数据了。
								for(var i = tempLength; i < zonepArray.length; i++) {
									id = i;
									var data = addData(i);
									dynamiclistitem.addItem(table, data, id);
								}
								dynamiclistitem.questionContent();
							} else {
								tempPage = 1;
								zonepArray = tempRspData;
								table.innerHTML = '';
								for(var i = 0; i < zonepArray.length; i++) {
									id = i;
									var data = addData(i);
									dynamiclistitem.addItem(table, data, id);
								}
								dynamiclistitem.questionContent();
							}
						});
					} else {
						mui.toast(data.RspTxt);
					}
				});
			}
		}

		var id = 0; //cell的id
		mui.plusReady(function() {
			events.preload("classSpace-persons.html");
			SCREEN_WIDTH = plus.screen.resolutionWidth;
			gid = plus.webview.currentWebview().data.classId
			mui.previewImage();
			addReplyView();
			publisherId = plus.webview.currentWebview().data; //发布者id

			tempPage = 1; //页码，请求第几页数据
			totalCnt = 0; //当前留言的总条数
			flag = 2; //判断是加载更多1，还是刷新2
			var comData = {
				userId: personalUTID, //用户ID
				publisherId: publisherId, //发布用户ID
				noteType: '2', //信息类型,1云笔记,2个人空间动态
				pageIndex: (tempPage).toString(), //当前页数
				pageSize: '10' //每页记录数
			};
			requestData(comData);
			window.addEventListener('refreshZonep', function(data) {
				var tempData = data.detail;
				console.log(JSON.stringify(tempData));
				var index = 'line' + tempIndex;
				console.log(index)

				if(tempData.flag == '评论') {
					document.getElementById(index).className = 'mui-media-body dynamic-line';
					var div = document.createElement("div");
					var index = zonepArray[tempIndex].Comments.length
					div.id = 'replyComment' + tempIndex + '-' + index + '-' + '评论'
					div.className = 'mui-media-body replyComment'
					div.innerHTML = '<font class="common-font-family-Regular dynamic-comment-name ">' + personalunick + '</font>' +
						'<font class="common-font-family-Regular" style = "font-size:14px">：' + tempData.content + '</font>'
					var commentList = document.getElementById("commentList" + tempData.tempIndex);
					commentList.appendChild(div);
				} else if(tempData.flag == '评论回复') {
					var indexArr = tempIndex.split('-');
					var id = indexArr[0];
					var commentId = indexArr[1];
					var replyId = indexArr[2];

					var tempModel = zonepArray[id].Comments[commentId];
					var replyUserId;
					var ReplyIdName;
					if(replyId == '评论') {
						replyUserId = tempModel.UserId
						ReplyIdName = tempModel.UserIdName
					} else {
						replyUserId = tempModel.Replys[replyId].UserId;
						ReplyIdName = tempModel.Replys[replyId].UserIdName;
					}
					var commentList = document.getElementById("commentList" + id);
					var div = document.createElement("div");
					div.id = 'replyComment' + id + '-' + commentId + '-' + replyId;
					div.className = 'mui-media-body replyComment';
					div.innerHTML = '<font class="common-font-family-Regular dynamic-comment-name">' + personalunick + '</font>' +
						'<font class="common-font-family-Regular" style = "font-size:14px">回复</font>' +
						'<font class="common-font-family-Regular dynamic-comment-name">' + ReplyIdName + '</font>' +
						'<font class="common-font-family-Regular" style = "font-size:14px">：' + tempData.content + '</font></div>'
					var tempDiv = document.getElementById('replyComment' + id + '-' + commentId + '-' + '评论')
					tempDiv.appendChild(div)

				} else {
					requestData(comData)
				}

			})
			//点击评论者名字
			mui('.mui-table-view').on('tap', '.dynamic-comment-name', function() {
				console.log('评论者id' + this.dataset.info);
				mui.openWindow({
					url: 'zone_main.html',
					id: 'zone_main.html',
					styles: {
						top: '0px', //设置距离顶部的距离
						bottom: '0px'
					},

					extras: {
						data: this.dataset.info,
						NoReadCnt: 0,
						flag: '0'
					},
					createNew: true,

				});
				window.event.stopPropagation()

			})
			mui('.mui-table-view').on('tap', '.dynamic-personal-image', function() {
				if(isPersonal == 1) {
					var index = this.id.replace('headImg', '');
					mui.openWindow({
						url: 'zone_main.html',
						id: 'zone_main.html',
						styles: {
							top: '0px', //设置距离顶部的距离
							bottom: '0px'
						},

						extras: {
							data: zonepArray[index].PublisherId,
							NoReadCnt: 0,
							flag: '0'
						},
						createNew: true,

					});
				}

			})
			var click = []; //记录被点击的li的id和被点击元素

			mui('.mui-table-view').on('tap', '.mui-table-view-cell', function() {

				var toast = '';
				mui.each(click, function(index, element) {
					toast = toast + element;
				});
				var id = this.getAttribute('id');

				click.push(id);
				//								mui.toast('li-id:' + click[click.length - 1] + '-' + toast);
				click = [];
			});
			mui('.mui-table-view').on('tap', '.question_content', function() {

				var toast = '';
				mui.each(click, function(index, element) {
					toast = toast + element;
				});
				var id = this.getAttribute('id');
				var index = this.id.replace('question_content', '');
				zonepArray[index].focusFlag = 0;

				events.openNewWindowWithData('space-detail.html', zonepArray[index])
				click.push(id);
				click = [];
			});
			mui('.mui-table-view').on('tap', '.show', function() {

				var toast = '';
				mui.each(click, function(index, element) {
					toast = toast + element;
				});
				var id = this.getAttribute('id');
				var index = this.id.replace('show', '');
				zonepArray[index].focusFlag = 0;

				events.openNewWindowWithData('space-detail.html', zonepArray[index])
				click.push(id);
				click = [];
			})
			mui('.mui-table-view').on('tap', '.show2', function() {

				var toast = '';
				mui.each(click, function(index, element) {
					toast = toast + element;
				});
				var id = this.getAttribute('id');
				var index = this.id.replace('show2', '');
				zonepArray[index].focusFlag = 0;

				events.openNewWindowWithData('space-detail.html', zonepArray[index])
				click.push(id);
				click = [];
			})

			//删除动态
			mui('.mui-table-view').on('tap', '.mui-icon-closeempty', function() {
				var btnArray = ['取消', '确定'];
				var closeId = this.id;
				mui.confirm('确定删除此条动态？', '提醒', btnArray, function(e) {
					if(e.index == 1) {
						var index = closeId.replace('delete', '');
						console.log(closeId);
						var comData = {
							userSpaceId: zonepArray[index].TabId, //用户空间ID
						};
						var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
						postDataPro_delUserSpaceById(comData, wd, function(data) {
							wd.close();
							if(data.RspCode == 0) {
								mui.toast('已删除');

								var deleteNode = document.getElementById(index);
								deleteNode.parentNode.removeChild(deleteNode);
								zonepArray.splice(index, 1)
							} else {
								mui.toast(data.RspTxt);
							}

						})
					} else {

					}
				})

				click.push('向下按钮');
			});

			//点赞和取消点赞
			mui('.mui-table-view').on('tap', '.dynamic-icon-praise', function() {
				click.push('点赞');
				personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid; //用户id
				var index = this.id.replace('praise', '');

				var color = this.style.color;
				if(color == 'rgb(183, 183, 183)') {
					var comData = {
						userId: personalUTID, //用户ID
						userSpaceId: zonepArray[index].TabId, //用户空间ID
					};
					var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
					postDataPro_setUserSpaceLikeByUser(comData, wd, function(data) {
						wd.close();
						if(data.RspCode == 0) {
							console.log('index=' + index)
							document.getElementById("line" + index).className = 'mui-media-body dynamic-line'
							var a = document.getElementById("praise" + index);
							a.style.color = 'rgb(26, 155, 255)'
							//							mui.toast('点赞成功');
							var PraiseList = document.getElementById("PraiseList" + index);
							console.log(PraiseList.innerHTML);
							var praiseNameList = PraiseList.getElementsByTagName("font");
							console.log(praiseNameList.length)
							if(praiseNameList.length > 0) {
								var praiseName = praiseNameList[0];
								praiseName.innerHTML = personalunick + '、' + praiseName.innerHTML;
								console.log(praiseName.innerHTML);
							} else {

								PraiseList.innerHTML = '<img id= "praiseImg' + index + '" src="../../image/dynamic/praise.png" class="dynamic-icon-praise-small mui-pull-left" />' +
									'<font class="common-font-family-Regular dynamic-praise-name">' + personalunick + '</font>';
							}
						} else {
							mui.toast(data.RspTxt);
						}

					})

				} else {

					var comData = {
						userId: personalUTID, //用户ID
						userSpaceId: zonepArray[index].TabId, //用户空间ID
					};
					var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
					postDataPro_delUserSpaceLikeByUser(comData, wd, function(data) {
						wd.close();
						if(data.RspCode == 0) {
							var a = document.getElementById("praise" + index);
							a.style.color = 'rgb(183, 183, 183)'
							//							mui.toast('取消点赞成功');
							var PraiseList = document.getElementById("PraiseList" + index);
							var praiseName = PraiseList.getElementsByTagName("font")[0];
							if(praiseName.innerHTML.indexOf('、') > -1) {
								console.log('多个人点赞')
								praiseName.innerHTML = praiseName.innerHTML.replace('、' + personalunick, '');
								praiseName.innerHTML = praiseName.innerHTML.replace(personalunick + '、', '');
							} else {
								console.log('一个人点赞')

								var comment0 = document.getElementById('"replyComment' + index + '-0-评论"');
								if(comment0) {
									document.getElementById("line" + index).className = 'mui-media-body dynamic-line'
								} else {
									document.getElementById("line" + index).className = 'mui-media-body dynamic-line mui-hidden'
								}
								PraiseList.removeChild(praiseName);
								var praiseImg = document.getElementById("praiseImg" + index);
								PraiseList.removeChild(praiseImg);

							}
						} else {
							mui.toast(data.RspTxt);
						}

					})

				}
				window.event.stopPropagation()
			});
			//点赞人多余20人 点击跳转到点赞的人的列表界面
			mui('.mui-table-view').on('tap', '.PraiseList', function() {
				console.log('跳转到点赞人列表界面')
				var index = this.id.replace('PraiseList', '')
				var LikeUsers = zonepArray[index].LikeUsers
				console.log(JSON.stringify(LikeUsers));
				events.fireToPageWithData("classSpace-persons.html", "personsList", { zanList: LikeUsers, type: 3 });
				//				mui.openWindow({
				//					url: 'classSpace-persons.html',
				//					id: 'classSpace-persons.html',
				//					styles: {
				//						top: '0px', //设置距离顶部的距离
				//						bottom: '0px'
				//					},
				//
				//					extras: {
				//						data: LikeUsers,
				//
				//					},
				//					createNew: true,
				//
				//				});
				window.event.stopPropagation()
			})
			//点击点赞的人跳转到相应界面
			mui('.mui-table-view').on('tap', '.praiseName', function() {
				console.log('点赞者id' + this.dataset.info);
				mui.openWindow({
					url: 'zone_main.html',
					id: 'zone_main.html',
					styles: {
						top: '0px', //设置距离顶部的距离
						bottom: '0px'
					},

					extras: {
						data: this.dataset.info,
						NoReadCnt: 0,
						flag: '0'
					},
					createNew: true,

				});
				window.event.stopPropagation()
			});

		});
		var addReplyView = function() {
			//			评论
			mui('.mui-table-view').on('tap', '.dynamic-icon-comment', function() {
				//				click.push('评论');
				tempIndex = this.id.replace('comment', '');
				console.log('tempIndex====' + tempIndex)
				addComment();

				window.event.stopPropagation()

			});

			//			回复评论
			mui('.mui-table-view').on('tap', '.replyComment', function() {

				tempIndex = this.id.replace('replyComment', '');
				console.log('tempIndex====' + tempIndex)
				addComment();

				window.event.stopPropagation()

			});

		}

		function addComment() {
			if(tempIndex.indexOf('-') >= 0) {
				var indexArr = tempIndex.split('-');
				var id = indexArr[0];
				var commentId = indexArr[1];
				var replyId = indexArr[2];

				var tempModel = zonepArray[id].Comments[commentId];
				if(!tempModel) {
					mui.toast('不可以回复自己');
					return;
				}
				console.log(JSON.stringify(tempModel));
				var upperId = tempModel.TabId;
				var replyUserId;
				var ReplyIdName;
				if(replyId == '评论') {
					replyUserId = tempModel.UserId
					ReplyIdName = tempModel.UserIdName
				} else {
					replyUserId = tempModel.Replys[replyId].UserId;
					ReplyIdName = tempModel.Replys[replyId].UserIdName;
				}
				if(personalUTID == replyUserId) {
					mui.toast('不可以回复自己');
					return;
				}
			}
			events.openNewWindowWithData('../show/add-comment.html', {
				tempIndex: tempIndex,
				zonepArray: zonepArray
			})

		}
		//加载数据
		function addData(index) {
			//[[InfoList],[ImageList],[InteractionList]]动态的信息
			var Data = [];
			var InfoList = []; //头部和内容
			var ImageList = []; //内容的图片
			var EncAddrList = [];
			var InteractionList = []; //底部内容

			//个人信息和内容
			//[personalImage,personalName,time,contentText]个人头像，姓名，发布时间，动态内容的文字
			//判断img是否为null，或者空
			var tempModel = zonepArray[index];

			var personalImage = tempModel.uimg;
			var personalName;
			console.log('tempModel.ugname='+tempModel.ugname)
			if(tempModel.ugname) {
				personalName = events.shortForString(tempModel.ugname, 15);
			} else {
				personalName = events.shortForString(tempModel.unick, 15);
			}

			var time = modifyTimeFormat(tempModel.PublishDate);
			var contentText = tempModel.MsgContent;
			InfoList.push(personalImage);
			InfoList.push(personalName);
			InfoList.push(time);
			InfoList.push(contentText);
			if(tempModel.EncImgAddr != '') {
				var EncImgAddrs = tempModel.EncImgAddr.split('|');
				var EncAddr = tempModel.EncAddr.split('|');

				//内容的图片
				for(var i = 0; i < EncImgAddrs.length; i++) {
					ImageList.push(EncImgAddrs[i])
					EncAddrList.push(EncAddr[i]);
				}
			}

			//底部
			//[introduce，viewCount，[praiseList],[commentList]]信息说明，浏览次数，点赞列表数组，评论列表数组
			var introduce = '上传了' + ImageList.length + '张图片到相册《手机相册》';
			var viewCount = tempModel.ReadCnt;
			var praiseList = [];
			if(tempModel.LikeUsers.length != 0) {
				for(var i = 0; i < tempModel.LikeUsers.length; i++)
					praiseList.push(tempModel.LikeUsers[i]);
			}

			//[commentList]:评论列表
			//1.评论[commenter,content]，评论者，评论内容
			//2.回复[replyer，commenter，replyContent]回复者，评论者，回复的内容
			var commentList = [];

			for(var i = 0; i < tempModel.Comments.length; i++) {

				var tempComment = tempModel.Comments[i];
				commentList.push(tempComment);

			}

			InteractionList.push(introduce);
			InteractionList.push(viewCount);
			InteractionList.push(praiseList);
			InteractionList.push(commentList);
			Data = [InfoList, ImageList, InteractionList, EncAddrList, '']
			return Data;
		}

		//设置个人空间动态为已读
		function setUserSpaceReadByUser(upString) {

			if(personalUTID == publisherId) {
				var comData = {
					userId: personalUTID, //用户ID
					spaceTypes: '[4,5,6]'
				}
				var wd;
				postDataPro_setCommentMsgReadByUser(comData, wd, function(data) {
					console.log('与我相关设置成已读success:RspCode:' + JSON.stringify(data));
				})
			}

			var NoReadCnt = plus.webview.currentWebview().data.NoReadCnt //未读条数
			//			if(NoReadCnt != 0) { //如果未读条数不为0，则设置空间状态为已读
			var comData = {
				userId: personalUTID, //用户ID
				publisherIds: upString
			};

			var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
			postDataPro_setUserSpaceReadByUser(comData, wd, function(data) {
				wd.close();
				console.log('设置空间状态为已读_setUserSpaceReadByUser' + JSON.stringify(data));
				if(data.RspCode == 0) {
					//获得主页面的webview
					var main = plus.webview.getWebviewById('../quan/tab-zone.html');
					//触发tab-zone页面的setRead事件
					mui.fire(main, 'setRead', {
						flag: 3
					});

				}

			})
			//			}
		}
		/**
		 * 下拉刷新具体业务实现
		 */
		function pulldownRefresh() {
			setTimeout(function() {
				flag = 2; //下拉刷新
				totalCnt = 0; //总页数
				tempPage = 1; //刷新时将页码归1
				var comData = {
					userId: personalUTID, //用户ID
					publisherId: publisherId, //发布用户ID
					noteType: '2', //信息类型,1云笔记,2个人空间动态
					pageIndex: (tempPage).toString(), //当前页数
					pageSize: '10' //每页记录数
				};
				//请求数据
				requestData(comData);
				mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //refresh completed
			}, 1500);
		}

		/**
		 * 上拉加载具体业务实现
		 */
		function pullupRefresh() {
			//			setTimeout(function() {
			flag = 1; //上拉加载更多
			if(tempPage * 10 > totalCnt || tempPage * 10 == totalCnt) {
				mui.toast('没有更多了...');
				mui('#pullrefresh').pullRefresh().endPullupToRefresh();
			} else {
				tempPage++;
				var comData = {
					userId: personalUTID, //用户ID
					publisherId: publisherId, //发布用户ID
					noteType: '2', //信息类型,1云笔记,2个人空间动态
					pageIndex: (tempPage).toString(), //当前页数
					pageSize: '10' //每页记录数
				};
				//请求数据
				requestData(comData);

			}

		}
		// 通过群ID获取群的正常用户
		function getBottomList() {
			//需要参数
			var comData = {
				top: '-1', //选择条数
				vvl: gid, //群ID，查询的值
				vvl1: '-1', //群员类型，0家长,1管理员,2老师,3学生,-1取全部

			};
			var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
			// 通过群ID获取群的正常用户
			postDataPro_PostGusers(comData, wd, function(data) {
				wd.close();
				console.log('通过群ID获取群的正常用户_PostGusers:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
				if(data.RspCode == 0) {
					datasource = data.RspData;
					console.log(JSON.stringify(datasource));
					var userIds = [];
					for(var i = 0; i < datasource.length; i++) {
						//群用户id数组
						tempModel = datasource[i];
						//判断img是否为null，或者空
						tempModel.uimg = updateHeadImg(tempModel.uimg, 2);
						userIds.push(tempModel.utid)
						userIds.join(',');

					}
					//					console.log('群用户：'+JSON.stringify(datasource));
					userIds = arrayDupRemoval(userIds)
					upString = arrayToStr(userIds)
					setUserSpaceReadByUser(upString);
					getAllUserSpacesByUser(upString); //获取多用户空间列表

				} else {
					mui.toast(data.RspTxt);
				}
			});
		}

		function getAllUserSpacesByUser(ids) {
			//74.(用户空间）获取多用户空间所有用户动态列表
			//所需参数
			var comData = {
				userId: personalUTID, //用户ID,登录用户
				publisherIds: ids, //发布者ID,例如[1,2,3]
				pageIndex: (tempPage).toString(), //当前页数
				pageSize: 10 //每页记录数
			};
			// 等待的对话框
			var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
			postDataPro_getAllUserSpacesByUser(comData, wd, function(data) {
				wd.close();
				console.log('74.(用户空间）获取多用户空间所有用户动态列表:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
				if(data.RspCode == 0) {
					if(data.RspData.Data.length == 0) {
						mui.toast('暂无动态')
						return;
					}
					//								setUserSpaceReadByUser();
					totalCnt = data.RspData.TotalCnt;
					var tempRspData = data.RspData.Data;

					//获取当前回调留言的个人信息，主要是头像、昵称
					var tempArray = [];
					//先遍历回调数组，获取
					for(var item in tempRspData) {
						//当前循环的model
						var tempModel0 = tempRspData[item];
						for(var i = 0; i < datasource.length; i++) {
							if(tempModel0.PublisherId == datasource[i].utid) {
								mui.extend(tempModel0, datasource[i])
							}
						}
						//将当前model中id塞到数组
						tempArray.push(tempModel0.PublisherId);
						//合并数组,点赞的人
						for(var i in tempModel0.LikeUsers) {
							tempArray = tempArray.concat(tempModel0.LikeUsers[i].userId);
							//								tempModel0.LikeUsers = arrayDupRemoval(tempModel0.LikeUsers);
						}
						//						tempArray = tempArray.concat(tempModel0.LikeUsers);
						//						tempModel0.LikeUsers = arrayDupRemoval(tempModel0.LikeUsers);
						//循环当前model中的回复数组
						for(var item1 in tempModel0.Comments) {
							//回复中的model
							var tempModel1 = tempModel0.Comments[item1];
							//将回复中的id塞到数组
							tempArray.push(tempModel1.UserId);
							tempArray.push(tempModel1.ReplyId);
							//
							for(var item2 in tempModel1.Replys) {
								//回复中的model
								var tempModel2 = tempModel1.Replys[item2];
								//将回复中的id塞到数组
								tempArray.push(tempModel2.UserId);
								tempArray.push(tempModel2.ReplyId);
							}
						}
					}
					//给数组去重
					tempArray = arrayDupRemoval(tempArray);
					//发送获取用户资料申请
					var tempData = {
						vvl: tempArray.join(), //用户id，查询的值,p传个人ID,g传ID串
						vtp: 'g' //查询类型,p(个人)g(id串)
					}

					//21.通过用户ID获取用户资料
					postDataPro_PostUinf(tempData, wd, function(data1) {
						wd.close();
						console.log('获取个人资料success:RspCode:' + data1.RspCode + ',RspData:' + JSON.stringify(data1.RspData) + ',RspTxt:' + data1.RspTxt);
						if(data1.RspCode == 0) {
							//循环当前的个人信息返回值数组
							for(var i in data1.RspData) {
								//当前model
								var tempModel = data1.RspData[i];
								//更新头像
								tempModel.uimg = updateHeadImg(tempModel.uimg, 2);
								//循环留言数组
								for(var item in tempRspData) {
									//当前循环的model
									var tempModel0 = tempRspData[item];
									//遍历点赞的人
									for(var item2 in tempModel0.LikeUsers) {
										//										console.log('item2;;;;;==' + tempModel.utid + ',' + tempModel0.LikeUsers[item2]);
										if(tempModel.utid == tempModel0.LikeUsers[item2].userId) {
											//												tempModel0.LikeUsers.splice(item2, 1, tempModel);
											tempModel0.LikeUsers[item2] = $.extend(tempModel0.LikeUsers[item2], tempModel);
										}
									}
									//									//对比id是否一致
									//									if(tempModel0.PublisherId == tempModel.utid) {
									//										//合并
									//										tempModel0 = $.extend(tempModel0, tempModel);
									//									}
									//循环当前model中的回复数组
									for(var item1 in tempModel0.Comments) {
										//回复中的model
										var tempModel1 = tempModel0.Comments[item1];
										//对比id是否一致
										if(tempModel.utid == tempModel1.UserId) {
											//添加参数
											tempModel1.UserIdName = tempModel.unick;
										}
										if(tempModel.utid == tempModel1.ReplyId) {
											//添加参数
											tempModel1.ReplyIdName = tempModel.unick;
										}
										//
										for(var item2 in tempModel1.Replys) {
											//回复中的model
											var tempModel2 = tempModel1.Replys[item2];
											//对比id是否一致
											if(tempModel.utid == tempModel2.UserId) {
												//添加参数
												tempModel2.UserIdName = tempModel.unick;
											}
											if(tempModel.utid == tempModel2.ReplyId) {
												//添加参数
												tempModel2.ReplyIdName = tempModel.unick;
											}
										}
									}
								}
							}
						}
						PostUmk(tempArray.join(), tempRspData);

					});
				} else {
					mui.toast(data.RspTxt);
				}

			})
		}

		function PostUmk(upString, tempRspData) {
			//所需参数
			var postData = {
				vvl: upString //被备注用户ID,utid或utid串
			};
			var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
			postDataPro_PostUmk(postData, wd, function(data) {
				wd.close();
				console.log('获取多用户备注_PostUmk:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
				if(data.RspCode == 0) {
					for(var j = 0; j < tempRspData.length; j++) {
						for(var k = 0; k < data.RspData.length; k++) {
							console.log(tempRspData[j].utid + '-------' + data.RspData[k].butid)
							if(tempRspData[j].utid == data.RspData[k].butid) {
								tempRspData[j].ugname = data.RspData[k].bunick;
								console.log(JSON.stringify(tempRspData))
							}
						}

					}

				} else if(data.RspCode == 0009) {

				}
				var table = document.body.querySelector('.mui-table-view');
				//判断是加载更多1，还是刷新2
				if(flag == 1) {
					console.log('上拉加载更多')
					var tempLength = zonepArray.length;
					//合并数组
					zonepArray = zonepArray.concat(tempRspData);

					mui('#pullrefresh').pullRefresh().endPullupToRefresh(); //参数为true代表没有更多数据了。
					for(var i = tempLength; i < zonepArray.length; i++) {
						id = i;
						var data = addData(i);
						dynamiclistitem.addItem(table, data, id);
					}
				} else {
					tempPage = 1;
					zonepArray = tempRspData;

					console.log('zoneArray=' + JSON.stringify(zonepArray))
					table.innerHTML = '';
					for(var i = 0; i < zonepArray.length; i++) {
						id = i;
						var data = addData(i);
						dynamiclistitem.addItem(table, data, id);
					}
				}
			})
		}
		//失去焦点事件
		function inputOnblur(input) {
			var inputComment = document.getElementById("msg-content");
			inputComment.value = '';
			document.getElementById('footer').className = '';
			document.getElementById('footer').style.display = 'none';
		}
	</script>

</html>