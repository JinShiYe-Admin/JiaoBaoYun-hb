<!--
	作者：444811716@qq.com
	时间：2016-10-22
	描述：学生动态父页面
-->
<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>学生动态</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<script src="../../js/mui.min.js"></script>
		<style>
			.mui-title {
				/*标题居左*/
				text-align: left;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">李欣芸</h1>
			<a class=" mui-icon mui-icon-contact mui-pull-right"></a>
		</header>
		<div class="mui-content"></div>
	</body>

	<script type="text/javascript">
		//启用双击监听
		mui.init({
			gestureConfig: {
				doubletap: true
			},
			subpages: [{
				url: 'studentdynamic_sub.html',
				id: 'studentdynamic_sub.html',
				styles: {
					top: '45px',
					bottom: '0px',
				}
			}]
		});

		var contentWebview = null;
		document.querySelector('header').addEventListener('doubletap', function() {
			if(contentWebview == null) {
				contentWebview = plus.webview.currentWebview().children()[0];
			}
			contentWebview.evalJS("mui('#pullrefresh').pullRefresh().scrollTo(0,0,100)");
		});

		mui.plusReady(function() {
			//显示等待窗口
			plus.nativeUI.showWaiting('正在加载中');
			//修改学生头像
			mui('.mui-bar-nav').on('tap', '.mui-icon-contact', function() {
				var btnArray = [{
					title: "拍照"
				}, {
					title: "相册"
				}];
				plus.nativeUI.actionSheet({
					title: "选择修改学生头像的方式",
					cancel: "取消",
					buttons: btnArray
				}, function(e) {
					var index = e.index;
					switch(index) {
						case 0: //取消
							break;
						case 1: //拍照
							camera();
							break;
						case 2: //相册
							pick();
							break;
					}
				});
			});

			//拍照
			function camera() {

				//获取设备默认的摄像头对象
				var cmr = plus.camera.getCamera();

				//获取摄像头支持的拍照分辨率。“WIDTH*Height”，如“400*800”
				//属性类型为String[]，若不支持此属性则返回空数组对象
				var res = cmr.supportedImageResolutions[0]; //[0]:最高的分辨率模式

				//获取摄像头支持的拍照文件格式。文件格式后缀名，如“jpg”、“png”、“bmp”
				//属性类型为String[]，若不支持此属性则返回空数组对象
				var fmt = cmr.supportedImageFormats[0];

				//console.log('支持的拍照分辨率:' + JSON.stringify(cmr.supportedImageResolutions));
				//console.log('支持的拍照文件格式:' + JSON.stringify(cmr.supportedImageFormats));
				console.log("选择的拍照分辨率: " + res + ", 选择的文件格式: " + fmt);

				//进行拍照操作cmr.captureImage( successCB, errorCB, option );
				//摄像头资源为独占资源，如果其它程序或页面已经占用摄像头，再次操作则失败
				//successCB: ( CameraSuccessCallback ) 必选 拍照操作成功的回调函数
				//errorCB: ( CameraErrorCallback ) 可选 拍照操作失败的回调函数
				//option: ( CameraOption ) 必选 摄像头拍照参数
				cmr.captureImage(function(capturedFile) {
						//拍照成功的回调
						//capturedFile ：图片的路径
						//显示等待窗口
						plus.nativeUI.showWaiting('正在加载中');
						console.log('拍照成功,图片的路径为：' + capturedFile);
						//将本地URL路径转换成平台绝对路径
						//capturedFile = 'file://' + plus.io.convertLocalFileSystemURL(capturedFile);
						//console.log('转换成平台绝对路径,图片的路径为：' + capturedFile);
						compressImage(capturedFile) //压缩图片
					},
					function(error) {
						// 拍照失败的回调
						var code = error.code; // error.code（Number类型）获取错误编码
						var message = error.message; // error.message（String类型）获取错误描述信息。
						if(code !== 11) {
							mui.toast('拍照失败！' + '错误编码：' + code + ' 描述信息：' + message, '拍照失败');
							console.log('拍照失败！' + JSON.stringify(error));
						} else {
							console.log('未拍取图片');
						}
					}, {
						resolution: res,
						format: fmt
					}
				);
			}

			//相册
			function pick() {
				//从系统相册选择文件（图片或视频）plus.gallery.pick( successCB, errorCB, option );
				//succesCB: ( GalleryPickSuccessCallback | GalleryMultiplePickSuccessCallback ) 必选 从系统相册中选择文件完成后的回调函数
				//单选时通过GalleryPickSuccessCallback回调函数返回选择的图片或视频文件路径，多选时通过GalleryMultiplePickSuccessCallback回调函数返回图片或视频文件路径。
				//errorCB: ( GalleryErrorCallback ) 可选 从系统相册中选择文件操作错误的回调函数
				//option: ( GalleryOptions ) 可选 设置选择文件的参数
				plus.gallery.pick(function(file) {
						//从相册选取图片成功的回调
						//file: ( String ) 必选 选择的图片或视频文件路径
						//显示等待窗口
						plus.nativeUI.showWaiting('正在加载中');
						console.log('从相册选取图片成功,图片的路径为：' + file);
						openImage(file); //打开新页面查看图片
					}, function(error) {
						//从相册选取图片失败的回调
						var code = error.code; // 错误编码
						var message = error.message; // 错误描述信息
						if(code != 12) {
							mui.toast('从相册选取图片失败！' + '错误编码：' + code + '描述信息：' + message);
							console.log('从相册选取图片失败！' + JSON.stringify(error));
						} else {
							console.log('未选取图片');
						}
					}
					//, option
					//设置选择文件的参数
					//animation: (Boolean 类型 )是否显示系统相册文件选择界面的动画
					//filename: (String 类型 )选择文件保存的路径
					//filter: (GalleryFilter 类型 )相册中选择文件类型过滤器
					//系统相册选择器中可选择的文件类型，可设置为仅选择图片文件（“image”）、视频文件（“video”）或所有文件（“none”），默认值为“image”。
				);
			}

			//压缩图片并且在新页面显示压缩后的图片
			function compressImage(filepath) {
				//图片压缩转换，plus.zip.compressImage( options, successCB, errorCB);
				//options: ( CompressImageOptions ) 必选
				//图片压缩转换的参数
				//successCB: ( CompressImageSuccessCallback ) 可选
				//图片压缩转换操作成功回调，操作成功时调用。
				//errorCB: ( ZipErrorCallback ) 可选
				//图片压缩转换操作失败回调，操作失败时调用。
				plus.zip.compressImage({
						src: filepath,
						dst: filepath,
						overwrite:true
					},
					function(event) {
						//图片压缩成功
						var target = event.target; // 压缩转换后的图片url路径，以"file://"开头
						var size = event.size; // 压缩转换后图片的大小，单位为字节（Byte）
						var width = event.width; // 压缩转换后图片的实际宽度，单位为px
						var height = event.height; // 压缩转换后图片的实际高度，单位为px
						openImage(target); //打开新页面查看图片
					},
					function(error) {
						//图片压缩失败
						var code = error.code; // 错误编码
						var message = error.message; // 错误描述信息
						mui.toast('图片压缩失败！' + '错误编码：' + code + '描述信息：' + message);
						console.log('图片压缩失败！' + JSON.stringify(error));
						//关闭等待窗口
						plus.nativeUI.closeWaiting();
					});
			}

			/**
			 * 打开新页面查看选择的图片
			 * @param {Object} path 图片路径
			 */
			function openImage(path) {
				mui.openWindow({
					url: 'studentpersonalimge.html',
					id: 'studentpersonalimge.html',
					waiting: {
						autoShow: false,
					},
					extras: {
						path: path, //传入图片路径
					}
				});
			}

		});
	</script>

</html>