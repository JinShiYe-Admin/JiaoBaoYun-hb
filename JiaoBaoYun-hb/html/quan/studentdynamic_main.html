<!--
	作者：444811716@qq.com
	时间：2016-10-22
	描述：学生动态父页面
-->
<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>学生动态</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/qiniu/qiniu.js"></script>
		<script type="text/javascript" src="../../js/utils/cryption.js"></script>
		<script type="text/javascript" src="../../js/utils/events.js"></script>
		<script type="text/javascript" src="../../js/publicProtocol.js"></script>
		<script type="text/javascript" src="../../js/utils/CloudFileUtil.js"></script>
		<script type="text/javascript" src="../../js/cloud/AndroidFileSystem.js"></script>
		<script type="text/javascript" src="../../js/utils/UploadHeadImage.js"></script>
		<style>
			.mui-title {
				/*标题居左*/
				text-align: left;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 id="title" class="mui-title"></h1>
			<a id="stuImage" class="mui-icon mui-icon-contact mui-pull-right"></a>
		</header>
		<div class="mui-content"></div>
	</body>

	<script type="text/javascript">
		//启用双击监听
		mui.init({
			gestureConfig: {
				doubletap: true
			},
		});

		var contentWebview = null;
		document.querySelector('header').addEventListener('doubletap', function() {
			if(contentWebview == null) {
				contentWebview = plus.webview.currentWebview().children()[0];
			}
			contentWebview.evalJS("mui('#pullrefresh').pullRefresh().scrollTo(0,0,100)");
		});

		mui.plusReady(function() {
			//显示等待窗口
			var wd = events.showWaiting();
			//---获取数据并传递数据---start---
			var main = plus.webview.currentWebview(); //获取当前窗体对象
			var data = main.data; //接收A页面传入参数值
			console.log('main-data:' + JSON.stringify(data));

			document.getElementById("title").innerText = data.studentName;

			//创建子页面
			events.createSubAppendMain(main, 'studentdynamic_sub.html', data, function(sub) {
				setTimeout(function() {
					wd.close();
				}, 250);
				events.changeTopPocket();
			});
			//---获取数据并传递数据---end---

			//资料头像修改
			var stuImage = document.getElementById("stuImage");
			UploadHeadImage.addListener(stuImage, 1, {
				id: data.studentId, //资料id
				name: data.studentName //资料名称
			}, function(successCB) {
				console.log('上传并修改资料头像，成功的回调' + JSON.stringify(successCB));
				mui.toast('资料头像更新成功');
				//获得主页面的webview
				var cloud_home = plus.webview.getWebviewById('../cloud/cloud_home.html');
				//触发tab-zone页面的setRead事件
				mui.fire(cloud_home, 'stuImgeChanged', {
					id: data.studentId,
					img: successCB
				});
			}, function(errorCB) {
				console.log('上传并修改资料头像失败 ' + JSON.stringify(errorCB));
				mui.toast('资料头像更新失败' + JSON.stringify(errorCB));
			});
		});
	</script>

</html>