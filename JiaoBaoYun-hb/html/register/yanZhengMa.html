<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<style>
			.mui-btn {
				padding: 10px;
			}
			
			.mui-input-group:before {
				background: #fff;
			}
			
			.mui-input-group:after {
				background: #fff;
			}
			
			.row1:after {
				background-color: #e4e4e4;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title"></h1>
		</header>
		<div class="mui-content">
			<div id="tishi" style="padding: 30px;text-align: center;">
				<a style="color: black;font-size: 20px;">短信验证码已发送，请填写验证码</a>
			</div>
			<form class="mui-input-group">
				<div class="mui-input-row row1">
					<label style="font-size: 15px;">手机号</label>
					<input type="text" id="phoneNumber" placeholder="请输入手机号" readonly="readonly" style="color: gray;">
					<input type="text" id="phoneNumber" placeholder="请输入手机号">
				</div>
				<div class="mui-input-row">
					<label style="font-size: 15px;">验证码</label>
					<input type="text" id="yanzheng" placeholder="请输入验证码">
				</div>
			</form>
			<div class="mui-content-padded">
				<button id='register' class="mui-btn mui-btn-block mui-btn-primary" style="background: #13b7f6; border: none;">提交</button>
			</div>
		</div>
		<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<!--界面中用到的事件-->
		<script src="../../js/utils/events.js" type="text/javascript" charset="utf-8"></script>
		<!--本地存储-->
		<script src="../../js/libs/myStorage/myStorage.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/storageKeyName.js" type="text/javascript" charset="utf-8"></script>
		<!--加密-->
		<script src="../../js/libs/RSA/Barrett.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/libs/RSA/BigInt.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/libs/RSA/RSA.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/utils/RSAEncrypt.js" type="text/javascript" charset="utf-8"></script>
		<!---->
		<script src="js/mui.enterfocus.js" type="text/javascript" charset="utf-8"></script>
		<!--网络请求-->
		<script src="../../js/utils/postData.js" type="text/javascript" charset="utf-8"></script>
		<!--签名-->
		<script src="../../js/libs/crypto-js/require.js"></script>
		<script src="../../js/utils/sortSign.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/utils/signHmacSHA1.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/libs/jquery.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			mui.init();
			mui.plusReady(function() {
				//				events.preLoad('index.html');
				var regFlag;
				var phoneNumBox = document.getElementById("phoneNumber");
				phoneNumBox.value = '';
				var codeBox = document.getElementById("yanzheng");

				window.addEventListener('yanzhengma', function(event) {
					var temp = event.detail.data;
					console.log('传值的电话号码为：' + JSON.stringify(event.detail));
					codeBox.value = '';
					phoneNumBox.value = temp.phone;
					regFlag = temp.flag;
				});
				events.addTap('register', function() {
					//先本地判断验证码
					//					if(document.getElementById("yanzheng").value != '123456') {
					//						mui.toast('验证码错误');
					//						return;
					//					}
					//需要加密的数据
					var enData = {
						uid: document.getElementById("phoneNumber").value,
						code: document.getElementById("yanzheng").value
					};
					// 等待的对话框
					var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
					//握手协议
					//需要加密的数据
					var enData0 = {};
					//不需要加密的数据
					var comData;
					if(regFlag == 0) { //注册
						comData = {
							uuid: plus.device.uuid,
							shaketype: 'reg',
							appid: plus.runtime.appid
						};
					} else { //验证码登录1
						comData = {
							uuid: plus.device.uuid,
							shaketype: 'login',
							appid: plus.runtime.appid
						};
					}
					//发送网络请求，data为网络返回值
					postDataEncry(storageKeyName.MAINURL + 'PostShakeHand', enData0, comData, 0, wd, function(data) {
						wd.close();
						console.log('90909090success:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
						if(data.RspCode == 0) {
							//存储到手机本地
							window.myStorage.setItem(window.storageKeyName.SHAKEHAND, data.RspData);
							//标注为登录状态
							data.RspData.isLogin = 1;
							//判断是注册0，还是验证码模式登录1
							if(regFlag == 0) { //注册0
								//发送网络请求，data为网络返回值
								postDataEncry(storageKeyName.MAINURL + 'PostReg', enData, comData, 0, wd, function(data) {
									//成功，关闭等待框
									wd.close();
									console.log('11111success12:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
									//判断返回值是否正确
									if(data.RspCode == 0) {
										//解析省市代码
										if(data.RspData.uarea.length > 0) {
											var tempArray = data.RspData.uarea.split('|');
											if(tempArray.length > 0) {
												var temp0 = tempArray[0].split(' ');
												var temp1 = tempArray[1].split(' ');
												var model_area = {
													procode: temp0[0], //省份code，自己添加的参数
													proname: temp1[0], //省份名称，自己添加的参数
													acode: temp0[1], //节点代码,通用6位,前两位为省份编码,中间两位为城市编码,后两位为区县编码--城市代码
													aname: temp1[1], //节点名称--城市名称
													atype: '' //节点类型,0省1城市2区县
												}
												data.RspData.uarea = model_area;
											}
										}
										//存储到手机本地
										window.myStorage.setItem(window.storageKeyName.PERSONALINFO, data.RspData);
										//判断是否有密码，如果有，直接到主界面，没有，则设置密码
										events.infoChanged();
										if(data.RspData.ispw == 1) {
											//跳转到主界面
											events.openNewWindowWithData('../index/index.html', '');
										} else {
											//跳转到修改密码界面
											var temp;
											events.openNewWindowWithData('modify_password.html', temp);
											events.fireToPageNone('modify_password.html', 'registerPW');
										}
									} else {
										mui.toast(data.RspTxt);
									}

								});
							} else { //验证码模式登录1
								console.log('yanzhengma denglu');
								//发送网络请求，data为网络返回值
								postDataEncry(storageKeyName.MAINURL + 'PostCodeLogin', enData, comData, 0, wd, function(data) {
									//成功，关闭等待框
									wd.close();
									console.log('11222success:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
									//判断返回值是否正确
									if(data.RspCode == 0) {
										//解析省市代码
										if(data.RspData.uarea.length > 0) {
											var tempArray = data.RspData.uarea.split('|');
											if(tempArray.length > 0) {
												var temp0 = tempArray[0].split(' ');
												var temp1 = tempArray[1].split(' ');
												var model_area = {
													procode: temp0[0], //省份code，自己添加的参数
													proname: temp1[0], //省份名称，自己添加的参数
													acode: temp0[1], //节点代码,通用6位,前两位为省份编码,中间两位为城市编码,后两位为区县编码--城市代码
													aname: temp1[1], //节点名称--城市名称
													atype: '' //节点类型,0省1城市2区县
												}
												data.RspData.uarea = model_area;
											}
										}
										if(data.RspCode != 0000) {
											mui.toast(data.RspTxt);
											return;
										} else {
											//存储到手机本地
											window.myStorage.setItem(window.storageKeyName.PERSONALINFO, data.RspData);
											//跳转到修改密码界面
											var temp;
											events.openNewWindowWithData('modify_password.html', temp);
											events.fireToPageNone('modify_password.html', 'registerPW');
											//										events.fireToPageNone('../quan/tab-zone.html','infoChanged');
										}
									} else {
										mui.toast(data.RspTxt);
									}
								});
							}
						} else {
							mui.toast(data.RspTxt);
						}
					});

				});
			});
		</script>
	</body>

</html>