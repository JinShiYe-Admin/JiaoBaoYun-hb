<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-icon mui-icon-right-nav mui-pull-right" id="cancelBtn" style="font-size: 18px;">取消</a>
			<h1 class="mui-title">修改密码</h1>
		</header>
		<div class="mui-content">
			<br/>
			<form class="mui-input-group">
				<!--<div class="mui-input-row">
					<label>原密码</label>
					<input type="text" id="phoneNumber" placeholder="请输入手机号 ">
				</div>-->
				<div class="mui-input-row">
					<label>新密码</label>
					<input type="password" id="password0" placeholder="请输入新密码 ">
				</div>
				<div class="mui-input-row">
					<label>新密码</label>
					<input type="password" id="password1" placeholder="重新输入新密码 ">
				</div>
			</form>
			<div class="mui-content-padded">
				<button id='modifypassword' class="mui-btn mui-btn-block mui-btn-primary">修改密码</button>
			</div>
		</div>
		<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<!--界面中用到的事件-->
		<script src="../../js/utils/events.js" type="text/javascript" charset="utf-8"></script>
		<!--本地存储-->
		<script src="../../js/libs/myStorage/myStorage.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/storageKeyName.js" type="text/javascript" charset="utf-8"></script>
		<!--加密-->
		<script src="../../js/libs/RSA/Barrett.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/libs/RSA/BigInt.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/libs/RSA/RSA.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/utils/RSAEncrypt.js" type="text/javascript" charset="utf-8"></script>
		<!---->
		<script src="js/mui.enterfocus.js" type="text/javascript" charset="utf-8"></script>
		<!--网络请求-->
		<script src="../../js/utils/postData.js" type="text/javascript" charset="utf-8"></script>
		<!--签名-->
		<script src="../../js/libs/crypto-js/require.js"></script>
		<script src="../../js/utils/sortSign.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/utils/signHmacSHA1.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/libs/jquery.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			mui.init();
			mui.plusReady(function() {
				//点击修改密码方法
				events.addTap('modifypassword', function() {
					var newpw0 = document.getElementById("password0").value;
					var newpw1 = document.getElementById("password1").value;
					if(!newpw0) {
						mui.toast('请输入新密码');
						return;
					}
					if(newpw0.length < 6) {
						mui.toast('密码不得小于6位');
						return;
					}
					if(!newpw1) {
						mui.toast('请确认新密码');
						return;
					}
					if(newpw0 != newpw1) {
						mui.toast('两次输入的密码不一致');
					}

					//握手协议
					//需要加密的数据
					var enData0 = {};
					//不需要加密的数据
					var comData0 = {
						uuid: plus.device.uuid,
						shaketype: 'repw',
						appid: plus.runtime.appid
					};
					// 等待的对话框
					var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
					//发送网络请求，data为网络返回值
					postDataEncry(storageKeyName.MAINURL + 'PostShakeHand', enData0, comData0, 0, wd, function(data) {
						wd.close();
						console.log('90909090success:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
						if(data.RspCode == 0) {
							//存储到手机本地
							window.myStorage.setItem(window.storageKeyName.SHAKEHAND, data.RspData);
							//获取个人信息
							//					var personalInfo = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).UserPhone;
							var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid;
							var personalToken = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).token;
							//需要加密的数据
							var enData = {
								utid: personalUTID,
								pw: document.getElementById("password0").value
							};
							//不需要加密的数据
							var comData = {
								uuid: plus.device.uuid,
								shaketype: 'repw',
								appid: plus.runtime.appid,
								token: personalToken
							};
							//发送网络请求，data为网络返回值
							postDataEncry(storageKeyName.MAINURL + 'PostRePW', enData, comData, 0, wd, function(data) {
								//成功，关闭等待框
								wd.close();
								console.log('11111success:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
								if(data.RspCode != 0000) {
									mui.toast(data.RspTxt);
									return;
								} else {
									window.myStorage.getItem(window.storageKeyName.PERSONALINFO).ispw = '1';
									mui.toast('修改密码成功');
									events.openNewWindowWithData('../../html/index.html','');
								}
							});
						} else {
							mui.toast(data.RspTxt);
						}
					});
				});
				//取消按钮
				events.addTap('cancelBtn', function() {
					events.openNewWindowWithData('../../html/index.html','');
				});
			});
		</script>
	</body>

</html>