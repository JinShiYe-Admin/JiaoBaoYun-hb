<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/utils/common.css" rel="stylesheet">
		<style>
			.mui-scroll-wrapper {
				padding-top: 44px;
			}
			
			.mui-bar~.mui-content .mui-fullscreen {
				top: 44px;
				height: auto;
			}
			
			.mui-pull-top-tips {
				position: absolute;
				top: -20px;
				left: 50%;
				margin-left: -25px;
				width: 40px;
				height: 40px;
				border-radius: 100%;
				z-index: 1;
			}
			
			.mui-bar~.mui-pull-top-tips {
				top: 24px;
			}
			
			.mui-pull-top-wrapper {
				width: 42px;
				height: 42px;
				display: block;
				text-align: center;
				background-color: #efeff4;
				border: 1px solid #ddd;
				border-radius: 25px;
				background-clip: padding-box;
				box-shadow: 0 4px 10px #bbb;
				overflow: hidden;
			}
			
			.mui-pull-top-tips.mui-transitioning {
				-webkit-transition-duration: 200ms;
				transition-duration: 200ms;
			}
			
			.mui-pull-top-tips .mui-pull-loading {
				/*-webkit-backface-visibility: hidden;
				-webkit-transition-duration: 400ms;
				transition-duration: 400ms;*/
				margin: 0;
			}
			
			.mui-pull-top-wrapper .mui-icon,
			.mui-pull-top-wrapper .mui-spinner {
				margin-top: 7px;
			}
			
			.mui-pull-top-wrapper .mui-icon.mui-reverse {
				/*-webkit-transform: rotate(180deg) translateZ(0);*/
			}
			
			.mui-pull-bottom-tips {
				text-align: center;
				background-color: #efeff4;
				font-size: 15px;
				line-height: 40px;
				color: #777;
			}
			
			.mui-pull-top-canvas {
				overflow: hidden;
				background-color: #fafafa;
				border-radius: 40px;
				box-shadow: 0 4px 10px #bbb;
				width: 40px;
				height: 40px;
				margin: 0 auto;
			}
			
			.mui-pull-top-canvas canvas {
				width: 40px;
			}
			
			.mui-slider-indicator.mui-segmented-control {
				background-color: #efeff4;
			}
			/*头像样式*/
			
			.head-img,
			.head-portrait {
				width: 4rem;
				height: 4rem;
				border-radius: 50%;
				/*max-width: 20%;*/
			}
			
			.head-img {
				max-width: 15%;
			}
			/**
 * 中间信息宽度
 */
			
			.info-container {
				max-width: 60%;
				padding-left: .5rem;
			}
			
			.attentioned-btn,
			.attention-btn {
				max-width: 25%;
				float: right;
				margin-top: 1rem;
				color: #fff;
				border: 1px solid #1db8F1;
				/*background-color: #1db8F1;*/
			}
			/*需关注button*/
			
			.attention-btn {
				color: #fff;
				border: 1px solid #1db8F1;
			}
			/*已关注的显示*/
			
			.attentioned-btn {
				color: lightgrey;
				border: 1px solid lightgrey;
			}
			/*.mui-table-view-cell:last-of-type{
	padding-right: .5rem;
}*/
			
			.li-container {
				height: 6rem;
				/*text-align: center;*/
			}
			/*外边框+关注内buttton字体颜色*/
			
			.mui-btn-outlined.attention-btn {
				color: #1db8F1;
			}
			/*点击后的颜色*/
			
			.attention-btn:enabled:active {
				color: white;
				border: 1px solid #1db8F1;
				background-color: #1db8F1;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">他关注的人</h1>
		</header>
		<div id="refreshContainer" class="mui-content mui-fullscreen" style="z-index:0">
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<ul id="list-container" class="mui-table-view">

					</ul>
				</div>
			</div>
		</div>

		<script src="../../js/mui.min.js"></script>
		<!--<script src="../../js/utils/h5fresh.js"></script>-->
		<script src="../../js/mui.pullToRefresh.js"></script>
		<script src="../../js/mui.pullToRefresh.material.js"></script>
		<script src="../../js/utils/events.js"></script>
		<script src="../../js/publicProtocol.js"></script>
		<script src="../../js/publicQiuzhiProtocol.js"></script>
		<script>
			var personalUTID; //登录用户ID
			var ExpertsInfo; //专家详细页传来的 专家信息
			var pageIndex = 1; //请求数据页面
			var totalPageCount; //总页码
			var flagRef = 0; //是刷新0，还是加载更多1
			var personArray = []; //他关注的人总数组

			mui.init();

			mui.plusReady(function() {
				//从专家页面传值
				window.addEventListener('heAttentionPersons', function(event) {
					//赋值
					ExpertsInfo = event.detail.data;
					console.log('专家回答页传值：' + JSON.stringify(ExpertsInfo));
					//清除节点
					document.getElementById('list-container').innerHTML = "";
					//27.获取某个用户的关注人列表
					getFocusUsersByUser(ExpertsInfo.UserId);
				});
				setListener();
				//上拉下拉注册
				mui(".mui-scroll-wrapper .mui-scroll").pullToRefresh({
					down: {
						callback: function() {
							//清除节点

							document.getElementById('list-container').innerHTML = "";
							var self = this;
							console.log("下拉刷新");
							pageIndex = 1;
							flagRef = 0;
							//27.获取某个用户的关注人列表
							getFocusUsersByUser(ExpertsInfo.UserId);
							self.endPullDownToRefresh();
						}
					},
					up: {
						callback: function() {

							var self = this;
							console.log("上拉加载更多");
							flagRef = 1;
							if(pageIndex < totalPageCount) {
								//27.获取某个用户的关注人列表
								getFocusUsersByUser(ExpertsInfo.UserId);
							} else {
								mui.toast('没有更多了');
							}
							self.endPullUpToRefresh();
						}
					}
				});

			});

			//27.获取某个用户的关注人列表
			function getFocusUsersByUser(focusId) {
				if(pageIndex == 1) {
					events.clearChild(document.getElementById('list-container'));
				}
				personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid; //当前登录账号utid
				//需要加密的数据
				var comData = {
					userId: personalUTID, //用户ID
					focusId: focusId, //关注用户ID,查看用户
					pageIndex: '1', //当前页数
					pageSize: 10 //每页记录数,传入0，获取总记录数
				};
				// 等待的对话框
				var wd = events.showWaiting();
				//27.获取某个用户的关注人列表
				postDataQZPro_getFocusUsersByUser(comData, wd, function(data) {
					wd.close();
					console.log('27.获取某个用户的关注人列表:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
					if(data.RspCode == 0) {
						//总页数
						totalPageCount = data.RspData.TotalPage;
						if(flagRef == 0) { //刷新
							personArray = data.RspData.Data;
							var personIds = [];
							//遍历获取关注人id数组
							for(var i in personArray) {
								personIds.push(personArray[i].UserId);
							}
							//通过id数组，获取人员资料，并重组
							requirePersonInfo(personIds, personArray);
						} else { //加载更多
							pageIndex++;
							//合并数组
							personArray = personArray.concat(data.RspData.Data);
							var personIds = [];
							//遍历获取关注人id数组
							for(var i in personArray) {
								personIds.push(personArray[i].UserId);
							}
							//通过id数组，获取人员资料，并重组
							requirePersonInfo(personIds, personArray);
						}
					} else {
						mui.toast(data.RspTxt);
					}
				});
			};

			/**
			 * 获取个人信息 并重组数据
			 * @param {Object} personIds
			 * @param {Object} persons
			 */
			var requirePersonInfo = function(personIds, persons) {
				var wd = events.showWaiting();
				postDataPro_PostUinf({
						vtp: 'g',
						vvl: personIds.toString()
					},
					wd,
					function(data) {
						console.log('通过用户id获取的用户资料数据：' + JSON.stringify(data));
						events.closeWaiting();
						if(data.RspCode == 0) {
							var personsData = data.RspData;
							for(var i in personArray) {
								for(var j in personsData) {
									if(personArray[i].UserId == personsData[j].utid) {
										jQuery.extend(personArray[i], personsData[j]);
										break;
									}
								}
							}

						} else {
							mui.toast(data.RspTxt);
						}
						//放置数据
						setPersonRecord(personArray);
					})
			}
			/**
			 * 放置邀请回答记录数据
			 * @param {Object} list 回答记录数据
			 */
			var setPersonRecord = function(list) {
				var listContainer = document.getElementById('list-container');
				for(var i in list) {
					createList(listContainer, list[i], i);

				}
			}
			/**
			 * 拼接他关注的人记录
			 * @param {Object} listContainer
			 * @param {Object} record
			 */
			var createList = function(listContainer, record, index) {
				var li = document.createElement('li');
				li.className = 'mui-table-view-cell';
				li.setAttribute('data-info', JSON.stringify(record));
				//拼接显示
				li.innerHTML = '<a><div class="li-container"><div class="head-img display-inlineBlock"><img class="head-portrait person-info" src="' + updateHeadImg(record.uimg, 2) + '"/></div>' +
					'<div class="info-container display-inlineBlock"><h5 class="person-name single-line person-info">' + record.unick + '</h5>' +
					'<p class="person-info single-line">' + record.UserNote + '</p></div>' +
					'<button type="button" class="mui-btn mui-btn-outlined ' + getButtonContent(record.FocusType).classInfo + ' " >' + getButtonContent(record.FocusType).inner + '</button></div></a>'
				listContainer.appendChild(li);
				li.querySelector('.mui-btn').personInfo = record;
			}
			/**
			 * 根据信息，设置关注状况
			 * @param {Object} focusType 
			 * 0 未关注
				1 已关注
				2 相互关注
				3 无法关注（自己）
			 */
			var getButtonContent = function(focusType) {
				var buttonInfo = {};
				switch(focusType) {
					case 0:
					case 2:
						buttonInfo.classInfo = 'attention-btn';
						buttonInfo.inner = '关注';
						break;
					case 1:
						buttonInfo.classInfo = 'attentioned-btn';
						buttonInfo.inner = '已关注';
						break;
					case 3:
						buttonInfo.classInfo = 'attentioned-btn';
						buttonInfo.inner = '已互关';
						break;
					case 5:
						buttonInfo.classInfo = 'display-none';
						buttonInfo.inner = '自己'
					default:
						break;
				}
				return buttonInfo;
			}
			/**
			 * 设置关注状态
			 * @param {Object} focusId 被关注人的id
			 * @param {Object} type 关注状态,0 不关注,1 关注
			 */
			var setFocus = function(item, type) {
				console.log("item.personInfo:" + JSON.stringify(item.personInfo));
				var wd = events.showWaiting();
				postDataQZPro_setUserFocus({
					userId: personalUTID, //登录用户ID
					focusUserId: item.personInfo.UserId, //关注用户ID
					status: type //关注状态,0 不关注,1 关注
				}, wd, function(data) {
					console.log('获取的关注结果：' + JSON.stringify(data));
					wd.close();
					if(data.RspCode == 0 && data.RspData.Result == 1) {
						if(type) {
							mui.toast('关注成功！')
						} else {
							mui.toast('取消关注成功！')
						}
						setButtonInfoType(item);
						var buttonInfo = getButtonContent(item.personInfo.FocusType);
						item.innerText = buttonInfo.inner;
						item.className = 'mui-btn mui-btn-outlined' + buttonInfo.classInfo;

					}
				})
			}
			/**
			 *	关注状态关注的
			 * @param {Object} item
			 */
			var setButtonInfoType = function(item) {
					switch(item.personInfo.FocusType) {
						case 0:
							item.personInfo.FocusType = 1;
							break;
						case 1:
							item.personInfo.FocusType = 0;
							break;
						case 2:
							item.personInfo.FocusType = 3;
							break;
						case 3:
							item.personInfo.FocusType = 2;
							break;
						default:
							break;
					}
					var setListener = function() {
						mui('.mui-table-view').on('tap', '.attention-btn', function() {
							var focusType;
							switch(this.personInfo.FocusType) {
								case 0:
									focusType = 1;
									break;
								case 1:
									//								case 2:
								case 3:
									focusType = 0;
									break;
								default:
									break;
							}
							//					if(focusType == 1) {
							setFocus(this, focusType);
							//					}
						});

						//点击头像、昵称、简介进入专家主页
						mui('.mui-table-view').on('tap', '.person-info', function() {
							//获取到当前控件的父节点
							var parent = this.parentNode.parentNode.parentNode.parentNode;
							//得到父节点的值
							var info = JSON.parse(parent.getAttribute('data-info'));
							events.openNewWindowWithData('expert-detail.html', info);
							events.fireToPageWithData('expert-detail.html', 'expert-detail', info);
						});
					}
		</script>
	</body>

</html>