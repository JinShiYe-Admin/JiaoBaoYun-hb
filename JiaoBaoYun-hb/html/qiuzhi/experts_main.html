<!--
	作者：444811716@qq.com
	时间：2017-02-23
	描述：专家列表
-->
<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/iconfont/iconfont.css" />
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<link rel="stylesheet" href="../../css/utils/pullToRefresh.css" />
		<style>
			body,
			.mui-content {
				background-color: white;
			}

			.mui-slider .mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active {
				border-bottom: 2px solid #00A5E0;
			}

			.mui-scroll-wrapper {
				background-color: white;
			}

			.mui-segmented-control.mui-scroll-wrapper {
				height: 40px;
			}

			.mui-slider-indicator.mui-segmented-control {
				background-color: #F8F9FB;
			}

			.more-navigation {
				position: absolute;
				height: 40px;
				right: 0;
				top: 0;
				text-align: center;
				padding: 5px 10px;
				border: solid thin #000000 2px;
				box-shadow: -5px 0 5px -3px #d2d2d2;
				z-index: 999;
				background-color: #F8F9FB;
			}

			.more-navigation p {
				line-height: 50%;
			}

			.more-navigation a {
				color: #8f8f94;
			}

			.mui-slider .mui-segmented-control.mui-segmented-control-inverted~.mui-slider-group .mui-slider-item {
				border-top: none;
				border-bottom: none;
			}

			.mui-table-view-cell:before,
			.mui-table-view-cell:after {
				left: 0px;
			}

			.mui-slider .mui-slider-group .mui-slider-item .mui-table-view-cell:after {
				height: 1px;
			}

			.mui-pull-bottom-wrapper {
				/*底部加载更多区域*/
				background-color: white;
			}

			.mui-slider .mui-slider-group .mui-slider-item img {
				height: 50px;
				width: 50px;
				max-height: 50px;
				max-width: 50px;
			}

			.mui-table-view-cell {
				line-height: 32px;
			}

			.mui-media-object.expert-headimg {
				/*专家头像*/
				border-radius: 50% !important;
				margin-top: 4px;
				margin-bottom: 10px;
			}

			.expert-name {
				/*专家姓名*/
				width: 35%;
			}

			.mui-media-object.expert-level {
				/*专家等级*/
				height: 20px !important;
				width: 20px !important;
			}

			.expert-answernum {
				/*专家回答数*/
				color: red;
			}

			.mui-btn-blue {
				/*提问按钮*/
				background-color: #1DB8F1;
				border: 1px solid #1DB8F1;
				margin-top: 15px;
			}

			.expert-usernote {
				/*专家简介*/
				line-height: 21px;
				font-size: 13px;
				color: #666666;
				margin-right: 20px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">专家列表</h1>
		</header>
		<div class="mui-content" id="content">
			<!--<div id="slider" class="mui-slider mui-fullscreen">
				<div id="sliderSegmentedControl" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<div id="topList" class="mui-scroll">
					</div>
				</div>
				<div class="more-navigation">
					<a class="iconfont icon-qita11"></a>
					<p>导航</p>
				</div>
				<div id="sliderGroup" class="mui-slider-group">
				</div>
			</div>-->
		</div>
	</body>
	<script src="../../js/mui.min.js"></script>
	<script type="text/javascript" src="../../js/mui.pullToRefresh.js"></script>
	<script type="text/javascript" src="../../js/mui.pullToRefresh.material.js"></script>
	<script type="text/javascript" src="../../js/publicProtocol.js"></script>
	<script type="text/javascript" src="../../js/utils/events.js"></script>
	<script type="text/javascript" src="../../js/publicQiuzhiProtocol.js"></script>
	<script type="text/javascript">
		//启用双击监听
		mui.init({
			gestureConfig: {
				doubletap: true
			}
		});

		var mainData; //接收页面传入参数值
		var pullToRefresh = []; //存储下拉上拉的控件
		var sliderId = ''; //记录选择的话题

		mui.plusReady(function() {
			events.closeWaiting();
			var main = plus.webview.currentWebview(); //获取当前窗体对象
			mainData = main.data; //接收页面传入参数值
			console.log('experts_main.html:' + JSON.stringify(mainData));

			document.getElementById("content").innerHTML = '\
				<div id="slider" class="mui-slider mui-fullscreen">\
					<div id="sliderSegmentedControl" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">\
						<div id="topList" class="mui-scroll">\
						</div>\
					</div>\
					<div class="more-navigation">\
						<a class="iconfont icon-qita11"></a>\
						<p>导航</p>\
					</div>\
					<div id="sliderGroup" class="mui-slider-group">\
					</div>\
				</div>';

			document.getElementById("sliderSegmentedControl").style.width = document.body.querySelector('.more-navigation').offsetLeft + 'px';

			//顶部增加话题和底部列表的框架
			addChannels(mainData.channelInfo, mainData.allChannels, function() {
				//				var gallery = mui('.mui-slider');
				//				gallery.slider({
				//					interval: 0 //自动轮播周期，若为0则不自动播放，默认为0；
				//				});

				mui('#slider').slider();

				//				var scrollTop = mui('#sliderSegmentedControl').scroll(); //话题列表区域
				//				var element = document.getElementById(sliderId);
				//				var more = document.body.querySelector('.more-navigation');
				//				console.log('element.offsetLeft ' + element.offsetLeft + '|' + element.offsetWidth + '|' + more.offsetLeft);
				//				if(more.offsetLeft < (element.offsetLeft + element.offsetWidth)) {
				//					setTimeout(function() {
				//						scrollTop.scrollTo(-(element.offsetLeft + element.offsetWidth - more.offsetLeft), 0, 100);
				//					}, 4000);
				//				}

				pullRefresh();
				//获取专家
				getExpertsArray(mainData.channelInfo.TabId, 1);
			});

			//滑动底部列表
			document.querySelector('.mui-slider').addEventListener('slide', function() {
				console.log('slide ' + event.detail.slideNumber);
				mui('.mui-control-item').each(function(index, element) {
					if(index == event.detail.slideNumber) {
						document.getElementById(sliderId).className = 'mui-control-item';
						element.className = 'mui-control-item mui-active';
						sliderId = element.id;
					}
				});
				var id = 'bot_' + sliderId.replace('top_', '');
				var element = document.getElementById(id);
				var info = JSON.parse(element.getAttribute('data-info'));
				var page = JSON.parse(element.getAttribute('data-page'));
				console.log('slide ' + JSON.stringify(info));
				console.log('slide ' + JSON.stringify(page));
				if(!page) {
					getExpertsArray(info.TabId, 1);
				}
			});

			//点击提问
			mui('#sliderGroup').on('tap', '.mui-btn-blue', function() {
				var element = this.parentNode.parentNode;
				//专家的信息
				var expert = JSON.parse(element.getAttribute('data-info'));
				//当前话题
				var id = 'bot_' + sliderId.replace('top_', '');
				var element2 = document.getElementById(id);
				var channelInfo = JSON.parse(element2.getAttribute('data-info'));
				//所有话题
				var allChannels = mainData.allChannels;
				console.log('expert ' + JSON.stringify(expert));
				console.log('channelInfo ' + JSON.stringify(channelInfo));
				console.log('allChannels ' + JSON.stringify(allChannels));
				//传递的数据
				var transportData = {
					expert: expert,
					curChannel: channelInfo,
					allChannels: allChannels
				}
				console.log('transportData ' + JSON.stringify(transportData));
				events.openNewWindowWithData('qiuzhi-newQ.html',transportData);
			});
		});

		/**
		 * 顶部增加话题和底部列表的框架
		 * @param {Object} channelInfo 当前话题
		 * @param {Object} allChannels 所有的话题
		 * @param {Object} callBack 完成的回调
		 */
		function addChannels(channelInfo, allChannels, callBack) {
			var fragmentTop = document.createDocumentFragment();
			var fragmentBot = document.createDocumentFragment();
			for(var i = 0; i < allChannels.length; i++) {
				//顶部话题
				var elementTop = document.createElement('a');
				//底部列表
				var elementBot = document.createElement('div');

				if(allChannels[i].TabId == channelInfo.TabId) {
					//选择的话题
					sliderId = 'top_' + allChannels[i].TabId;
					elementTop.className = 'mui-control-item mui-active';
					elementBot.className = 'mui-slider-item mui-control-content mui-active';
				} else {
					elementTop.className = 'mui-control-item';
					elementBot.className = 'mui-slider-item mui-control-content';
				}
				//顶部话题
				elementTop.id = 'top_' + allChannels[i].TabId;
				elementTop.href = '#bot_' + allChannels[i].TabId;
				elementTop.innerText = allChannels[i].ChannelName;
				//底部列表
				elementBot.id = 'bot_' + allChannels[i].TabId;
				elementBot.setAttribute('data-info', JSON.stringify(allChannels[i]));
				elementBot.innerHTML = '<div id="bot_sw_' + allChannels[i].TabId + '" class="mui-scroll-wrapper">\
											<div id="bot_sc_' + allChannels[i].TabId + '" class="mui-scroll">\
												<ul id="bot_ul_' + allChannels[i].TabId + '" class="mui-table-view">\
												</ul>\
											</div>\
										</div>';
				fragmentTop.appendChild(elementTop);
				fragmentBot.appendChild(elementBot);
			}
			document.getElementById("topList").appendChild(fragmentTop);
			document.getElementById("sliderGroup").appendChild(fragmentBot);

			callBack();
		}

		/**
		 * 循环初始化所有下拉刷新，上拉加载。
		 */
		function pullRefresh() {
			//阻尼系数
			var deceleration = mui.os.ios ? 0.003 : 0.0009;
			mui('.mui-scroll-wrapper').scroll({
				bounce: false,
				indicators: true, //是否显示滚动条
				deceleration: deceleration
			});
			var pullRefresh = [];
			//循环初始化所有下拉刷新，上拉加载。
			mui.each(document.querySelectorAll('.mui-slider-group .mui-scroll'), function(index, pullRefreshEl) {
				var refresh = mui(pullRefreshEl).pullToRefresh({
					down: {
						callback: function() {
							var self = this;
							var id = pullRefreshEl.parentNode.parentNode.id;
							var element = document.getElementById(id);
							var info = JSON.parse(element.getAttribute('data-info'));
							var page = JSON.parse(element.getAttribute('data-page'));
							console.log('down ' + JSON.stringify(info));
							console.log('down ' + JSON.stringify(page));
							setTimeout(function() {
								//获取数据
								getExpertsArray(info.TabId, 1);
								//结束下拉刷新
								self.endPullDownToRefresh();
							}, 1000);
						}
					},
					up: {
						contentinit: '',
						callback: function() {
							var self = this;
							var id = pullRefreshEl.parentNode.parentNode.id;
							var element = document.getElementById(id);
							var info = JSON.parse(element.getAttribute('data-info'));
							var page = JSON.parse(element.getAttribute('data-page'));
							console.log('up ' + JSON.stringify(info));
							console.log('up ' + JSON.stringify(page));
							if(page) {
								setTimeout(function() {
									getExpertsArray(info.TabId, page.pageIndex + 1);
									self.endPullUpToRefresh();
								}, 1000);
							} else {
								self.endPullUpToRefresh();
							}
						}
					}
				});
				pullToRefresh.push({
					id: pullRefreshEl.id,
					refresh: refresh,
				});
			});
		}

		/**
		 * 增加专家
		 * @param {Object} channelId 话题Id
		 * @param {Object} data 数据
		 */
		function addExperts(channelId, data) {
			for(var i = 0; i < data.length; i++) {
				//console.log("addExperts " + JSON.stringify(data[i]));
				var element = document.createElement('li');
				element.id = 'experts_' + channelId + '_' + data[i].TabId; //问答用户表ID
				element.className = 'mui-table-view-cell mui-media';
				element.setAttribute('data-info', JSON.stringify(data[i]));
				element.innerHTML = '<div class="mui-media-body mui-pull-right">\
										<button type="button" class="mui-btn mui-btn-blue">提问</button>\
									</div>\
									<img class="mui-media-object mui-pull-left expert-headimg" src="' + updateHeadImg(data[i].uimg, 2) + '">\
									<div class="mui-media-body">\
										<div id="expert_name_' + channelId + '_' + data[i].TabId + '" class="expert-name  mui-pull-left mui-ellipsis"></div>\
										<img class="mui-media-object expert-level" src="../../image/qiuzhi/expert_level.png" />\
										<font>回答数 :</font>\
										<font class="expert-answernum">' + data[i].AnswerNum + '</font>\
										<div id="expert_usernote_' + channelId + '_' + data[i].TabId + '" class="mui-ellipsis expert-usernote"></div>\
									</div>';
				document.getElementById("bot_ul_" + channelId).appendChild(element);
				document.getElementById("expert_name_" + channelId + '_' + data[i].TabId).innerText = data[i].unick;
				document.getElementById("expert_usernote_" + channelId + '_' + data[i].TabId).innerText = data[i].UserNote;
			}
		}

		/**
		 * 获取符合条件的专家信息
		 * @param {Object} channelId 当前话题ID
		 * @param {Object} pageIndex 当前页数
		 */
		function getExpertsArray(channelId, pageIndex) {
			//需要加密的数据
			var comData = {
				userIds: '[0]', //用户编号列表,Array,传入0，获取所有专家
				channelId: channelId.toString(), //话题ID,传入0，获取所有话题数据
				pageIndex: pageIndex, //当前页数
				pageSize: '10' //每页记录数,传入0，获取总记录数
			};
			// 等待的对话框
			var wd = events.showWaiting();
			//2.获取符合条件的专家信息
			postDataQZPro_getExpertsByCondition(comData, wd, function(data) {
				console.log('2.获取符合条件的专家信息:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
				//记录页数
				var page = {
					pageIndex: pageIndex, //当前页数
					totalPage: 0 //总页数
				};
				if(data.RspCode == 0) {
					page.totalPage = data.RspData.totalPages;
				}
				document.getElementById("bot_" + channelId).setAttribute('data-page', JSON.stringify(page))
				if(pageIndex == 1) { //获取的第一页的内容
					//清空对应的界面
					document.getElementById("bot_ul_" + channelId).innerHTML = '';
				}
				if(data.RspCode == 0) {
					//添加人员信息
					//回调中的临时数据
					var tempRspData = data.RspData.Data;
					//获取当前回调的个人信息，主要是头像、昵称
					var tempArray = [];
					//先遍历回调数组，获取
					for(var item in tempRspData) {
						//当前循环的model
						var tempModel0 = tempRspData[item];
						//将当前model中id塞到数组
						tempArray.push(tempModel0.UserId);
					}
					//给数组去重
					tempArray = arrayDupRemoval(tempArray);
					//发送获取用户资料申请
					var tempData = {
						vvl: tempArray.join(), //用户id，查询的值,p传个人ID,g传ID串
						vtp: 'g' //查询类型,p(个人)g(id串)
					}
					console.log('tempData:' + JSON.stringify(tempData));
					// 等待的对话框
					var wd2 = events.showWaiting();
					//21.通过用户ID获取用户资料
					postDataPro_PostUinf(tempData, wd2, function(data1) {
						console.log('21.获取个人资料success:RspCode:' + data1.RspCode + ',RspData:' + JSON.stringify(data1.RspData) + ',RspTxt:' + data1.RspTxt);
						if(data1.RspCode == 0) {
							//循环当前的个人信息返回值数组
							for(var i in data1.RspData) {
								//当前model
								var tempModel = data1.RspData[i];
								//更新头像
								tempModel.uimg = updateHeadImg(tempModel.uimg, 2);
								//循环回调数组
								for(var item in tempRspData) {
									//当前循环的model
									var tempModel0 = tempRspData[item];
									//对比id是否一致
									if(tempModel0.UserId == tempModel.utid) {
										//合并
										tempModel0 = $.extend(tempModel0, tempModel);
									}
								}
							}
						}
						console.log('专家循环遍历后的值：' + JSON.stringify(tempRspData));
						//刷新界面
						addExperts(channelId, tempRspData);
						wd2.close();
					});
				} else {
					mui.toast(data.RspTxt);
				}

				//设置上拉下拉控件的状态
				setTimeout(function() {
					var tempRefresh;
					for(var i = 0; i < pullToRefresh.length; i++) {
						var id = pullToRefresh[i].id.replace('bot_sc_', '');
						if(id == channelId) {
							tempRefresh = pullToRefresh[i];
						}
					}
					if(pageIndex < data.RspData.totalPages) {
						//更新当前控件
						self.refresh(true);
					} else {
						//没有下一页
						tempRefresh.refresh.endPullUpToRefresh(true);
					}
					wd.close();
				}, 500);
			});
		};
	</script>

</html>