<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/utils/common.css" rel="stylesheet" />
		<link href="../../css/iconfont/iconfont.css" rel="stylesheet" />
		<link href="../../css/qiuzhi/qiuzhi-questionSub.css" rel="stylesheet" />
		<link href="../../css/quan/custom-textarea.css" rel="stylesheet" />

	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">问题</h1>
			<a id="publish" class="mui-pull-right">提问</a>
		</header>
		<!--快捷输入具体内容，开发者可自己替换常用语-->
		<div id="popover" class="mui-popover">
			<ul class="mui-table-view">

			</ul>
		</div>
		<div class="mui-content">
			<textarea id="askTitle" placeholder="写下你的问题" style="height: 40px;margin-top: 5px;"></textarea>
			<p style="margin-left: 10px;font-size: 14px;margin-top: -12px;">请添加问题的补充说明</p>
			<div class="input-content">
				<textarea id="askNote" placeholder="请输入内容"></textarea>
				<div id="take_pic" class="take_pic">
					<a class="mui-icon iconfont icon-xiangji1"></a>
				</div>
				<div id="take_camero" class="take_camero">
					<a class="mui-icon iconfont icon-shipin"></a>
				</div>
				<div id="get_gallery" class="get_gallery">
					<a class="mui-icon iconfont icon-tuku"></a>
				</div>
			</div>
			<p style="margin-top: 10px;margin-left: 10px;font-size: 14px;width: 100px;">选择话题:
				<a id="channal" style="margin-left: 4px;" href="#popover">
					全部
				</a>
			</p>
			<!--<div class="mui-input-row mui-checkbox mui-left" style="float: right;width: 100px;margin-top: -35px;margin-left: -100px;">
				<label>匿名</label>
				<input id="checkbox" name="checkbox" value="" type="checkbox">
			</div>-->
			<ul id="ExpertList" class="mui-table-view">
				<!--<li class="mui-table-view-cell mui-media">
						<img class="mui-media-object mui-pull-left" src="../../image/tab_zone/u72.png">
						<div class="mui-media-body">
							李欣芸
							<p class='mui-ellipsis'>今天上课表现良好</p>
						</div>
					</li>-->
				<ul/>

		</div>

		<script src="../../js/mui.min.js"></script>
		<script src="../../js/utils/events.js"></script>
		<script src="../../js/utils/camera.js"></script>
		<script src="../../js/utils/files.js"></script>
		<script src="../../js/utils/ASFiles.js"></script>
		<script src="../../js/publicProtocol.js"></script>

		<script src="../../js/publicProtocol.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/storageKeyName.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/publicQiuzhiProtocol.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			mui.init();
			var askChannel = '0';
			var datasource = [];
			mui.plusReady(function() {
				var data = plus.webview.currentWebview().data;
				console.log('获取的数据：' + JSON.stringify(data));
				channelData = data.allChannels;
								channelData.splice(0, 1);
				var curChannel = data.curChannel;
				console.log('curChannel=' + JSON.stringify(curChannel));
				console.log('获取的数据111：' + JSON.stringify(channelData));
				//2.获取符合条件的专家信息
				if(channelData.length > 0) {
					var model_Channel = channelData[0];
					getExpertsArray(model_Channel.TabId);
				}

				if(curChannel.TabId == 0) {
					curChannel = channelData[0];
				}
				askChannel = curChannel.TabId;
				document.getElementById("channal").innerHTML = curChannel.ChannelName;
				var ul = document.getElementById("popover").getElementsByClassName('mui-table-view')[0];
				for(var i = 0; i < channelData.length; i++) {
					var li = document.createElement("li");
					li.id = channelData[i].TabId;
					li.className = 'mui-table-view-cell';
					var a = document.createElement("a");
					a.href = '#'
					a.innerHTML = channelData[i].ChannelName;
					li.appendChild(a);
					ul.appendChild(li);
				}

			})

			events.addTap('take_pic', function() {
				mui.toast('此功能暂未开放');
				//				camera.getPic(camera.getCamera(), function(path) {
				//
				//				});
			});
			events.addTap('take_camero', function() {
				mui.toast('此功能暂未开放');
				//				camera.getVideo(camera.getCamera(), function(path) {
				//
				//				});
			});
			events.addTap('get_gallery', function() {
				mui.toast('此功能暂未开放');
				//				gallery.getMultiplePic(function(paths) {
				//
				//				});
			});
			events.addTap('publish', function() {
				console.log(1111111)
				requestAddAsk();
			});

			//6.新增某个用户提交问题
			function requestAddAsk() {
				var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid; //用户id
				var askTitle = document.getElementById("askTitle");
				var askNote = document.getElementById("askNote");
				var tempText = Trim(askTitle.value);
				console.log('textView.value===' + tempText)
				if(!tempText || tempText == '') {
					mui.toast('请输入问题');
					return;
				} else if(tempText.length > 200) {
					mui.toast('不能超过200字');
					return;
				} else {
					tempText = replaceAllBL(tempText)
				}
				tempText = Trim(askNote.value);
				console.log('textView.value===' + tempText)
				if(!tempText || tempText == '') {
					mui.toast('请输入补充说明');
					return;
				} else if(tempText.length > 2000) {
					mui.toast('不能超过2000字');
					return;
				} else {
					tempText = replaceAllBL(tempText)
				}
				//				var checkbox = document.getElementById("checkbox")
				//				var isAnonym = 0;
				//				if(!checkbox.checked) {
				//					isAnonym = 0;
				//				} else {
				//					isAnonym = 1;
				//				}
				var box = document.getElementsByClassName('checkbox');
				var selectedBoxes = [];
				for(var i = 0; i < box.length; i++) {
					console.log()
					if(box[i].checked) {
						selectedBoxes.push(box[i].value);
					}
				}
				var boxesStr =arrayToStr(selectedBoxes)
				console.log(JSON.stringify(selectedBoxes));
				//所需参数
				var comData = {
					askTitle: askTitle.value, //问题标题,200
					askNote: askNote.value, //问题说明,2000
					askChannel: askChannel, //问题话题
					askMan: personalUTID, //提问人
					isAnonym: 0, //是否匿名
					encAddr: '',
					inviteExperts: boxesStr //邀请专家,例如[1,2,3]
				};
				// 等待的对话框
				var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
				//6.新增某个用户提交问题
				postDataQZPro_addAsk(comData, wd, function(data) {
					wd.close();
					console.log('6.新增某个用户提交问题:' + JSON.stringify(data));
					if(data.RspCode == 0) {
						mui.toast('发布成功')
						askTitle.value = '';
						askNote.value = '';
						mui.back();
					} else {
						mui.toast(data.RspTxt);
					}
				});
			}
			//去除前后空格
			function Trim(str) {
				return str.replace(/(^\s*)|(\s*$)/g, "");
			}
			//选择快捷输入
			mui('.mui-popover').on('tap', 'li', function(e) {
				document.getElementById("channal").innerHTML = this.children[0].innerHTML;
				askChannel = this.id;
				console.log('askChannel=' + askChannel);
				//2.获取符合条件的专家信息
				getExpertsArray(askChannel);
				mui('.mui-popover').popover('toggle')
			})

			//2.获取符合条件的专家信息
			function getExpertsArray(code) {
				//需要加密的数据
				var comData = {
					userIds: '[0]', //用户编号列表,Array,传入0，获取所有专家
					channelId: code, //话题ID,传入0，获取所有话题数据
					pageIndex: '1', //当前页数
					pageSize: '0' //每页记录数,传入0，获取总记录数
				};
				// 等待的对话框
				var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
				//2.获取符合条件的专家信息
				postDataQZPro_getExpertsByCondition(comData, wd, function(data) {
					wd.close();
					console.log('2.获取符合条件的专家信息:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
					if(data.RspCode == 0) {
						//添加人员信息
						//回调中的临时数据
						var tempRspData = data.RspData.Data;
						//获取当前回调的个人信息，主要是头像、昵称
						var tempArray = [];
						//先遍历回调数组，获取
						for(var item in tempRspData) {
							//当前循环的model
							var tempModel0 = tempRspData[item];
							//将当前model中id塞到数组
							tempArray.push(tempModel0.UserId);
						}
						//给数组去重
						tempArray = arrayDupRemoval(tempArray);
						//发送获取用户资料申请
						var tempData = {
							vvl: tempArray.join(), //用户id，查询的值,p传个人ID,g传ID串
							vtp: 'g' //查询类型,p(个人)g(id串)
						}
						console.log('tempData:' + JSON.stringify(tempData));
						//21.通过用户ID获取用户资料
						postDataPro_PostUinf(tempData, wd, function(data1) {
							wd.close();
							console.log('21.获取个人资料success:RspCode:' + data1.RspCode + ',RspData:' + JSON.stringify(data1.RspData) + ',RspTxt:' + data1.RspTxt);
							if(data1.RspCode == 0) {
								//循环当前的个人信息返回值数组
								for(var i in data1.RspData) {
									//当前model
									var tempModel = data1.RspData[i];
									//更新头像
									tempModel.uimg = updateHeadImg(tempModel.uimg, 2);
									//循环回调数组
									for(var item in tempRspData) {
										//当前循环的model
										var tempModel0 = tempRspData[item];
										//对比id是否一致
										if(tempModel0.UserId == tempModel.utid) {
											//合并
											tempModel0 = $.extend(tempModel0, tempModel);
										}
									}
								}
							}
							console.log('循环遍历后的值：' + JSON.stringify(tempRspData));
							datasource = tempRspData;
							//刷新界面
							addExperts();

						});
					} else {
						mui.toast(data.RspTxt);
					}
				});
			};

			function addExperts() {
				var ul = document.getElementById("ExpertList");
				for(var i = 0; i < datasource.length; i++) {
					var li = document.createElement('li');
					li.className = 'mui-table-view-cell mui-media';
					li.innerHTML =
						'<img class="mui-media-object mui-pull-left" src="' + updateHeadImg(datasource[i].uimg,2) + '">' +
						'<div class="mui-media-body">' +
						datasource[i].unick + '<font style="color:gray"> 回答数:<span style="color:red">' + datasource[i].AnswerNum + '</span>' +
						'</font><p class="mui-ellipsis">' + datasource[i].UserNote + '</p></div>' +
						'<div class="mui-checkbox" style="float:right;">' +
						'<input class = "checkbox" value="' + datasource[i].TabId + '" type="checkbox" style="margin-top: -37px;">' +
						'</div>'
					ul.appendChild(li);
				}

			}
		</script>
		<!--<script src="../../js/qiuzhi/qiuzhi-questionSub.js"></script>-->
	</body>

</html>