<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/utils/common.css" rel="stylesheet" />
		<link href="../../css/iconfont/iconfont.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/quan/custom-textarea.css" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 id="title" class="mui-title" style="color: white;">我要回答</h1>
			<h1 id="submitBtn" class="mui-icon mui-icon-right-nav mui-pull-right" style="text-align: right;right: 10px;font-size: 15px;">提交</h1>
		</header>

		<div class="mui-content">
			<p id="askTitle" style="margin-left: 10px;font-size: 14px;margin-top: 5px;word-wrap: break-word;"></p>
			<div class="input-content">
				<textarea id="answerContent" placeholder="添加回答,最多4000字"></textarea>
				<div id="take_pic" class="take_pic file-extras">
					<a class="mui-icon iconfont icon-xiangji1"></a>
				</div>
				<div id="take_camero" class="take_camero file-extras">
					<a class="mui-icon iconfont icon-shipin"></a>
				</div>
				<div id="get_gallery" class="get_gallery file-extras">
					<a class="mui-icon iconfont icon-tuku"></a>
				</div>
			</div>
			<div class="mui-input-row mui-checkbox mui-left file-extras" style="float: right;width: 100px;margin-top: -35px;margin-left: -100px;">
				<label>匿名</label>
				<input id="checkbox" name="checkbox" value="" type="checkbox">
			</div>
			<div id="pictures" style="float: left;background-color: transparent;width: 320px;"></div>
		</div>

		<script src="../../js/mui.min.js"></script>
		<script src="../../js/utils/events.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/utils/camera.js"></script>
		<script src="../../js/utils/CloudFileUtil.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/utils/compress.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/utils/cryption.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/qiniu/qiniu.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/publicQiuzhiProtocol.js" type="text/javascript" charset="utf-8"></script>

		<script type="text/javascript">
			mui.init();
			//将传值到的标题显示
			var askModel; //问题model
			var answerInfo; //答案信息
			var commentInfo; //评论信息
			var type = 0; //0：回答问题，1：评论答案 2：评论回复
			//传值接收方法
			mui.plusReady(function() {
				jQuery('#answerContent').prop("maxLength", "4000");
				window.addEventListener('qiuzhi-addAnswer', function(event) {
					CloudFileUtil.files = [];
					events.clearChild(document.getElementById('pictures'));
					type = 0;
					askModel = event.detail.data;
					document.getElementById('title').innerText = '我要回答';
					[].forEach.call(document.querySelectorAll('.file-extras'), function(item) {
						item.style.display = 'inline-block';
					})
					document.getElementById('answerContent').placeholder = "添加回答,最多4000字";
					jQuery('#answerContent').prop("maxLength", "4000"); //设置最长
					var askTitle = document.getElementById("askTitle");
					askTitle.innerHTML = askModel.AskTitle;
				});
				//加载评论
				window.addEventListener('add-comment', function(e) {
					CloudFileUtil.files = [];
					events.clearChild(document.getElementById('pictures'))
					type = 1;
					document.getElementById('title').innerText = '我要评论';
					document.getElementById('answerContent').placeholder = "添加评论,最多1000字";
					jQuery('#answerContent').prop("maxLength", "1000"); //设置最长
					[].forEach.call(document.querySelectorAll('.file-extras'), function(item) {
						item.style.display = 'none';
					})
					answerInfo = e.detail.data;
					document.getElementById('askTitle').innerText = answerInfo.AnswerContent;
				})
				window.addEventListener("comment-reply", function(e) {
					console.log('回复评论要加载的值：' + JSON.stringify(e.detail.data));
					type = 2;
					document.getElementById('title').innerText = '回复评论';
					commentInfo=e.detail.data;
					document.getElementById('answerContent').placeholder = "添加评论回复,最多1000字";
					[].forEach.call(document.querySelectorAll('.file-extras'), function(item) {
						item.style.display = 'none';
					})
				})
				setListener();
			});
			var setListener = function() {
				events.addTap('take_pic', function() {
					if(CloudFileUtil.files.length < 9) {
						camera.getPic(camera.getCamera(), function(picPath) {
							plus.nativeUI.showWaiting(storageKeyName.UPLOADING, {
								back: 'none'
							});
							var saveSpace = storageKeyName.KNOWLEDGE; //保存空间
							compress.compressPIC(picPath, function(event) {
								var localPath = event.target;
								var options = {
									type: 10,
									thumbSize: {
										width: 200,
										height: 200
									},
									cropSize: {
										height: 200
									}
								}
								var data = CloudFileUtil.getSingleImgUploadOptions(localPath, 7, 0, saveSpace, options);
								//								var data = CloudFileUtil.getQNUpTokenWithManage(localPath, 7, 200, 0, );
								CloudFileUtil.getQNUpTokenWithManage(storageKeyName.QNGETUPLOADTOKEN, data.options, function(datas) {
									console.log("获取的数据：" + JSON.stringify(datas));
									if(datas.Status == 1) {
										var tokenInfo = datas.Data;

										//上传文件
										CloudFileUtil.uploadFile(tokenInfo, localPath, function(uploadData, status) {
											console.log(JSON.stringify(uploadData));
											var img = { //图片信息
												url: tokenInfo.Domain + tokenInfo.Key,
												thumb: tokenInfo.OtherKey[data.thumbKey],
												clip: tokenInfo.OtherKey[data.clipKey],
												type: 1
											}
											console.log("获取的图片信息：" + JSON.stringify(img));
											//关闭等待框
											plus.nativeUI.closeWaiting();
											//放置图片
											CloudFileUtil.setPic(img);
										});
									}

								}, function(xhr, type, errorThrown) {
									console.log("错误类型：" + type + errorThrown);
									plus.nativeUI.closeWaiting(); //关闭等待框
								});
							})
						})
					} else {
						mui.toast('上传图片附件不得多于9张！');
					}
				});
				events.addTap('take_camero', function() {
					mui.toast('此功能暂未开放');
					//				camera.getVideo(camera.getCamera(), function(path) {
					//
					//				});
				});
				events.addTap('get_gallery', function() {
					if(CloudFileUtil.files.length < 9) {
						var picCount = 0; //上传图片计数
						gallery.getMultiplePic(9 - CloudFileUtil.files.length, function(paths) { //回调函数
							plus.nativeUI.showWaiting(storageKeyName.UPLOADING, {
								back: 'none'
							}); //等待框
							console.log("保存的路径：" + JSON.stringify(paths));
							var saveSpace = storageKeyName.KNOWLEDGE; //保存路径
							compress.compressPics(paths, function(compressedPaths) {
									console.log('获取的图片路径：' + JSON.stringify(compressedPaths));
									var options = { //上传七牛后的处理参数
										type: 1, //处理类型 0：缩略图 1 裁剪 10 缩略图+裁剪
										thumbSize: {
											width: 200, //缩略图最大宽度
											height: 200 //缩略图最大高度
										},
										cropSize: {
											height: 200 //裁剪宽度值
										}
									}
									//多图片处理获取参数
									var data = CloudFileUtil.getMultipleImgUploadOptions(compressedPaths, 7, 0, saveSpace, options);
									//								var data = CloudFileUtil.getMultipleUploadDataOptions(compressedPaths, 7, 200, 0, saveSpace); //获取获取token的各参数
									CloudFileUtil.getQNUpTokenWithManage(storageKeyName.QNGETUPLOADTOKEN, data.options, function(datas) {
										console.log("传回来的值：" + JSON.stringify(datas)) //回调数据
										if(datas.Status == 1) { //成功
											var tokenInfos = datas.Data; //参数信息
											//上传图片
											CloudFileUtil.uploadFiles(compressedPaths, tokenInfos, function(uploadData, status) {
												console.log(JSON.stringify(uploadData));
												var img = {
													url: tokenInfos[0].Domain + JSON.parse(uploadData.responseText).key,
													thumb: tokenInfos[0].Domain + JSON.parse(uploadData.responseText).key.replace(saveSpace, saveSpace + "thumb/"),
													clip: tokenInfos[0].Domain + tokenInfos[0].Key.replace(saveSpace, saveSpace + "clip/"),
													type: 1
												};
												picCount++;
												//放置图片
												CloudFileUtil.setPic(img); //放置图片
												if(picCount == compressedPaths.length) { //所有图片已上传
													plus.nativeUI.closeWaiting(); //关闭等待框
												}
											})
										}
									})
								},
								//错误的回调
								function(xhr, type, errorThrown) {
									console.log("错误类型：" + type + errorThrown);
									plus.nativeUI.closeWaiting();
								});

						});
					} else {
						mui.toast('上传图片附件不得多于9张！');
					}

				});

				//提交按钮
				events.addTap('submitBtn', function() {
					var answerContent = jQuery.trim(document.getElementById("answerContent").value);
					if(answerContent) {
						switch(type) {
							case 0:
								addAnswer(answerContent);
								break;
							case 1:
								addComment(answerContent);
								break;
							case 2:
								addComment(answerContent, commentInfo);
								break;
							default:
								break;
						}
					} else {
						mui.toast('请输入内容');
					}
				});
			}
			/**
			 * 回答问题
			 */
			var addAnswer = function(answerContent) {
				var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid; //用户id

				var isAnonym = document.getElementById('checkbox').checked;
				var isAnonymNo = isAnonym ? 1 : 0;
				console.log('是否显示匿名：' + isAnonym);
				//所需参数
				var comData = {
					askId: askModel.TabId, //问题ID
					answerContent: answerContent, //回答内容,4000
					encAddr: getTypeAddress(CloudFileUtil.files).encAddr, //附件地址,300,多个的情况例如：1.jpg|2.jpg
					thumbnail: getTypeAddress(CloudFileUtil.files).encImg,
					cutImg: getTypeAddress(CloudFileUtil.files).clipAddress,
					answerMan: personalUTID, //回答人
					isAnonym: isAnonymNo
				};
				// 等待的对话框
				var wd = events.showWaiting();
				//9.新增某个用户回答问题
				postDataQZPro_addAnswer(comData, wd, function(data) {
					wd.close();
					console.log('9.新增某个用户回答问题:' + JSON.stringify(data));
					if(data.RspCode == 0) {
						mui.toast('回答成功');
						document.getElementById("answerContent").value = '';
						events.fireToPageNone('qiuzhi-questionSub.html', 'answerAdded');
						mui.back();
					} else {
						mui.toast(data.RspTxt);
					}
				});
			}
			/**
			 * 增加评论
			 * @param {Object} commentValue
			 */
			var addComment = function(commentValue, opotions) {
				var pId = myStorage.getItem(storageKeyName.PERSONALINFO).utid;
				var wd = events.showWaiting();
				var upperId = 0;
				var replyId = 0;
				var answerId;
				if(answerInfo) {
					answerId = answerInfo.AnswerId;
				}
				//如果有参数
				if(opotions) {
//					if(opotions.UpperId=0){
						upperId = opotions.TabId;
//					}else{
//						upperId=opotions.UpperId;
//					}
					replyId = opotions.UserId;
					answerId = opotions.AnswerId;
				}

				postDataQZPro_addAnswerComment({
					answerId: answerId, //回答ID
					upperId: upperId, //上级评论ID,第一个评论传0，其他的传最上层的ID
					userId: pId, //评论用户ID,
					commentContent: commentValue, //评论内容
					replyId: replyId //回复用户ID,新增评论的话传0，回复评论传用户Id
				}, wd, function(data) {
					wd.close();
					console.log('评论结果:' + JSON.stringify(data))
					if(data.RspCode == 0) {
						if(data.RspData.Result) {
							document.getElementById('answerContent').value = '';
							mui.toast('评论成功！')
							events.fireToPageNone('qiuzhi-answerDetailSub.html', 'commentAdded');
							mui.back();
						}
					} else {
						mui.toast('评论失败，请重新提交评论！');
					}
				})
			}
			var imgs = [];

			//删除图标的点击事件
			CloudFileUtil.setDelPicListener();
			/**
			 * 获取接口数据文件及缩略图
			 * encType: '',//附件类型,1图片2音视频3仅文字
			 * encAddr: '',//附件地址
			 * encImg: '',//附件缩略图地址
			 */
			var getTypeAddress = function() {
				var TAs = {};
				var encType;
				var encAddrs = [];
				var encImgs = [];
				var theFile;
				if(CloudFileUtil.files.length > 0) { //如果存在附件
					for(var i in CloudFileUtil.files) {
						theFile = CloudFileUtil.files[i];
						if(i == 0) {
							TAs.encType = theFile.type;
							TAs.clipAddress = theFile.clip;
						}
						encAddrs.push(theFile.url);
						encImgs.push(theFile.thumb);
					}
					console.log(JSON.stringify(encAddrs));
					console.log(JSON.stringify(encImgs));
					TAs.encAddr = encAddrs.join('|');
					TAs.encImg = encImgs.join('|');
				} else { //不存在附件
					TAs.encType = 0;
					TAs.encAddr = '';
					TAs.encImg = '';
				}
				return TAs;
			}
		</script>
	</body>

</html>