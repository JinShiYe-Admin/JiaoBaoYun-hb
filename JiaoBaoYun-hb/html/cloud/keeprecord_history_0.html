<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<!--<link rel="stylesheet" href="../../css/mui.picker.min.css" />-->
		<link rel="stylesheet" href="../../css/utils/pullToRefresh.css" />
		<link rel="stylesheet" href="../../css/utils/preview.css" />
		<style>
			body,
			.mui-content {
				background-color: white;
			}

			.mui-pull-bottom-wrapper {
				/*底部加载更多区域*/
				background-color: white;
			}

			.mui-table-view {
				font-size: 15px;
				word-break: break-all;
			}
			/*.mui-table-view-cell.mui-active {*/
			/*background-color: white*/
			/*}*/

			.mui-table-view:before {
				height: 0px;
			}

			.mui-table-view:after {
				height: 2px;
			}

			.mui-table-view:first-child:before {
				height: 0px;
			}

			.mui-table-view-cell:before,
			.mui-table-view-cell:after {
				left: 15px;
				right: 15px;
			}

			.mui-table-view .history-date:before {
				height: 0px;
			}

			.mui-table-view .history-date:after {
				height: 2px;
			}

			.mui-table-view-cell:last-child:after {
				height: 1px;
			}

			.history-title {
				/*标题*/
				display: inline;
				color: #323232;
				font-weight: 900;
			}

			.history-date {
				/*日期*/
				color: #FF9900;
			}

			.history-time {
				/*时间*/
				color: #B7B7B7;
				font-size: 13px;
			}

			.history-content {
				/*内容*/
				color: #808080;
				font-size: 14px;
				margin-top: 5px;
			}

			.record-imge {
				width: 100%;
				margin-top: 5px;
			}

			.record-picture {
				/*显示图片区域*/
				overflow: hidden;
				position: relative;
				float: left;
				text-align: center;
				margin-top: 5px;
				margin-bottom: 5px;
			}

			.record-picture-num {
				/*剩余图片数量*/
				position: absolute;
				color: white;
				background-color: rgba(0, 0, 0, .3);
				width: 100%;
				font-size: 25px;
			}

			.ellipsis-show {
				/*内容*/
				display: -webkit-box;
				overflow: hidden;
				white-space: normal !important;
				text-overflow: ellipsis;
				word-wrap: break-word;
				-webkit-line-clamp: 3;
				-webkit-box-orient: vertical;
			}

			.show-all {
				display: none;
				color: #CCCCCC;
				font-size: 14px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 id="title" class="mui-title">历史记录</h1>
		</header>
		<!--下拉刷新容器-->
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper mui-fullscreen" style="z-index: 1;">
			<div class="mui-scroll">
				<div id="data_scroll">
				</div>
			</div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/mui.pullToRefresh.js"></script>
		<script type="text/javascript" src="../../js/mui.pullToRefresh.material.js"></script>
		<script type="text/javascript" src="../../js/mui.zoom.js"></script>
		<script type="text/javascript" src="../../js/mui.previewimage.js"></script>
		<script type="text/javascript" src="../../js/publicProtocol.js"></script>
		<script type="text/javascript" src="../../js/utils/events.js"></script>

		<!--<script type="text/javascript" src="../../js/mui.picker.min.js" ></script>-->
		<script type="text/javascript">
			mui.init({
				gestureConfig: {
					doubletap: true,
				}
			});
			var previewImage; //查看图片的控件
			var pullRefresh; //下拉，上拉控件
			var main; //获取当前窗体对象
			var mainData; //接收A页面传入参数值
			var markDate = ''; //记录日期
			mui.plusReady(function() {
				previewImage = mui.previewImage();
				main = plus.webview.currentWebview(); //获取当前窗体对象
				mainData = main.data; //接收A页面传入参数值
				console.log(main.id + ' ' + JSON.stringify(mainData));
				var deceleration = mui.os.ios ? 0.003 : 0.0009;
				mui('.mui-scroll-wrapper').scroll({
					bounce: false,
					indicators: true, //是否显示滚动条
					deceleration: deceleration
				});

				//初始化下拉，上拉控件
				pullRefresh = mui('.mui-scroll-wrapper .mui-scroll').pullToRefresh({
					down: {
						callback: function() {
							var self = this;
							var element = document.getElementById('data_scroll');
							var page = JSON.parse(element.getAttribute('data-page'));
							console.log('down ' + JSON.stringify(page));
							getClassHistory(1, 10);
							setTimeout(function() {
								//获取数据
								self.endPullDownToRefresh(); //结束下拉刷新
							}, 1000);
						}
					},
					up: {
						contentinit: '', //默认没有更多显示空白
						callback: function() {
							var self = this;
							var element = document.getElementById('data_scroll');
							var page = JSON.parse(element.getAttribute('data-page'));
							console.log('up ' + JSON.stringify(page));
							if(page) {
								getClassHistory(page.pageIndex + 1, 10);
							} else {
								mui.toast('数据异常，请下拉刷新后重新尝试');
							}
						}
					}
				});

				//获取数据
				getClassHistory(1, 10);

				//点击图片的数字
				mui('#data_scroll').on('tap', '.record-picture-num', function() {
					previewImage.open(document.getElementById("img_" + this.getAttribute('data-id')))
				});

				//显示全部
				mui('#data_scroll').on('tap', '.show-all', function() {
					var str = this.innerText;
					var id = this.id.replace('_show', '');
					if(str == '显示全部') {
						this.innerText = '收起';
						document.getElementById(id + "_content").style.webkitLineClamp = 'inherit';
					} else if(str == '收起') {
						this.innerText = '显示全部';
						document.getElementById(id + "_content").style.webkitLineClamp = '3';
					}
				});

				//双击标题返回列表顶部
				document.getElementById('title').addEventListener('doubletap', function() {
					var scrollTop = mui('#pullrefresh').scroll(); //话题列表区域
					scrollTop.scrollTo(0, 0, 100);
				});
			});

			/**
			 * 获取针对某班的点到记事列表
			 * @param {Object} pageIndex 当前页数
			 * @param {Object} pageSize 每页记录数
			 */
			function getClassHistory(pageIndex, pageSize) {
				var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid;
				//66.（点到记事）获取针对某班的点到记事列表
				//所需参数
				var comData = {
					classId: mainData.data, //班级ID
					pageIndex: pageIndex, //当前页数
					pageSize: pageSize, //每页记录数
					publisherId: personalUTID //发布者ID,0代表全部
				};
				var wd = events.showWaiting();
				postDataPro_getNotesForClass(comData, wd, function(data) {
					console.log('66.90909090success:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);

					//记录页数
					var page = {
						pageIndex: pageIndex, //当前页数
						totalPage: 0 //总页数
					};
					if(data.RspCode == 0) {
						page.totalPage = data.RspData.TotalPage;
					}
					document.getElementById('data_scroll').setAttribute('data-page', JSON.stringify(page))
					if(pageIndex == 1) { //下拉刷新或者获取的第一页的内容
						//清空对应的界面
						document.getElementById('data_scroll').innerHTML = '';
						markDate = ''; //日期
					} else { //上拉加载更多
						pullRefresh.endPullUpToRefresh(); //结束上拉加载更多
					}

					if(data.RspCode == 0) {
						var tempRspData = data.RspData.Data;
						for(var i = 0; i < tempRspData.length; i++) {
							for(var j = 0; j < mainData.mem.length; j++) {
								if(tempRspData[i].StudentId == mainData.mem[j].stuid) {
									mui.extend(tempRspData[i], {
										stuname: mainData.mem[j].stuname
									});
								}
							}
						}

						//生成界面
						for(var i = 0; i < tempRspData.length; i++) {
							createItem(tempRspData[i]);
						}
						//console.log(document.getElementById("data_scroll").innerHTML)

						if(data.RspData.Data.length == 0 && pageIndex == 1) {
							mui.toast('班级历史记录为空');
						}
					} else {
						mui.toast(data.RspTxt);
					}
					console.log('page ' + JSON.stringify(page));
					if(page.pageIndex >= page.totalPage) {
						//没有下一页
						console.log('没有下一页');
						pullRefresh.endPullUpToRefresh(true);
					} else {
						if(pageIndex == 1) {
							//获取第一页的数据更新当前控件
							pullRefresh.refresh(true);
						}
					}

					setTimeout(function() {
						wd.close();
					}, 500)
				});
			}

			/**
			 * 生成界面
			 * @param {Object} data
			 */
			function createItem(data) {
				//console.log('createItem ' + JSON.stringify(data));
				var date = data.PublishDate.split(' '); //发布的日期和时间
				var dateItem = date[0].replace(/-/g, '/'); //替换横杠为斜杠
				var time = date[1].split(':');
				var timeItem = time[0] + ':' + time[1];
				if(markDate != dateItem) { //新的日期
					markDate = dateItem;
					var element = document.createElement('ul');
					element.className = 'mui-table-view';
					element.id = dateItem;
					element.innerHTML = '<div class="mui-table-view-cell history-date">' + dateItem + '</div><div id="' + dateItem + '_data"></div>';
					document.getElementById("data_scroll").appendChild(element);
				}

				var html_first = '<div id="' + data.TabId + '_title' + '" class="mui-media-body history-title"></div>\
							<div class="mui-media-body mui-pull-right history-time">' + timeItem + '</div>\
							<div id="' + data.TabId + '_content' + '" class="mui-media-body history-content ellipsis-show"></div><div id="' + data.TabId + '_show' + '" class="show-all">显示全部</div>';
				var html_media = ''; //多媒体
				var width = (document.getElementById("data_scroll").offsetWidth - 30) * 0.32;
				var height = width * 3 / 4;
				var marginBottom = (document.getElementById("data_scroll").offsetWidth - 30) * 0.02;
				var marginRight;

				var title = ''; //标题
				var content = ''; //内容
				if(data.EncType == 1) { //附件类型,1图片2音视频3仅文字
					var imageArray = data.EncAddr.split('|');
					var thumbArray = data.EncImgAddr.split('|');

					var html_0 = '<div class="record-imge">';
					var html_1 = '';
					var html_2 = ''; //显示剩余的图片数量
					var html_3 = ''; //是否显示图片
					for(var i = 0; i < imageArray.length; i++) {
						if(i == 2 || i == 5 || i == 8) {
							marginRight = 0;
						} else {
							marginRight = marginBottom;
						}
						if(i > 2) {
							html_3 = 'display: none;';
						}
						if(i == 2 && imageArray.length > 3) {
							html_2 = '<div data-id="' + data.TabId + '_' + i + '" class="record-picture-num" style="line-height: ' + (height + 1) + 'px;">+' + (imageArray.length - 3) + '</div>'
						}
						html_1 = html_1 + '<div class="record-picture" style="width: ' + width + 'px; height: ' + height + 'px; margin-right: ' + marginRight + 'px;' + html_3 + '">\
									' + html_2 + '<img id="img_' + data.TabId + '_' + i + '" src="' + thumbArray[i] + '" data-preview-src="' + imageArray[i] + '" data-preview-group="' + data.TabId + '" style="width:100%;" onload="if(this.offsetHeight<this.offsetWidth){this.style.height=\'' + height + 'px\';this.style.width=\'initial\';this.style.marginLeft=-(this.offsetWidth-' + width + ')/2+\'px\';}else{this.style.marginTop=-(this.offsetHeight-' + height + ')/2+\'px\';}">\
								</div>';
					}
					html_media = html_0 + html_1 + '</div>';
				}
				var element = document.createElement('li');
				element.className = 'mui-table-view-cell';

				if(data.stuname == undefined) { //
					data.stuname = '';
					console.log('stuname 异常 无此人资料' + data.StudentId);
					//console.log('createItem ' + JSON.stringify(data));
				}
				if(data.NoteType == 1) { //点到
					element.innerHTML = html_first;
					title = data.stuname + ' ' + data.CheckTypeStr;
					if(data.MsgContent != '') {
						content = '说明:' + data.MsgContent;
					}
				} else if(data.NoteType == 2) { //记事
					element.innerHTML = html_first + html_media;
					title = data.stuname;
					content = data.MsgContent;
				} else {
					console.log('NoteType 异常' + data.NoteType);
					element.innerHTML = html_first;
					title = data.stuname;
					content = data.MsgContent;
				}

				document.getElementById(dateItem + '_data').appendChild(element);
				document.getElementById(data.TabId + '_title').innerText = title;
				if(content == '') {
					document.getElementById(data.TabId + '_content').style.display = 'none';
				} else {
					var height_0;
					var height_1;
					var contentEl = document.getElementById(data.TabId + '_content');
					contentEl.innerText = content;

					contentEl.style.webkitLineClamp = '4';
					height_0 = contentEl.offsetHeight;
					contentEl.style.webkitLineClamp = '3';
					height_1 = contentEl.offsetHeight;
					if(height_0 > height_1) {
						//内容高度大于三行
						document.getElementById(data.TabId + "_show").style.display = 'inline';
					}
				}
			}
		</script>
	</body>

</html>