<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<link rel="stylesheet" href="../../css/iconfont/iconfont.css" />
		<link rel="stylesheet" href="../../css/cloud/file.css" />
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/utils/events.js"></script>
		<script type="text/javascript" src="../../js/cloud/cloud.js"></script>
		<script type="text/javascript" src="../../js/cloud/AndroidFileSystem.js"></script>
		<script type="text/javascript" src="../../js/publicProtocol.js"></script>
		<style>
			.mui-control-item {
				background: #F5F5F5;
			}

			.iconfont {
				line-height: 42px;
			}

			.iconfont-color {
				color: #8f8f94;
			}

			.iconfont-size {
				font-size: 42px;
			}
			/*.mui-bar-nav~ .mui-content .mui-pull-top-pocket {
				top: 90px !important;
			}*/

			body,
			.mui-content {
				/*background: white;*/
			}

			.mui-table-view:before,
			.mui-table-view:after,
			.mui-table-view-cell:after {
				height: 0px;
			}

			.mui-table-view {
				background: transparent;
			}

			.mui-table-view-cell {
				margin-top: 10px;
				background: white;
			}

			.icon-download,
			.icon-trash {
				/*background: red;*/
				text-align: center;
				min-width: 40px;
			}

			#top {
				background-color: white;
				text-align: center;
				height: 45px;
			}

			.mui-segmented-control.mui-scroll-wrapper .mui-control-item {
				display: inline-block;
				width: auto;
				padding: 0;
				padding-right: 10px;
				border: 0;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">选择上传的文件</h1>
		</header>
		<nav class="mui-bar mui-bar-tab" style="background: #383E4E;">
			<div style="margin: 5px;">
				<div id="choose" class="mui-pull-left" style="width: 45%;">
					<div style="color: white;margin-left: 10%;">选择上传的位置</div>
					<button type="button" class="mui-btn mui-btn-blue" style="width: 100%;margin-bottom: 15px;margin-left: 5%;background: #7F8594;border-color: #7F8594;height: 40px;">
						<img class="mui-pull-left" src="../../image/cloud/A_folder.png"style="width: 20%;height: 20px;" />
						<div id="yunpath" class="mui-ellipsis mui-pull-right"style="width: 80%;text-align: center;"></div>
					</button>
				</div>
				<div id="upload" class="mui-pull-right" style="width: 45%;">
					<br />
					<button type="button" class="mui-btn mui-btn-blue" style="width: 100%;margin-bottom: 15px;margin-left: -5%;background: #636770;border-color: #636770;height: 40px;">上传</button>
				</div>
			</div>
		</nav>
		<div class="mui-content">
			<div id="slider" class="mui-slider">
				<div id="sliderSegmentedControl" style="background: #E8E9E9;" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<div id="folderlist" class="mui-scroll">
						<!--<div class="mui-control-item mui-active">
							手机 >
						</div>-->
					</div>
				</div>
			</div>
			<div id="all">
				<!--<div id="folder_path" style="display: ;">
					<div class="mui-scroll-wrapper" style="margin-top: 83px;">
						<div class="mui-scroll">
							<ul id="ul_path" class="mui-table-view">
								<li class="mui-table-view-cell mui-media">
									<span class="mui-navigate-right mui-media-object mui-pull-right"></span>
									<img class="mui-media-object mui-pull-left" src="../../image/cloud/A_folder.png">
									<div class="mui-media-body">
										<p class="mui-ellipsis">文件夹名字</p>
									</div>
								</li>
								<li class="mui-table-view-cell mui-media">
									<span class="mui-media-object mui-pull-right"></span>
									<span class="mui-media-object mui-icon iconfont iconfont-size icon-excel mui-pull-left"></span>
									<div class="mui-media-body">
										<p class="mui-ellipsis">文件名字</p>
									</div>
								</li>
							</ul>
						</div>
					</div>
				</div>-->
			</div>

		</div>
		<script type="text/javascript">
			mui.init();
			mui.plusReady(function() {
				//---初始化--start---
				events.preload('storage_main_choose.html'); //预加载选择云存储的文件
				events.preload('storage_transport.html'); //预加载传输列表

				console.log('选择上传的文件');
				var main = plus.webview.currentWebview(); //获取当前窗体对象
				var subData = null; //记录从父页面获取的数据
				var pid = ''; //文件的上层ID
				var showFolderId = ''; //当前显示的文件夹id
				var folderList = []; //目录数组，每打开一个目录，将该目录保存
				//---初始化--end---

				//---滑动start---
				mui(".mui-scroll-wrapper").scroll({
					scrollY: true, //是否竖向滚动
					scrollX: false, //是否横向滚动
					indicators: true, //是否显示滚动条
					deceleration: 0.0006, //阻尼系数,系数越小滑动越灵敏
					bounce: true, //是否启用回弹
				});
				//---滑动end---

				//初始化
				window.addEventListener('init', function(e) {
					subData = e.detail.data; //接收页面传入的参数值
					console.log('subData:' + JSON.stringify(subData));
					document.getElementById("yunpath").innerHTML = subData.title;
					pid = subData.fid;
					init();
				});

				//选择上传的路径
				window.addEventListener('chooseFolder', function(e) {
					var folder = e.detail.data; //接收页面传入的参数值
					console.log('chooseFolder:' + JSON.stringify(folder));
					document.getElementById("yunpath").innerHTML = folder.title;
					pid = folder.fid;
				});

				//返回按钮
				mui.back = function() {

					folderList.pop(); //清除最后一个历史记录
					if(folderList.length == 0) {
						//mui.back();
						plus.webview.hide(main, 'pop-out');
					} else {
						//隐藏当前界面
						document.getElementById("folder_" + showFolderId).style.display = 'none';
						//显示上一个历史界面
						var show = folderList[folderList.length - 1];
						console.log('back:showFolderId:' + showFolderId + '|show:' + show);
						document.getElementById("folder_" + show).style.display = 'inline';
						//顶部列表处理
						document.getElementById("top_" + show).className = 'mui-control-item mui-active';
						document.getElementById("top_" + showFolderId).parentNode.removeChild(document.getElementById("top_" + showFolderId));
						showFolderId = show;
					}
				}

				//修改存储到云盘的路径
				document.getElementById('choose').addEventListener('tap', function() {
					//					if(pid == '0') {
					events.fireToPageWithData('storage_main_choose.html', 'init', {
						fid: subData.fid, //文件id,顶层0
						showTop: subData.showTop, //是否显示顶部的上传，传输列表，文件夹，如果是选择云盘上的文件夹则为false
						title: subData.title, //标题名
						top: subData.top //顶层文件和文件夹的数据
					});
					//					} else {
					//						plus.webview.getWebviewById('storage_main_choose.html').show('slide-in-right', 250);
					//					}
				});

				//点击顶部文件夹列表
				mui('#folderlist').on('tap', '.mui-control-item', function() {
					console.log('folderlist:' + this.getAttribute('id') + '|' + this.getAttribute('data-path') + '|' + this.getAttribute('data-name'));
					var id = this.getAttribute('id');
					var fid = this.getAttribute('data-path');
					var fname = this.getAttribute('data-name');

					//底部界面显示
					document.getElementById("folder_" + showFolderId).style.display = 'none';
					document.getElementById("folder_" + fid).style.display = 'inline';
					showFolderId = fid; //底部显示的界面id
					var tempList = []; //记录保留下来的数据
					var del = false; //是否删除
					mui.each(folderList, function(index, item) {
						if(!del) {
							console.log('folderList保留:' + item);
							tempList.push(item);
							if(item == fid) {
								del = true;
							}
						} else {
							console.log('folderList删除:' + item);
							//删除顶部文件夹
							if(document.getElementById("top_" + item) != null) {
								//console.log('top_!=null');
								document.getElementById("top_" + item).parentNode.removeChild(document.getElementById("top_" + item));
							}
							//else {
							//console.log('top_==null');
							//}
							//删除底部文件夹界面
							if(document.getElementById("folder_" + item) != null) {
								//console.log('folder_!=null');
								document.getElementById("folder_" + item).parentNode.removeChild(document.getElementById("folder_" + item));
							}
							//else {
							//console.log('folder_==null');
							//}
						}
					});
					folderList = tempList;
				});

				/**
				 * 点击文件或文件夹
				 */
				mui('#all').on('tap', '.mui-table-view-cell', function() {
					var id = this.getAttribute('id'); //元素id
					var fid = this.getAttribute('data-fid'); //文件id
					var fname = this.getAttribute('data-fname'); //文件或文件夹名字
					var isFile = this.getAttribute('data-isFile'); //文件类型
					var isDirectory = this.getAttribute('data-isDirectory'); //文件类型
					console.log('点击文件或文件夹' + id + '|' + fid + "|" + fname + '|' + isFile + '|' + isDirectory);
					if(isDirectory == 'true') { //点击文件夹
						if(document.getElementById("folder_" + fid) != null) {
							console.log('点击文件夹folder_' + fid + '!=null');
							document.getElementById("folder_" + fid).parentNode.removeChild(document.getElementById("folder_" + fid));
						}
						//						else {
						//							console.log('点击文件夹folder_' + fid + '==null');
						//						}
						addTop(fid, fname); //顶部
						addbot(fid); //底部
						folderList.push(fid);

						//顶部处理
						document.getElementById('top_' + showFolderId).className = 'mui-control-item';
						document.getElementById('top_' + fid).className = 'mui-control-item mui-active';
						//底部处理
						document.getElementById("folder_" + showFolderId).style.display = 'none';
						document.getElementById("folder_" + fid).style.display = 'inline';
						showFolderId = fid;
						resolveLocalFileSystemURL(fid);
					} else if(isFile == 'true') {
						plus.io.resolveLocalFileSystemURL(fid, function(entry) {
							//请求成功的回调
							//succesCB:DirectoryEntry:请求到的目录或文件对象
							//console.log("请求文件系统成功");
							entry.getMetadata(function(succesCB) {
								//succesCB：文件或目录的状态信息
								//JSON对象，保存文件或目录的状态信息对象
								//说明：
								//可通过DirectoryEntry或FileEntry对象的getMetaData方法获取
								//属性：
								//modificationTime: (Date 类型 )文件或目录的最后修改时间
								//size: (Number 类型 )文件的大小，若获取的是目录对象的属性则值为0。
								//directoryCount: (Number 类型 )包含的子目录数，若自身是文件则其值为0。
								//fileCount: (Number 类型 )目录的文件数，若自身是文件则其值为0。
								console.log("获取目录或文件的属性成功");
								console.log("getMetadata:" + JSON.stringify(succesCB));
								console.log("readFileSize：" + AndroidFileSystem.readSize(succesCB.size));
								//限制50M
								if(succesCB.size <= (50 * 1024 * 1024)) {
									//跳转到传输列表
									events.fireToPageWithData('storage_transport.html', 'addUpload', {
										path: fid, //路径
										fname: fname, //文件名
										metadata: succesCB, //文件信息
										pid: pid //云盘文件夹父ID
									});
								} else {
									mui.toast('上传文件不得大于50M');
								}
							}, function(errorCB) {
								mui.toast('获取目录或文件的属性失败');
								console.log("获取目录或文件的属性失败: " + JSON.stringify(errorCB));
							});
						}, function(errorCB) {
							//请求失败的的回调
							if(errorCB.code == 12) {
								mui.toast('请求文件系统失败:文件不存在');
								console.log("请求文件系统失败: " + JSON.stringify(errorCB));
							} else {
								mui.toast('请求文件系统失败:' + JSON.stringify(errorCB));
								console.log("请求文件系统失败: " + JSON.stringify(errorCB));
							}
						});
					}
				});

				//界面初始化
				function init() {
					document.getElementById("folderlist").innerHTML = '';
					document.getElementById("all").innerHTML = '';
					createFolder();
				}

				/**
				 * 在程序中创建utid的文件夹
				 */
				function createFolder() {
					var url = plus.io.PUBLIC_DOCUMENTS;
					//  PRIVATE_WWW: 应用运行资源目录常量
					//  PRIVATE_DOC: 应用私有文档目录常量
					//  PUBLIC_DOCUMENTS: 程序公用文档目录常量
					//  PUBLIC_DOWNLOADS: 程序公用下载目录常量
					//					var path = plus.io.convertLocalFileSystemURL(url);
					//					var newurl = plus.io.convertAbsoluteFileSystem(url);
					//					console.log("initIOS: " + path + '|' + newurl);
					plus.io.requestFileSystem(url, function(succesCB) {
						//请求成功的回调
						//succesCB:FileSystem:请求到的文件系统对象
						//属性：
						//name: 文件系统的名称
						//root: 文件系统中的目录对象，用于管理特定的本地目录
						console.log("请求文件系统成功");
						console.log("文件系统的名称:" + succesCB.name);
						console.log("文件系统中的目录对象:" + succesCB.root.fullPath);
						var LocalURL = succesCB.root.toLocalURL();
						var URL = succesCB.root.toURL();
						console.log("root: " + LocalURL + '|' + URL);
						var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid;
						console.log("getDirectory: " + LocalURL + personalUTID + "/");
						//创建utid文件夹
						getDirectory(succesCB.root, personalUTID, function(succesCB2) {
							//创建下载文件夹
							getDirectory(succesCB2, 'download', function(succesCB3) {
								//创建上传文件夹
								getDirectory(succesCB2, 'upload', function(succesCB4) {
									if(mui.os.ios) { //iOS系统
										initElement(succesCB2.toLocalURL());
									}
								});
							});
						});

					}, function(errorCB) {
						//请求失败的的回调
						mui.toast("请求文件系统失败: " + JSON.stringify(errorCB));
						console.log("请求文件系统失败: " + JSON.stringify(errorCB));
					});
					if(mui.os.android) { //android系统
						initANDROID();
					}
				}

				function initANDROID() {
					initElement('/storage/');
				}

				function initElement(path) {
					console.log('initElement:' + path);
					addTop(path, '手机'); //顶部
					addbot(path); //底部
					folderList.push(path);
					showFolderId = path;
					document.getElementById("folder_" + path).style.display = 'inline';
					resolveLocalFileSystemURL(path);
				}

				//通过URL参数获取目录对象或文件对象
				function resolveLocalFileSystemURL(URL) {
					plus.io.resolveLocalFileSystemURL(URL, function(succesCB) {
						//请求成功的回调
						//succesCB:DirectoryEntry:请求到的目录或文件对象
						//console.log("请求文件系统成功");
						directoryReader(URL, succesCB); //读取对象
					}, function(errorCB) {
						//请求失败的的回调
						mui.toast('请求文件系统失败' + JSON.stringify(errorCB));
						console.log("请求文件系统失败: " + JSON.stringify(errorCB));
					});
				}

				/**
				 * 创建或打开子目录
				 * @param {Object} entry 文件系统中的目录对象
				 * @param {Object} name 目录名字
				 * @param {Object} succesCB 成功的回调
				 * @param {Object} errorCB 失败的回调
				 */
				function getDirectory(entry, name, succesCallBack, errorCallBack) {
					entry.getDirectory(name, {
						create: true,
						exclusive: false
					}, function(succesCB) {
						console.log("创建或打开子目录" + name + "成功");
//						console.log("文件系统的名称:" + succesCB.name);
//						console.log("文件系统中的目录对象:" + succesCB.fullPath);
						succesCallBack(succesCB);
					}, function(errorCB) {
						mui.toast("创建或打开子目录" + name + "失败:" + JSON.stringify(errorCB));
						console.log("创建或打开子目录" + name + "失败: " + JSON.stringify(errorCB));
						errorCallBack(errorCB);
					});
				}

				/**
				 * 读取目录下的文件及子目录
				 * @param {Object} URL 目录路径
				 * @param {Object} entry 文件系统对象
				 */
				function directoryReader(URL, entry) {
					//创建一个目录读取对象，用户读取目下的文件及子目录。
					//DirectoryReader entry.createReader();
					//返回值：DirectoryReader : 目录读取对象
					//DirectoryReader
					//方法：
					//readEntries: 获取当前目录中的所有文件和子目录
					//directoryReader.readEntries( succesCB, errorCB );
					var directoryReader = entry.createReader();
					directoryReader.readEntries(function(succesCB) {
						//succesCB:文件或目录对象的引用,可指向文件或目录对象（DirectoryEntry|FileEntry）
						console.log("获取当前目录中的所有文件和子目录成功");
						mui.each(succesCB, function(index, element) {
							//console.log("directoryReader:" + JSON.stringify(element));
							additem(URL, element)
						});
						if(succesCB.length == 0) {
							mui.toast('没有文件');
						}
						//---滑动start---
						mui(".mui-scroll-wrapper").scroll({
							scrollY: true, //是否竖向滚动
							scrollX: false, //是否横向滚动
							indicators: true, //是否显示滚动条
							deceleration: 0.0006, //阻尼系数,系数越小滑动越灵敏
							bounce: true, //是否启用回弹
						});
						//---滑动end---

					}, function(errorCB) {
						mui.toast("获取当前目录中的所有文件和子目录失败: " + JSON.stringify(errorCB));
						console.log("获取当前目录中的所有文件和子目录失败: " + JSON.stringify(errorCB));
					});
				}

				/**
				 * 新增一个空的文件夹
				 * @param {Object} pid 父id
				 */
				function addbot(path) {
					console.log('addbot:' + path);
					var top = 45 + 38 + localStorage.getItem('StatusHeightNo') * 1;
					var div = document.createElement('div');
					div.setAttribute('id', 'folder_' + path);
					div.innerHTML = '<div class="mui-scroll-wrapper"style="top:' + top + 'px;margin-bottom: 91px;">\
										<div class="mui-scroll">\
											<ul id="ul_' + path + '" class="mui-table-view">\
											<div id="ul_folder_' + path + '"></div>\
											<div id="ul_file_' + path + '"></div>\
											</ul>\
										</div>\
									</div>';
					div.style.display = 'none';
					document.getElementById("all").appendChild(div);
				}

				/**
				 * 顶部增加一项文件夹
				 * @param {Object} fid 文件id
				 * @param {Object} fname 文件名
				 */
				function addTop(path, name) {
					console.log('addTop:' + path + '|' + name);
					var div = document.createElement('div');
					div.setAttribute('id', 'top_' + path);
					div.setAttribute('data-path', path);
					div.setAttribute('data-name', name);
					div.className = 'mui-control-item';
					if(folderList.length == 0) {
						div.className = 'mui-control-item mui-active';
					}
					div.innerText = name + ' >';
					document.getElementById("folderlist").appendChild(div);
				}

				/**
				 * 新增一个文件或文件夹
				 * @param {Object} URL 父文件夹路径
				 * @param {Object} data
				 */
				function additem(URL, data) {
					//console.log('additem:URL：' + URL + '|data：' + data.fullPath);
					if(mui.os.ios) { //android系统
						data.fullPath = 'file://' + data.fullPath
					}
					var li = document.createElement('li');
					li.setAttribute('id', 'fid_' + data.fullPath); //元素id
					li.setAttribute('data-fid', data.fullPath); //文件id
					li.setAttribute('data-fname', data.name); //文件名
					li.setAttribute('data-isFile', data.isFile); //类型
					li.setAttribute('data-isDirectory', data.isDirectory); //类型
					li.className = 'mui-table-view-cell mui-media';
					//文件夹右侧箭头
					var html1 = '';
					//文件或文件图标
					var html2 = '';
					//文件名
					var html3 = '';
					if(data.name[0] == '.') { //隐藏的文件夹或文件
						//console.log('隐藏的文件夹或文件');
					} else if(data.isDirectory) { //文件夹
						html1 = '<span class="mui-navigate-right mui-media-object mui-pull-right"></span>';
						html2 = '<img class="mui-media-object mui-pull-left" src="../../image/cloud/A_folder.png">';
						html3 = '<div class="mui-media-body">\
									<div id="fname_' + data.fullPath + '/' + '" class="mui-ellipsis">' + data.name + '</div>\
								</div>';
						li.innerHTML = html1 + html2 + html3;
						document.getElementById("ul_folder_" + URL).appendChild(li);
					} else if(data.isFile) {
						html1 = '<span class="mui-media-object mui-pull-right"></span>';
						var type = cloud.classify2(data.name);
						//console.log(type);
						html2 = '<span class="mui-media-object mui-icon iconfont iconfont-size ' + type + ' mui-pull-left"></span>';
						html3 = '<div class="mui-media-body">\
								<div id="fname_' + data.fullPath + '/' + '" class="mui-ellipsis">' + data.name + '</div>\
							</div>';
						li.innerHTML = html1 + html2 + html3;
						document.getElementById("ul_file_" + URL).appendChild(li);
					}
				}
			});
		</script>
	</body>

</html>