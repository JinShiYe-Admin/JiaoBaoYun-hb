<!--
	作者：444811716@qq.com
	时间：2016-10-26
	描述：云盘主页
-->
<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<link rel="stylesheet" href="../../css/iconfont/iconfont.css" />
		<link rel="stylesheet" href="../../css/cloud/file.css" />
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/utils/events.js"></script>
		<script type="text/javascript" src="../../js/publicProtocol.js"></script>
		<script type="text/javascript" src="../../js/cloud/cloud.js"></script>
		<style>
			.cloud-top {
				/*界面顶部区域*/
				background-repeat: no-repeat;
				/*不重复*/
				background-size: 100%;
				/*宽度占100%*/
			}

			.cloud-info {
				position: absolute;
				/*顶部信息*/
				/*left: 0;*/
				top: 2%;
				/*float: left;*/
				/*text-align: left;*/
				margin-left: 55%;
			}

			#cloud_prsonalimge {
				/*个人头像*/
				border-radius: 50%;
				height: 70px;
				width: 70px;
				margin-top: 10px;
				float: right;
				margin-right: 10px;
			}

			#cloud_name {
				/*名字*/
				color: white;
				margin-bottom: 0px;
				font-size: 18px;
			}

			.cloud-top-icon {
				/*图标*/
				width: 20px;
				height: 20px;
			}

			#gift,
			#yuan {
				/*积分和钱*/
				color: #FF6600;
				margin-right: 10px;
				font-weight: 900;
				margin-left: 5px;
			}

			.mui-progressbar {
				/*进度条*/
				margin-top: 5px;
				margin-bottom: 5px;
				height: 10px;
				width: 30%;
			}

			.cloud-capacity {
				/*容量*/
				margin-top: 0px;
				color: white;
			}

			.mui-table-view:before,
			.mui-table-view:after,
			.mui-table-view-cell:after {
				height: 0px;
			}

			.mui-table-view-cell {
				background: white;
			}

			.mui-table-view.mui-grid-view .mui-table-view-cell {
				margin-right: 0px;
			}

			.cloud-bottom-imge {
				/*云存储的文件夹图片*/
				height: 40px;
				width: 50px;
			}

			.cloud-bottom-imge2 {
				/*云档案，云应用的图片*/
				height: 50px;
				width: 50px;
				/*margin-top: 10px;*/
			}

			.cloud-bottom-imge2-bg {
				/*云档案，云应用的图片背景*/
				height: 50px;
				width: 50px;
				border-radius: 50%;
				margin: auto;
			}

			.cloud-bottom-icon {
				/*云存储右侧按钮*/
				height: 20px;
				width: 20px;
			}

			.cloud-text-align-center {
				text-align: center;
			}

			.cloud-line {
				/*功能名字右侧树竖线*/
				position: absolute;
				right: 0;
				top: 1%;
				width: 1px;
				background: #D9D9D9;
				height: 100%;
			}

			#cloudstorage,
			#cloudapps,
			#cloudrecord {
				background-color: white;
				padding: 10px;
				margin: 0;
			}

			.mui-table-view {
				background: transparent;
				min-height: 90px;
				margin: 20px 0 !important;
				padding: 16px 0 !important;
			}

			.mui-progressbar {
				border-radius: 5px;
				background-color: #EBEBEB;
			}

			.mui-progressbar span {
				background-color: #4aa5fc;
			}

			.iconfont {
				font-size: 45px;
			}

			.mui-table-view.mui-grid-view .cloud-font {
				font-weight: bold;
				width: 16%;
				padding: 0 12px;
			}
		</style>
	</head>

	<body>
		<div class="mui-content">
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<!--顶部-->
					<div class="cloud-top" style="min-height: 100px;width:100%;">
						<img id="imge_bg" src="../../image/cloud/cloud_bg2.png" style="width: 100%;position: absolute;" />
						<div class="cloud-info" style="width: 100%;">
							<div style="width: 45%;">
								<div id="cloud_name" class="common-font-family-Bold mui-ellipsis" style="float: left;width: 100%;">
								</div>
							</div>
							<br />
							<div class="mui-progressbar mui-progressbar-in" style="float: left;">
								<span></span>
							</div>
							<br />
							<div class="cloud-capacity" style="float: left;">
								总容量:1000G
							</div>
							<br />
							<div class="cloud-capacity" style="float: left;">
								已用800G 剩余:200G
							</div>
						</div>
					</div>
					<div id="bottom" style="width: 100%;position: relative;">
						<!--云存储-->
						<ul id="cloudstorage" class="mui-table-view mui-grid-view " style="padding-right: 0px;">
							<li class="mui-table-view-cell mui-media cloud-font">
								存<br/>储
							</li>
							<li class="mui-table-view-cell mui-media " style="padding: 5px;margin: 0;width: 66%;border-left: 1px solid #d9d9d9;">
								<div class="mui-row" id="cloudstoragefile">
									<!--<div class="mui-col-sm-4 mui-col-xs-4 cloud-text-align-center">
									<img class="cloud-bottom-imge" src="../../image/cloud/cloud_doc.png" />
									<span class="mui-icon iconfont icon-txt"></span>
									<p class="mui-ellipsis">泰国旅游照片泰国旅游照片</p>
								</div>
								<div class="mui-col-sm-4 mui-col-xs-4 cloud-text-align-center">
									<img class="cloud-bottom-imge" src="../../image/cloud/A_folder.png" />
									<p class="mui-ellipsis">H5基础视频</p>
								</div>
								<div class="mui-col-sm-4 mui-col-xs-4 " id="addFolder">
									<img class="cloud-bottom-imge" style="margin-top: 4px;" src="../../image/cloud/A_addfolder.png" />
								</div>-->
								</div>
							</li>
							<li class="mui-table-view-cell mui-media " style="padding: 0;width:18%;">
								<span class="mui-icon mui-icon-arrowright" style="color: #CCCCCC;"></span>
							</li>
						</ul>
						<!--云档案-->
						<ul id="cloudrecord" class="mui-table-view mui-grid-view">
							<li class="mui-table-view-cell mui-media cloud-font" style="width: 16%;">
								档<br/>案
							</li>
							<li class="mui-table-view-cell mui-media mui-col-sm-11 mui-col-xs-11 " style="padding: 5px;margin: 0;width:84% ;border-left: 1px solid #d9d9d9;">
								<div id="record_row" class="mui-row">
									<!--<div class="mui-col-sm-3 mui-col-xs-3 cloud-text-align-center">
									<div class="cloud-bottom-imge2-bg">
										<img class="cloud-bottom-imge2" src="../../image/cloud/archives.png" />
									</div>
									<p class="mui-ellipsis">档案</p>
								</div>
								<div id="learningpath" class="mui-col-sm-3 mui-col-xs-3 cloud-text-align-center" value="1">
									<div class="cloud-bottom-imge2-bg">
										<img class="cloud-bottom-imge2" src="../../image/cloud/Trajectory.png" />
									</div>
									<p class="mui-ellipsis">学习轨迹</p>
								</div>
								-->
								</div>
							</li>
						</ul>
						<!--云应用-->
						<ul id="cloudapps" class="mui-table-view mui-grid-view">
							<li class="mui-table-view-cell mui-media cloud-font" style="width: 16%;">
								应<br/>用
							</li>
							<li class="mui-table-view-cell mui-media mui-col-sm-11 mui-col-xs-11 " style="padding: 5px;margin: 0;width: 84%;border-left: 1px solid #d9d9d9;">
								<div class="mui-row">
									<div class="mui-col-sm-3 mui-col-xs-3 cloud-text-align-center" value="0">
										<div class="cloud-bottom-imge2-bg">
											<img class="cloud-bottom-imge2" src="../../image/cloud/notes.png" />
										</div>
										<p class="mui-ellipsis" style="margin-top:5px;">笔记</p>
									</div>
									<div class="mui-col-sm-3 mui-col-xs-3 cloud-text-align-center" value="1">
										<div class="cloud-bottom-imge2-bg">
											<img class="cloud-bottom-imge2" src="../../image/cloud/note.png" />
										</div>
										<p class="mui-ellipsis" style="margin-top:5px;">记事</p>
									</div>
									<div class="mui-col-sm-3 mui-col-xs-3 cloud-text-align-center" value="3">
										<div class="cloud-bottom-imge2-bg">
											<img class="cloud-bottom-imge2-bg" src="../../image/cloud/operation.png" />
										</div>
										<p class="mui-ellipsis" style="margin-top:5px;">作业</p>
									</div>
								</div>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript">
			mui.init();

			//声明变量
			//存储数组
			var fileArray = [];

			mui.plusReady(function() {
				events.preload("../homework/homework-tea.html", 300);
				events.preload('storage_main.html'); //预加载云存储
				events.preload('storage_upload.html'); //预加载上传文件选择
				events.preload('storage_upload_choose.html'); //预加载选择上传文件的方式
				//初始化滚动条
				//---滑动start---
				mui(".mui-scroll-wrapper").scroll({
					scrollY: true, //是否竖向滚动
					scrollX: false, //是否横向滚动
					indicators: true, //是否显示滚动条
					deceleration: 0.0006, //阻尼系数,系数越小滑动越灵敏
					bounce: true, //是否启用回弹
				});
				//---滑动end---
				//				var imge_bg = document.getElementById("imge_bg");
				//				setTimeout(function() {
				//					imge_bg.onload = function() {
				//						console.log('onload:' + imge_bg.height + 'px');
				//						document.getElementById("bottom").style.top = imge_bg.height + 'px';
				//					};
				//				}, 1000);
				//-----------设置数据start---------------
				//设置进度条进度
				mui('.mui-progressbar').progressbar({
					progress: 80
				}).show();

				//增加存储文件，获取顶层文件夹
				//26.用户云盘顶层文件及文件夹获取
				//postFirstFile();

				changeInfo();
				changeData();
				//73.73.（云档案）按家长获取学生档案姓名
				//postUserStudent();

				//重新登录或者自动登录后获取的信息
				window.addEventListener('infoChanged', function() {
					//设置页面信息
					changeInfo();
					changeData();
					events.fireToPageNone('storage_upload.html', 'createFolder'); //在程序中创建utid的文件夹和对应的上传下载文件夹
					fileArray = []
				});

				//修改用户信息
				window.addEventListener('personChanged', function() {
					//设置页面信息
					changeInfo();
				});

				//修改云存储信息
				window.addEventListener('cloudDataChange', function() {
					//设置页面信息
					changeCloudData();
				});

				//-----------设置数据end-----------------

				//-----------设置监听start---------------

				//上传按钮
				window.addEventListener('upload', function() {
					events.fireToPageWithData('storage_upload_choose.html', 'init', {
						fid: '0', //文件id,顶层0
						showTop: false, //是否显示顶部的上传，传输列表，文件夹，如果是选择云盘上的文件夹则为false
						title: '我的教宝云盘', //标题名
						top: fileArray //顶层文件和文件夹的数据
					});
				});

				//---存储start---
				//云存储显示的文件
				mui('#cloudstorage').on('tap', '.cloud-text-align-center', function() {
					events.fireToPageWithData('storage_main.html', 'init', {
						fid: '0', //文件id,顶层0
						showTop: true, //是否显示顶部的上传，传输列表，文件夹，如果是选择云盘上的文件夹则为false
						title: '云盘—云存储', //标题名
						top: fileArray //顶层文件和文件夹的数据
					});
					//					console.log('tap:' + this.getAttribute("data-fid"));
					//					var fid = this.getAttribute("data-fid"); //文件id
					//					var title = '';
					//					mui.each(fileArray, function(index, item) {
					//						console.log('fileArray:' + index + '|' + JSON.stringify(item));
					//						if(fid == item.fid) {
					//							title = item.fname;
					//							return false;
					//						}
					//					});
					//					events.fireToPageWithData('storage_main.html', 'init', {
					//						fid: fid, //文件id
					//						showTop: true, //是否显示顶部的上传，传输列表，文件夹，如果是选择云盘上的文件夹则为false
					//						title: title, //标题名
					//						top: fileArray //顶层文件和文件夹的数据
					//					});
				});

				//云存储右侧按钮
				mui('#cloudstorage').on('tap', '.mui-icon-arrowright', function() {
					events.fireToPageWithData('storage_main.html', 'init', {
						fid: '0', //文件id,顶层0
						showTop: true, //是否显示顶部的上传，传输列表，文件夹，如果是选择云盘上的文件夹则为false
						title: '云盘—云存储', //标题名
						top: fileArray //顶层文件和文件夹的数据
					});
				});

				//增加文件夹
				mui('#cloudstorage').on('tap', '#addFolder', function(e) {
					e.detail.gesture.preventDefault(); //修复iOS 8.x平台存在的bug，使用plus.nativeUI.prompt会造成输入法闪一下又没了
					var btnArray = ['取消', '确定'];
					mui.prompt('请输入新文件夹的名称：', '新文件夹', '新建文件夹', btnArray, function(e) {
						if(e.index == 1) { //点击确定
							var reg = new RegExp('^[^\\\\\\/:*?\\"<>|]+$'); //特殊字符过滤的正则表达式
							if(e.value.replace(/(^\s*)|(\s*$)/g, "") == "") {
								mui.toast('文件夹名字不能为空');
							} else if(!reg.test(e.value)) {
								//特殊字符
								mui.toast('名字中不能包含这些字符 \ / : * ? " < > | ');
							} else {
								//27.用户云盘文件上传或创建文件夹
								//所需参数
								var comData = {
									pid: '0', //	父ID，该文件的上层ID
									fname: e.value, //	文件名称，文件或文件夹名称,文件存扩展名之前的名称
									ftype: '.file', //	文件类型，存文件的扩展名,如.file为文件夹
									fpath: '', //	文件路径，文件路径,为文件用
									fsize: '0' //	文件大小，文件用
								};
								// 等待的对话框
								var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
								postDataPro_PostDiFiA(comData, wd, function(data) {
									wd.close();
									console.log('27.postDataPro_PostDiFiA:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
									if(data.RspCode == 0) {
										//26.用户云盘顶层文件及文件夹获取
										postFirstFile();
									} else if(data.RspCode == 8) {
										mui.toast('操作失败！已存在相同的名字');
									} else {
										mui.toast(data.RspTxt);
									}
								});
							}
						} else {
							//点击取消
						}
					}, 'div');
					document.querySelector('.mui-popup-input input').type = 'text';
					document.querySelector('.mui-popup-input input').maxLength = '20';
				});

				//---存储end---

				//---应用---
				mui('#cloudapps').on('tap', '.mui-col-sm-3', function() {
					var value = this.getAttribute("value");
					switch(value) {
						case "0": //笔记
							events.openNewWindow('app_notes_main.html');
							break;
						case "1": //记事
							events.openNewWindow('app_keeprecord.html');
							break;
							//						case "2": //充值
							//							events.openNewWindow('../quan/studentdynamic_main.html');
							//							break;
						case "3": //作业批改
							requestClassData();
							break;
					}
				});
				/**
				 * 获取用户所在群数据
				 */
				function requestClassData() {
					var teacherClasses = [];
					var studentClasses = [];
					var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid;
					//获取当前账号，所在的群
					//需要参数
					var comData = {
						vtp: 'ag', //要获取的项:cg(创建的群),ug(参与群),mg(协管的群),ag(所有的群),ig(群信息vvl对应群ID)
						vvl: personalUTID //查询的各项，对应人的utid，可以是查询的任何人
					};
					// 等待的对话框
					var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
					//9.获取用户群
					postDataPro_PostGList(comData, wd, function(data) {
						wd.close();
						console.log('作业主界面获取的群信息：' + JSON.stringify(data));
						if(data.RspCode == 0) {
							var tempArray = data.RspData;
							//			gid:'14',//群ID
							//			gname:'10群',//群名
							//			gimg:'',//群头像,群头像的链接
							//			mstype:'2'//用户角色,0家长,1管理员,2老师,3学生
							//然后检索身份为老师或者家长、学生的
							for(var i in tempArray) {
								var tempModel = tempArray[i];

								var isHave = false;
								//2老师
								if(tempModel.mstype == 2 || tempModel.mstype == 1) {
									for(var m in teacherClasses) {
										if(tempModel.gid == teacherClasses[m].gid) {
											isHave = true;
											break;
										}
									}
									if(!isHave) {
										teacherClasses.push(tempModel);
									}
								}
								var isHave1 = false;
								//家长、学生
								if(tempModel.mstype == 0 || tempModel.mstype == 3) {
									for(var m in studentClasses) {
										if(tempModel.gid == studentClasses[m].gid) {
											isHave1 = true;
											break;
										}
									}
									if(!isHave1) {
										studentClasses.push(tempModel);
									}
								}
							}
							if(teacherClasses.length > 0 || studentClasses.length > 0) {
								console.log('teacherClasses:' + teacherClasses.length + ',' + studentClasses.length);
								events.fireToPageWithData('../homework/homework-tea.html', 'postClasses', {
									teacherClasses: teacherClasses,
									studentClasses: studentClasses
								})
							} else {
								mui.toast('您还未加入班级');
							}
						} else {
							mui.toast(data.RspTxt);
						}
					});
				}
				//
				//26.用户云盘顶层文件及文件夹获取
				function postFirstFile() {
					//所需参数
					var comData = {
						vvl: '0' //	节点ID，顶层为0
					};
					// 等待的对话框
					var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
					postDataPro_PostDiFi(comData, wd, function(data) {
						wd.close();
						console.log('26.postDataPro_PostDiFi_用户云盘顶层文件及文件夹获取_RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
						if(data.RspCode == 0) {
							//给存储数组赋值
							if(data.RspData != null && data.RspData != '') {
								fileArray = data.RspData;
							} else {
								fileArray = [];
							}
							//清掉所有文件夹
							var table = document.getElementById("cloudstoragefile");
							table.innerHTML = '';
							//循环将获取到的值塞入界面
							for(var i in data.RspData) {
								if(i == 3) { //只显示3个文件或文件夹
									return false;
								}
								var tempModel = data.RspData[i];
								addStorageFolder(tempModel);
							}
							//增加加号
							if(fileArray.length < 3) {
								addStorageIcon();
							}
						} else if(data.RspCode == 9) {
							addStorageIcon();
						} else {
							mui.toast(data.RspTxt);
						}
					});
				}

				//73.（云档案）按家长获取学生档案姓名
				function postUserStudent() {
					var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid;
					//73.（云档案）按家长获取学生档案姓名
					//所需参数
					var comData = {
						parentId: personalUTID //家长ID
					};
					//返回学生姓名数组
					// 等待的对话框
					var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
					postDataPro_getStudentName(comData, wd, function(data) {
						wd.close();
						console.log('73.postDataPro_getStudentName:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
						if(data.RspCode == 0) {
							//设置页面显示
							document.getElementById("record_row").innerHTML = '';
							addLeaningPath(); //学习轨迹
							mui.each(data.RspData.Students, function(index, item) {
								console.log('学生档案：' + index + '|' + JSON.stringify(item));
								addRecord(item);
							});
						} else if(data.RspCode == 9) {
							addLeaningPath(); //学习轨迹
						} else {
							mui.toast(data.RspTxt);
						}
					});
				}

				//-----------设置监听end---------------

				/**
				 * 增加存储的文件夹或文件
				 * @param {Object} data
				 */
				function addStorageFolder(data) {
					var table = document.getElementById("cloudstoragefile");
					var div = document.createElement("div");
					div.setAttribute('data-fid', data.fid);
					div.className = 'mui-col-sm-4 mui-col-xs-4 cloud-text-align-center';
					var html1 = ''; //图标
					var html2 = ''; //名字
					if(data.ftype == '.file') { //文件夹
						html1 = '<img class="cloud-bottom-imge" src="../../image/cloud/A_folder.png" />';
						html2 = '<p class="mui-ellipsis">' + data.fname + '</p>';
					} else { //文件
						var type = cloud.classify(data.ftype);
						var pathList = data.fpath.split('/');
						var pathList2 = pathList[pathList.length - 1].split('.');
						var fileName = pathList2[0];
						var path = window.storageKeyName.QNFILEIMGEDOMAIN + fileName + '.PNG';
						if(type != '') {
							html1 = '<span class="mui-icon iconfont ' + type + '"></span>';
						} else { //七牛能生成缩略图的图片或视频
							html1 = '<img class="cloud-bottom-imge" src="' + path + '" />';
						}
						html2 = '<p class="mui-ellipsis">' + data.fname + data.ftype + '</p>';
					}
					div.innerHTML = html1 + html2;
					table.appendChild(div);
				}

				/**
				 * 增加文件夹的按钮（加号按钮）
				 */
				function addStorageIcon() {
					var table = document.getElementById("cloudstoragefile");
					var div = document.createElement('div');
					div.id = 'addFolder';
					div.className = 'mui-col-sm-4 mui-col-xs-4';
					div.innerHTML = '<img class="cloud-bottom-imge" style="margin-top: 4px;" src="../../image/cloud/A_addfolder.png" /><p class="mui-ellipsis"> </p>';
					table.appendChild(div);
				}

				/**
				 * 增加档案
				 * @param {Object} data
				 */
				function addRecord(data) {
					var div = document.createElement('div');
					div.setAttribute('data-studentName', data);
					div.className = 'mui-col-sm-3 mui-col-xs-3 cloud-text-align-center';
					div.innerHTML = '<div class="cloud-bottom-imge2-bg">\
										<img class="cloud-bottom-imge2" src="../../image/cloud/archives.png" />\
									</div>\
									<p class="mui-ellipsis" style="margin-top:5px;">' + data.StudentName + '档案</p>';
					document.getElementById("record_row").insertBefore(div, document.getElementById("learningpath"));
					div.addEventListener('tap', function() {
						events.openNewWindowWithData('record_student_main.html', {
							StudentId: data.StudentId, //学生ID
							StudentName: data.StudentName //学生姓名
						});
					});
				}

				/**
				 * 学习轨迹
				 */
				function addLeaningPath() {
					var div = document.createElement('div');
					div.setAttribute('id', 'learningpath');
					div.className = 'mui-col-sm-3 mui-col-xs-3 cloud-text-align-center';
					div.innerHTML = '<div class="cloud-bottom-imge2-bg">\
										<img class="cloud-bottom-imge2" src="../../image/cloud/Trajectory.png" />\
									</div>\
									<p class="mui-ellipsis" style="margin-top:5px;">学习轨迹</p>';
					document.getElementById("record_row").appendChild(div);
					//学习轨迹监听
					div.addEventListener('tap', function() {
						mui.toast('功能暂未开放');
						//events.openNewWindow('record_learningpath_main.html');
					});
				}

				/**
				 * 修改账号资料
				 */
				function changeInfo() {
					document.getElementById("cloud_name").innerText = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).unick;
					//					document.getElementById("cloud_prsonalimge").src = updateHeadImg(window.myStorage.getItem(window.storageKeyName.PERSONALINFO).uimg, 2);
				}

				/**
				 * 修改云盘的文件，档案数据
				 */
				function changeData() {
					document.getElementById("cloudstoragefile").innerHTML = '';
					document.getElementById("record_row").innerHTML = '';
					//26.用户云盘顶层文件及文件夹获取
					postFirstFile();
					//73.（云档案）按家长获取学生档案姓名
					postUserStudent();
				}

				/**
				 * 修改云盘的文件
				 */
				function changeCloudData() {
					document.getElementById("cloudstoragefile").innerHTML = '';
					//26.用户云盘顶层文件及文件夹获取
					postFirstFile();
				}
			});
		</script>
	</body>

</html>