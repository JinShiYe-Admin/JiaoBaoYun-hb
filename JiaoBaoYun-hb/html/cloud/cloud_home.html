<!--
	作者：444811716@qq.com
	时间：2016-10-26
	描述：云盘主页
-->
<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<link rel="stylesheet" href="../../css/iconfont/iconfont.css" />
		<link rel="stylesheet" href="../../css/cloud/file.css" />
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/utils/events.js"></script>
		<script type="text/javascript" src="../../js/publicProtocol.js"></script>
		<script type="text/javascript" src="../../js/cloud/cloud.js"></script>
		<style>
			.cloud-top {
				/*界面顶部区域*/
				background-repeat: no-repeat;
				/*不重复*/
				background-size: 100%;
				/*宽度占100%*/
			}

			.cloud-info {
				/*顶部信息*/
				padding: 10px;
			}

			#cloud_prsonalimge {
				/*个人头像*/
				border-radius: 50%;
				height: 70px;
				width: 70px;
				margin-top: 10px;
				float: right;
				margin-right: 10px;
			}

			#cloud_name {
				/*名字*/
				color: white;
				margin-bottom: 5px;
			}

			.cloud-top-icon {
				/*图标*/
				width: 20px;
				height: 20px;
			}

			#gift,
			#yuan {
				/*积分和钱*/
				color: #FF6600;
				margin-right: 10px;
				font-weight: 900;
				margin-left: 5px;
			}

			.mui-progressbar {
				/*进度条*/
				margin-top: 5px;
				margin-bottom: 5px;
				height: 10px;
				width: 70%;
			}

			.cloud-capacity {
				/*容量*/
				margin-top: 3px;
				color: white;
			}

			.mui-table-view:before,
			.mui-table-view:after,
			.mui-table-view-cell:after {
				height: 0px;
			}

			.mui-table-view {
				background: transparent;
				min-height: 90px;
			}

			.mui-table-view-cell {
				background: white;
			}

			.cloud-bottom-imge {
				/*云存储的文件夹图片*/
				height: 40px;
				width: 50px;
			}

			.cloud-bottom-imge2 {
				/*云档案，云应用的图片*/
				height: 50px;
				width: 50px;
				/*margin-top: 10px;*/
			}

			.cloud-bottom-imge2-bg {
				/*云档案，云应用的图片背景*/
				height: 50px;
				width: 50px;
				border-radius: 50%;
				margin: auto;
			}

			.cloud-bottom-icon {
				/*云存储右侧按钮*/
				height: 20px;
				width: 20px;
			}

			.cloud-text-align-center {
				text-align: center;
			}

			.cloud-line {
				/*功能名字右侧树竖线*/
				position: absolute;
				right: 0;
				top: 1%;
				width: 1px;
				background: #A9A9A9;
				height: 50px;
			}

			#cloudstorage {
				background-color: white;
				padding: 10px;
				margin: 0;
				margin-top: 11px;
				padding-top: 7px;
				padding-bottom: 7px;
			}

			#cloudrecord,
			#cloudapps {
				background: white;
				padding: 10px;
				margin: 0;
				margin-top: 10px;
				padding-top: 10px;
				padding-bottom: 10px;
			}

			.mui-progressbar {
				border-radius: 5px;
			}

			.iconfont {
				font-size: 45px;
			}
		</style>
	</head>

	<body>
		<div class="mui-content">
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<!--顶部-->
					<div class="cloud-top" style="background-image: url(../../image/cloud/cloud_bg.png); ">
						<div class="cloud-info">
							<div class="mui-row">
								<div class="mui-col-sm-3 mui-col-xs-3">
									<img id="cloud_prsonalimge" src="../../image/utils/default_personalimage.png">
								</div>
								<div class="mui-col-sm-9 mui-col-xs-9" style="margin-top: 15px;">
									<div id="cloud_name" class="common-font-family-Bold mui-ellipsis">

									</div>
									<!--<font>
										<img class="cloud-top-icon" src="../../image/cloud/cloud_gift.png" />
										<font id="gift">1000</font>
										<img class="cloud-top-icon" src="../../image/cloud/cloud_yuan.gif" />
										<font id="yuan">50元</font>
									</font>-->
									<div class="mui-progressbar mui-progressbar-in">
										<span></span>
									</div>
									<div class="cloud-capacity">
										总容量:1000G 已用800G 剩余:200G
									</div>
								</div>
							</div>
						</div>
					</div>
					<!--云存储-->
					<ul id="cloudstorage" class="mui-table-view mui-grid-view ">
						<li class="mui-table-view-cell mui-media mui-col-sm-1 mui-col-xs-1" style="padding: 0;position: absolute;">
							<div style="font-weight: bold;">
								<div>存</div>
								<div>储</div>
								<div class="cloud-line"></div>
							</div>
						</li>
						<li class="mui-table-view-cell mui-media mui-col-sm-9 mui-col-xs-9 " style="padding: 5px;margin: 0;margin-left: 10%;">
							<div class="mui-row" id="cloudstoragefile">
								<!--<div class="mui-col-sm-4 mui-col-xs-4 cloud-text-align-center">
									<img class="cloud-bottom-imge" src="../../image/cloud/cloud_doc.png" />
									<span class="mui-icon iconfont icon-txt"></span>
									<p class="mui-ellipsis">泰国旅游照片泰国旅游照片</p>
								</div>
								<div class="mui-col-sm-4 mui-col-xs-4 cloud-text-align-center">
									<img class="cloud-bottom-imge" src="../../image/cloud/A_folder.png" />
									<p class="mui-ellipsis">H5基础视频</p>
								</div>
								<div class="mui-col-sm-4 mui-col-xs-4 " id="addFolder">
									<img class="cloud-bottom-imge" style="margin-top: 4px;" src="../../image/cloud/A_addfolder.png" />
								</div>-->
							</div>
						</li>
						<li class="mui-table-view-cell mui-media mui-col-sm-1 mui-col-xs-1 " style="padding: 0;">
							<img class="cloud-bottom-icon" src="../../image/cloud/rightarrow.png" />
						</li>
					</ul>
					<!--云档案-->
					<ul id="cloudrecord" class="mui-table-view mui-grid-view">
						<li class="mui-table-view-cell mui-media mui-col-sm-1 mui-col-xs-1" style="padding: 0;position: absolute;">
							<div style="font-weight: bold;">
								<div>档</div>
								<div>案</div>
								<div class="cloud-line"></div>
							</div>
						</li>
						<li class="mui-table-view-cell mui-media mui-col-sm-11 mui-col-xs-11 " style="padding: 5px;margin: 0;margin-left: 8%;">
							<div id="record_row" class="mui-row">
								<!--<div class="mui-col-sm-3 mui-col-xs-3 cloud-text-align-center">
									<div class="cloud-bottom-imge2-bg">
										<img class="cloud-bottom-imge2" src="../../image/cloud/archives.png" />
									</div>
									<p class="mui-ellipsis">档案</p>
								</div>
								<div id="learningpath" class="mui-col-sm-3 mui-col-xs-3 cloud-text-align-center" value="1">
									<div class="cloud-bottom-imge2-bg">
										<img class="cloud-bottom-imge2" src="../../image/cloud/Trajectory.png" />
									</div>
									<p class="mui-ellipsis">学习轨迹</p>
								</div>
								-->
							</div>
						</li>
					</ul>
					<!--云应用-->
					<ul id="cloudapps" class="mui-table-view mui-grid-view">
						<li class="mui-table-view-cell mui-media mui-col-sm-1 mui-col-xs-1" style="padding: 0;position: absolute;">
							<div style="font-weight: bold;">
								<div>应</div>
								<div>用</div>
								<div class="cloud-line"></div>
							</div>
						</li>
						<li class="mui-table-view-cell mui-media mui-col-sm-11 mui-col-xs-11 " style="padding: 5px;margin: 0;margin-left: 8%;">
							<div class="mui-row">
								<div class="mui-col-sm-3 mui-col-xs-3 cloud-text-align-center" value="0">
									<div class="cloud-bottom-imge2-bg">
										<img class="cloud-bottom-imge2" src="../../image/cloud/notes.png" />
									</div>
									<p class="mui-ellipsis">笔记</p>
								</div>
								<div class="mui-col-sm-3 mui-col-xs-3 cloud-text-align-center" value="1">
									<div class="cloud-bottom-imge2-bg">
										<img class="cloud-bottom-imge2" src="../../image/cloud/note.png" />
									</div>
									<p class="mui-ellipsis">记事</p>
								</div>
								<!--<div class="mui-col-sm-3 mui-col-xs-3 cloud-text-align-center" value="2">
									<div class="cloud-bottom-imge2-bg" style="background: #FF9861;">
										<img class="cloud-bottom-imge2" src="../../image/cloud/cloud_pay.png" />
									</div>
									<p class="mui-ellipsis">充值</p>
								</div>-->
								<div class="mui-col-sm-3 mui-col-xs-3 cloud-text-align-center" value="3">
									<div class="cloud-bottom-imge2-bg">
										<img class="cloud-bottom-imge2-bg" src="../../image/cloud/operation.png" />
									</div>
									<p class="mui-ellipsis">作业</p>
								</div>
								<!--<div class="mui-col-sm-3 mui-col-xs-3 cloud-text-align-center" value="3">
									<div class="cloud-bottom-imge2-bg" style="background: #31C27C;">
										<img class="cloud-bottom-imge2-bg" src="../../image/cloud/cloud_homework.png" />
									</div>
									<p class="mui-ellipsis">作业批改</p>
								</div>-->
							</div>
						</li>
					</ul>
				</div>
			</div>
		</div>
		<script type="text/javascript">
			mui.init();

			//声明变量
			//存储数组
			var fileArray = [];

			mui.plusReady(function() {
				events.preload("../homework/homework-tea.html", 300);
				//初始化滚动条
				mui('.mui-scroll-wrapper').scroll({
					indicators: true, //是否显示滚动条
					bounce: false, //是否启用回弹
				});
				//-----------设置数据start---------------
				//设置进度条进度
				mui('.mui-progressbar').progressbar({
					progress: 80
				}).show();

				//增加存储文件，获取顶层文件夹
				//26.用户云盘顶层文件及文件夹获取
				//postFirstFile();

				changeInfo();
				changeData();
				//73.73.（云档案）按家长获取学生档案姓名
				//postUserStudent();

				//重新登录或者自动登录后获取的信息
				window.addEventListener('infoChanged', function() {
					//设置页面信息
					changeInfo();
					changeData();
				});

				window.addEventListener('personChanged', function() {
					//设置页面信息
					changeInfo();
				});

				//-----------设置数据end-----------------

				//-----------设置监听start---------------
				//---存储start---
				//云存储显示的文件
				mui('#cloudstorage').on('tap', '.cloud-text-align-center', function() {
					console.log('tap:' + this.getAttribute("data-fid"));
					var fid = this.getAttribute("data-fid"); //文件id
					var title = '';
					mui.each(fileArray, function(index, item) {
						console.log('fileArray:' + index + '|' + JSON.stringify(item));
						if(fid == item.fid) {
							title = item.fname;
							return false;
						}
					});
					events.openNewWindowWithData('storage_main.html', {
						fid: fid, //文件id
						title: title, //标题名
						top: fileArray //顶层文件和文件夹的数据

					});
				});

				//云存储右侧按钮
				mui('#cloudstorage').on('tap', '.cloud-bottom-icon', function() {
					events.openNewWindowWithData('storage_main.html', {
						fid: '0', //文件id,顶层0
						title: '云盘—云存储', //标题名
						top: fileArray //顶层文件和文件夹的数据

					});
				});

				//增加文件夹
				mui('#cloudstorage').on('tap', '#addFolder', function(e) {
					e.detail.gesture.preventDefault(); //修复iOS 8.x平台存在的bug，使用plus.nativeUI.prompt会造成输入法闪一下又没了
					var btnArray = ['取消', '确定'];
					mui.prompt('请输入新文件夹的名称：', '新文件夹', '新建文件夹', btnArray, function(e) {
						if(e.index == 1) { //点击确定
							if(e.value.replace(/(^\s*)|(\s*$)/g, "") == "") {
								mui.toast('文件夹名字不能为空');
							} else {
								//27.用户云盘文件上传或创建文件夹
								//所需参数
								var comData = {
									pid: '0', //	父ID，该文件的上层ID
									fname: e.value, //	文件名称，文件或文件夹名称,文件存扩展名之前的名称
									ftype: '.file', //	文件类型，存文件的扩展名,如.file为文件夹
									fpath: '', //	文件路径，文件路径,为文件用
									fsize: '0' //	文件大小，文件用
								};
								// 等待的对话框
								var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
								postDataPro_PostDiFiA(comData, wd, function(data) {
									wd.close();
									console.log('27.postDataPro_PostDiFiA:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
									if(data.RspCode == 0) {
										//26.用户云盘顶层文件及文件夹获取
										postFirstFile();
									} else if(data.RspCode == 8) {
										mui.toast('操作失败！已存在相同的名字');
									} else {
										mui.toast(data.RspTxt);
									}
								});
							}
						} else {
							//点击取消
						}
					});
				});

				//---存储end---

				//---应用---
				mui('#cloudapps').on('tap', '.mui-col-sm-3', function() {
					var value = this.getAttribute("value");
					switch(value) {
						case "0": //笔记
							events.openNewWindow('app_notes_main.html');
							break;
						case "1": //记事
							events.openNewWindow('app_keeprecord.html');
							break;
							//						case "2": //充值
							//							events.openNewWindow('../quan/studentdynamic_main.html');
							//							break;
						case "3": //作业批改
							requestClassData();
							break;
					}
				});

				function requestClassData() {
					var teacherClasses = [];
					var studentClasses = [];
					var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid;
					//获取当前账号，所在的群
					//需要参数
					var comData = {
						vtp: 'ag', //要获取的项:cg(创建的群),ug(参与群),mg(协管的群),ag(所有的群),ig(群信息vvl对应群ID)
						vvl: personalUTID //查询的各项，对应人的utid，可以是查询的任何人
					};
					// 等待的对话框
					var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
					//9.获取用户群
					postDataPro_PostGList(comData, wd, function(data) {
						wd.close();
						console.log('作业主界面获取的群信息：' + JSON.stringify(data));
						if(data.RspCode == 0) {
							var tempArray = data.RspData;
							//			gid:'14',//群ID
							//			gname:'10群',//群名
							//			gimg:'',//群头像,群头像的链接
							//			mstype:'2'//用户角色,0家长,1管理员,2老师,3学生
							//然后检索身份为老师的
							for(var i in tempArray) {
								var tempModel = tempArray[i];
								//2老师
								if(tempModel.mstype == 2) {
									teacherClasses.push(tempArray[i]);
								}
								//家长、学生
								if(tempModel.mstype == 0 || tempModel.mstype == 3) {
									studentClasses.push(tempArray[i]);
								}
							}
							if(teacherClasses.length > 0 || studentClasses.length > 0) {
								events.fireToPageWithData('../homework/homework-tea.html', 'postClasses', {
									teacherClasses: teacherClasses,
									studentClasses: studentClasses
								})
							} else {
								mui.toast('您还未加入班级');
							}
						} else {
							mui.toast(data.RspTxt);
						}
					});
				}
				//
				//26.用户云盘顶层文件及文件夹获取
				function postFirstFile() {
					//所需参数
					var comData = {
						vvl: '0' //	节点ID，顶层为0
					};
					// 等待的对话框
					var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
					postDataPro_PostDiFi(comData, wd, function(data) {
						wd.close();
						console.log('26.postDataPro_PostDiFi_用户云盘顶层文件及文件夹获取_RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
						if(data.RspCode == 0) {
							//给存储数组赋值
							if(data.RspData != null && data.RspData != '') {
								fileArray = data.RspData;
							} else {
								fileArray = [];
							}
							//清掉所有文件夹
							var table = document.getElementById("cloudstoragefile");
							table.innerHTML = '';
							//循环将获取到的值塞入界面
							for(var i in data.RspData) {
								if(i == 3) { //只显示3个文件或文件夹
									return false;
								}
								var tempModel = data.RspData[i];
								addStorageFolder(tempModel);
							}
							//增加加号
							if(fileArray.length < 3) {
								addStorageIcon();
							}
						} else if(data.RspCode == 9) {
							addStorageIcon();
						} else {
							mui.toast(data.RspTxt);
						}
					});
				}

				//24.通过用户表ID获取用户关联的学生
				function postUserStudent() {
					var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid;
					//73.（云档案）按家长获取学生档案姓名
					//所需参数
					var comData = {
						parentId: personalUTID //家长ID
					};
					//返回学生姓名数组
					// 等待的对话框
					var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
					postDataPro_getStudentName(comData, wd, function(data) {
						wd.close();
						console.log('24.postDataPro_PostUstu:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
						if(data.RspCode == 0) {
							//设置页面显示
							document.getElementById("record_row").innerHTML = '';
							addLeaningPath(); //学习轨迹
							mui.each(data.RspData.Students, function(index, item) {
								console.log('学生档案：' + index + '|' + JSON.stringify(item));
								addRecord(item);
							});
						} else if(data.RspCode == 9) {
							addLeaningPath(); //学习轨迹
						} else {
							mui.toast(data.RspTxt);
						}
					});
				}

				//-----------设置监听end---------------

				/**
				 * 增加存储的文件夹或文件
				 * @param {Object} data
				 */
				function addStorageFolder(data) {
					var table = document.getElementById("cloudstoragefile");
					var div = document.createElement("div");
					div.setAttribute('data-fid', data.fid);
					div.className = 'mui-col-sm-4 mui-col-xs-4 cloud-text-align-center';
					var html1 = '';

					if(data.ftype == '.file') { //文件夹
						html1 = '<img class="cloud-bottom-imge" src="../../image/cloud/A_folder.png" />';
					} else { //文件
						var type = cloud.classify(data.ftype);
						if(type != '') {
							html1 = '<span class="mui-icon iconfont ' + type + '"></span>';
						} else { //七牛能生成缩略图的图片或视频
							html1 = '<img class="cloud-bottom-imge" src="' + data.fpath + '" />';
						}
					}
					var html2 = '<p class="mui-ellipsis">' + data.fname + '</p>';
					div.innerHTML = html1 + html2;
					table.appendChild(div);
				}

				/**
				 * 增加文件夹的按钮（加号按钮）
				 */
				function addStorageIcon() {
					var table = document.getElementById("cloudstoragefile");
					var div = document.createElement('div');
					div.id = 'addFolder';
					div.className = 'mui-col-sm-4 mui-col-xs-4';
					div.innerHTML = '<img class="cloud-bottom-imge" style="margin-top: 4px;" src="../../image/cloud/A_addfolder.png" /><p class="mui-ellipsis"> </p>';
					table.appendChild(div);
				}

				/**
				 * 增加档案
				 * @param {Object} data
				 */
				function addRecord(data) {
					var div = document.createElement('div');
					div.setAttribute('data-studentName', data);
					div.className = 'mui-col-sm-3 mui-col-xs-3 cloud-text-align-center';
					div.innerHTML = '<div class="cloud-bottom-imge2-bg">\
										<img class="cloud-bottom-imge2" src="../../image/cloud/archives.png" />\
									</div>\
									<p class="mui-ellipsis">' + data.StudentName + '档案</p>';
					document.getElementById("record_row").insertBefore(div, document.getElementById("learningpath"));
					div.addEventListener('tap', function() {
						events.openNewWindowWithData('record_student_main.html', {
							StudentId: data.StudentId, //学生ID
							StudentName: data.StudentName //学生姓名
						});
					});
				}

				/**
				 * 学习轨迹
				 */
				function addLeaningPath() {
					var div = document.createElement('div');
					div.setAttribute('id', 'learningpath');
					div.className = 'mui-col-sm-3 mui-col-xs-3 cloud-text-align-center';
					div.innerHTML = '<div class="cloud-bottom-imge2-bg">\
										<img class="cloud-bottom-imge2" src="../../image/cloud/Trajectory.png" />\
									</div>\
									<p class="mui-ellipsis">学习轨迹</p>';
					document.getElementById("record_row").appendChild(div);
					//学习轨迹监听
					div.addEventListener('tap', function() {
						mui.toast('功能暂未开放');
						//events.openNewWindow('record_learningpath_main.html');
					});
				}

				/**
				 * 修改账号资料
				 */
				function changeInfo() {
					document.getElementById("cloud_name").innerText = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).unick;
					document.getElementById("cloud_prsonalimge").src = updateHeadImg(window.myStorage.getItem(window.storageKeyName.PERSONALINFO).uimg, 2);
				}

				/**
				 * 修改云盘的文件，档案数据
				 */
				function changeData() {
					document.getElementById("cloudstoragefile").innerHTML = '';
					document.getElementById("record_row").innerHTML = '';
					//26.用户云盘顶层文件及文件夹获取
					postFirstFile();
					//73.（云档案）按家长获取学生档案姓名
					postUserStudent();
				}
			});
		</script>
	</body>

</html>