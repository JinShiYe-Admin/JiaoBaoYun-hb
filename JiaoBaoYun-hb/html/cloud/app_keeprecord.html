<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<link rel="stylesheet" href="../../css/iconfont/iconfont.css" />
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/utils/events.js"></script>
		<script type="text/javascript" src="../../js/publicProtocol.js"></script>
		<style>
			.mui-table-view:before,
			.mui-table-view:after,
			.mui-table-view-cell:after {
				height: 0px;
			}

			.mui-fullscreen {
				background-color: white;
			}

			.keep-noqun {
				/*无班级*/
				text-align: center;
				margin-top: 20px;
			}

			.mui-slider .mui-segmented-control.mui-segmented-control-inverted~ .mui-slider-group .mui-slider-item {
				border-top: 0px solid #c8c7cc;
				border-bottom: 0px solid #c8c7cc;
			}

			.mui-segmented-control.mui-scroll-wrapper .mui-control-item {
				padding-left: 10px;
				padding-right: 10px;
			}

			#sliderSegmentedControl {
				margin-top: 10px;
				background-color: #F2F2F2;
				margin-left: 5px;
			}

			.keep-line-blue {
				/*群栏蓝竖线*/
				position: absolute;
				height: 38px;
				width: 5px;
				top: 54px;
				background-color: #64A1EB;
				z-index: 999;
			}

			.keep-line-black {
				/*群栏黑竖线*/
				position: absolute;
				top: 10px;
			}

			.mui-table-view-cell {
				padding: 10px 8px;
			}

			.keep-member {
				/*群成员*/
				text-align: center;
				height: 75px;
			}

			.keep-member2 {
				/*添加成员按钮*/
				text-align: center;
				height: 75px;
			}

			.keep-member img {
				/*添加成员按钮图标*/
				border-radius: 50%;
				height: 40px;
				width: 40px;
				max-width: 40px;
			}

			.keep-box-shadow-border {
				/*边框和阴影*/
				box-shadow: 1px 1px 1px #888888;
				border: 1px solid #F2F2F2;
				padding: 3px;
			}

			.icon-close {
				/*删除成员按钮*/
				position: absolute;
				right: 6px;
				color: #BBBBBB;
			}

			.addqun {
				/*添加班级的元素*/
			}

			.addmember {
				/*添加成员的元素*/
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<p class="mui-title common-color-white" style="text-align: left;">云盘—记事</p>
			<img id="history" class="mui-icon mui-pull-right" src="../../image/cloud/record_history.gif" style="height: 40px;width: 40px;" />
			<img id="link" class="mui-icon mui-pull-right" src="../../image/cloud/record_link.gif" style="height: 40px;width: 40px;margin-right: 10px;" />
		</header>
		<div class="mui-content">
			<div class="mui-popover" style="width: 100%;top: 150px;height: 200px;">
				<ul class="mui-table-view">
					<img id="closepop" src="../../image/cloud/record_addclassclose.png" style="height: 30px;float: right;margin: 10px;" />
					<input id="inputqunname" type="text" class="mui-input-clear" placeholder="请输入班级名称" style="width:80% ;margin-left: 10%;text-align: center;border-radius: 50px;">
					<button id="createclass" type="button" class="mui-btn mui-btn-blue mui-btn-block" style="border-radius: 50px;height: 40px;width: 80%;left: 10%;padding: 0;">创建</button>
				</ul>
			</div>
			<div id="noqun" class="keep-noqun" style="display: none;">
				<h5>现在没有班级请点击一下按钮创建班级</h5>
				<div>
					<img class="addqun" src="../../image/cloud/record_addclass.gif" />
				</div>
			</div>
			<div id="line" class="keep-line-blue" style="display: none;"></div>
			<div id="slider" class="mui-slider mui-fullscreen" style="display: none;">
				<div id="sliderSegmentedControl" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<div id="qunlist" class="mui-scroll">
						<!--<a class="mui-control-item" href="#1001班" style="margin-left: 10px;">
							1001班
						</a>
						<font class="keep-line-black">丨</font>
						<a class="mui-control-item" href="#1002班" style="margin-left: 10px;">
							1002班222
						</a>-->
						<a id="controladd" class="mui-control-item" style="width: 40px;">
						</a>
						<div class="mui-icon mui-icon-plus addqun" style="position: absolute;border: 0px solid #ddd;font-size: 25px;color: #C7C7CC;right: 0px;"></div>
					</div>
				</div>
				<div id="qunmemberlist" class="mui-slider-group">
					<!--<div id="1001班" class="mui-slider-item mui-control-content mui-active">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<ul class="mui-table-view">
									<div class="mui-row" style="margin-top: 8px;">
										<li class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3">
											<div class="mui-icon iconfont icon-close" style="display: none;"></div>
											<div class="keep-box-shadow-border keep-member">
												<img src="../../image/quan/u108.jpg" />
												<p class="mui-ellipsis">李伟</p>
											</div>
										</li>
										<li class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3">
											<div class="mui-icon iconfont icon-close" style="display: none;"></div>
											<div class="keep-box-shadow-border keep-member">
												<img src="../../image/quan/u108.jpg" />
												<p class="mui-ellipsis">李伟</p>
											</div>
										</li>
										<li class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3">
											<div class="mui-icon iconfont icon-close" style="display: none;"></div>
											<div class="keep-box-shadow-border keep-member">
												<img src="../../image/quan/u108.jpg" />
												<p class="mui-ellipsis">李伟</p>
											</div>
										</li>
										<li id="addmember_1001班" class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3 ">
											<div class="keep-box-shadow-border keep-member2 addmember" data-id="1001班">
												<img src="../../image/cloud/record_add.png" style="height: 30px;width: 30px;margin-top: 18px;" />
											</div>
										</li>
									</div>
								</ul>
							</div>
						</div>
					</div>
					<div id="1002班" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<ul class="mui-table-view">
									<div class="mui-row" style="margin-top: 8px;">
										<li class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3">
											<div class="keep-box-shadow-border keep-member">
												<div class="mui-icon iconfont icon-close" style="display: none;"></div>
												<img src="../../image/quan/u108.jpg" />
												<p class="mui-ellipsis">李伟</p>
											</div>
										</li>
										<li id="addmember_1002班" class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3 ">
											<div class="keep-box-shadow-border keep-member2 addmember" data-id="1002班">
												<img src="../../image/cloud/record_add.png" style="height: 30px;width: 30px;margin-top: 18px;" />
											</div>
										</li>
									</div>
								</ul>
							</div>
						</div>
					</div>-->
				</div>
			</div>
		</div>
	</body>

	<script type="text/javascript">
		mui.init({
			gestureConfig: {
				longtap: true, //默认为false
			}
		});
		mui.plusReady(function() {
			var qunList = []; //记录所有班级的名称
			var historyQun = null; //记录选择的班级，用于显示历史记录
			var content = document.body.querySelector('.mui-content');
			var qunlist = document.getElementById("qunlist"); //班级栏
			var controladd = document.getElementById("controladd"); //班级栏添加班级按钮前一个item
			var qunmemberlist = document.getElementById("qunmemberlist"); //成员列表

			//---获取群数据---start---
			//9.获取用户群
			//获取个人信息
			var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid;
			//需要参数
			var getQunData = {
				vtp: 'cg', //要获取的项:cg(创建的群),ug(参与群),mg(协管的群),ag(所有的群)
				vvl: personalUTID, //查询的各项，对应人的utid，可以是查询的任何人
			};
			// 等待的对话框
			var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
			postData_jiaobaoYunPro_PostGList(getQunData, wd, function(data) {
				console.log('90909090success:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
				if(data.RspCode == 0) {
					//获取到数据
					console.log('获取群数据成功');
					document.getElementById("line").style.display = 'inline';
					document.getElementById("slider").style.display = 'inline';
					//参数名	名称	参数类型	长度	是否加密	备注
					//gid	群ID	int		否
					//gname	群名	string		否	群名称
					//gimg	群头像	string		否	群头像的链接
					mui.each(data.RspData, function(index, item) {
						console.log('data.RspData:' + item.gname);
						var qun = {
							gid: item.gid,
							gname: item.gname,
							gimg: item.gimg
						}
						qunList.push(qun);
						addQun(qun);

					});
					//13.通过群ID获取群的正常用户
					//需要参数
					var getMemData = {
						top: '-1', //选择条数,-1取全部
						vvl: qunList[0].gid, //群ID，查询的值
						vvl1: '-1', //群员类型，0家长,1管理员,2老师,3学生,-1取全部
					};

					postData_jiaobaoYunPro_PostGusers(getMemData, wd, function(data) {
						console.log('90909090success:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
						//参数名	名称	参数类型	长度	是否加密	备注
						//gid	群ID	int
						//utid	用户tid	int
						//ugname	用户在群昵称	string			用户在群里的备注名称
						//ugnick	用户昵称	string			用户资料昵称
						//uimg	用户头像	string			用户头像
						//ugtp	用户在群类型	int			0家长,1管理员,2老师,3学生
						if(data.RspCode == 0) {
							mui.each(data.RspData, function(index, item) {
								console.log('getMemData:' + JSON.stringify(item));
								var addid = 'addmember_' + item.gid;
								var addTable = document.getElementById(addid);
								var classTable = document.getElementById(item.gid).querySelector('.mui-row');
								addMember(classTable, addTable, item);
							});
						} else {
							mui.toast(data.RspTxt);
						}
					});
				} else {
					mui.toast(data.RspTxt);
					//未获取到数据
					document.getElementById("noqun").style.display = 'inline';
					document.getElementById("noqun").style.textAlign = "center";
				}
				wd.close();
			});
			//---获取群数据---end---

			//---创建班级popover---start---
			//关闭创建班级界面
			document.getElementById('closepop').addEventListener('tap', function() {
				mui('.mui-popover').popover('hide');
			});

			//创建班级
			document.getElementById('createclass').addEventListener('tap', function() {
				var inputqun = document.getElementById("inputqunname");
				var name = inputqun.value; //创建的班级名称
				if(name == '') {
					mui.toast('不允许为空');
				} else {
					//7.用户创建群
					//需要参数
					var comData = {
						gname: name, //群名
						gimg: '', //群头像
					};
					// 等待的对话框
					var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
					postData_jiaobaoYunPro_PostCrGrp(comData, wd, function(data) {
						wd.close();
						console.log('90909090success:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
						if(data.RspCode == 0) {
							mui.toast('创建群成功');
							console.log('创建群成功');
							if(qunList.length == 0) {
								//移除没有班级的界面
								document.getElementById("noqun").style.display = 'none';
								document.getElementById("line").style.display = 'inline';
								document.getElementById("slider").style.display = 'inline';
							}
							//群头像未设定
							var qun = {
								gid: data.RspData,
								gname: name,
								gimg: ''
							}
							qunList.push(qun);
							addQun(qun);
							mui('.mui-popover').popover('hide');
							inputqun.value = '';
						} else {
							mui.toast(data.RspTxt);
							console.log('创建群失败：' + data.RspTxt);
						}
					});
				}
			});
			//---创建班级popover---end---

			//滑动组件监听
			document.querySelector('.mui-slider').addEventListener('slide', function(event) {
				historyQun = qunList[event.detail.slideNumber];
			});
			//所有的添加班级按钮监听
			mui('.mui-content').on('tap', '.addqun', function() {
				mui('.mui-popover').popover('show');
			});

			//监听添加成员按钮班级
			mui('.mui-content').on('tap', '.addmember', function(e) {
				var id = this.getAttribute('data-id');
				var addid = 'addmember_' + id;
				var addTable = document.getElementById(addid);
				e.detail.gesture.preventDefault(); //修复iOS 8.x平台存在的bug，使用plus.nativeUI.prompt会造成输入法闪一下又没了
				var btnArray = ['取消', '确定'];
				mui.prompt('请输入添加的新成员：', '添加新成员', '新成员', btnArray, function(e) {
					if(e.index == 1) {
						//点击确定
						if(e.value == '') {
							mui.toast('不能为空');
						} else {
							//向服务器发送数据并获得成功的回调
							var classTable = document.getElementById(id).querySelector('.mui-row');
							addMember(classTable, addTable, e.value);
						}
					} else {
						//点击取消
					}
				});
			});
			//顶部导航关联，历史按钮
			document.getElementById('link').addEventListener('tap', function() {
				events.openNewWindow('keeprecord_link.html');
			});
			document.getElementById('history').addEventListener('tap', function() {
				var passData = historyQun;
				if(passData == null) {
					passData = qunList[0];
				}
				console.log('passData:' + JSON.stringify(passData));

				events.openNewWindow('keeprecord_history_main.html');

				setTimeout(function() {
					var main = plus.webview.getWebviewById('keeprecord_history_sub.html');
					if(main !== null) {
						mui.fire(main, "passData", {
							qun: passData
						});
					}
				}, 1000);

			});

			//长按成员显示删除成员按钮
			mui('.mui-slider').on('longtap', '.keep-member', function() {
				var gid = this.getAttribute('data-gid'); //群id
				var utid = this.getAttribute('data-utid'); //成员id

				var sliderItem = document.getElementById(gid); //获得当前群的slider
				var close = sliderItem.querySelectorAll('.icon-close'); //获得当前slider的删除按钮
				mui.each(close, function(index, item) {
					item.style.display = 'inline';
					item.setAttribute('data-gid', gid); ////群id
					item.setAttribute('data-utid', utid); //成员的gid
				});
			});

			//删除按钮监听
			mui('.mui-slider').on('tap', '.icon-close', function(e) {
				var gid = this.getAttribute('data-gid'); //群id
				var utid = this.getAttribute('data-utid'); //成员id

				var sliderItem = document.getElementById(gid); //获得当前群的slider
				var close = sliderItem.querySelectorAll('.icon-close'); //获得当前slider的删除按钮
				mui.each(close, function(index, item) {
					item.style.display = 'inline';
				});

				var btnArray = ['否', '是'];
				mui.confirm('删除该成员，确认？', '删除群成员', btnArray, function(e) {
					if(e.index == 1) {
						console.log('删除');
						//向服务器发送删除成员的请求成功后
						var memId = 'member_' + utid;
						var memTable = document.getElementById(memId);
						var rowId = 'row_' + gid;
						var rowTable = document.getElementById(rowId);
						rowTable.removeChild(memTable); //删除成功
						mui.toast('删除成功');
					} else {
						console.log('不删除');
					}
				});

			});

			//
			document.body.querySelector('#qunmemberlist').addEventListener('tap', function() {
				var close = mui('.icon-close');
				console.log();
				mui.each(close, function(index, item) {
					item.style.display = 'none';
				});
			})

			/**
			 * 班级栏添加一个班级，对应的成员栏添加默认界面
			 */
			function addQun(qun) {
				//班级栏添加班级
				var a = document.createElement('a');
				a.innerText = qun.gname;
				if(qunList[0].gid == qun.gid) {
					//第一个群
					a.className = 'mui-control-item mui-active';
//					a.className = 'mui-control-item ';
				} else {
					var font = document.createElement('font');
					font.className = 'keep-line-black';
					font.innerText = '丨';
					qunlist.insertBefore(font, controladd);
					a.className = 'mui-control-item';
					a.style.marginLeft = '10px';
				}
				a.setAttribute('href', '#' + qun.gid);
				qunlist.insertBefore(a, controladd);

				//成员栏添加默认元素
				var div = document.createElement('div');
				div.id = qun.gid;
				if(qunList[0].gid == qun.gid) {
					//第一个群
					div.className = 'mui-slider-item mui-control-content mui-active';
				} else {
					div.className = 'mui-slider-item mui-control-content';
				}

				div.innerHTML = '<div class="mui-scroll-wrapper">\
								<div class="mui-scroll">\
									<ul class="mui-table-view">\
										<div id="row_' + qun.gid + '" class="mui-row" style="margin-top: 8px;">\
											<li id="addmember_' + qun.gid + '" class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3">\
												<div class="keep-box-shadow-border keep-member2 addmember" data-id="' + qun.gid + '">\
													<img src="../../image/cloud/record_add.png" style="height: 30px;width: 30px;margin-top: 18px;" />\
												</div>\
											</li>\
										</div>\
									</ul>\
								</div>\
							</div>';
				qunmemberlist.appendChild(div);
				mui(".mui-slider").slider().refresh();
//				if(qunList[qunList.length-1].gid == qun.gid) {
//					//第一个群
//					mui(".mui-slider").slider().gotoItem(1);
//				}
			}

			/**
			 * 添加成员
			 * @param {Object} classTable
			 * @param {Object} addTable
			 * @param {Object} value
			 */
			function addMember(classTable, addTable, member) {
				var li = document.createElement('li');
				var memId = 'member_' + member.utid;
				li.id = memId;
				li.className = 'mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3';
				//删除按钮
				var html1 = '<div class="mui-icon iconfont icon-close" style="display: none;"></div>';
				//成员,
				var html2 = '<div class="keep-box-shadow-border keep-member" data-utid="' + member.utid + '" data-gid="' + member.gid + '" data-ugnick="' + member.ugnick + '">';
				//头像
				var html3 = '';
				if(member.uimg != null) {
					html3 = '<img src="' + member.uimg + '" />';
				} else {
					html3 = '<img src="../../image/utils/default_personalimage.png" />';
				}
				//名称
				var html4 = '<p class="mui-ellipsis">' + member.ugnick + '</p></div>';
				li.innerHTML = html1 + html2 + html3 + html4;
				classTable.insertBefore(li, addTable);
			}
		});
	</script>

</html>