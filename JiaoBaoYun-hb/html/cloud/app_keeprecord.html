<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<link rel="stylesheet" href="../../css/iconfont/iconfont.css" />
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/utils/events.js"></script>
		<script type="text/javascript" src="../../js/publicProtocol.js"></script>
		<style>
			body,
			.mui-content {
				background: white;
			}

			.mui-table-view:before,
			.mui-table-view:after,
			.mui-table-view-cell:after {
				height: 0px;
			}

			.mui-segmented-control.mui-segmented-control-inverted .mui-control-item {
				border-right: 1px solid #b7b7b7;
				line-height: normal;
				margin-top: 10px;
			}

			.mui-segmented-control.mui-segmented-control-inverted .mui-control-item:last-child {
				border-right: none;
			}

			.mui-segmented-control.mui-segmented-control-inverted {
				border-left: 3px solid #64A1EB;
				margin-top: 5px;
			}

			.mui-table-view-cell {
				padding: 10px 8px;
			}

			.keep-member {
				/*群成员*/
				text-align: center;
				height: 75px;
			}

			.keep-member2 {
				/*添加成员按钮*/
				text-align: center;
				height: 75px;
			}

			.keep-member img {
				/*添加成员按钮图标*/
				border-radius: 50%;
				height: 40px;
				width: 40px;
				max-width: 40px;
			}

			.keep-box-shadow-border {
				/*边框和阴影*/
				box-shadow: 0px 1px 5px rgba(136,136,136,0.5);
				padding: 3px;
			}

			.icon-close {
				/*删除成员按钮*/
				position: absolute;
				right: 6px;
				color: #BBBBBB;
			}

			.addqun {
				/*添加班级的元素*/
			}

			.addmember {
				/*添加成员的元素*/
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<p class="mui-title common-color-white">云盘—记事</p>
			<span id="history" class=" mui-icon iconfont icon-lishijilu mui-pull-right" style="color: white;display:none;margin-top: 2px;padding-right: 14px;"></span>
		</header>
		<div class="mui-content">
			<div id="slider" class="mui-slider" style="display:none;">
				<div id="sliderSegmentedControl" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted" style="background:#EFEFEF;">
					<div id="qunlist" class="mui-scroll">
						<!--<a class="mui-control-item" href="#1001班">
							1001班
						</a>
						<a class="mui-control-item" href="#1002班">
							1002班222
						</a>-->
						<!--<div class="mui-icon mui-icon-plus addqun" style="position: absolute;border: 0px solid #ddd;font-size: 25px;color: #C7C7CC;right: 0px;"></div>-->
					</div>
				</div>
			</div>
			<div id="scrollwrapper" class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<div id="all_mem"></div>
				</div>
			</div>
			<!--<div id="bot_1001班" data-value="1001班" class=" bot" style="display: none;">
				<div class="mui-scroll-wrapper" style="background: white;top: 95px;">
					<div class="mui-scroll">
						<ul class="mui-table-view">
							<div class="mui-row" style="margin-top: 8px;">
								<li id="member__memid" data-gid="1001班" class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3">
									<div class="mui-icon iconfont icon-close" style="display: none;"></div>
									<div class="keep-box-shadow-border keep-member">
										<img src="../../image/quan/u108.jpg" />
										<p class="mui-ellipsis">李伟</p>
									</div>
								</li>

								<li id="addmember_1001班" class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3 ">
									<div class="keep-box-shadow-border keep-member2 addmember" data-id="1001班">
										<img src="../../image/cloud/record_add.png" style="height: 30px;width: 30px;margin-top: 18px;" />
									</div>
								</li>
							</div>
						</ul>
					</div>
				</div>
			</div>
			<div id="bot_1002班" data-value="1002班" class=" bot" style="display: none;">
				<div class="mui-scroll-wrapper" style="background: white;top: 95px;">
					<div class="mui-scroll">
						<ul class="mui-table-view">
							<div class="mui-row" style="margin-top: 8px;">
								<li id="member__memid" data-gid="1002班" class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3">
									<div class="mui-icon iconfont icon-close" style="display: none;"></div>
									<div class="keep-box-shadow-border keep-member">
										<img src="../../image/quan/u108.jpg" />
										<p class="mui-ellipsis">李伟</p>
									</div>
								</li>
								<li id="addmember_1002班" class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3 ">
									<div class="keep-box-shadow-border keep-member2 addmember" data-id="1001班">
										<img src="../../image/cloud/record_add.png" style="height: 30px;width: 30px;margin-top: 18px;" />
									</div>
								</li>
							</div>
						</ul>
					</div>
				</div>
			</div>-->

		</div>
		<script type="text/javascript">
			mui.init({
				gestureConfig: {
					//longtap: true, //默认为false
				}
			});
			mui.plusReady(function() {
				var show = ''; //记录当前展示的群id
				var qunList = []; //记录所有群的信息
				var qunMemList = []; //记录所有的群成员
				var closeShow = false; //删除按钮是否显示
				var content = document.body.querySelector('.mui-content');
				var qunlist = document.getElementById("qunlist"); //群名称显示栏
				document.querySelector(".mui-content").style.marginTop = (localStorage.getItem('StatusHeightNo') * 1-4) + 'px';
				document.querySelector("#scrollwrapper").style.top = (localStorage.getItem('StatusHeightNo') * 1 + 90) + 'px';

				mui(".mui-scroll-wrapper").scroll({
					scrollY: true, //是否竖向滚动
					scrollX: false, //是否横向滚动
					indicators: true, //是否显示滚动条
					deceleration: 0.0006, //阻尼系数,系数越小滑动越灵敏
					bounce: true, //是否启用回弹
				});
				//-------------------------

				//---获取群数据---start---
				getQunMemCG(); //获取群

				//---获取群数据---end---

				//顶部导航历史按钮
				document.getElementById('history').addEventListener('tap', function() {
					var passData = show; //群id
					var memList = [];
					console.log('passData:' + JSON.stringify(passData));
					mui.each(qunMemList, function(index, item) {
						console.log('qunMemList:' + JSON.stringify(item));
						if(item.gid == show) {
							memList = item.mem;
							return false;
						}
					});
					//跳到历史记录
					events.openNewWindowWithData('keeprecord_history_0.html', {
						data: passData, //群id
						mem: memList //群成员
					});
				});

				//切换显示选中的群
				mui('#qunlist').on('tap', 'a', function() {
					mui('#scrollwrapper').scroll().scrollTo(0, 0, 100); //100毫秒滚动到顶
					document.getElementById('bot_' + show).style.display = 'none';
					console.log('show:' + show);
					console.log('qun:' + this.getAttribute('data-value'));
					document.getElementById("bot_" + this.getAttribute('data-value')).style.display = 'inline';
					show = this.getAttribute('data-value');
					mui.each(qunList, function(index, item) {
						if(item.gid == show) { //在群记录中找到这个群
							if(!item.hasGetMem) { //这个群没有获得成员
								getMember(item.gid); //通过群ID获取群的正常用户
							}
							return false;
						}
					});
				});

				//监听点击成员
				mui('.mui-content').on('tap', '.mui-table-view-cell', function() {
					//console.log('mui-table-view-cell-id:' + this.getAttribute('id'));
					//console.log('mui-table-view-cell-gid:' + this.getAttribute('data-gid'));
					//console.log('mui-table-view-cell-stuid:' + this.getAttribute('data-stuid'));
					//console.log('mui-table-view-cell-stuname:' + this.getAttribute('data-stuname'));
					var gid = this.getAttribute('data-gid'); //群id
					var gname = ''; //群名称
					var stuid = this.getAttribute('data-stuid'); //资料id
					var stuname = this.getAttribute('data-stuname'); //学生姓名
					mui.each(qunList, function(index, item) {
						if(item.gid == gid) {
							gname = item.gname;
							return false;
						}
					});
					//跳到点到记事
					events.openNewWindowWithData('keeprecord_callorrecord_main.html', {
						gid: gid,
						gname: gname,
						stuid: stuid,
						stuname: stuname
					});
				});

				//---方法---start---

				/**
				 * 获取创建的群和协管的群
				 */
				function getQunMemCG() {
					//9.获取用户群
					//获取个人信息
					var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid;
					//需要参数
					var cgQunData = {
						vtp: 'cg', //要获取的项:cg(创建的群),ug(参与群),mg(协管的群),ag(所有的群)
						vvl: personalUTID, //查询的各项，对应人的utid，可以是查询的任何人
					};
					// 等待的对话框
					var wd = events.showWaiting();
					//获取创建的群
					postDataPro_PostGList(cgQunData, wd, function(data) {
						console.log('9_PostGList_获取创建的群.90909090success:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
						if(data.RspCode == 0) {
							mui.each(data.RspData, function(index, item) {
								//console.log('data.RspData:' + item.gname);
								var qun = {
									gid: item.gid,
									gname: item.gname,
									gimg: item.gimg,
									mstype: item.mstype
								}
								var hasGetMember = {
									hasGetMem: false //记录是否已获得群成员
								};
								mui.extend(qun, hasGetMember); //合并两个对象
								qunList.push(qun);
							});
							getQunMemMG(); //获取协管的群
						} else if(data.RspCode == 9) { //为空
							getQunMemMG(); //获取协管的群
						} else {
							mui.toast(data.RspTxt);
						}
						wd.close();
					});
				}

				/**
				 * 获取协管的群
				 */
				function getQunMemMG() {
					var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid;
					var mgQunData = {
						vtp: 'mg', //要获取的项:cg(创建的群),ug(参与群),mg(协管的群),ag(所有的群)
						vvl: personalUTID, //查询的各项，对应人的utid，可以是查询的任何人
					};
					// 等待的对话框
					var wd2 = events.showWaiting();
					postDataPro_PostGList(mgQunData, wd2, function(data2) {
						console.log('9_PostGList_获取协管的群.90909090success:RspCode:' + data2.RspCode + ',RspData:' + JSON.stringify(data2.RspData) + ',RspTxt:' + data2.RspTxt);
						if(data2.RspCode == 0) {
							mui.each(data2.RspData, function(index, item) {
								//剔除同一个群身份不同
								var same = false;
								mui.each(qunList, function(index, qitem) {
									if(qitem.gid == item.gid) {
										same = true;
										return false;
									}
								});
								if(!same) {
									console.log('data.RspData:' + item.gname);
									var qun = {
										gid: item.gid,
										gname: item.gname,
										gimg: item.gimg,
										mstype: item.mstype
									}
									var hasGetMember = {
										hasGetMem: false //记录是否已获得群成员
									};
									mui.extend(qun, hasGetMember); //合并两个对象
									qunList.push(qun);
								}

							});
						} else {
							if(data2.RspCode != 9) {
								mui.toast(data.RspTxt);
							}
						}

						if(qunList.length == 0) {
							//未获取到数据
							mui.toast('没有管理的群');
							document.getElementById("history").style.display = 'none';
							document.body.querySelector('.mui-slider').style.display = 'none';
						} else {
							//获取到数据
							document.getElementById("history").style.display = 'inline';
							document.body.querySelector('.mui-slider').style.display = 'inline';
							document.getElementById("scrollwrapper").style.background = 'white';
							mui.each(qunList, function(index, item) {
								//console.log('qunList:' + JSON.stringify(item));
								addQun(item);
							});
							getMember(qunList[0].gid); //通过群ID获取群的正常用户
						}
						wd2.close();
					});
				}

				/**
				 * 群栏添加一个群，对应的成员栏添加默认界面
				 * @param {Object} qun 群信息
				 */
				function addQun(qun) {
					//群栏添加班级
					var a = document.createElement('a');
					a.innerText = qun.gname;
					if(qunList[0].gid == qun.gid) {
						//第一个群
						show = qun.gid;
						a.className = 'mui-control-item mui-active';
					} else {
						a.className = 'mui-control-item';
					}
					a.setAttribute('data-value', qun.gid);
					qunlist.appendChild(a);

					//成员栏添加默认元素
					var div = document.createElement('div');
					var divId = 'bot_' + qun.gid;
					div.id = divId;
					div.className = 'bot';
					div.setAttribute('data-value', qun.gid);
					if(qunList[0].gid == qun.gid) {
						//第一个群
						div.style.display = "inline";
					} else {
						div.style.display = "none";
					}
					var html1 = '<ul class="mui-table-view">\
									<div class="mui-row">';
					//添加学生
					var html2 = '';
					html2 = '<li id="addmember_' + qun.gid + '" class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3 "></li>';

					var html3 = '</div></ul>';
					div.innerHTML = html1 + html2 + html3;
					document.getElementById("all_mem").appendChild(div);
				}

				/**
				 * 添加成员
				 * @param {Object} qunBot 对应的群页面
				 * @param {Object} addTable 对应的群页面中的添加成员按钮
				 * @param {Object} value 成员信息
				 */
				function addMember(qunBot, addTable, member) {
					var li = document.createElement('li');
					var memId = 'member_' + member.stuid; //
					li.id = memId;
					li.setAttribute('data-gid', member.gid);
					li.setAttribute('data-stuid', member.stuid);
					li.setAttribute('data-stuname', member.stuname);
					li.className = 'mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3';
					//删除按钮
					var html1 = '<div class="mui-icon iconfont icon-close" data-stuid="' + member.stuid + '" data-gid="' + member.gid + '" style="display: none;"></div>';
					//成员,
					var html2 = '<div class="keep-box-shadow-border keep-member" data-stuid="' + member.stuid + '" data-gid="' + member.gid + '" data-stuname="' + member.stuname + '">';
					//头像
					var html3 = '';
					if(member.stuimg != null && member.stuimg != '') {
						html3 = '<img src="' + updateHeadImg(member.stuimg, 2) + '" />';
					} else {
						html3 = '<img src="../../image/utils/default_personalimage.png" />';
					}
					//名称
					var html4 = '<p id="stuname_' + member.stuid + '" class="mui-ellipsis"></p></div>';
					li.innerHTML = html1 + html2 + html3 + html4;
					qunBot.insertBefore(li, addTable);
					document.getElementById("stuname_" + member.stuid).innerText = member.stuname;
					//console.log('addMember|member:' + JSON.stringify(member));
				}

				/**
				 * 通过群ID获取群的学生资料
				 * @param {Object} qunId 群ID
				 */
				function getMember(qunId) {
					var tempAllMem = [];
					//16.通过群ID获取群对象资料
					//所需参数
					var getMemData = {
						vtp: '0', //获取类型,0普通资料获取,1邀请排除(主老师用)
						top: '-1', //选择条数,-1为全部
						vvl: qunId, //群ID,查询的值
						vvl1: '3' //类型,0家长,1管理员,2老师,3学生,-1全部
					};
					//返回值model：model_groupStus
					//	mod.model_groupStus = {
					//		gid:'',//群ID
					//		stuid:'',//资料id
					//		stuname:'',//名称
					//		stuimg:'',//头像,头像地址
					//		mstype:''//资料类型,0家长,1管理员,2老师,3学生
					//	}
					// 等待的对话框
					var wd = events.showWaiting();
					postDataPro_PostGUInf(getMemData, wd, function(data) {
						console.log('90909090success:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
						if(data.RspCode == 0) {
							mui.each(data.RspData, function(index, item) {
								if(item.stuname != '') { //不显示没有资料名称的资料
									tempAllMem.push(item);
								}
							});
							mui.each(qunList, function(index, item) {
								if(item.gid == qunId) {
									item.hasGetMem = true; //获得了成员
									return;
								}
							});
						} else {
							if(data.RspCode != 9){
								mui.toast(data.RspTxt);
							}
						}

						if(tempAllMem.length == 0) {
							mui.toast('查询记录为空');
						} else {
							mui.each(tempAllMem, function(index, item) {
								var addTable = document.getElementById('addmember_' + item.gid);
								var qunBot = document.getElementById("bot_" + item.gid).querySelector('.mui-row');
								addMember(qunBot, addTable, item);
							});
						}

						qunMemList.push({
							gid: qunId, //群id
							mem: tempAllMem //成员
						});
						wd.close();
					});
				}

				//---方法---end---
			});
		</script>
	</body>

</html>