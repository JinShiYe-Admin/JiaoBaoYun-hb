<!--
	作者：444811716@qq.com
	时间：2016-12-08
	描述：传输列表
-->
<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<link rel="stylesheet" href="../../css/iconfont/iconfont.css" />
		<link rel="stylesheet" href="../../css/cloud/file.css" />
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/qiniu/qiniu.js"></script>
		<script type="text/javascript" src="../../js/utils/cryption.js"></script>
		<script type="text/javascript" src="../../js/utils/events.js"></script>
		<script type="text/javascript" src="../../js/publicProtocol.js"></script>
		<script type="text/javascript" src="../../js/cloud/cloud.js"></script>
		<script type="text/javascript" src="../../js/utils/CloudFileUtil.js"></script>
		<script type="text/javascript" src="../../js/cloud/AndroidFileSystem.js"></script>
		<style>
			#sliderSegmentedControl {
				background-color: white;
			}
			/*.iconfont {
				line-height: 42px;
			}*/

			.iconfont-size {
				font-size: 42px;
			}

			.mui-table-view {
				background-color: transparent;
			}

			.mui-table-view-cell {
				background-color: white;
			}

			.mui-btn {
				right: 15px;
			}

			.transport-info {
				width: 90%;
			}

			.mui-media-object {
				height: 42px;
				width: 42px;
			}

			.mui-slider .mui-segmented-control.mui-segmented-control-inverted~.mui-slider-group .mui-slider-item {
				border-top: none;
			}

			.mui-segmented-control.mui-segmented-control-inverted~.mui-slider-progress-bar {
				background-color: #00a5e0;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">传输列表</h1>
		</header>
		<div class="mui-content">
			<div id="slider" class="mui-slider mui-fullscreen">
				<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<a class="mui-control-item mui-active" href="#item1mobile">
						下载列表
					</a>
					<a class="mui-control-item" href="#item2mobile">
						上传列表
					</a>
				</div>
				<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-6" style="margin-top: -1px;"></div>
				<div class="mui-slider-group">
					<div id="item1mobile" class="mui-slider-item mui-control-content mui-active">
						<div id="scroll1" class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<ul class="mui-table-view">
									<div style="margin-top: 5px;background-color: white;">
										<div id="downloadnum" style="padding:5px;">
											下载中
										</div>
										<div style="height: 1px;width: 100%;background: #E4E4E4;"></div>
									</div>
									<div id="download">
										<!--<li class="mui-table-view-cell mui-media">
											<div class="mui-media-object mui-pull-right">
												<button type="button" class="mui-btn mui-btn-outlined">暂停</button>
											</div>
											<img class="mui-media-object mui-pull-left" src="../../image/cloud/A_folder.png">
											<div class="mui-media-body">
												<div class="mui-ellipsis transport-info">
													文件夹名字文件夹名字文件夹名字文件夹名字文件夹名字
												</div>
												<div class="transport-info">
													<div class="mui-progressbar" style="display: none;">
														<span></span>
													</div>
													<p class="mui-pull-left">
														420KB/528KB
													</p>
													<p class="mui-pull-right">
														420KB/s
													</p>
												</div>
											</div>
										</li>
										<li class="mui-table-view-cell mui-media">
											<div class="mui-media-object mui-pull-right">
												<button type="button" class="mui-btn mui-btn-outlined">取消</button>
											</div> <span class="mui-media-object mui-icon iconfont iconfont-size icon-excel mui-pull-left"></span>
											<div class="mui-media-body">
												<div class="mui-ellipsis transport-info">
													文件名字文件名字文件名字文件名字文件名字文件名字
												</div>
												<div class="transport-info">
													<div class="mui-progressbar">
														<span></span>
													</div>
													<p class="mui-pull-left">
														420KB/528KB
													</p>
													<p class="mui-pull-right">
														正在等待...
													</p>
												</div>
											</div>
										</li>-->
									</div>
									<div style="margin-top: 10px;background-color: white;">
										<div id="downloadednum" style="padding:5px;">
											已下载
										</div>
										<div style="height: 1px;width: 100%;background: #E4E4E4;"></div>
									</div>
									<div id="downloaded">
										<!--<li class="mui-table-view-cell mui-media">
											<div class="mui-media-object mui-pull-right">
												<button type="button" class="mui-btn mui-btn-outlined">打开</button>
											</div>
											<img class="mui-media-object mui-pull-left" src="../../image/cloud/A_folder.png">
											<div class="mui-media-body">
												<div class="mui-ellipsis transport-info">
													文件夹名字文件夹名字文件夹名字文件夹名字
												</div>
												<div class="transport-info">
													<p class="mui-pull-left">
														528KB&nbsp;&nbsp;2016-12-13 15:25:36
													</p>
												</div>
											</div>
										</li>
										<li class="mui-table-view-cell mui-media">
											<div class="mui-media-object mui-pull-right">
												<button type="button" class="mui-btn mui-btn-outlined">打开</button>
											</div> <span class="mui-media-object mui-icon iconfont iconfont-size icon-excel mui-pull-left"></span>
											<div class="mui-media-body">
												<div class="mui-ellipsis transport-info">
													文件名字文件名字文件名字文件名字文件名字
												</div>
												<div class="transport-info">
													<p class="mui-pull-left">
														528KB&nbsp;&nbsp;2016-12-13 15:25:36
													</p>
												</div>
											</div>
										</li>-->
									</div>
								</ul>
							</div>
						</div>
					</div>
					<div id="item2mobile" class="mui-slider-item mui-control-content">
						<div id="scroll2" class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<ul class="mui-table-view">
									<div style="margin-top: 5px;background-color: white;">
										<div id="uploadnum" style="padding:5px;">
											上传中
										</div>
										<div style="height: 1px;width: 100%;background: #E4E4E4;"></div>
									</div>
									<div id="upload">
										<!--<li class="mui-table-view-cell mui-media">
											<div class="mui-media-object mui-pull-right">
												<button type="button" class="mui-btn mui-btn-outlined">暂停</button>
											</div>
											<img class="mui-media-object mui-pull-left" src="../../image/cloud/A_folder.png">
											<div class="mui-media-body">
												<div class="mui-ellipsis transport-info">
													文件夹名字文件夹名字文件夹名字文件夹名字文件夹名字
												</div>
												<div class="transport-info">
													<div class="mui-progressbar">
														<span></span>
													</div>
													<p class="mui-pull-left">
														420KB/528KB
													</p>
													<p class="mui-pull-right">
														420KB/s
													</p>
												</div>
											</div>
										</li>
										<li class="mui-table-view-cell mui-media">
											<div class="mui-media-object mui-pull-right">
												<button type="button" class="mui-btn mui-btn-outlined">取消</button>
											</div> <span class="mui-media-object mui-icon iconfont iconfont-size icon-excel mui-pull-left"></span>
											<div class="mui-media-body">
												<div class="mui-ellipsis transport-info">
													文件名字文件名字文件名字文件名字文件名字文件名字
												</div>
												<div class="transport-info">
													<div class="mui-progressbar">
														<span></span>
													</div>
													<p class="mui-pull-left">
														420KB/528KB
													</p>
													<p class="mui-pull-right">
														正在等待...
													</p>
												</div>
											</div>
										</li>-->
									</div>
									<div style="margin-top: 10px;background-color: white;">
										<div id="uploadednum" style="padding:5px;">
											已上传
										</div>
										<div style="height: 1px;width: 100%;background: #E4E4E4;"></div>
									</div>
									<div id="uploaded">
										<!--<li class="mui-table-view-cell mui-media">
											<div class="mui-media-object mui-pull-right">
												<button type="button" class="mui-btn mui-btn-outlined">打开</button>
											</div>
											<img class="mui-media-object mui-pull-left" src="../../image/cloud/A_folder.png">
											<div class="mui-media-body">
												<div class="mui-ellipsis transport-info">
													文件夹名字文件夹名字文件夹名字文件夹名字
												</div>
												<div class="transport-info">
													<p class="mui-pull-left">
														528KB&nbsp;&nbsp;2016-12-13 15:25:36
													</p>
												</div>
											</div>
										</li>
										<li class="mui-table-view-cell mui-media">
											<div class="mui-media-object mui-pull-right">
												<button type="button" class="mui-btn mui-btn-outlined">打开</button>
											</div> <span class="mui-media-object mui-icon iconfont iconfont-size icon-excel mui-pull-left"></span>
											<div class="mui-media-body">
												<div class="mui-ellipsis transport-info">
													文件名字文件名字文件名字文件名字文件名字
												</div>
												<div class="transport-info">
													<p class="mui-pull-left">
														528KB&nbsp;&nbsp;2016-12-13 15:25:36
													</p>
												</div>
											</div>
										</li>-->
									</div>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript">
			mui.init({
				gestureConfig: {
					longtap: true, //默认为false
				}
			});
			mui.plusReady(function() {
				var main = plus.webview.currentWebview(); //获取当前窗体对象
				var uploadList = []; //记录所有的上传对象
				var downloadList = []; //记录所有的下载对象
				var uploading = false; //是否正在下载
				var downloading = false; //是否正在上传
				var upFolderEntry = null; //上传文件夹的目录对象
				var downFolderEntry = null; //下载文件夹的目录对象
				//文件存放在私有空间或公有空间
				var mainSpace = window.storageKeyName.QNPRISPACE;
				//缩略图存放在私有空间或公有空间
				var imageThumb = window.storageKeyName.QNPUBSPACE; //文件上传的空间
				var uploadSpace = window.storageKeyName.CLOUDSTORAGE;
				console.log('传输列表');
				document.querySelector("#slider").style.top = (localStorage.getItem('StatusHeightNo') * 1 + 45) + 'px';

				//---滑动start---
				mui(".mui-scroll-wrapper").scroll({
					scrollY: true, //是否竖向滚动
					scrollX: false, //是否横向滚动
					indicators: true, //是否显示滚动条
					deceleration: 0.0006, //阻尼系数,系数越小滑动越灵敏
					bounce: true, //是否启用回弹
				});
				//---滑动end---

				mui.back = function() {
					plus.webview.hide(main, 'pop-out');
				}

				//清除所有的任务和界面
				window.addEventListener('removeAllTask', function() {
					console.log('传输列表:removeAllTask');
					//上传处理
					mui.each(uploadList, function(index, element) {
						element.abort();
					});
					uploadList = [];
					document.getElementById("upload").innerHTML = '';
					document.getElementById("uploaded").innerHTML = '';

					//下载处理
					mui.each(downloadList, function(index, element) {
						element.abort();
					});

					downloadList = [];
					document.getElementById("download").innerHTML = '';
					document.getElementById("downloaded").innerHTML = '';
					//
					uploading = false; //是否正在下载
					downloading = false; //是否正在上传
					upFolderEntry = null; //上传文件夹的目录对象
					downFolderEntry = null; //下载文件夹的目录对象
					plus.uploader.clear(); //清除上传任务
					plus.downloader.clear(); //清除下载任务
				});

				//新增一项下载任务
				window.addEventListener('addDownload', function(e) {
					var gallery = mui('.mui-slider');
					gallery.slider().gotoItem(0);
					//---数据准备---start---
					var subData = e.detail.data; //接收页面传入的参数值
					//var subData = {
					//	pid: pid, //父ID
					//	fid: fid, //文件id
					//	fname: fname, //文件或文件夹名字
					//	ftype: ftype, //文件类型
					//	fpath: fpath //文件路径
					//}
					console.log('传输列表新增一项下载任务:' + JSON.stringify(subData));
					//获取上传和下载文件夹的目录对象
					getUpAndDownEntry();
					var myDate = new Date();
					var dateName = myDate.getTime() + (Math.floor(Math.random() * 10)) + '.';
					var url = subData.fpath + '?attname=' + dateName + subData.fname + subData.ftype;
					console.log('addDownload ' + url);
					//---数据准备---end---
					var data = {
						fileUrl: url, //文件下载地址
						fname: subData.fname + subData.ftype, //云端的文件名
						localname: dateName + subData.fname + subData.ftype //本地的文件名
					}
					getCurrentTypeAndUpOrDown(0, data); //下载
				});

				//新增一项上传任务
				window.addEventListener('addUpload', function(e) {
					var gallery = mui('.mui-slider');
					gallery.slider().gotoItem(1);
					//---数据准备---start---
					var subData = e.detail.data; //接收页面传入的参数值
					//var subData = {
					//	path: fid, //路径
					//	fname: fname, //文件名
					//	metadata: succesCB //文件信息
					//  pid:pid//云盘文件夹父ID
					//}
					//if(mui.os.android) { //android系统
					//subData.path = 'file://' + subData.path;
					//}
					console.log('传输列表新增一项上传任务:' + JSON.stringify(subData));

					//获取上传和下载文件夹的目录对象
					getUpAndDownEntry()

					//---数据准备---end---
					var ftype = '';
					var ftypeList = subData.fname.split('.');
					if(ftypeList.length != 1) {
						ftype = '.' + ftypeList[ftypeList.length - 1];
					}
					var myDate = new Date();
					var QNFileName = myDate.getTime() + (Math.floor(Math.random() * 10000) + 1) + ftype;
					var getUpTokenUrl = window.storageKeyName.QNGETUPTOKENFILE;
					var data = {
						getUpTokenUrl: getUpTokenUrl, //获取uptoken的url
						QNFileName: QNFileName, //存放在七牛的文件名
						fpath: subData.path, //上传文件的本地路径
						fname: subData.fname, //上传文件的名字
						pid: subData.pid //父ID，该文件的上层ID
					}
					getCurrentTypeAndUpOrDown(1, data); //上传
				});

				/**
				 * 获取上传和下载文件夹的目录对象
				 */
				window.addEventListener('getUpAndDownEntry', function() {
					getUpAndDownEntry();
				})

				//上传中列表的按钮
				mui('#upload').on('tap', 'button', function() {
					console.log('button:' + this.getAttribute('id') + '|' + this.getAttribute('value') + '|' + this.getAttribute('data-upid'));
					var id = this.getAttribute('id'); //元素id
					var value = this.getAttribute('value'); //元素状态
					var upid = this.getAttribute('data-upid'); //任务id
					var task = null;
					var num = '';
					mui.each(uploadList, function(index, item) {
						console.log('uploadList:' + JSON.stringify(item))
						if(item.__UUID__ == upid) {
							task = item;
							num = index;
							return false;
						}
					});
					if(task != null) {
						if(value == '0') { //开始
							if(!uploading) { //没有正在上传的任务
								CloudFileUtil.getCurrentType(function(data) {
									console.log('获取当前网络状态:' + JSON.stringify(data));
									if(data.code == 3) { //无线WIFI网络
										task.start();
										uploading = true;
									} else {
										if(data.code == 1) {
											mui.toast(data.type);
										} else {
											var btnArray = ['否', '是'];
											mui.confirm('当前不是无线WIFI网络，还继续上传吗？', '提示', btnArray, function(e) {
												if(e.index == 1) { //是
													task.start();
													uploading = true;
												} else {

												}
											});
										}
									}
								});
							} else {
								mui.toast('有正在上传的任务');
							}
						} else if(value == '3') { //正在上传
							//task.pause();
							//task.abort();
						} else if(value == '5') { //暂停
							//task.resume();
						} else if(value == '6') { //取消
							var btnArray = ['否', '是'];
							mui.confirm('确认删除任务？', '提示', btnArray, function(e) {
								if(e.index == 1) { //是
									if(task.state == undefined) {
										task.abort();
										//删除对应的任务
										mui.each(uploadList, function(index, element) {
											if(element.id == task.id) {
												uploadList.splice(index, 1);
												return false;
											}
										});
										document.getElementById("up_" + upid).parentNode.removeChild(document.getElementById("up_" + upid)); //删除元素
										mui.toast('删除上传任务成功');
									} else {
										mui.toast('删除失败:任务已经开始上传');
									}
								} else {

								}
							});
						}
					} else {
						mui.toast('未找到对应的上传任务');
						console.log('未找到对应的上传任务');
					}
				});

				//已上传列表的按钮
				mui('#uploaded').on('tap', 'button', function() {
					var parentNode = this.parentNode;
					var parentNode2 = parentNode.parentNode;
					var id = parentNode2.getAttribute('id');
					var fpath = parentNode2.getAttribute('data-fpath');
					plus.runtime.openFile(fpath, '', function(error) {
						console.log('打开文件失败:' + JSON.stringify(error));
						mui.toast('打开文件失败:调用第三方程序失败')
					});
				});

				//删除一条已上传的记录和本地文件
				mui('#uploaded').on('longtap', '.mui-table-view-cell', function() {
					var id = this.getAttribute('id'); //元素id
					var fpath = this.getAttribute('data-fpath'); //文件本地路径
					console.log('uploaded:' + id + "|" + fpath);
					removeFile(fpath, function(successCB) {
						document.getElementById(id).parentNode.removeChild(document.getElementById(id));
						mui.toast('删除成功');
					});
				});

				//下载中列表的按钮
				mui('#download').on('tap', 'button', function() {
					console.log('button:' + this.getAttribute('id') + '|' + this.getAttribute('value') + '|' + this.getAttribute('data-downid'));
					var id = this.getAttribute('id'); //元素id
					var value = this.getAttribute('value'); //元素状态
					var downid = this.getAttribute('data-downid'); //任务id
					var dtask = null;
					var num = '';
					mui.each(downloadList, function(index, item) {
						//console.log('downloadList:' + JSON.stringify(item))
						if(item.id == downid) {
							dtask = item;
							num = index;
							return false;
						}
					});
					if(dtask != null) {
						if(value == '0') { //开始
							if(!downloading) { //没有正在下载的任务
								CloudFileUtil.getCurrentType(function(data) {
									console.log('获取当前网络状态:' + JSON.stringify(data));
									if(data.code == 3) { //无线WIFI网络
										dtask.start();
										downloading = true;
									} else {
										if(data.code == 1) {
											mui.toast(data.type);
										} else {
											var btnArray = ['否', '是'];
											mui.confirm('当前不是无线WIFI网络，还继续下载吗？', '提示', btnArray, function(e) {
												if(e.index == 1) { //是
													dtask.start();
													downloading = true;
												} else {

												}
											});
										}
									}
								});
							} else {
								mui.toast('有正在下载的任务');
							}
						} else if(value == '3') { //正在下载时
							dtask.pause();
							dtask.state = 5;
							downloading = false;
							document.getElementById("down_btn_" + downid).innerText = '继续';
							document.getElementById("down_btn_" + downid).value = '5';
							document.getElementById("down_waiting_" + downid).innerText = '已经暂停';
							//开始新的下载任务
							mui.each(downloadList, function(index, element) {
								if(element.id !== downid && element.state != 5) {
									downloading = true;
									element.start();
									return false;
								}
							});
						} else if(value == '5') { //已经暂停了
							if(!downloading) { //没有正在下载的任务
								downloading = true;
								dtask.resume(); //恢复暂停的下载任务
								document.getElementById("down_btn_" + downid).innerText = '暂停';
								document.getElementById("down_btn_" + downid).value = '3';
							} else {
								mui.toast('有正在下载的任务');
							}
						}
					} else {
						mui.toast('未找到对应的下载任务');
						console.log('未找到对应的下载任务');
					}
				});

				//已下载列表的按钮
				mui('#downloaded').on('tap', 'button', function() {
					var parentNode = this.parentNode;
					var parentNode2 = parentNode.parentNode;
					var id = parentNode2.getAttribute('id');
					var fpath = parentNode2.getAttribute('data-fpath');
					plus.runtime.openFile(fpath, '', function(error) {
						console.log('打开文件失败:' + JSON.stringify(error));
						mui.toast('打开文件失败:未能识别能打开文件的第三方程序')
					});
				});

				//删除下载的任务
				mui('#download').on('longtap', '.mui-table-view-cell', function() {
					console.log('download:' + this.getAttribute('id') + '|' + this.getAttribute('data-id'));
					var id = this.getAttribute('id'); //元素id
					var downid = this.getAttribute('data-id'); //任务id
					var dtask = null;
					var num = '';
					mui.each(downloadList, function(index, item) {
						console.log('downloadList:' + JSON.stringify(item))
						if(item.id == downid) {
							dtask = item;
							num = index;
							return false;
						}
					});
					if(dtask != null) {
						var btnArray = ['否', '是'];
						mui.confirm('确认删除任务？', '提示', btnArray, function(e) {
							if(e.index == 1) { //是
								if(dtask.state == 0 || dtask.state == 1 || dtask.state == 2 || dtask.state == 3) {
									dtask.pause();
									downloading = false;
									//删除对应的任务
									mui.each(downloadList, function(index, element) {
										if(element.id == dtask.id) {
											downloadList.splice(index, 1);
											return false;
										}
									});
									//开始新的下载任务
									mui.each(downloadList, function(index, element) {
										if(element.state != 5) {
											downloading = true;
											element.start();
											return false;
										}
									});
								}
								dtask.abort();
								downloadList.splice(num, 1); //删除一项任务

								document.getElementById("down_" + downid).parentNode.removeChild(document.getElementById("down_" + downid)); //删除元素
								mui.toast('删除下载任务成功');
							} else {

							}
						});
					} else {
						mui.toast('未找到对应的下载任务');
						console.log('未找到对应的下载任务');
					}
				});

				//删除一条已下载的记录和本地文件
				mui('#downloaded').on('longtap', '.mui-table-view-cell', function() {
					var id = this.getAttribute('id'); //元素id
					var fpath = this.getAttribute('data-fpath'); //文件本地路径
					console.log('downloaded:' + id + "|" + fpath);
					removeFile(fpath, function(successCB) {
						document.getElementById(id).parentNode.removeChild(document.getElementById(id));
						mui.toast('删除成功');
					});
				});

				/**
				 * 判断网络类型后进行上传或下载
				 * @param {Object} type 下载0，上传1
				 * @param {Object} postData 数据
				 */
				function getCurrentTypeAndUpOrDown(type, postData) {
					CloudFileUtil.getCurrentType(function(data) {
						console.log('获取当前网络状态:' + JSON.stringify(data));
						if(data.code == 3) { //无线WIFI网络
							if(type == 1) { //上传
								getQNUpToken(postData.getUpTokenUrl, postData.QNFileName, postData.fpath, postData.fname, postData.pid);
							} else {
								getQNDownToken(postData.fileUrl, postData.fname, postData.localname);
							}
						} else {
							if(data.code == 1) {
								mui.toast(data.type);
							} else {
								var btnArray = ['否', '是'];
								mui.confirm('当前不是无线WIFI网络，还继续吗？', '提示', btnArray, function(e) {
									if(e.index == 1) { //是
										if(type == 1) { //上传
											getQNUpToken(postData.getUpTokenUrl, postData.QNFileName, postData.fpath, postData.fname, postData.pid);
										} else {
											getQNDownToken(postData.fileUrl, postData.fname, postData.localname);
										}
									}
								});
							}
						}
					});
				}

				/**
				 * 获取七牛下载token并创建下载任务
				 * @param {Object} fileUrl 文件的下载路径
				 * @param {Object} fname 云端文件的名字
				 * @param {Object} loaclname 本地文件的名字
				 */
				function getQNDownToken(fileUrl, fname, loaclname) {
					var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid;
					//var myDate = new Date();
					//var dateName = myDate.getTime() + (Math.floor(Math.random() * 10)) + '_';
					var filename = '_documents/' + personalUTID + '/download/'; // + dateName + fname + '';
					var fpath = '_documents/' + personalUTID + '/download/' + loaclname;
					console.log('getQNDownToken:fname ' + fname);
					console.log('getQNDownToken:fpath ' + fpath);
					var getDownToken = {
						appId: 4, //int 必填 项目id
						urls: [fileUrl] //array 必填 需要获取下载token文件的路径
					}
					var getDownTokenUrl = window.storageKeyName.QNGETDOWNTOKENFILE;
					CloudFileUtil.getQNDownToken(getDownTokenUrl, getDownToken, function(data) {
						console.log('七牛下载token ' + JSON.stringify(data));
						CloudFileUtil.download(data.Data[0].Value, filename, function(download, status) {
							//下载任务完成的监听
							console.log('下载任务完成' + status + '|' + JSON.stringify(download));
							downloading = false;
							//删除对应的任务
							mui.each(downloadList, function(index, element) {
								if(element.id == download.id) {
									downloadList.splice(index, 1);
									return false;
								}
							});
							//开始新的下载任务
							mui.each(downloadList, function(index, element) {
								if(element.state != 5) {
									downloading = true;
									element.start();
									return false;
								}
							});
							if(status == 200) {
								mui.toast('下载成功');
								document.getElementById("down_btn_" + download.id).style.display = 'none';
								document.getElementById("down_" + download.id).parentNode.removeChild(document.getElementById("down_" + download.id));

								plus.io.resolveLocalFileSystemURL(fpath, function(succesCB) {
									addUpedOrDownedMetadataItem(0, succesCB);
								}, function(errorCB) {
									console.log("请求上传或者下载文件系统失败: " + JSON.stringify(errorCB));
								});
							} else {
								document.getElementById("down_btn_" + download.id).style.display = 'none';
								//document.getElementById("down_" + download.id).parentNode.removeChild(document.getElementById("down_" + download.id));
								document.getElementById("down_waiting_" + download.id).innerText = '下载失败';
								mui.toast('下载失败');
							}

						}, function(download, status) {
							//下载任务状态监听
							//console.log('下载任务状态监听:' + JSON.stringify(download));
							//下载任务的标识
							var id = download.id;
							//已下载数据的大小
							var downloadSize = AndroidFileSystem.readSize(download.downloadedSize);
							//下载数据的总大小
							var totalSize = AndroidFileSystem.readSize(download.totalSize);
							//下载任务的状态
							var downloadState = download.state;
							switch(downloadState) {
								case 0: //下载任务开始调度
									console.log('下载任务开始调度:|id:' + id + '|downloadState:' + downloadState);
									break;
								case 1: //下载任务开始请求
									console.log('下载任务开始请求:|id:' + id + '|downloadState:' + downloadState);
									mui("#down_bar_" + id).progressbar({
										progress: 0
									}).show();
									break;
								case 2: //下载任务请求已经接收
									console.log('下载任务请求已经接收:|id:' + id + '|downloadState:' + downloadState);
									document.getElementById("down_btn_" + id).innerText = '暂停';
									document.getElementById("down_btn_" + id).value = '3';
									document.getElementById("down_waiting_" + id).innerText = '请求已经接收';
									break;
								case 3: //下载任务接收数据
									document.getElementById("down_waiting_" + id).innerText = '下载中';
									//console.log('下载任务接收数据:|id:' + id + '|downloadSize:' + downloadSize + '|totalSize:' + totalSize + '|uploadState:' + downloadState);
									//document.getElementById("down_btn_" + id).innerText = '暂停';
									//document.getElementById("down_btn_" + id).value = '3';
									if(document.getElementById("down_bar_" + id) !== null) {
										mui("#down_bar_" + id).progressbar().setProgress(download.downloadedSize / download.totalSize * 100);
									}
									if(document.getElementById("down_size_" + id) !== null) {
										document.getElementById("down_size_" + id).innerText = downloadSize + '/' + totalSize;
									}
									break;
								case 4: //下载任务已完成
									console.log('下载任务已完成:|id:' + id + '|downloadState:' + downloadState);
									break;
								case 5: //下载任务已暂停
									document.getElementById("down_waiting_" + id).innerText = '已经暂停';
									console.log('下载任务已暂停:|id:' + id + '|downloadState:' + downloadState);
									document.getElementById("down_btn_" + id).innerText = '继续';
									document.getElementById("down_btn_" + id).value = '5';
									break;
								default:
									console.log('下载任务状态监听:其他状态' + downloadState);
									break;
							}
						}, function(dtask) {
							//下载任务创建成功的回调
							console.log('dtask:' + JSON.stringify(dtask));
							addDownloadItem(dtask.id, fname);
							downloadList.push(dtask);
							if(!downloading) {
								downloading = true;
								dtask.start();
							}
						});
					}, function(xhr, type, errorThrown) {
						mui.toast('获取七牛下载token失败：' + type);
						console.log('获取七牛下载token失败：' + type);
					});
				}

				/**
				 * 获取七牛上传token并创建上传任务
				 * @param {Object} getUpTokenUrl 获取uptoken的url
				 * @param {Object} QNFileName 存放在七牛的文件名
				 * @param {Object} fPath 上传文件的本地路径
				 * @param {Object} fname 上传文件的名字
				 * @param {Object} pid 父ID，该文件的上层ID
				 */
				function getQNUpToken(getUpTokenUrl, QNFileName, fPath, fname, pid) {
					var temp = cloud.classify(QNFileName);
					var type = '1';
					if(temp == '') {
						type = '0';
					}
					var getToken = {
						type: type, //str 必填 获取上传token的类型。0上传需要生成缩略图的文件；1上传文件
						QNFileName: QNFileName, //str 必填 存放到七牛的文件名
						appId: 4, //int 必填 项目id
						mainSpace: mainSpace, //str 必填 文件存放在私有空间或公有空间
						uploadSpace: uploadSpace, //str 必填  上传的空间
						imageThumb: imageThumb //str json 选填 type为0时有效，缩略图存放在私有空间或公有空间，默认mainSpace
					}
					CloudFileUtil.getQNUpToken(getUpTokenUrl, getToken, function(data) {
						var QNUptoken = data.data; //token数据
						var configure = data.configure; //获取token的配置信息
						console.log('七牛上传token:' + JSON.stringify(QNUptoken));
						if(QNUptoken.Status == 0) { //失败
							mui.toast('获取上传凭证失败 ' + QNUptoken.Message);
							console.log('### ERROR ### 获取上传凭证失败' + QNUptoken.Message);
						} else {
							CloudFileUtil.upload(fPath, QNUptoken.Data.Token, QNUptoken.Data.Key, function(upload, status) {
								//上传任务完成的监听
								console.log('上传任务完成' + status + '|' + JSON.stringify(upload));
								uploading = false;
								if(status == 200) {
									//var thumb = QNUptoken.Data.OtherKey[configure.thumbKey]; //缩略图地址
									var domain = QNUptoken.Data.Domain + QNUptoken.Data.Key; //文件地址
									//console.log(thumb);
									console.log(domain);
									var fnameList = fname.split('.');
									var name = '';
									var type = '';
									if(fnameList.length == 1) {
										name = fname;
										type = '';
									} else {
										type = '.' + fnameList[fnameList.length - 1];
										name = fname.substring(0, (fname.length * 1 - type.length * 1));
									}
									var comData = {
										pid: pid, //父ID，该文件的上层ID
										fname: name, //文件名称，文件或文件夹名称,文件存扩展名之前的名称
										ftype: type, //文件类型，存文件的扩展名,如.file为文件夹
										fpath: domain, //文件路径，文件路径,为文件用
										fsize: upload.totalSize //文件大小，文件用
									};
									//删除对应的任务
									mui.each(uploadList, function(index, element) {
										if(element.id == upload.id) {
											uploadList.splice(index, 1);
											return false;
										}
									});
									document.getElementById("up_btn_" + upload.__UUID__).style.display = 'none';
									document.getElementById("up_" + upload.__UUID__).parentNode.removeChild(document.getElementById("up_" + upload.__UUID__));
									addFile(comData, fPath, fname);
								} else {
									mui.each(uploadList, function(index, element) {
										if(element.id == upload.id) {
											uploadList.splice(index, 1);
											return false;
										}
									});
									document.getElementById("up_btn_" + upload.__UUID__).style.display = 'none';
									//document.getElementById("up_" + upload.__UUID__).parentNode.removeChild(document.getElementById("up_" + upload.__UUID__));
									document.getElementById("up_waiting_" + upload.__UUID__).innerText = '上传失败';
									mui.toast('上传失败:' + status + ' ' + upload.responseText);
								}
							}, function(upload, status) {
								//上传任务状态监听
								//上传任务的标识
								var id = upload.__UUID__;
								//已完成上传数据的大小
								var uploadedSize = AndroidFileSystem.readSize(upload.uploadedSize);
								//上传数据的总大小
								var totalSize = AndroidFileSystem.readSize(upload.totalSize);
								//上传任务的状态
								var uploadState = upload.state;
								switch(uploadState) {
									case 0: //上传任务开始调度
										console.log('上传任务开始调度:|id:' + id + '|uploadState:' + uploadState);
										break;
									case 1: //上传任务开始请求
										console.log('上传任务开始请求:|id:' + id + '|uploadState:' + uploadState);
										document.getElementById("up_btn_" + id).style.display = 'none';
										mui("#up_bar_" + id).progressbar({
											progress: 0
										}).show();
										document.getElementById("up_waiting_" + id).innerText = '开始请求';
										break;
									case 2: //上传任务请求已经建立
										document.getElementById("up_waiting_" + id).innerText = '请求已经建立';
										console.log('上传任务请求已经建立:|id:' + id + '|uploadState:' + uploadState);
										break;
									case 3: //上传任务提交数据
										document.getElementById("up_waiting_" + id).innerText = '正在上传';
										//console.log('上传任务状态监听:|id:' + id + '|uploadedSize:' + uploadedSize + '|totalSize:' + totalSize + '|uploadState:' + uploadState);
										//document.getElementById("up_btn_" + id).innerText = '暂停';
										//document.getElementById("up_btn_" + id).value = '3';
										if(document.getElementById("up_bar_" + id) !== null) {
											mui("#up_bar_" + id).progressbar().setProgress(upload.uploadedSize / upload.totalSize * 100);
										}
										if(document.getElementById("up_size_" + id) !== null) {
											document.getElementById("up_size_" + id).innerText = uploadedSize + '/' + totalSize;
										}
										break;
									case 4: //上传任务已完成
										console.log('上传任务已完成:|id:' + id + '|uploadState:' + uploadState);
										break;
									case 5: //上传任务已暂停
										//document.getElementById("up_btn_" + id).innerText = '继续';
										//document.getElementById("up_btn_" + id).value = '5';
										//document.getElementById("up_waiting_" + id).innerText = '已经暂停';

										console.log('上传任务已暂停:|id:' + id + '|uploadState:' + uploadState);
										break;
									default:
										console.log('上传任务状态监听:其他状态' + uploadState);
										break;
								}
							}, function(task) {
								//上传任务创建成功的回调
								addUploadItem(task.__UUID__, fname);
								console.log('task:' + JSON.stringify(task));
								uploadList.push(task);
								if(!uploading) {
									uploading = true;
									task.start();
								}
							});
						}
					}, function(xhr, type, errorThrown) {
						mui.toast('请求上传凭证失败：' + type);
						console.log('请求上传凭证失败：' + type);
					});
				}

				/**
				 * 添加一项正在上传
				 * @param {Object} id
				 * @param {Object} fname
				 */
				function addUploadItem(id, fname) {
					console.log('addUploadItem:' + id + '|' + fname)
					var type = cloud.classify2(fname);
					var li = document.createElement('li');
					li.setAttribute('id', 'up_' + id);
					li.setAttribute('data-id', id);
					li.className = 'mui-table-view-cell mui-media';
					li.innerHTML = '<div class="mui-media-object mui-pull-right">\
											<button id="up_btn_' + id + '" type="button" class="mui-btn mui-btn-outlined" value="6" data-upid="' + id + '">取消</button>\
										</div> <span class="mui-media-object mui-icon iconfont iconfont-size ' + type + ' mui-pull-left"></span>\
										<div class="mui-media-body">\
											<div class="mui-ellipsis transport-info">\
												' + fname + '\
											</div>\
											<div class="transport-info">\
												<div id="up_bar_' + id + '" class="mui-progressbar"">\
													<span></span>\
												</div>\
												<p id="up_size_' + id + '" class="mui-pull-left">\
													 \
												</p>\
												<p id="up_waiting_' + id + '" class="mui-pull-right">\
													正在等待...\
												</p>\
											</div>\
										</div>';
					document.getElementById("upload").appendChild(li);
				}

				/**
				 * 添加一项已经上传
				 * @param {Object} fpath 本地文件路径
				 * @param {Object} fname 显示的文件名
				 * @param {Object} size 文件的大小
				 * @param {Object} modificationTime 文件或目录的最后修改时间
				 */
				function addUploadedItem(fpath, fname, size, modificationTime) {
					//console.log('addUploadItem:' + fpath + '|' + fname + '|' + size + '|' + modificationTime);
					var type = cloud.classify2(fname); //图标
					var fsize = ''; //文件的大小
					var fmodificationTime = ''; //modificationTime
					if(size != undefined) {
						fsize = AndroidFileSystem.readSize(size);
					}
					if(modificationTime != undefined) {
						fmodificationTime = modificationTime;
					}
					var li = document.createElement('li');
					li.setAttribute('id', 'uped_' + fpath);
					li.setAttribute('data-fpath', fpath);
					li.className = 'mui-table-view-cell mui-media';
					li.innerHTML = '<div class="mui-media-object mui-pull-right">\
											<button id="uped_btn_' + fpath + '" type="button" class="mui-btn mui-btn-outlined">打开</button>\
										</div> <span class="mui-media-object mui-icon iconfont iconfont-size ' + type + ' mui-pull-left"></span>\
										<div class="mui-media-body">\
											<div class="mui-ellipsis transport-info">\
												' + fname + '\
											</div>\
											<div class="transport-info">\
												<p class="mui-pull-left">\
													' + fsize + '&nbsp;&nbsp;' + fmodificationTime + '\
												</p>\
											</div>\
										</div>';
					document.getElementById("uploaded").insertBefore(li, document.getElementById("uploaded").firstChild);
				}

				/**
				 * 添加一项正在下载
				 * @param {Object} id
				 * @param {Object} fname
				 */
				function addDownloadItem(id, fname) {
					console.log('addDownloadItem:' + id + '|' + fname)
					var type = cloud.classify2(fname);
					var li = document.createElement('li');
					li.setAttribute('id', 'down_' + id);
					li.setAttribute('data-id', id);
					li.className = 'mui-table-view-cell mui-media';
					li.innerHTML = '<div class="mui-media-object mui-pull-right">\
											<button id="down_btn_' + id + '" type="button" class="mui-btn mui-btn-outlined" value="0" data-downid="' + id + '">开始</button>\
										</div> <span class="mui-media-object mui-icon iconfont iconfont-size ' + type + ' mui-pull-left"></span>\
										<div class="mui-media-body">\
											<div class="mui-ellipsis transport-info">\
												' + fname + '\
											</div>\
											<div class="transport-info">\
												<div id="down_bar_' + id + '" class="mui-progressbar"">\
													<span></span>\
												</div>\
												<p id="down_size_' + id + '" class="mui-pull-left">\
													 \
												</p>\
												<p id="down_waiting_' + id + '" class="mui-pull-right">\
													正在等待...\
												</p>\
											</div>\
										</div>';
					document.getElementById("download").appendChild(li);
				}

				/**
				 * 添加一项已经下载
				 * @param {Object} fpath 本地文件路径
				 * @param {Object} fname 显示的文件名
				 * @param {Object} size 文件的大小
				 * @param {Object} modificationTime 文件或目录的最后修改时间
				 */
				function addDownloadedItem(fpath, fname, size, modificationTime) {
					//console.log('addDownloadedItem:' + fpath + '|' + fname + '|' + size + '|' + modificationTime);
					var type = cloud.classify2(fname); //图标
					var fsize = ''; //文件的大小
					var fmodificationTime = ''; //modificationTime
					if(size != undefined) {
						fsize = AndroidFileSystem.readSize(size);
					}
					if(modificationTime != undefined) {
						fmodificationTime = modificationTime;
					}
					var html1 = '';
					//if(type == 'icon-imge') {
					//	html1 = '<img class="mui-media-object mui-pull-left" src="' + fpath + '">'
					//} else {
					html1 = '<span class="mui-media-object mui-icon iconfont iconfont-size ' + type + ' mui-pull-left"></span>';
					//}
					var li = document.createElement('li');
					li.setAttribute('id', 'downed_' + fpath); //文件名
					li.setAttribute('data-fpath', fpath); //文件路径
					li.className = 'mui-table-view-cell mui-media';
					li.innerHTML = '<div class="mui-media-object mui-pull-right">\
										<button id="downed_btn_' + fpath + '" type="button" class="mui-btn mui-btn-outlined">打开</button>\
									</div> ' + html1 + '\
									<div class="mui-media-body">\
										<div class="mui-ellipsis transport-info">\
											' + fname + '\
										</div>\
										<div class="transport-info">\
											<p class="mui-pull-left">\
												' + fsize + '&nbsp;&nbsp;' + fmodificationTime + '\
											</p>\
										</div>\
									</div>';
					document.getElementById("downloaded").insertBefore(li, document.getElementById("downloaded").firstChild);
				}
				/**
				 * 用户云盘文件上传或创建文件夹
				 * @param {Object} comData 往服务器传的数据
				 * @param {Object} filePath 本地文件路径
				 *  @param {Object} fname 本地文件名
				 */
				function addFile(comData, filePath, fname) {
					console.log('addFile:' + JSON.stringify(comData));
					//27.用户云盘文件上传或创建文件夹
					//所需参数
					//var comData = {
					//	pid: '', //	父ID，该文件的上层ID
					//	fname: '', //	文件名称，文件或文件夹名称,文件存扩展名之前的名称
					//	ftype: '', //	文件类型，存文件的扩展名,如.file为文件夹
					//	fpath: '', //	文件路径，文件路径,为文件用
					//	fsize: '' //	文件大小，文件用
					//};
					// 等待的对话框
					var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
					postDataPro_PostDiFiA(comData, wd, function(data) {
						wd.close();
						console.log('90909090success:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
						if(data.RspCode == 0) {
							mui.toast(comData.fname + comData.ftype + ' 上传成功');
							copyFileToUpload(filePath, fname);
						} else {
							if(data.RspCode == 8) {
								mui.toast('上传失败 ' + fname + ' ' + data.RspTxt + '');
							} else {
								mui.toast('上传失败 ' + data.RspTxt);
							}
							var batchDelete = {
								appId: 4, //int 必填 项目id
								urls: [comData.fpath] //array 必填 需要获取下载token文件的路径
							}
							/**
							 * 七牛批量删除
							 */
							CloudFileUtil.BatchDelete(window.storageKeyName.QNGETTOKENDELETE, batchDelete, function(data) {
									if(data.Status == 1) {
										//mui.toast('七牛删除成功');
										console.log('七牛删除成功:' + JSON.stringify(data));
									} else {
										mui.toast('七牛删除失败' + JSON.stringify(data));
										console.log('七牛删除:' + JSON.stringify(data));
									}
								},
								function(xhr, type, errorThrown) {
									mui.toast('七牛删除失败' + JSON.stringify(type));
									console.log('七牛删除失败:' + JSON.stringify(type));
								}
							);
						}
						//开始新的上传任务
						mui.each(uploadList, function(index, element) {
							if(element.state != 5) {
								uploading = true;
								element.start();
								return false;
							}
						});
					});
				}

				/**
				 * 获取上传和下载文件夹的目录对象
				 */
				function getUpAndDownEntry() {
					//获取下载文件夹目录对象
					if(downFolderEntry == null) {
						getUpOrDownEntry(0);
					}
					//获取上传文件夹目录对象
					if(upFolderEntry == null) {
						getUpOrDownEntry(1);
					}
				}

				/**
				 * 获取上传或者下载文件夹的目录对象
				 * @param {Object} type 下载0上传1
				 */
				function getUpOrDownEntry(type) {
					var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid;
					var utidPath = window.myStorage.getItem(window.storageKeyName.DOCUMENTSPATH) + personalUTID;
					var path = '';
					if(type == 1) { //上传
						path = utidPath + '/upload/';
					} else { //下载
						path = utidPath + '/download/';
					}
					//console.log("getUpOrDownEntry: " + path);
					plus.io.resolveLocalFileSystemURL(path, function(succesCB) {
						if(type == 1) { //上传
							upFolderEntry = succesCB;
							console.log("请求上传或者下载文件系统成功: " + upFolderEntry.name);
							folderUpOrDownDirectoryReader(1, upFolderEntry);
						} else {
							downFolderEntry = succesCB;
							console.log("请求上传或者下载文件系统成功: " + downFolderEntry.name);
							folderUpOrDownDirectoryReader(0, downFolderEntry);
						}
					}, function(errorCB) {
						console.log("请求上传或者下载文件系统失败: " + JSON.stringify(errorCB));
					});
				}

				/**
				 * 读取上传或文件夹下的文件及子目录
				 * @param {Object} type 下载0上传1
				 * @param {Object} entry 文件系统对象
				 */
				function folderUpOrDownDirectoryReader(type, entry) {
					var directoryReader = entry.createReader();
					directoryReader.readEntries(function(succesCB) {
						//succesCB:文件或目录对象的引用,可指向文件或目录对象（DirectoryEntry|FileEntry）
						//console.log("获取上传或下载目录中的所有文件和子目录成功");
						mui.each(succesCB, function(index, element) {
							//console.log("directoryReader:" + element.fullPath);
							//读取上传或下载文件夹下的文件或子目录属性并生成记录
							addUpedOrDownedMetadataItem(type, element);
						});
					}, function(errorCB) {
						mui.toast("获取上传或下载记录失败:" + JSON.stringify(errorCB));
						console.log("获取上传或下载记录失败:" + JSON.stringify(errorCB));
					});
				}

				/**
				 * 读取上传或下载文件夹下的文件或子目录属性并生成记录
				 * @param {Object} type 下载0上传1
				 * @param {Object} element 文件系统对象
				 */
				function addUpedOrDownedMetadataItem(type, element) {
					var fNameList = element.name.split('.');
					var fname1 = fNameList[0] + '.';
					var fname = element.name.replace(fname1, '');
					//获取文件属性
					element.getMetadata(function(succesCB2) {
						//console.log("获取上传或下载记录文件属性成功:" + JSON.stringify(succesCB2));
						//						var timeList = JSON.stringify(succesCB2.modificationTime).replace(/"/g, '').split("T");
						//						var time1 = timeList[0];
						//						var timeList2 = timeList[1].split('.');
						//						var time2 = timeList2[0];

						if(type == 1) { //增加一项已上传记录
							addUploadedItem(element.toLocalURL(), fname, succesCB2.size, dateToStr(succesCB2.modificationTime));
						} else { //增加一项已下载记录
							addDownloadedItem(element.toLocalURL(), fname, succesCB2.size, dateToStr(succesCB2.modificationTime));
						}
					}, function(errorCB2) {
						console.log("获取上传或下载记录文件属性失败:" + JSON.stringify(errorCB2));
						if(type == 1) { //增加一项已上传记录
							addUploadedItem(element.toLocalURL(), fname);
						} else { //增加一项已下载记录
							addDownloadedItem(element.toLocalURL(), fname);
						}
					});
				}

				/**
				 * data to string
				 * @param {Object} datetime
				 */
				function dateToStr(datetime) {
					//console.log(datetime);
					var year = datetime.getFullYear(),
						month = datetime.getMonth() + 1,
						date = datetime.getDate(),
						hour = datetime.getHours(),
						minutes = datetime.getMinutes(),
						second = datetime.getSeconds();
					if(month < 10) {
						month = "0" + month;
					}
					if(date < 10) {
						date = "0" + date;
					}
					if(hour < 10) {
						hour = "0" + hour;
					}
					if(minutes < 10) {
						minutes = "0" + minutes;
					}
					if(second < 10) {
						second = "0" + second;
					}
					return(year + "-" + month + "-" + date + " " + hour + ":" + minutes + ":" + second);
				}

				/**
				 * 拷贝一份文件到程序
				 * @param {Object} filePath 文件路径
				 * @param {Object} fname 文件名
				 */
				function copyFileToUpload(filePath, fname) {
					console.log("copyFileToUpload:" + filePath + '|' + fname);
					plus.io.resolveLocalFileSystemURL(filePath, function(succesCB) {
						console.log("拷贝:请求被文件的文件系统成功: " + JSON.stringify(succesCB.name));
						//拷贝
						var myDate = new Date();
						var dateName = myDate.getTime() + (Math.floor(Math.random() * 10)) + '.';
						succesCB.copyTo(upFolderEntry, dateName + fname, function(succesCB2) {
							console.log("拷贝:成功:" + JSON.stringify(succesCB2.name));
							//获取文件属性
							succesCB2.getMetadata(function(succesCB3) {
								console.log("拷贝:获取文件属性成功:" + JSON.stringify(succesCB3));
								//增加一项已上传记录
								//								var timeList = JSON.stringify(succesCB3.modificationTime).replace(/"/g, '').split("T");
								//								var time1 = timeList[0];
								//								var timeList2 = timeList[1].split('.');
								//								var time2 = timeList2[0];
								addUploadedItem(succesCB2.toLocalURL(), fname, succesCB3.size, dateToStr(succesCB3.modificationTime));
							}, function(errorCB3) {
								console.log("拷贝:获取文件属性失败:" + JSON.stringify(errorCB3));
								//增加一项已上传记录
								addUploadedItem(succesCB2.toLocalURL(), fname);
							});
						}, function(errorCB2) {
							mui.toast('在本地增加上传记录失败:' + JSON.stringify(errorCB2));
							console.log("拷贝:失败:" + JSON.stringify(errorCB2));
						});
					}, function(errorCB) {
						//请求失败的的回调
						mui.toast('在本地增加上传记录失败:' + JSON.stringify(errorCB));
						console.log("请求被拷贝文件的文件系统失败: " + JSON.stringify(errorCB));
					});
				}

				/**
				 * 删除一个本地文件
				 * @param {Object} fPath 本地文件路径
				 * @param {Object} succesCallBack 删除成功的回调
				 */
				function removeFile(fPath, succesCallBack) {
					var btnArray = ['否', '是'];
					mui.confirm('确认删除记录？', '提示', btnArray, function(e) {
						if(e.index == 1) { //是
							plus.io.resolveLocalFileSystemURL(fPath, function(succesCB) {
								console.log("获取删除本地文件的文件系统成功: " + succesCB.name);
								succesCB.remove(function(succesCB2) {
									console.log("删除本地文件成功: " + JSON.stringify(succesCB2));
									succesCallBack(succesCB2);
								}, function(errorCB2) {
									mui.toast('删除本地文件失败');
									console.log("删除本地文件失败: " + JSON.stringify(succesCB2));
								});
							}, function(errorCB) {
								mui.toast('删除本地文件失败');
								console.log("获取删除本地文件的文件系统失败: " + JSON.stringify(errorCB));
							});
						} else {

						}
					});
				}
			});
		</script>
	</body>

</html>