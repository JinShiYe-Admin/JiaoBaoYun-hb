<!--
	作者：444811716@qq.com
	时间：2017-06-19
	描述：选择上传的文件
-->
<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<link rel="stylesheet" href="../../css/iconfont/iconfont.css" />
		<link rel="stylesheet" href="../../css/cloud/file.css" />
		<style type="text/css">
			body,
			.mui-content {
				background: white;
			}

			nav {
				background-color: #383E4E !important;
			}

			.bar-tab-div {
				margin: 5px;
			}

			.bar-tab-div .mui-pull-left,
			.bar-tab-div .mui-pull-right {
				width: 45%;
			}

			.bar-tab-div .mui-pull-left div:first-child {
				color: white;
				margin-left: 10%;
			}

			.bar-tab-div .mui-pull-left button {
				width: 100%;
				margin-bottom: 15px;
				margin-left: 5%;
				background: #7F8594;
				border-color: #7F8594;
				height: 40px;
			}

			.bar-tab-div .mui-pull-left button img {
				width: 20%;
				height: 20px;
			}

			.bar-tab-div .mui-pull-left button div {
				width: 80%;
				text-align: center;
			}

			.bar-tab-div .mui-pull-right button {
				width: 100%;
				margin-bottom: 15px;
				margin-left: -5%;
				background: #636770;
				border-color: #636770;
				height: 40px;
			}

			.mui-backdrop {
				background-color: rgba(0, 0, 0, 0.03);
			}

			.mui-popover-arrow {
				display: none;
			}

			.mui-popover {
				width: 100%;
			}

			.mui-popover.mui-active {
				left: 0px !important;
				height: 200px;
			}

			.popover-background {
				width: 100% !important;
				background-color: wheat;
				height: 100%;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">选择文件</h1>
			<div id="addfiles" class="title-text-pull-right">添加</div>
		</header>
		<nav class="mui-bar mui-bar-tab">
			<div class="bar-tab-div">
				<div class="mui-pull-left">
					<div>选择上传的位置</div>
					<button id="choose" type="button" class="mui-btn mui-btn-blue">
						<img class="mui-pull-left" src="../../image/cloud/A_folder.png"/>
						<div id="yunpath" class="mui-ellipsis mui-pull-right"></div>
					</button>
				</div>
				<div class="mui-pull-right">
					<br />
					<button id="upload" type="button" class="mui-btn mui-btn-blue">上传</button>
				</div>
			</div>
		</nav>
		<div class="mui-content mui-scroll-wrapper">
			<div class="mui-scroll">
				<ul class="mui-table-view" id="filesList">
					<li class="mui-table-view-cell" value="2">
						从本地选择
					</li>
				</ul>
			</div>
		</div>
		<div id="popover" class="mui-popover">
			<div id="popover_bg" class="popover-background">
			</div>
		</div>

		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/utils/events.js"></script>
		<script src="../../js/utils/camera.js"></script>
		<script src="../../js/utils/video.js"></script>
		<script src="../../js/utils/vue.js"></script>
		<script type="text/javascript" src="../../js/cloud/AndroidFileSystem.js"></script>
		<script type="text/javascript" src="../../js/storageKeyName.js"></script>
		<script type="text/javascript" src="../../js/utils/compress.js"></script>
		<script src="../../js/cloud/upload-filter.js"></script>
		<script type="text/javascript">
			var main; //当前webview对象
			var chooseData = {
				files: []
			}; //当前页面的数据

			mui.init();
			mui.plusReady(function() {
				initData();
				initListener();
				initPopover();
			});

			/**
			 * 初始化数据
			 */
			function initData() {
				main = plus.webview.currentWebview(); //获取当前窗体对象
				console.log(main.id + " " + JSON.stringify(main.data));
				chooseData.pid = main.data.pid;
				chooseData.pname = main.data.pname;
				if(main.data.pid == 0) {
					chooseData.pname = "我的教宝云盘";
				}
				document.getElementById("yunpath").innerHTML = chooseData.pname;
			}

			/**
			 * 初始化监听
			 */
			function initListener() {

				//添加文件
				document.getElementById('addfiles').addEventListener('tap', function() {
					console.log("添加文件");
					mui('#popover').popover('toggle');
				});

				//选择上传的路径
				window.addEventListener('chooseFolder', function(e) {
					var folder = e.detail.data; //接收页面传入的参数值
					console.log('chooseFolder:' + JSON.stringify(folder));
					document.getElementById("yunpath").innerHTML = folder.title;
					pid = folder.fid;
				});

				//相册，拍照，从本地选择
				mui('.mui-table-view').on('tap', '.mui-table-view-cell', function() {
					var value = this.getAttribute('value');
					switch(value) {
						case '0': //相册
							pick();
							break;
						case '1': //拍照
							camera();
							break;
						case '2': //从本地选择
							console.log("从本地选择");
							events.openNewWindowWithData('storage_upload.html', {});
							break;
					}
				});

				//修改存储到云盘的路径
				document.getElementById('choose').addEventListener('tap', function() {
					var targetPage = plus.webview.getWebviewById('storage_main_choose.html');
					mui.fire(targetPage, 'init', {
						fid: subData.fid, //文件id,顶层0
						showTop: subData.showTop, //是否显示顶部的上传，传输列表，文件夹，如果是选择云盘上的文件夹则为false
						title: subData.title, //标题名
						top: subData.top, //顶层文件和文件夹的数据
						type: '0' //选择文件的方式0，从本地文件1
					});
					targetPage.show('slide-in-bottom', 250);
				});

				//上传选择的文件
				document.getElementById('upload').addEventListener('tap', function() {
					if(chooseData.files.length != 0) {
						//console.log("upload:" + JSON.stringify(upFile));
						//跳转到传输列表
						events.fireToPageWithData('storage_transport.html', 'addUpload', {
							path: upFile.path, //路径
							fname: upFile.fname, //文件名
							metadata: upFile.metadata, //文件信息
							pid: pid //云盘文件夹父ID
						});
						upFile = null;
						document.getElementById("file").innerHTML = '';
						changeUpBtnColorToDefault();
					} else {
						mui.toast('请选择上传的文件');
					}
				});

				/**
				 * 删除从相册或拍照选择的文件
				 */
				mui('#file').on('tap', '.mui-icon-closeempty', function() {
					var btnArray = ['否', '是'];
					mui.confirm('确认,删除？', '提示', btnArray, function(e) {
						if(e.index == 1) { //是
							upFile = null
							changeUpBtnColorToDefault();
							document.getElementById("file").innerHTML = '';
						} else {

						}
					});
				})
			}

			/*
			 * 初始化选择文件方式弹框
			 */
			function initPopover() {
				document.getElementById("popover").style.height = plus.screen.resolutionHeight - plus.navigator.getStatusbarHeight() - 45 + "px";
				document.getElementById("popover").style.top = 45 + "px"
			}

			/**
			 * 增加一项上传的文件
			 * @param {Object} fName 文件名
			 * @param {Object} fPath 文件路径
			 */
			function addUpFile(fName, fPath) {
				var li = document.createElement('li');
				li.className = 'mui-table-view-cell mui-media';
				var html1 = '';
				html1 = '<span class="mui-media-object mui-icon iconfont icon-imge mui-pull-left"></span>';
				if(fPath != undefined) {
					html1 = '<div class="mui-media-object mui-pull-left" style="overflow: hidden;">\
									<img style="width: 100%;" onload="if(this.offsetHeight<=this.offsetWidth){if(this.offsetHeight<42){this.style.height=\'42px\';this.style.width=\'initial\';}this.style.marginLeft=-parseInt((this.offsetWidth-42)/2)+\'px\';}else{this.style.marginTop=-parseInt((this.offsetHeight-42)/2)+\'px\';}" src="' + fPath + '">\
								</div>';
					//html1 = '<div style="overflow: hidden;"><img class="mui-media-object mui-pull-left" src="' + fPath + '"></div>';
				}
				li.innerHTML = '<span id="closeempty" class="mui-media-object mui-pull-right mui-icon mui-icon-closeempty"></span>\
									' + html1 + '\
									<div class="mui-media-body">\
										<div class="mui-ellipsis">' + fName + '</div>\
									</div>'
				document.getElementById("file").appendChild(li);
			}

			/**
			 * 将上传按钮颜色设置为默认颜色
			 */
			function changeUpBtnColorToDefault() {
				document.getElementById('upload').style.background = '#636770';
				document.getElementById('upload').style.border = '#636770';
			}

			/**
			 * 将上传按钮颜色设置为蓝色
			 */
			function changeUpBtnColor() {
				document.getElementById('upload').style.background = '#4DA3F5';
				document.getElementById('upload').style.border = '#4DA3F5';
			}
		</script>
	</body>

</html>