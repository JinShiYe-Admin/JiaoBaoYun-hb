<!--
	作者：444811716@qq.com
	时间：2016-10-20
	描述：云盘父页面
-->
<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>云盘</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<link rel="stylesheet" href="../../css/iconfont/iconfont.css" />
		<link rel="stylesheet" href="../../css/cloud/file.css" />
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/publicProtocol.js"></script>
		<script type="text/javascript" src="../../js/utils/events.js"></script>
		<style>
			.iconfont {
				line-height: 42px;
			}

			.iconfont-color {
				color: #8f8f94;
			}

			.iconfont-size {
				font-size: 42px;
			}
			/*.mui-bar-nav~ .mui-content .mui-pull-top-pocket {
				top: 90px !important;
			}*/

			body,
			.mui-content {
				/*background: white;*/
			}

			.mui-table-view:before,
			.mui-table-view:after,
			.mui-table-view-cell:after {
				height: 0px;
			}

			.mui-table-view {
				background: transparent;
			}

			.mui-table-view-cell {
				margin-top: 10px;
				background: white;
			}

			.mui-scroll-wrapper {
				top: 90px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="back" class="mui-icon mui-icon-left-nav mui-pull-left"></a>
			<p id="title" class="mui-title common-color-white" style="text-align: left;"></p>
		</header>
		<div class="mui-content">
			<div style="background-color: white;text-align: center;height: 45px;">
				<span class="mui-icon iconfont iconfont-color icon-upload mui-pull-left" style="margin-left: 15px;"> 上传</span>
				<span class="mui-icon iconfont iconfont-color icon-chuanshu"> 传输列表</span>
				<span id="addfolder" class="mui-icon iconfont iconfont-color icon-newfolder mui-pull-right" style="margin-right: 15px;"> 文件夹</span>
				<!--<div style="height: 1px;width: 100%;background: black;"></div>-->
			</div>
			<div id="all">
				<!--<div id="fid_fid" style="display: ;">
					<div class="mui-scroll-wrapper">
						<div class="mui-scroll">
							<ul id="ul_fid" class="mui-table-view">
								<li class="mui-table-view-cell mui-media">
									<span class="mui-navigate-right mui-media-object mui-pull-right"></span>
									<span class="mui-icon iconfont iconfont-color icon-trash mui-media-object mui-pull-right" style="margin-right: 15px;"></span>
									<span class="mui-icon iconfont iconfont-color icon-download mui-media-object mui-pull-right" style="margin-right: 15px;"></span>
									<img class="mui-media-object mui-pull-left" src="../../image/cloud/A_folder.png">
									<div class="mui-media-body">
										<p class="mui-ellipsis">文件夹名字</p>
									</div>
								</li>
								<li class="mui-table-view-cell mui-media">
									<span class="mui-media-object mui-pull-right"></span>
									<span class="mui-icon iconfont iconfont-color icon-trash mui-media-object mui-pull-right" style="margin-right: 15px;"></span>
									<span class="mui-icon iconfont iconfont-color icon-download mui-media-object mui-pull-right" style="margin-right: 15px;"></span>
									<span class="mui-media-object mui-icon iconfont iconfont-size icon-excel mui-pull-left"></span>
									<div class="mui-media-body">
										<p class="mui-ellipsis">文件名字</p>
									</div>
								</li>
							</ul>
						</div>
					</div>
				</div>-->
			</div>
		</div>
		</div>
	</body>

	<script type="text/javascript">
		//云盘子页面
		mui.init({
			gestureConfig: {
				longtap: true, //默认为false
			}

			//			subpages: [{
			//				url: 'storage_sub.html',
			//				id: 'storage_sub.html',
			//				styles: {
			//					top: '90px',
			//					bottom: localStorage.getItem('$Statusbar'),
			//				}
			//			}]
		});

		mui.plusReady(function() {
			//			var path = [];
			//			path.push('云盘—云存储');

			//---从父页面获取数据---start---
			var main = plus.webview.currentWebview(); //获取当前窗体对象
			var subData = main.data; //接收页面传入的参数值
			//			var subData = {
			//				fid: this.getAttribute("data-fid"), //fid，如果是0则显示顶层文件和文件夹
			//				top: fileArray //顶层文件和文件夹的数据
			//			}
			console.log('subData:' + JSON.stringify(subData));
			//---从父页面获取数据---end---

			//---初始化---start---
			var allData = []; //记录所有的文件和文件夹
			var showPid = ''; //当前展示的界面的父id
			var showPidList = []; //记录打开的文件夹父id历史
			//增加空的顶层文件夹
			addbot('0');
			var fData = {
				pid: '0', //上层文件夹id
				fdata: subData.top //本层文件夹数据
			}
			allData.push(fData);
			//增加空的顶层文件夹历史
			var pData = {
				pid: '0', //上层文件夹id
				pname: '云盘—云存储' //上层文件夹名字
			}
			showPidList.push(pData);

			//添加顶层文件夹的数据
			mui.each(subData.top, function(index, item) {
				additem(item);
			});

			document.getElementById("title").innerText = subData.title;
			if(subData.fid == '0') {
				showPid = '0'; //当前显示的文件id
				document.getElementById("pid_0").style.display = 'inline';
			} else {
				showPid = subData.fid; //当前显示的文件id
				//所需参数
				var comData = {
					vvl: subData.fid //	节点ID，顶层为0
				};
				//请求数据
				requestData(comData, subData.title);
			}

			//---初始化---end---

			//---滑动start---
			mui(".mui-scroll-wrapper").scroll({
				scrollY: true, //是否竖向滚动
				scrollX: false, //是否横向滚动
				indicators: true, //是否显示滚动条
				deceleration: 0.0006, //阻尼系数,系数越小滑动越灵敏
				bounce: true, //是否启用回弹
			});
			//---滑动end---

			//增加文件夹的监听
			document.getElementById('addfolder').addEventListener('tap', function(e) {
				console.log('增加文件夹showPid:' + showPid);
				e.detail.gesture.preventDefault(); //修复iOS 8.x平台存在的bug，使用plus.nativeUI.prompt会造成输入法闪一下又没了
				var btnArray = ['取消', '确定'];
				mui.prompt('请输入新文件夹的名称：', '新文件夹', '新建文件夹', btnArray, function(e) {
					if(e.index == 1) {
						//点击确定
						console.log(e.value);
						if(e.value.replace(/(^\s*)|(\s*$)/g, "") == "") {
							mui.toast('文件夹名字不能为空');
						} else {
							//27.用户云盘文件上传或创建文件夹
							//所需参数
							var comData = {
								pid: showPid, //	父ID，该文件的上层ID
								fname: e.value, //	文件名称，文件或文件夹名称,文件存扩展名之前的名称
								ftype: '.file', //	文件类型，存文件的扩展名,如.file为文件夹
								fpath: '', //	文件路径，文件路径,为文件用
								fsize: '0' //	文件大小，文件用
							};
							// 等待的对话框
							var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
							postDataPro_PostDiFiA(comData, wd, function(data) {
								wd.close();
								console.log('27.postDataPro_PostDiFiA:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
								if(data.RspCode == 0) {
									var newFolderData = {
										pid: showPid, //	父ID，该文件的上层ID
										fid: data.RspData, //该文件ID
										fname: e.value, //	文件名称，文件或文件夹名称,文件存扩展名之前的名称
										ftype: '.file', //	文件类型，存文件的扩展名,如.file为文件夹
										fpath: '', //	文件路径，文件路径,为文件用
										fsize: '0' //	文件大小，文件用
									};
									additem(newFolderData);
								} else if(data.RspCode == 8) {
									mui.toast('操作失败！已存在相同的名字');
								} else {
									mui.toast(data.RspTxt);
								}
							});
						}
					} else {
						//点击取消
					}
				});
			});

			//返回按钮监听
			document.getElementById('back').addEventListener('tap', function() {
				mui.each(showPidList, function(index, item) {
					console.log('backshowPidList:' + JSON.stringify(item));
				});
				mui.each(allData, function(index, item) {
					console.log('back:allData' + JSON.stringify(item));
				});
				showPidList.pop(); //清除最后一个历史记录
				allData.pop(); //清除最后一个数据
				console.log('------------------------');
				mui.each(showPidList, function(index, item) {
					console.log('backshowPidList:' + JSON.stringify(item));
				});
				mui.each(allData, function(index, item) {
					console.log('back:allData' + JSON.stringify(item));
				});
				if(showPidList.length == 0) {
					mui.back();
				} else {
					//隐藏当前界面
					document.getElementById("pid_" + showPid).style.display = 'none';
					//显示上一个历史界面
					var show = showPidList[showPidList.length - 1];
					document.getElementById("pid_" + show.pid).style.display = 'inline';
					document.getElementById("title").innerText = show.pname;
					showPid = show.pid;
				}
			});

			/**
			 * 点击文件或文件夹
			 */
			mui('#all').on('tap', '.mui-table-view-cell', function() {
				var id = this.getAttribute('id'); //元素id
				var fid = this.getAttribute('data-fid'); //文件id
				var fname = this.getAttribute('data-fname'); //文件或文件夹名字
				var ftype = this.getAttribute('data-ftype'); //文件类型
				console.log('点击文件或文件夹' + id + '|' + fid + "|" + fname + '|' + ftype);
				if(ftype == '.file') { //点击文件夹
					document.getElementById("title").innerText = fname;
					if(document.getElementById("pid_" + fid) != null) {
						console.log('点击文件夹pid_' + fid + '!=null');
						document.getElementById("pid_" + fid).parentNode.removeChild(document.getElementById("pid_" + fid));
					} else {
						console.log('点击文件夹pid_' + fid + '==null');
					}

					//所需参数
					var comData = {
						vvl: fid //	节点ID，顶层为0
					};
					//请求数据
					requestData(comData, fname);
				}
			});

			/**
			 * 长按文件或文件夹
			 */
			mui('#all').on('longtap', '.mui-table-view-cell', function() {
				var id = this.getAttribute('id'); //元素id
				var fid = this.getAttribute('data-fid'); //文件id
				var fname = this.getAttribute('data-fname'); //文件或文件夹名字
				var ftype = this.getAttribute('data-ftype'); //文件类型
				console.log('长按文件或文件夹' + id + '|' + fid + "|" + fname + '|' + ftype);
			});

			/**
			 * 点击文件或文件夹的下载
			 */
			mui('#all').on('tap', '.icon-download', function(e) {
				console.log('下载');
				if(e && e.stopPropagation) {
					//因此它支持W3C的stopPropagation()方法
					e.stopPropagation();
					console.log('if');
				} else {
					console.log('else');
					//否则，我们需要使用IE的方式来取消事件冒泡
					window.event.cancelBubble = true;
				}
			});

			/**
			 * 新增一个空的文件夹
			 * @param {Object} pid 父id
			 */
			function addbot(pid) {
				console.log('addbot:' + JSON.stringify(pid));
				var div = document.createElement('div');
				div.setAttribute('id', 'pid_' + pid);
				div.innerHTML = '<div class="mui-scroll-wrapper">\
									<div class="mui-scroll">\
										<ul id="ul_' + pid + '" class="mui-table-view">\
										</ul>\
									</div>\
								</div>';
				div.style.display = 'none';

				document.getElementById("all").appendChild(div);
			}

			/**
			 * 新增一个文件或文件夹
			 * @param {Object} data
			 */
			function additem(data) {
				console.log('additem:' + JSON.stringify(data))
				var li = document.createElement('li');
				li.setAttribute('id', 'fid_' + data.fid); //元素id
				li.setAttribute('data-fid', data.fid); //文件id
				li.setAttribute('data-fname', data.fname); //文件名
				li.setAttribute('data-ftype', data.ftype); //类型
				li.className = 'mui-table-view-cell mui-media';
				//文件夹右侧箭头
				var html1 = '';
				//删除和下载按钮
				var html2 = '<span class="mui-icon iconfont iconfont-color icon-trash mui-media-object mui-pull-right" style="margin-right: 15px;"></span>\
							 <span class="mui-icon iconfont iconfont-color icon-download mui-media-object mui-pull-right" style="margin-right: 15px;"></span>';

				//文件或文件图标
				var html3 = '';
				if(data.ftype == '.file') { //文件夹
					html1 = '<span class="mui-navigate-right mui-media-object mui-pull-right"></span>';
					html3 = '<img class="mui-media-object mui-pull-left" src="../../image/cloud/A_folder.png">';
				} else {
					html1 = '<span class="mui-media-object mui-pull-right"></span>';
					var type = cloud.classify(data.ftype);
					if(type != '') {
						html3 = '<span class="mui-media-object mui-icon iconfont iconfont-size ' + type + ' mui-pull-left"></span>';
					} else { //七牛能生成缩略图的图片或视频
						html3 = '<img class="cloud-bottom-imge" src="' + data.fpath + '" />';
					}
				}

				//文件名或文件夹名字
				var html4 = '<div class="mui-media-body">\
								<p class="mui-ellipsis">' + data.fname + '</p>\
							</div>';
				li.innerHTML = html1 + html2 + html3 + html4;
				document.getElementById("ul_" + data.pid).appendChild(li)
			}

			/**
			 * 请求数据
			 * @param {Object} comData 节点ID，顶层为0
			 * @param {Object} pname 上层文件夹名字
			 */
			function requestData(comData, pname) {
				//所需参数
				//var comData = {
				//	vvl: '1' //	节点ID，顶层为0
				//};
				// 等待的对话框
				var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
				//26.用户云盘顶层文件及文件夹获取
				postDataPro_PostDiFi(comData, wd, function(data) {
					wd.close();
					console.log('26.postDataPro_PostDiFi用户云盘顶层文件及文件夹获取:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
					if(data.RspCode == 0 || data.RspCode == 9) {
						if(data.RspCode == 9) {
							mui.toast('文件夹为空');
						}
						var tempRspData = [];
						if(data.RspData != null && data.RspData != '') {
							tempRspData = data.RspData;
						}
						var pid = comData.vvl;
						if(document.getElementById("pid_" + pid) == null) {
							console.log('获取数据pid_' + pid + '==null');
							addbot(pid); //增加对应的文件夹
							var fData2 = {
								pid: pid, //上层id
								fdata: tempRspData //本层数据
							}
							allData.push(fData2);
							mui.each(tempRspData, function(index, item) {
								additem(item);
							});
						} else {
							console.log('获取数据pid_' + pid + '!=null');
						}
						//---滑动start---
						mui(".mui-scroll-wrapper").scroll({
							scrollY: true, //是否竖向滚动
							scrollX: false, //是否横向滚动
							indicators: true, //是否显示滚动条
							deceleration: 0.0006, //阻尼系数,系数越小滑动越灵敏
							bounce: true, //是否启用回弹
						});
						//---滑动end---
						console.log('上一个界面的showPid:' + showPid);
						document.getElementById("pid_" + showPid).style.display = 'none';
						document.getElementById("pid_" + pid).style.display = 'inline';
						showPid = pid;
						//增加文件夹历史
						var pData2 = {
							pid: pid, //上层文件夹id
							pname: pname //上层文件夹名字
						}
						showPidList.push(pData2);
					} else {
						mui.toast(data.RspTxt);
					}
				});
			}

		});
	</script>

</html>