<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>老师临时作业详情</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<!--标准mui.css-->
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<link rel="stylesheet" href="../../css/homework/workdetail.css" />
		<link rel="stylesheet" href="../../css/iconfont/iconfont.css" />
		<style type="text/css">
			.dynamic-personal-image {
				/*个人头像圆形*/
				border-radius: 50%;
				width: 50px;
				height: 50px;
			}
		</style>
	</head>

	<body>

		<div class="mui-content mui-scroll-wrapper">
			<div class="mui-scroll">
				<ul id="list" class="mui-table-view">
				</ul>

			</div>
			<script src="../../js/mui.min.js"></script>
			<!--加载选项按钮-->
			<script src="../../js/homework/homework_detail.js"></script>
			<script src="../../js/publicHomeworkProtocol.js" type="text/javascript" charset="utf-8"></script>
			<script src="../../js/publicProtocol.js" type="text/javascript" charset="utf-8"></script>
			<script src="../../js/storageKeyName.js" type="text/javascript" charset="utf-8"></script>
			<script src="../../js/utils/events.js" type="text/javascript" charset="utf-8"></script>

			<script type="text/javascript">
				var selectCell;
				var homeworkModel = {};
				var homeworkNodes = {
					list: document.getElementById('list'), //临时作业列表
					date: document.getElementById('date'), //日期
				}
				mui.plusReady(function() {
					mui('.mui-table-view').on('tap', '.mui-table-view-cell', function() {
						events.fireToPageNone('homework-comment.html', 'workInfo', this.homeworkInfo);
						plus.webview.getWebviewById("homework-comment.html").show();
						selectCell = this;
					})
					window.addEventListener('workCommented', function(e) {
						selectCell.innerHTML = '<img id="img" class="mui-media-object mui-pull-left dynamic-personal-image " src=""><div class="mui-media-body" style="margin-top: 8px;"><p id="name" style="font-size: 16px;">undefined<font style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;</font></p></div><div class="mui-media-body mui-pull-right" style="margin-top: -25px;"><p id="isCommented" class="IsCommented" style="font-size: 13px;">已评<span class="mui-icon mui-icon-forward"></span></p></div>'

						selectCell.homeworkInfo.IsCommented = 'true';
					})

					window.addEventListener('workDetail', function(e) {
						resetData();
						console.log('作业主界面传送的值：' + JSON.stringify(e.detail.data));
						homeworkModel = e.detail.data;
						var tempDate = homeworkModel.Date.replace('/', '-');
						tempDate = tempDate.replace('/', '-');
						var date = tempDate.substring(0, tempDate.indexOf(' '));
						console.log(date);
						//4.	根据教师Id和班级Id获取学生某个日期上传的答案列表；
						//所需参数
						var comData = {
							teacherId: personalUTID, //教师Id
							classId: homeworkModel.gid, //班级群Id；
							date: date //查看的日期，不带时间；
						};
						requestAnswerList(comData);
						refeshUI();

					})

				});
				var resetData = function() {
						homeworkNodes.list.innerHTML = '';
						answerListArray = [];
						personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid;
					}
					//个人id
				var personalUTID;
				//答案列表数组
				var answerListArray = [];
				//群id

				//4.	根据教师Id和班级Id获取学生某个日期上传的答案列表；
				function requestAnswerList(comData) {
					// 等待的对话框
					var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
					//11.上传文件；逻辑：如果是图片类型，同时生成缩略图
					postDataPro_GetAnswerResultList(comData, wd, function(data) {
						wd.close();
						console.log('4.postDataPro_GetAnswerResultList:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
						if(data.RspCode == 0) {
							//给数组赋值
							answerListArray = data.RspData;
							//13.通过群ID获取群的正常用户
							//所需参数
							var comData1 = {
								top: '-1', //选择条数
								vvl: homeworkModel.gid, //群ID，查询的值
								vvl1: '-1' //群员类型，0家长,1管理员,2老师,3学生,-1取全部
							};
							console.log('comData1:' + JSON.stringify(comData1));
							//13.通过群ID获取群的正常用户
							postDataPro_PostGusers(comData1, wd, function(data1) {
								wd.close();
								console.log('13.postDataPro_PostGusers:RspCode:' + data1.RspCode + ',RspData:' + JSON.stringify(data1.RspData) + ',RspTxt:' + data1.RspTxt);
								if(data1.RspCode == 0) {
									//循环数组，将对应的信息id，塞入对应值
									for(var m in data1.RspData) {
										var tempModel0 = data1.RspData[m];
										for(var n in answerListArray) {
											var tempModel1 = answerListArray[n];
											var QuestionResultStr = '';
											//遍历里面的答案结果列表，进行数据拼接
											for(var a in tempModel1.QuestionResults) {
												var tempResultModel = tempModel1.QuestionResults[a];
												if(tempResultModel.IsRight) {
													QuestionResultStr = QuestionResultStr + tempResultModel.QuestionNo + '.' + '&#10003,';
												} else {
													QuestionResultStr = QuestionResultStr + tempResultModel.QuestionNo + '.' + '&#10005,';
												}
											}
											//赋值答案字符串
											tempModel1.QuestionResultStr = QuestionResultStr;
											//判断id是否一致
											if(tempModel1.StudentId == tempModel0.utid) {
												//合并
												tempModel1 = $.extend(tempModel1, tempModel0);
											}
										}
									}
								}
								console.log('最终的数据为:' + JSON.stringify(answerListArray));
								//刷新界面
								refeshUI();
							});

						} else {
							mui.toast(data.RspTxt);
						}
					});
				}
				var refeshUI = function() {
					for(var i = 0; i < answerListArray.length; i++) {
						var li = document.createElement('li');
						li.className = 'mui-table-view-cell mui-media';
						li.homeworkInfo = answerListArray[i];
						mui.extend(this.homeworkInfo, homeworkModel);
						li.homeworkInfo.workType = 0;
						var IsCommented;
						if(answerListArray[i].IsCommented == true) {
							IsCommented = '已评'
						} else {
							IsCommented = '未评'
						}
						li.innerHTML =
							'<img id="img" class="mui-media-object mui-pull-left dynamic-personal-image " src="' + updateHeadImg(answerListArray[i].uimg,2) + '" />' +
							'<div class="mui-media-body" style="margin-top: 8px;">' +
							'<p id="name"  style="font-size: 16px;">' + answerListArray[i].ugnick + '<font style="font-size: 12px;">&nbsp&nbsp&nbsp&nbsp' + answerListArray[i].QuestionResultStr + '</font></p>' +
							'</div>' +
							'<div class="mui-media-body mui-pull-right" style="margin-top: -25px;">' +
							'<p id="isCommented" class = "IsCommented" style="font-size: 13px;">' + IsCommented + '<span class="mui-icon mui-icon-forward"></span></p>' +
							'</div>'
						homeworkNodes.list.appendChild(li);
					}

				}
			</script>

	</body>

</html>