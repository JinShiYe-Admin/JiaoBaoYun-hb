<!--学生做作业界面-->
<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/utils/common.css" rel="stylesheet" />
		<link href="../../css/quan/class_space.css" rel="stylesheet" />
		<link href="../../css/iconfont/iconfont.css" rel="stylesheet" />
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/utils/events.js"></script>
		<script src="../../js/utils/camera.js"></script>
		<script src="../../js/utils/files.js"></script>
		<script src="../../js/utils/ASFiles.js"></script>
		<script src="../../js/publicProtocol.js"></script>
		<script src="../../js/publicHomeworkProtocol.js" type="text/javascript" charset="utf-8"></script>
		<script>
			var userInfo = window.myStorage.getItem(window.storageKeyName.PERSONALINFO); //用户id
		</script>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 id="title" class="mui-title">作业详情</h1>
			<a id="publish" class="mui-pull-right ">完成</a>
		</header>
		<div class="mui-content">
			<div class="input-content">
				<textarea id="input-content" placeholder="请按照老师的要求来完成作业吧"></textarea>
				<!--<div id="take_pic" class="take_pic">
					<a class="mui-icon iconfont icon-xiangji"></a>
				</div>
				<div id="add_file" class="add_file">
					<a class="mui-icon iconfont icon-jia"></a>
				</div>-->
			</div>
		</div>
		<script type="text/javascript">
			mui.init();
			var flag = 0
			mui.plusReady(function(){
				window.addEventListener('homeworkInfo',function(e){
					homeworkModel=e.detail.data;
					console.log('学生做作业界面从上级界面获取的做作业数据：'+JSON.stringify(homeworkModel));
					flag = 0;
				})
				window.addEventListener('workDetail',function(e){
					homeworkModel = e.detail.data;
					console.log('修改作业数据：'+JSON.stringify(homeworkModel))
					var textView = document.getElementById('input-content');
					textView.value = homeworkModel.HomeworkResult.Result;
					
					flag = 1;
					
				})
				var item = document.getElementById('publis');
				

				events.addTap('publish', function() {
					if(flag == 0){
						requestSubmitHomeworkResult();
					}else{
						requestModifyHomeworkResult();
					}
				
				
			})
			});

			var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid;
			//作业model
			var homeworkModel;

			//7.	提交作业结果；逻辑：如果是图片类型，同时生成缩略图
			function requestSubmitHomeworkResult() {
				var textView = document.getElementById('input-content');
				var tempText =  textView.value;
				 
				console.log('textView.value===' + tempText)
				if(!tempText || tempText == '') {
					mui.toast('请输入作业内容');
					return;
				}else{
					tempText = tempText.replace('\n','<br />')
				}
				//所需参数
				var comData = {
					userId: personalUTID, //学生/家长id，
					studentId: personalUTID, //学生Id；
					homeworkId: homeworkModel.HomeworkId, //作业id；
					content: tempText, //文本答案；
					fileIds: '' //文件id数组；
				};
				// 等待的对话框
				var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
				//7.	提交作业结果；逻辑：如果是图片类型，同时生成缩略图
				postDataPro_SubmitHomeworkResult(comData, wd, function(data) {
					wd.close();
					console.log('7.postDataPro_SubmitHomeworkResult:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
					if(data.RspCode == 0) {
						//清空输入框
						textView.value='';
						mui.back();
					} else {
						mui.toast(data.RspTxt);
					}
				});
			}

			//9.修改作业结果；逻辑：如果是图片类型，同时生成缩略图
			function requestModifyHomeworkResult() {
				var textView = document.getElementById('input-content');
				var tempText =  textView.value;
				 
				console.log('textView.value===' + tempText)
				if(!tempText || tempText == '') {
					mui.toast('请输入作业内容');
					return;
				}else{
					tempText = tempText.replace('\n','<br />')
				}
				//所需参数
				var comData = {
					userId: personalUTID, //学生/家长id，
					studentId: personalUTID, //学生Id；
					homeworkResultId: homeworkModel.HomeworkResult.HomeworkResultId, //要修改的作业结果id；
					content: tempText, //文本答案；
					fileIds: '' //文件id串，例如“1,2”；
				};
				// 等待的对话框
				var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
				//9.修改作业结果；逻辑：如果是图片类型，同时生成缩略图
				postDataPro_ModifyHomeworkResult(comData, wd, function(data) {
					wd.close();
					console.log('9.postDataPro_ModifyHomeworkResult:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
					if(data.RspCode == 0) {
						//清空输入框
						textView.value='';
						mui.back();
						
					} else {
						mui.toast(data.RspTxt);
					}
				});
			}
		</script>
	</body>

</html>