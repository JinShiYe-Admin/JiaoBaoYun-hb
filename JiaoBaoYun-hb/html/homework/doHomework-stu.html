<!--学生做作业界面-->
<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/utils/common.css" rel="stylesheet" />
		<link href="../../css/quan/class_space.css" rel="stylesheet" />
		<link href="../../css/iconfont/iconfont.css" rel="stylesheet" />
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/utils/events.js"></script>
		<script src="../../js/utils/camera.js"></script>
		<script src="../../js/utils/files.js"></script>
		<script src="../../js/utils/ASFiles.js"></script>
		<script src="../../js/publicProtocol.js"></script>
		<script src="../../js/publicHomeworkProtocol.js" type="text/javascript" charset="utf-8"></script>
		<script>
		</script>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 id="title" class="mui-title">作业详情</h1>
			<a id="publish" class="mui-pull-right ">完成</a>
		</header>
		<div class="mui-content">
			<div class="input-content">
				<textarea id="input-content" placeholder="请按照老师的要求来完成作业吧"></textarea>
			</div>
		</div>
		<script type="text/javascript">
			mui.init();
			var personalUTID;
			var flag = 0
			mui.plusReady(function() {
				
				
				window.addEventListener('homeworkInfo', function(e) {
					personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid; //用户id
					homeworkModel = e.detail.data;
					console.log('学生做作业界面从上级界面获取的做作业数据：' + JSON.stringify(homeworkModel));
					flag = 0;
				})
				window.addEventListener('workDetail', function(e) {
					personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid;
					homeworkModel = e.detail.data;
					console.log('修改作业数据：' + JSON.stringify(homeworkModel))
					var textView = document.getElementById('input-content');
					textView.value = homeworkModel.HomeworkResult.Result;
					flag = 1;
				})
				events.addTap('publish', function() {
					if(flag == 0) {
						requestSubmitHomeworkResult();
					} else {
						requestModifyHomeworkResult();
					}

				})
			});
			//作业model
			var homeworkModel;
			//7.	提交作业结果；逻辑：如果是图片类型，同时生成缩略图
			function requestSubmitHomeworkResult() {
				var textView = document.getElementById('input-content');
				var tempText = textView.value;

				console.log('textView.value===' + tempText)
				if(!tempText || tempText == '') {
					mui.toast('请输入作业内容');
					return;
				} else {
					tempText = replaceAllBL(tempText);
				}
				//所需参数
				var comData = {
					userId: personalUTID, //学生/家长id，
					studentId: personalUTID, //学生Id；
					homeworkId: homeworkModel.HomeworkId, //作业id；
					content: tempText, //文本答案；
					fileIds: '' //文件id数组；
				};
				// 等待的对话框
				var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
				//7.	提交作业结果；逻辑：如果是图片类型，同时生成缩略图
				postDataPro_SubmitHomeworkResult(comData, wd, function(data) {
					wd.close();
					console.log('做作业界面，提交作业获取的值'+JSON.stringify(data));
					if(data.RspCode == 0) {
						mui.toast('提交作业答案成功！')
						events.fireToPageNone(plus.webview.currentWebview().opener(),'workSubmitted');
							//清空输入框
						textView.value = '';
						mui.back();

					} else {
						mui.toast(data.RspTxt);
					}
				});
			}

			//9.修改作业结果；逻辑：如果是图片类型，同时生成缩略图
			function requestModifyHomeworkResult() {
				var textView = document.getElementById('input-content');
				var tempText = textView.value;

				console.log('textView.value===' + tempText)
				if(!tempText || tempText == '') {
					mui.toast('请输入作业内容');
					return;
				} else {
					tempText = replaceAllBL(tempText);
				}
				//所需参数
				var comData = {
					userId: personalUTID, //学生/家长id，
					studentId: personalUTID, //学生Id；
					homeworkResultId: homeworkModel.HomeworkResult.HomeworkResultId, //要修改的作业结果id；
					content: tempText, //文本答案；
					fileIds: '' //文件id串，例如“1,2”；
				};
				// 等待的对话框
				var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
				//9.修改作业结果；逻辑：如果是图片类型，同时生成缩略图
				postDataPro_ModifyHomeworkResult(comData, wd, function(data) {
					wd.close();
					console.log('9.postDataPro_ModifyHomeworkResult:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
					if(data.RspCode == 0) {
						mui.toast('修改作业答案成功！')
						events.fireToPageNone('homework-commented.html','refreshAnswer',{answer: textView.value});
//						//获得主页面的webview
//						var main = plus.webview.getWebviewById('../quan/doHomework-stu.html');
//						//触发tab-zone页面的setRead事件
//						mui.fire(main, 'refreshAnswer', {
//							answer: textView.value
//						});
							//清空输入框
						textView.value = '';
						mui.back();
					} else {
						mui.toast(data.RspTxt);
					}
				});
			}
			var old_back = mui.back;
			mui.back = function() {
				var textView = document.getElementById('input-content');
				textView.blur();
				old_back()
			}
		</script>
	</body>

</html>