<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<!--标准mui.css-->
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<link rel="stylesheet" href="../../css/homework/workdetail.css" />
		<link rel="stylesheet" href="../../css/iconfont/iconfont.css" />
		<style type="text/css">
			.mui-table-view:before,
			.mui-table-view:after,
			.mui-table-view-cell:after {
				height: 0px;
				/*去掉横线*/
			}
		</style>

	</head>

	<body>
		<nav id="alertBar" class="mui-bar mui-bar-tab" style="visibility: hidden;">
			<div align="center" >
				<button id="alertAll" type="button" class="mui-btn mui-btn-blue " style="border-radius: 10px;width: 200px;">一键提醒</button>
			</div>
		</nav>
		<div class="mui-content mui-scroll-wrapper">
			<div class="mui-scroll">
				<ul class="mui-table-view">
					<li class="mui-table-view-cell mui-media ">
						<img id="img" class="mui-media-object mui-pull-left" src="../../image/homework/math.png" />
						<div class="mui-media-body">
							<h4 id="homeworkTitle"></h6>
						<p id="publishDate" class='mui-ellipsis'>发布时间：</p>
					</div>
					<div class="mui-media-body">
						<font id="homeWorkContent"></font> 
					</div>
					<div align="center"  style="visibility: hidden;">
						<button id="checkDetail" type="button" class="mui-btn mui-btn-blue " style="border-radius: 10px;width: 100px;margin-top:15px ;">查看详情</button>
					</div>

				</li>
			</ul>
			<!--<div><img src="../../image/homework/math.png"></img>数学作业</div>-->
			<!--滑动组件-->
			<div id="slider" class="mui-slider">
				<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted mui-segmented-control-positive">
					<!--已完成选项卡-->
					<a id="item1" class="mui-control-item mui-active" href="#div-finished">
						已完成(0)
					</a>
					<!--未完成选项卡-->
					<a id="item2" class="mui-control-item" href="#div-unfinish">
						未完成(0)
					</a>
				</div>
				<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-6"></div>
				<!--滑动内容-->
				<div class="mui-slider-group">
					<div id="div-finished" class="mui-slider-item mui-control-content mui-active">
								<ul id="finished-list" class="mui-table-view">
								</ul>
					</div>
					<div id="div-unfinish" class="mui-slider-item mui-control-content">
								<ul id="unfinished-list" class="mui-table-view">
									
								</ul>
									
						</div>
					</div>
				</div>
			</div>

		</div>
		<script src="../../js/mui.min.js"></script>
		<!--加载选项按钮-->
		<script src="../../js/homework/homework_detail.js"></script>
		<script src="../../js/publicHomeworkProtocol.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/publicProtocol.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/storageKeyName.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/utils/events.js" type="text/javascript" charset="utf-8"></script>

		<script type="text/javascript">
		
			mui.init();
			var	homeworkDetailNodes = {
				img:document.getElementById("img"),//作业类型图像
				title:document.getElementById("homeworkTitle"),//作业类型标题
				publishDate:document.getElementById("publishDate"),//发布日期
				content:document.getElementById("homeWorkContent"),//作业内容
				checkDetailBtn:document.getElementById("checkDetail"),//查看详情按钮
				slider:document.getElementById("slider"),
				segItem1:document.getElementById("item1"),
				segItem2:document.getElementById("item2"),
				finishedList:document.getElementById("finished-list"),
				unfinishedList:document.getElementById("unfinished-list"),
				alertBar:document.getElementById("alertBar"),
				alertAllBtn:document.getElementById("alertAll")
			}
			var imgType ={
				chineseImg:'../../image/homework/chinese.png',
				mathImg:'../../image/homework/math.png',
				biologyImg:'../../image/homework/biology.png',
				chemistryImg:'../../image/homework/chemistry.png',
				englishImg:'../../image/homework/english.png',
				otherImg:'../../image/homework/other.png',
				physicsImg:'../../image/homework/physics.png',
				politicalImg:'../../image/homework/political.png',
				historyImg:'../../image/homework/history.png',
				yuwenImg:'../../image/homework/yuwen.png',
				geographyImg:'../../image/homework/geography.png'
			}
			//从主页传值到这个界面的model
			var homeworkModel = {
//				"Contents": "Test",
//				"HomeworkId": 28,
//				"HomeworkTitle": "2016年12月2日星期五数学作业",
//				"Remain": 1,
//				"Subject": "语文",
//				"Upload": 0,
//				'classId': 1 //人为赋值
			};
			var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid;
			//作业详情model
			var homeworkDetailModel;
			//已完成学生列表
			var uploadArray = [];
			//未完成学生列表
			var remainArray = [];

			mui.plusReady(function() {
				events.addTap('checkDetail', function() {
					console.log('点击查看详情')
				})
				events.addTap('alertBar', function() {
					console.log('一键提醒');
					alertStu(homeworkDetailNodes.alertAllBtn);
					
				})
							window.addEventListener('workDetail',function(e){
								resetData();
				console.log('作业主界面传送的值：'+JSON.stringify(e.detail.data));
				homeworkModel = e.detail.data;
				console.log('homeworkModel='+JSON.stringify(homeworkModel));

				

				//获取作业详情
				requestHomeworkDetail();

				//3.	获取作业对应学生列表
				requestHomeworkStuList();
			})


			});
			function resetData(){
				homeworkDetailNodes.unfinishedList.innerHTML = '';
//				var gallery = mui('#slider');
//				gallery.slider().gotoItem(0);
				uploadArray = [];
				remainArray = [];
				homeworkDetailModel = {};
				homeworkDetailNodes.alertAllBtn.innerHTML = '一键提醒'

//				homeworkDetailNodes.segItem1.className = 'mui-control-item mui-active';
//				homeworkDetailNodes.segItem2.className = 'mui-control-item';

				
			};
			//获取作业详情
			function requestHomeworkDetail() {
				//所需参数
				var comData = {
					teacherId: personalUTID, //教师Id
					homeworkId: homeworkModel.HomeworkId //作业id；
				};
				// 等待的对话框
				var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
				//2.获取教师发布作业详情；
				postDataPro_GetHomework(comData, wd, function(data) {
					wd.close();
					console.log('2.postDataPro_GetHomework:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
					if(data.RspCode == 0) {
						homeworkDetailModel = data.RspData;
						//修改界面
						refreshhomeworkDetail();

					} else {
						mui.toast(data.RspTxt);
					}
				});
			}

			//3.	获取作业对应学生列表
			function requestHomeworkStuList() {
				//所需参数
				var comData = {
					teacherId: personalUTID, //教师Id
					classId: homeworkModel.classId, //班级群Id；
					homeworkId: homeworkModel.HomeworkId //作业id；
				};
				// 等待的对话框
				var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
				//3.	获取作业对应学生列表
				postDataPro_GetStudentList(comData, wd, function(data) {
					wd.close();
					console.log('3.postDataPro_GetStudentList:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
					if(data.RspCode == 0) {
						//赋值
						remainArray = data.RspData.Remain.List;
						uploadArray = data.RspData.Upload.List;
						//将学生id，塞入数组，获取学生信息
						for(var i in remainArray) {
							var tempModel = remainArray[i];
							tempModel.ClassId = data.RspData.ClassId;
							tempModel.HomeworkId = data.RspData.HomeworkId;
						}
						for(var i in uploadArray) {
							var tempModel = uploadArray[i];
							tempModel.ClassId = data.RspData.ClassId;
							tempModel.HomeworkId = data.RspData.HomeworkId;
						}
						//13.通过群ID获取群的正常用户
						//所需参数
						var tempData = {
							top: '-1', //选择条数
							vvl: homeworkModel.classId, //群ID，查询的值
							vvl1: '-1' //群员类型，0家长,1管理员,2老师,3学生,-1取全部
						};
						console.log('tempData:' + JSON.stringify(tempData));
						//13.通过群ID获取群的正常用户
						postDataPro_PostGusers(tempData, wd, function(data1) {
							wd.close();
							console.log('13.postDataPro_PostGusers:RspCode:' + data1.RspCode + ',RspData:' + JSON.stringify(data1.RspData) + ',RspTxt:' + data1.RspTxt);
							if(data1.RspCode == 0) {
								//循环当前的个人信息返回值数组
								for(var i in data1.RspData) {
									//当前model
									var tempModel = data1.RspData[i];
									//更新头像
									tempModel.uimg = updateHeadImg(tempModel.uimg, 2);
									//循环未完成
									for(var m in remainArray) {
										var tempModel9 = remainArray[m];
										if(tempModel9.StudentId == tempModel.utid) {
											//合并
											tempModel9 = $.extend(tempModel9, tempModel);
										}
									}
									//已完成
									for(var m in uploadArray) {
										var tempModel9 = uploadArray[m];
										if(tempModel9.StudentId == tempModel.utid) {
											//合并
											tempModel9 = $.extend(tempModel9, tempModel);
										}
									}
								}
							}
							console.log('未完成列表：' + JSON.stringify(remainArray));
							console.log('已完成列表：' + JSON.stringify(uploadArray));
							//刷新界面
							refreshStuList();
						});

					} else if(data.RspCode == 9){
						
					}else {
						mui.toast(data.RspTxt);
					}
				});
			}
			function refreshhomeworkDetail(){
				console.log(homeworkDetailModel.Subject);
				switch (homeworkDetailModel.Subject){
					case '语文':
					    homeworkDetailNodes.img.src = imgType.yuwenImg;
						break;
					case '数学':
					    homeworkDetailNodes.img.src = imgType.mathImg;
						break;
					case '英语':
					    homeworkDetailNodes.img.src = imgType.englishImg;
						break;
					case '历史':
					    homeworkDetailNodes.img.src = imgType.historyImg;
						break;
					case '政治':
					    homeworkDetailNodes.img.src = imgType.politicalImg;
						break;
					case '地理':
					    homeworkDetailNodes.img.src = imgType.geographyImg;
						break;
					case '物理':
					    homeworkDetailNodes.img.src = imgType.physicsImg;
						break;
					case '化学':
					    homeworkDetailNodes.img.src = imgType.chemistryImg;
						break;	
					case '生物':
					    homeworkDetailNodes.img.src = imgType.biologyImg;
						break;	
						
						
					default:
						break;
				}
				homeworkDetailNodes.title.innerText = homeworkDetailModel.Subject;
				homeworkDetailNodes.publishDate.innerText = homeworkDetailModel.HomeworkTitle;
				homeworkDetailNodes.content.innerText = homeworkDetailModel.Contents
				
				
			}
			function refreshStuList(){
				console.log('学生列表')
				homeworkDetailNodes.segItem1.innerHTML = '已完成('+uploadArray.length+')';
				homeworkDetailNodes.segItem2.innerHTML = '未完成('+remainArray.length+')';
				homeworkDetailNodes.finishedList.innerHTML = '';
				homeworkDetailNodes.unfinishedList.innerHTML = '';

				for(var i=0;i<uploadArray.length;i++){
									var IsCommented;
				if(uploadArray[i].IsCommented==true){
					IsCommented = '已评';
				}else{
					IsCommented = '未评';
				}
				var headImg = updateHeadImg(uploadArray[i].uimg,2)
									var li = document.createElement('li');
									li.className = 'mui-table-view-cell mui-media'
				li.innerHTML = '<img  class="mui-media-object mui-pull-left" src="'+headImg +'" />'
										'<div class="mui-media-body">'+
											uploadArray[i].ugnick+
											'<button class="mui-media-body" style="float: right;">'+
												IsCommented+
											'</button>'+
										'</div>'
									
				homeworkDetailNodes.finishedList.appendChild(li)	;
				}

				for(var i=0;i<remainArray.length;i++){
					var alert;
					if(remainArray[i].IsAlertChecked==true){
							alert = '已查阅('+remainArray[i].AlertCheckTime+')';
					}else if(remainArray[i].IsAlerted==false){
						alert = '提醒';
					}else{
						alert = '已提醒';
					}
					var headImg = updateHeadImg(remainArray[i].uimg,2)
									var li = document.createElement('li');
									li.className = 'mui-table-view-cell mui-media'
				li.innerHTML = '<img  class="mui-media-object mui-pull-left" src="'+headImg +'" />'+
										'<div class="mui-media-body">'+
											remainArray[i].ugnick+
											'<button id="alert'+i+'" class="mui-media-body" style="float: right;" onclick="alertStu(this)">'+
												alert+
											'</button>'+
										'</div>'
									;
				homeworkDetailNodes.unfinishedList.appendChild(li);
				
				}	
			}
				document.getElementById('slider').addEventListener('slide', function(e) {
					if (e.detail.slideNumber === 0) {
						console.log('已完成');
						homeworkDetailNodes.alertBar.style.visibility = 'hidden';
					} else if (e.detail.slideNumber === 1) {
						console.log('未完成');
						if(remainArray.length==0){
							console.log(11111)
							homeworkDetailNodes.alertBar.style.visibility = 'hidden';
						}else{
							homeworkDetailNodes.alertBar.style.visibility = 'visible';
							console.log(homeworkDetailNodes.alertBar.outerHTML)
						}
						
					}
				});
				
function alertStu(alertBtn){
	console.log(alertBtn.id);
	var userIds;
	var userIdArr=[];
	if(alertBtn.id=='alertAll'){
		for(var i=0;i<remainArray.length;i++){
			var userId = remainArray[i].utid+'|'+remainArray[i].utid;
			userIdArr.push(userId);
		}
		userIds = userIdArr.join(',')
	}else{
		var index = alertBtn.id.replace('alert','');
		userIds = remainArray[index].utid+'|'+remainArray[index].utid;
	}
	console.log('userIds==='+userIds);
	

				//所需参数
				var comData = {
					teacherId: personalUTID, //教师Id
					userIds:userIds,
					homeworkId: homeworkModel.HomeworkId //作业id；
				};
				// 等待的对话框
				var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
				//2.获取教师发布作业详情；
				postDataPro_HomeworkAlert(comData, wd, function(data) {
					wd.close();
					console.log('10.postDataPro_HomeworkAlert:RspCode:' + data.RspCode + ',RspData:' + JSON.stringify(data.RspData) + ',RspTxt:' + data.RspTxt);
					if(data.RspCode == 0) {
						alertBtn.innerHTML = '已提醒'
						homeworkDetailNodes.alertAllBtn.innerHTML = '一键提醒'


					} else {
						mui.toast(data.RspTxt);
					}
				});
			
}
		</script>

	</body>

</html>