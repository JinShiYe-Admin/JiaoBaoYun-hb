<!--
	作者：444811716@qq.com
	时间：2017-01-12
	描述：科教首页
-->
<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>科教</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<link rel="stylesheet" href="../../css/utils/pullToRefresh.css" />
		<link rel="stylesheet" href="../../css/sciedu/sciedu.css" />
		<style>
			body,
			.mui-content {
				background: white;
			}

			#sliderSegmentedControl,
			.mui-segmented-control.mui-scroll-wrapper .mui-scroll {
				height: 0px;
			}

			.mui-fullscreen .mui-segmented-control~.mui-slider-group {
				top: 0px;
				background-color: white;
			}

			.mui-slider .mui-slider-group .mui-slider-item .mui-table-view-cell:after {
				height: 1px;
			}

			.mui-scroll-wrapper,
			.mui-pull-bottom-wrapper {
				/*底部加载更多区域*/
				background-color: white;
			}

			.mui-slider .mui-segmented-control.mui-segmented-control-inverted~.mui-slider-group .mui-slider-item {
				border-top: none;
				border-bottom: none;
			}

			.show-picture {
				overflow: hidden;
				position: relative;
			}

			/*.show-picture img {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
			}*/
		</style>
	</head>

	<body>
		<div id="content" class="mui-content"></div>
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/mui.pullToRefresh.js"></script>
		<script type="text/javascript" src="../../js/mui.pullToRefresh.material.js"></script>
		<script type="text/javascript" src="../../js/mui.lazyload.js"></script>
		<script type="text/javascript" src="../../js/mui.lazyload.img.js"></script>
		<script type="text/javascript" src="../../js/publicProtocol.js"></script>
		<script type="text/javascript" src="../../js/storageKeyName.js"></script>
		<script type="text/javascript" src="../../js/utils/events.js"></script>
		<script type="text/javascript" src="../../js/sciedu/SciEduHomeItem.js"></script>
		<script type="text/javascript">
			mui.init();

			var cities = []; //存储当前定制的城市
			var show = true; //是否显示科教的内容
			var pullToRefresh = [] //存储下拉上拉的控件
			var sliderId = ''; //记录显示的城市
			var index; //获取index的webview

			//var showImage = []; //存储需要显示的图片的路径
			//var clientHeight = document.documentElement.clientHeight; //webview显示的高度

			mui.plusReady(function() {
				//events.closeWaiting();
				var main = plus.webview.currentWebview(); //获取当前窗体对象
				index =main.parent(); //
				console.log("iddddddddddddddddddddddddd"+index.id);
				if(!myStorage.getItem(storageKeyName.PERSONALINFO).utid){
					initBody();
					changeIndexHeader();
				}
				//Webview窗口显示事件
				main.addEventListener("show", function(e) {
					//alert('### 硬件加速 ### ' + main.id + ' ' + main.isHardwareAccelerated());
//					console.log("show " + main.id + '|' + index.id + "|" + sliderId + '|' + cities.length);
					initBody();
					changeIndexHeader();
				});

				//---订制城市---start---
				//进入订制城市界面
				window.addEventListener('tapTitleLeft', function() {
					events.openNewWindowWithData('../utils/customizeCity.html', {
						id: '0', //0科教，1展现
						webid: '../sciedu/sciedu_home.html', //当前webview的id
						cities: cities //已经定制的城市数组
					});
				});

				//退出订制城市界面返回的数据
				window.addEventListener('customizeCity', function(e) {
					var data = e.detail.data;
					console.log('获取的修改后的城市信息:' + JSON.stringify(data));
					cities = []; //存储当前定制的城市
					show = true; //是否显示科教的内容
					pullToRefresh = [] //存储下拉上拉的控件
					sliderId = ''; //记录显示的城市
					initBody();
				});
				//---订制城市---end---

				//退出登录清理科教界面
				window.addEventListener('cleanSicEduHome', function() {
					cities = []; //存储当前定制的城市
					show = true; //是否显示科教的内容
					pullToRefresh = [] //存储下拉上拉的控件
					sliderId = ''; //记录显示的城市
					document.getElementById("content").innerHTML = ''; //清理界面
					var evalJS = "var sciEduSlider=document.getElementById('sciEduSlider');if(sciEduSlider){sciEduSlider.parentNode.removeChild(sciEduSlider);}";
					index.evalJS(evalJS);
				});
			});

			/**
			 * 初始化主体
			 */
			function initBody() {
				//console.log('initBody ' + show);
				if(show) {
					//生成滑动控件
					document.getElementById("content").innerHTML = '\
					<div id="slider" class="mui-slider mui-fullscreen">\
						<div id="sliderSegmentedControl" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">\
							<div id="topList" class="mui-scroll">\
							</div>\
						</div>\
						<div id="sliderGroup" class="mui-slider-group">\
						</div>\
					</div>';
					show = false;
					//滑动底部列表
					document.querySelector('.mui-slider').addEventListener('slide', function() {
						console.log('slide ' + event.detail.slideNumber);
						mui('.mui-control-item').each(function(index, element) {
							if(index == event.detail.slideNumber) {
								document.getElementById(sliderId).className = 'mui-control-item';
								element.className = 'mui-control-item mui-active';
								sliderId = element.id;
							}
						});
						changeIndexHeader();
						var id = 'bot_' + sliderId.replace('top_', '');
						var element = document.getElementById(id);
						var info = JSON.parse(element.getAttribute('data-info'));
						var page = JSON.parse(element.getAttribute('data-page'));
						console.log('slide ' + JSON.stringify(info));
						console.log('slide ' + JSON.stringify(page));
						if(!page) {
							requestCityNews(info.acode, 1);
						}
					});

					//点击每一项的监听
					mui('#sliderGroup').on('tap', '.mui-table-view-cell', function() {
						var self = this;
						self.disabled = true;
						var id = this.getAttribute('id');
						var turl = this.getAttribute('data-turl');
						var dataHistory = this.getAttribute('data-seHistory');
						var tabid = this.getAttribute('data-tabid');
						console.log(id + ' ' + turl + ' ' + dataHistory + ' ' + tabid);
						if(dataHistory != 'true') { //不是历史记录
							//console.log('dataHistory ' + dataHistory);
							this.setAttribute('data-seHistory', true);
							var personalUID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).uid;
							var History = window.myStorage.getItem(window.storageKeyName.seHistory + '_' + personalUID);
							History[History.length] = tabid;
							if(History.length > 100) {
								History.splice(0, 1); //删掉第一个
							}
							window.myStorage.setItem(window.storageKeyName.seHistory + '_' + personalUID, History);
							//console.log('tap seHistory ' + JSON.stringify(History));
						}
						document.getElementById("title_" + id).style.color = 'darkgray';
						events.openNewWindowWithData('sciedu_show_main.html', {
							turl: turl
						});
						setTimeout(function() {
							self.disabled = false;
						}, 1500);
					});

					//获取定制的城市
					requestCustomizationCity(function(data) {
						//生成滑动框架
						addCitiesSilders(data, function() {
							changeIndexHeader();
							//初始化滑动控件
							mui('#slider').slider();
							//循环初始化所有下拉刷新，上拉加载。
							pullRefresh(function() {
								//设置监听上下滑动
								mui('#sliderGroup .mui-scroll-wrapper').each(function(index, element) {
									element.addEventListener('scrollend', function(e) {
										//console.log('scrollstart');
										var cityCode = sliderId.replace('top_', '');
										var placeholder = '../../' + window.storageKeyName.DEFAULTSCIEDUIMAGELOAD;
										var lazyLoad = mui("#bot_ul_" + cityCode).imageLazyload({
											placeholder: placeholder.toString(), //缩略图
										}); //懒加载控件
										lazyLoad.refresh(true);
									});
								});
								requestCityNews(cities[0].acode, 1);
							});
						});
					});
				}
			}

			/**
			 * 顶部增加定制的城市和底部列表的框架
			 * @param {Object} data 定制的城市
			 * @param {Object} callBack 完成的回调
			 */
			function addCitiesSilders(data, callBack) {
				var fragmentTop = document.createDocumentFragment();
				var fragmentBot = document.createDocumentFragment();
				for(var i = 0; i < data.length; i++) {
					//顶部城市
					var elementTop = document.createElement('a');
					//底部列表
					var elementBot = document.createElement('div');

					if(i == 0) {
						//选择的城市
						sliderId = 'top_' + data[i].acode;
						elementTop.className = 'mui-control-item mui-active';
						elementBot.className = 'mui-slider-item mui-control-content mui-active';
					} else {
						elementTop.className = 'mui-control-item';
						elementBot.className = 'mui-slider-item mui-control-content';
					}
					//顶部城市
					elementTop.id = 'top_' + data[i].acode;
					elementTop.href = '#bot_' + data[i].acode;
					elementTop.innerText = data[i].aname;
					//底部列表
					elementBot.id = 'bot_' + data[i].acode;
					elementBot.setAttribute('data-info', JSON.stringify(data[i]));
					elementBot.innerHTML = '<div id="bot_sw_' + data[i].acode + '" class="mui-scroll-wrapper">\
											<div id="bot_sc_' + data[i].acode + '" class="mui-scroll">\
												<ul id="bot_ul_' + data[i].acode + '" class="mui-table-view">\
												</ul>\
											</div>\
										</div>';
					fragmentTop.appendChild(elementTop);
					fragmentBot.appendChild(elementBot);
				}
				document.getElementById("topList").appendChild(fragmentTop);
				document.getElementById("sliderGroup").appendChild(fragmentBot);

				callBack();
			}

			/**
			 * 循环初始化所有下拉刷新，上拉加载。
			 * @param {Object} callBack 完成的回调
			 */
			function pullRefresh(callBack) {
				//阻尼系数
				var deceleration = mui.os.ios ? 0.003 : 0.0009;
				mui('.mui-scroll-wrapper').scroll({
					bounce: false,
					indicators: true, //是否显示滚动条
					deceleration: deceleration
				});
				//循环初始化所有下拉刷新，上拉加载。
				mui.each(document.querySelectorAll('.mui-slider-group .mui-scroll'), function(index, pullRefreshEl) {
					var refresh = mui(pullRefreshEl).pullToRefresh({
						down: {
							callback: function() {
								var self = this;
								var id = pullRefreshEl.parentNode.parentNode.id;
								var element = document.getElementById(id);
								var info = JSON.parse(element.getAttribute('data-info'));
								var page = JSON.parse(element.getAttribute('data-page'));
								console.log('down ' + JSON.stringify(info));
								console.log('down ' + JSON.stringify(page));
								//获取数据
								requestCityNews(info.acode, 1);
								setTimeout(function() {
									self.endPullDownToRefresh(); //结束下拉刷新
								}, 1000);
							}
						},
						up: {
							contentinit: '',
							callback: function() {
								var self = this;
								var id = pullRefreshEl.parentNode.parentNode.id;
								var element = document.getElementById(id);
								var info = JSON.parse(element.getAttribute('data-info'));
								var page = JSON.parse(element.getAttribute('data-page'));
								console.log('up ' + JSON.stringify(info));
								console.log('up ' + JSON.stringify(page));
								if(page) {
									requestCityNews(info.acode, page.pageIndex + 1);
								} else {
									mui.toast('数据异常，请下拉刷新后重新尝试');
								}
							}
						}
					});
					pullToRefresh.push({
						id: pullRefreshEl.id,
						refresh: refresh
					});
				});
				callBack();
			}

			/**
			 * 添加新闻
			 * @param {Object} cityCode 城市代码
			 * @param {Object} data 新闻数据
			 */
			function addItems(cityCode, data) {
				var personalUID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).uid;
				var seHistory = [];
				//如果没有这个人的记录，则创建一份空记录
				if(window.myStorage.getItem(window.storageKeyName.seHistory + '_' + personalUID)) {
					seHistory = window.myStorage.getItem(window.storageKeyName.seHistory + '_' + personalUID);
				} else {
					window.myStorage.setItem(window.storageKeyName.seHistory + '_' + personalUID, []);
				}
				var placeholder = '../../' + window.storageKeyName.DEFAULTSCIEDUIMAGELOAD;
				var lazyLoad = mui("#bot_ul_" + cityCode).imageLazyload({
					placeholder: placeholder.toString(), //缩略图
				}); //懒加载控件
				for(var i = 0; i < data.length; i++) {
					//console.log('addItems ' + JSON.stringify(data[i]));
					var tips = data[i].tips;
					var tipsList = tips.split('|');
					var date = tipsList[0].split(' ')[0]; //日期
					var time = tipsList[0].split(' ')[1]; //日期
					var from = tipsList[1]; //.substring(3, tipsList[1].length); //来源

					var dataStr = '';
					var timeStr = time.substring(0, 5);
					var mydate = new Date();
					var today = mydate.getFullYear() + '-' + (mydate.getMonth() + 1) + '-' + mydate.getDate();

					if(today == date) { //今天，显示时间
						dataStr = timeStr;
					} else { //显示日期
						dataStr = date;
					}
					data[i].tips = from + ' | ' + dataStr;
					data[i].seHistory = false; //默认都未读
					for(var j = 0; j < seHistory.length; j++) {
						if(data[i].tabid == seHistory[j]) {
							data[i].seHistory = true; //是历史记录，则设为已读
							break;
						}
					}
					SciEduHomeItem.addItem(document.getElementById("bot_ul_" + cityCode), data[i], function() {
						lazyLoad.refresh(true);
					});
				}
				lazyLoad.refresh(true);
				//console.log(document.getElementById("bot_" + cityCode).innerHTML);
			}

			/**
			 * 44.获取个人的订制城市
			 * @param {Object} callBack 成功后的回调
			 */
			function requestCustomizationCity(callBack) {
				//所需参数
				var comData = {
					vvl: '0' //订制频道,0科教频道,1展示频道,其他待定
				};
				// 等待的对话框
				var waitingDia = events.showWaiting();
				//44.获取个人的订制城市
				postDataPro_PostUTcity(comData, waitingDia, function(data) {
					var eduArray = [];
					console.log('获取个人的订制城市科教频道:' + JSON.stringify(data));
					if(data.RspCode == 0) {
						if(data.RspData[0].citys) {
							//先通过‘|’将返回值分为数组
							eduArray = data.RspData[0].citys.split('|');
							//遍历此数组
							for(var m in eduArray) {
								var tempStr = eduArray[m];
								//初始化model
								var model_area = {
									acode: '', //节点代码,通用6位,前两位为省份编码,中间两位为城市编码,后两位为区县编码
									aname: '', //节点名称
								};
								console.log('tempStr:' + tempStr);
								//将分成的每个值，再通过‘_’拆分为model
								var tempArea = tempStr.split('_');
								model_area.acode = tempArea[0];
								model_area.aname = tempArea[1];
								//将对应的这个数组的str和model对换，将数组中的值，替换为model数组
								eduArray.splice(m, 1, model_area);
							}
							console.log('修改后的最终值为:' + JSON.stringify(eduArray));
						}
					} else {
						eduArray = [];
						//mui.toast(data.RspTxt);
					}
					if(eduArray.length == 0) {
						var uarea = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).uarea;
						console.log(JSON.stringify(uarea));
						eduArray.push({
							acode: uarea.acode,
							aname: uarea.aname
						});
					}
					cities = eduArray.slice(0); //拷贝数组
					callBack(cities);
					waitingDia.close();
				});
			}

			//45.通过区域代码获取对应区域的分页新闻
			function requestCityNews(cityCode, pageIndex) {
				//所需参数
				var comData = {
					top: '10', //每页行数，
					vvl: cityCode, //查询的区域代码,省份截取城市代码前两位,城市截取城市代码的前4位
					vvl1: pageIndex //页码,获取第几页
				};
				// 等待的对话框
				var wd = events.showWaiting();
				//45.通过区域代码获取对应区域的分页新闻
				postDataPro_PostTnews(comData, wd, function(data) {
					console.log('对应区域的分页新闻:' + JSON.stringify(data));

					//记录页数
					var page = {
						pageIndex: pageIndex, //当前页数
						totalPage: 0 //总页数
					};
					if(data.RspCode == 0) {
						page.totalPage = data.RspData.pg.PageCount;
					}
					document.getElementById("bot_" + cityCode).setAttribute('data-page', JSON.stringify(page))
					if(pageIndex == 1) { //获取的第一页的内容
						//清空对应的界面
						document.getElementById("bot_ul_" + cityCode).innerHTML = '';
					}

					if(data.RspCode == 0) {
						//新闻总页数
						var tempArr = data.RspData.dt;
						//将返回的新闻遍历
						for(var m in tempArr) {
							var tempModel = tempArr[m];
							if(tempModel.timgs == 'null' || tempModel.timgs == null) {
								tempModel.timgs = [];
							} else {
								tempModel.timgs = tempModel.timgs.split('|');
							}
						}
						console.log('新闻最终值为:' + JSON.stringify(tempArr));
						//生成每一项
						addItems(cityCode, tempArr);
					} else {
						mui.toast(data.RspTxt);
					}

					//设置上拉下拉控件的状态
					var tempRefresh;
					for(var i = 0; i < pullToRefresh.length; i++) {
						var id = pullToRefresh[i].id.replace('bot_sc_', '');
						if(id == cityCode) {
							tempRefresh = pullToRefresh[i];
						}
					}
					if(page.pageIndex != 1) { //结束上拉加载更多
						tempRefresh.refresh.endPullUpToRefresh(); //结束上拉加载更多
					}

					if(page.pageIndex >= page.totalPage) {
						//没有下一页
						tempRefresh.refresh.endPullUpToRefresh(true);
					} else {
						if(pageIndex == 1) {
							//获取第一页的数据更新当前控件
							tempRefresh.refresh.refresh(true);
						}
					}
					wd.close();
				});
			}

			/**
			 * 改变顶部的城市
			 */
			function changeIndexHeader() {
				if(sliderId != '' && cities.length != 0) {
					var acode = sliderId.replace('top_', '');
					for(var i = 0; i < cities.length; i++) {
						if(cities[i].acode == acode) {
							var str = '<div class="mui-slider-indicator">';
							if(cities.length > 1) {
								for(var j = 0; j < cities.length; j++) {
									if(cities[j].acode == acode) {
										str = str + '<div class="mui-indicator mui-active"></div>';
									} else {
										str = str + '<div class="mui-indicator"></div>';
									}
								}
							}
							str = str + '</div>';
							var str_0 = "document.getElementById('title').innerText = '" + cities[i].aname + "';";
							var str_1 = "var sciEduSlider = document.getElementById('sciEduSlider');";
							var str_2 = "if(sciEduSlider) {sciEduSlider.innerHTML = '" + str + "';} else {";
							var str_3 = "var element = document.createElement('div');element.id = 'sciEduSlider';element.className = 'mui-slider';";
							var str_4 = "element.style.height = '45px';element.style.top = '" + (localStorage.getItem('StatusHeightNo') * 1 + 10) + "px';";
							var str_5 = "element.innerHTML = '" + str + "';document.querySelector('header').appendChild(element);}";
							var evalJS = str_0 + str_1 + str_2 + str_3 + str_4 + str_5;
							//console.log("evalJS " + evalJS);
							index.evalJS(evalJS);
						}
					}
				}
			}
		</script>

	</body>

</html>