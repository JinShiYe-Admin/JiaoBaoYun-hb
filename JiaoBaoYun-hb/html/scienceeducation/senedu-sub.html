<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<style>
			body,
			.mui-content {
				background: white;
			}

			.mui-table-view:before,
			.mui-table-view:after {
				height: 0px;
			}

			.mui-content .mui-table-view:first-child {
				margin-top: 0px;
			}

			.mui-table-view-cell:after {
				right: 15px;
				left: 15px;
			}

			.mui-table-view-cell:last-child:after {
				height: 1px;
			}
		</style>
	</head>

	<body>
		<div class="mui-content">
			<ul id="ul_refresh" class="mui-table-view">

			</ul>
		</div>

		<script src="../../js/mui.min.js"></script>
		<script src="../../js/utils/events.js"></script>
		<script src="../../js/utils/slide-selector.js"></script>
		<script src="../../js/publicProtocol.js"></script>
		<script src="../../js/utils/h5fresh.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="../../js/senedu/SenEduHomeItem.js"></script>

		<script type="text/javascript">
			mui.init();

			//判断是加载更多1还是刷新0
			var eduFlag = 0;
			//当前加载的页码
//			var eduIndex = 1;
//			//新闻总页码
//			var eduSumCount = 0;
			mui.plusReady(function() {

				//---滑动start---
				mui(".mui-scroll-wrapper").scroll({
					scrollY: true, //是否竖向滚动
					scrollX: false, //是否横向滚动
					indicators: true, //是否显示滚动条
					deceleration: 0.0006, //阻尼系数,系数越小滑动越灵敏
					bounce: true, //是否启用回弹
				});
				//---滑动end---

				window.addEventListener('cityInfo', function(e) {
					SECity = e.detail; //当前显示的科教城市
					console.log("科教子页面获取的城市信息：" + JSON.stringify(SECity));
					//获取对应城市新闻
					if (!SECity.array||SECity.array.length == 0) {

						requestCityNews(SECity.acode);
					}

					//刷新界面
					document.getElementById("ul_refresh").innerHTML = '';
					mui.each(SECity.array, function(index, element) {
						//生成每一项
						addItem(element);
					});
					personalUTID = myStorage.getItem(storageKeyName.PERSONALINFO).utid;
				});
				//刷新
				h5fresh.addRefresh(function() {
					eduFlag = 0;
					SECity.eduIndex = 1;
					SECity.eduSumCount = 0;
					requestCityNews(SECity.acode);
				});
				slide_selector.addSwipeListener();

				//点击每一项的监听
				mui('.mui-table-view').on('tap', '.mui-table-view-cell', function() {
					var id = this.getAttribute('id');
					var turl = this.getAttribute('data-turl');
					console.log(id + '|' + turl);
					events.openNewWindowWithData('senedu_show_main.html', {
						turl: turl
					});
				});
			});

			//加载更多
			var pullUpRefresh = function() {
				document.addEventListener("plusscrollbottom", function() {
					//					console.log('我在底部pageIndex:' + selectGContainer.classInfo.pageIndex + ',totalPageCount:' + totalPageCount);
					eduFlag = 1;
					//判断是否还有更多
					if(SECity.eduIndex <= SECity.eduSumCount) {
						requestCityNews();
					}
				}, false);
			}

			//45.通过区域代码获取对应区域的分页新闻
			function requestCityNews(cityCode) {
				//所需参数
				var comData = {
					top: '10', //每页行数，
					vvl: cityCode, //查询的区域代码,省份截取城市代码前两位,城市截取城市代码的前4位
					vvl1: SECity.eduIndex //页码,获取第几页
				};
				// 等待的对话框
				var wd = plus.nativeUI.showWaiting(storageKeyName.WAITING);
				//45.通过区域代码获取对应区域的分页新闻
				postDataPro_PostTnews(comData, wd, function(data) {
					wd.close();
					console.log('对应区域的分页新闻:' + JSON.stringify(data));
					if(data.RspCode == 0) {
						//新闻总页数
						SECity.eduSumCount = data.RspData.pg.PageCount;
						SECity.eduIndex++;
						var tempArr = data.RspData.dt;
						//将返回的新闻遍历
						for(var m in tempArr) {
							var tempModel = tempArr[m];
							if(tempModel.timgs == 'null' || tempModel.timgs == null) {
								tempModel.timgs = [];
							} else {
								tempModel.timgs = tempModel.timgs.split('|');
							}
						}
						console.log('新闻最终值为:' + JSON.stringify(tempArr));
						//判断是加载更多1还是刷新0
						if(eduFlag == 0) {
							SECity.array = tempArr;
							//清空界面
							document.getElementById("ul_refresh").innerHTML = '';
						} else {
							SECity.array = SECity.array.concat(tempArr);
						}
						events.fireToPageNone('scienceeducation_home.html', 'cityInfo', SECity);
						//刷新界面
						mui.each(tempArr, function(index, element) {
							//生成每一项
							addItem(element);
						});
					} else {
						mui.toast(data.RspTxt);
					}
				});
			}

			/**
			 * 添加一条记录
			 * @param {Object} data
			 */
			function addItem(data) {
				var tips = data.tips;
				var tipsList = tips.split('|');
				var date = tipsList[0].split(' ')[0]; //日期
				var time = tipsList[0].split(' ')[1]; //日期
				var from = tipsList[1]; //.substring(3, tipsList[1].length); //来源

				var dataStr = '';
				var timeStr = time.substring(0, 5);
				var mydate = new Date();
				var today = mydate.getFullYear() + '-' + (mydate.getMonth() + 1) + '-' + mydate.getDate();

				if(today == date) { //今天，显示时间
					dataStr = timeStr;
				} else { //显示日期
					dataStr = date;
				}
				data.tips = from + ' | ' + dataStr;
				SenEduHomeItem.addItem(document.getElementById("ul_refresh"), data);
			}
		</script>
	</body>

</html>