<!--我的界面-->
<!--@anthor an-->
<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/utils/common.css" />
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/home/index-menu.css" />
		<link rel="stylesheet" href="../../css/iconfont/iconfont.css" />
	</head>

	<body>
		<div class="mui-content">

			<div id="title" class="title">
				<img id="uimg" style="height: 60px;width: 60px;" src="../../image/utils/default_personalimage.png" class="head-portrait" /><br />
				<h4 id="uname">姓名</h4>
				<p id="utext">暂无信息</p>
			</div>

			<!--各项-->
			<ul class="mui-table-view mui-table-view-chevron">

				<li class="mui-table-view-cell" position='0'>
					<a class="mui-navigate-right" open-type="common">
						<span class="mui-icon iconfont icon-qunziliao"></span> 群资料
					</a>
				</li>
				<li class="mui-table-view-cell" position='1'>
					<a class="mui-navigate-right" open-type="common">
						<span class="mui-icon iconfont icon-group"></span> 群管理
					</a>
				</li>
				<li class="mui-table-view-cell" position='2'>
					<a class="mui-navigate-right" open-type="common">
						<span class="mui-icon iconfont icon-jiaqun"></span> 申请加入群
					</a>
				</li>
				<li class="mui-table-view-divider"></li>
				<li class="mui-table-view-cell" position='3'>
					<a class="mui-navigate-right">
						<span class="mui-icon iconfont icon-newmessage"></span> 新消息
						<span id="news-amount" class="mui-badge mui-badge-red">数字</span>
					</a>
				</li>

				<li class="mui-table-view-cell" position='4'>
					<a class="mui-navigate-right">
						<span class="mui-icon iconfont icon-zone"></span> 我的空间
					</a>
				</li>
				<li class="mui-table-view-cell" position='5'>
					<a class="mui-navigate-right">
						<span class="mui-icon iconfont icon-jifen"></span> 积分
					</a>
				</li>
				<li class="mui-table-view-divider"></li>
				<li class="mui-table-view-cell" position='6'>
					<a class="mui-navigate-right">
						<span class="mui-icon iconfont icon-shezhi about-icon"></span> 设置
					</a>
				</li>
				<li class="mui-table-view-cell" position='7'>
					<a class="mui-navigate-right">
						<span class="mui-icon iconfont icon-about about-icon"></span> 关于
					</a>
				</li>
			</ul>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/utils/events.js"></script>
		<script src="../../js/publicProtocol.js"></script>
		<script type="text/javascript" charset="utf-8">
			mui.init({
				keyEventBind: {
					backbutton: false,
					menubutton: false
				}
			});
			//获得侧滑主窗口webview对象
			var main = null;
			var info = null;
			mui.plusReady(function() {
				main = plus.webview.currentWebview().opener();
				var personalUTID = window.myStorage.getItem(window.storageKeyName.PERSONALINFO).utid; //用户id

				//获取个人信息
				//personalInfo = myStorage.getItem(storageKeyName.PERSONALINFO);

				//展示个人信息
				getInfo();
				//				events.jumpPage(document.getElementById('title'),'mine/account-info.html');
				//点击title跳转到账号信息界面
				events.addTap('title', function() {
					closeMenu()
					events.openNewWindow('/html/mine/account-info.html')
				})

				mui('.mui-table-view').on('tap', '.mui-table-view-cell', function() {
					console.log('click position:' + this.getAttribute('position'))
//				
					switch(parseInt(this.getAttribute('position'))) {
						//群资料
						case 0:
							events.openNewWindow('/html/mine/qun_data.html');
							break;
							//群管理
						case 1:
							events.openNewWindow('/html/mine/qun_manage.html');
							break;
							//申请加入群
						case 2:
							events.openNewWindow('/html/mine/apply-record.html');
							break;
							//新消息
						case 3:
							events.openNewWindow('/html/mine/approval-apply.html');
							break;
							//我的空间
						case 4:
						events.openNewWindowWithData('/html/quan/zone_main.html',personalUTID);
							break;
							//积分
						case 5:
							break;
							//设置
						case 6:
							events.openNewWindow('/html/mine/setting.html')
							break;
							//关于
						case 7:
							events.openNewWindow('/html/mine/group-info.html')
							break;

						default:
							break;
					}
					setTimeout(function(){
						closeMenu()
					},1500);
				});
			})
			window.addEventListener('infoChanged', function() {
					getInfo()
				})
			window.addEventListener('newsChanged',function(){
					getNewsAmount();
			})
			/**
			 * 获取个人信息
			 */
			function getInfo() {
				info = myStorage.getItem(storageKeyName.PERSONALINFO);
				console.log('我的界面获取的个人信息：' + JSON.stringify(info))
				if(info.uimg) {
					var myDate = new Date();
					document.getElementById('uimg').src = info.uimg + '?' + myDate.getTime();
				}else{
					document.getElementById('uimg').src ='../../image/utils/default_personalimage.png';
				}
				if(info.uname) {
					document.getElementById('uname').innerText = info.uname;
				}
				if(info.utxt) {
					document.getElementById('utext').innerText = info.utxt;
				}else{
					document.getElementById('utext').innerText = "暂无信息";
				}
				getNewsAmount();
			}
			/**
			 * 获取新消息数量
			 */
			var getNewsAmount=function(){
				var wd=plus.nativeUI.showWaiting(storageKeyName.WAITING);
				postDataPro_PostGrInvC({},wd,function(data){
					wd.close();
					console.log('我的界面获取的新消息数目：'+JSON.stringify(data));
					var num=document.getElementById('news-amount');
					if(data.RspCode=='0000'){
						num.style.display='inline';
						num.innerText=setAmount(data.RspData);
					}else{
						num.style.display='none';
					}
				});
			}
			var setAmount=function(data){
				var amount=0;
				data.forEach(function(cell){
					amount+=cell.pc;
				})
				return amount;
			}
			//关闭
			function closeMenu() {
				mui.fire(main, "menu:close");
			}
			//优化显示出来的侧滑菜单，只需监听该菜单的左滑事件，然后将其关闭即可；在菜单上右滑，不做任何操作；
			window.addEventListener("swipeleft", closeMenu);
			//android菜单按钮
			mui.menu = closeMenu;
			//android系统返回键
			mui.back = closeMenu;
		</script>
	</body>

</html>